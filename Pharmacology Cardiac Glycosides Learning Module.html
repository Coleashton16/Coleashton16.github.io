<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiovascular Pharmacology Learning Module</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration to use the Inter font.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- React and Library Setup ---
        // Destructure necessary hooks from the global React object.
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup for Standalone Demo ---
        // This mock object simulates basic user authentication to allow progress tracking via localStorage.
        // In a real application, this would be replaced with actual Firebase authentication.
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                // Simulate an asynchronous authentication check, providing a unique user ID.
                setTimeout(() => callback({ uid: 'standalone-cardiac-user' }), 100);
                return () => {}; // Returns an empty function as a cleanup/unsubscribe placeholder.
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-cardiac-user' } }), // Mock anonymous sign-in.
        };

        // --- Content & Data Structure for the Learning Modules ---
        // The main content is broken down into smaller, focused modules based on concepts.
        const contentData = {
            'introduction-cardio': {
                title: 'Introduction to Cardiovascular System',
                color: 'from-sky-500 to-cyan-400',
                description: 'Understand the basics of the heart, blood flow, and electrical impulses.',
                steps: [
                    { id: 'intro-system', title: 'Introduction', type: 'text', content: `The <strong>cardiovascular system</strong> includes the heart, blood vessels (arteries and veins), and blood flow. Blood abundant in oxygen (O2), nutrients, and hormones moves through arteries, narrowing to arterioles and then to capillaries. Capillaries transport nourished blood to body cells and absorb waste products like carbon dioxide (CO2), urea, creatinine, and ammonia. Deoxygenated blood returns via venules and veins for elimination by the lungs and kidneys.<br><br>The heart’s pumping action circulates blood. Blockage of vessels can inhibit blood flow.` },
                    { id: 'heart-anatomy', title: 'Heart Anatomy', type: 'text', content: `The heart has four chambers: right and left atria, and right and left ventricles. The <strong>right atrium</strong> receives deoxygenated blood, and the <strong>right ventricle</strong> pumps it to the lungs. The <strong>left atrium</strong> receives oxygenated blood, and the <strong>left ventricle</strong> pumps it into the aorta for systemic circulation.<br><br>The heart muscle, or <strong>myocardium</strong>, surrounds the ventricles and atria. Ventricles, especially the left, have thick walls for powerful pumping. The atria have thinner walls and primarily receive blood.<br><br>The <strong>pericardium</strong> is the heart's fibrous covering, protecting it from injury. The <strong>endocardium</strong> lines the inner chambers. Four valves (tricuspid, mitral, pulmonic, aortic) control blood flow. Two main coronary arteries (right and left, dividing into circumflex and anterior descending) supply blood to the heart muscle. Blockage in these arteries can cause a <strong>myocardial infarction (MI)</strong>, or heart attack.` },
                    { id: 'electrical-impulses', title: 'Conduction of Electrical Impulses', type: 'text', content: `The myocardium generates and conducts its own electrical impulses. The cardiac impulse originates in the <strong>sinoatrial (SA) node</strong>, the heart's pacemaker, setting a rate of 60 to 80 beats/min. If the SA node fails, the <strong>atrioventricular (AV) node</strong> takes over as pacemaker (40 to 60 beats/min). The AV node transmits impulses to the ventricles via the bundle of His. The ventricles can contract independently at 30 to 40 times per minute.<br><br>Drugs affecting cardiac contraction include calcium, digitalis preparations, and quinidine. The <strong>autonomic nervous system (ANS)</strong> also influences heart contractions: sympathetic stimulation increases heart rate, while parasympathetic stimulation decreases it.` },
                    { id: 'heart-rate-blood-flow', title: 'Regulation of Heart Rate and Blood Flow', type: 'text', content: `The heart beats 60 to 80 times/min, pumping blood into systemic circulation. Arterial pressure (blood pressure, avg. 120/80 mm Hg) is determined by peripheral resistance and <strong>cardiac output (CO)</strong>. CO is blood volume expelled in 1 minute (Heart Rate × Stroke Volume), averaging 4 to 8 L/min.<br><br><strong>Stroke volume</strong> (approx. 70 mL/beat) is the blood ejected from the left ventricle per beat, determined by three factors:<br>- <strong>Preload:</strong> Blood flow force stretching the ventricle at end-diastole. Increased preload increases stroke volume.<br>- <strong>Contractility:</strong> Force of ventricular contraction.<br>- <strong>Afterload:</strong> Resistance to ventricular ejection, caused by opposing pressures in the aorta/systemic circulation. Increased afterload decreases stroke volume.<br><br>Specific drugs can increase or decrease preload and afterload, affecting stroke volume and CO. Most vasodilators decrease preload and afterload, thus decreasing arterial pressure and CO.` },
                    { id: 'circulation-blood', title: 'Circulation and Blood', type: 'text', content: `There are two types of circulation:<br>- <strong>Pulmonary circulation:</strong> Deoxygenated blood from the right ventricle goes to the lungs via the pulmonary artery; oxygenated blood returns to the left atrium via the pulmonary vein.<br>- <strong>Systemic (peripheral) circulation:</strong> Blood from the left ventricle goes to the aorta and general circulation, supplying nutrients to cells and collecting waste products before returning to the heart.<br><br><strong>Blood</strong> is composed of plasma (90% water, 10% solutes), red blood cells (RBCs), white blood cells (WBCs), and platelets. RBCs (120-day lifespan) carry oxygen via hemoglobin. WBCs (2-24-hour lifespan) are the body's defense, engulfing microorganisms and producing antibodies. Platelets cause blood coagulation.` },
                    { id: 'intro-quiz', title: 'Introductory Quiz', type: 'quiz',
                      questions: [
                          { question: "Which part of the heart is responsible for pumping oxygenated blood to the systemic circulation?", options: ["Right atrium", "Right ventricle", "Left atrium", "Left ventricle"], correctAnswer: "Left ventricle" },
                          { question: "What is the primary pacemaker of the heart?", options: ["Atrioventricular (AV) node", "Bundle of His", "Purkinje fibers", "Sinoatrial (SA) node"], correctAnswer: "Sinoatrial (SA) node" },
                          { question: "Which of the following factors is NOT one of the three determinants of stroke volume?", options: ["Preload", "Afterload", "Heart Rate", "Contractility"], correctAnswer: "Heart Rate" },
                          { question: "Deoxygenated blood is carried from the right ventricle to the lungs by which vessel?", options: ["Aorta", "Pulmonary artery", "Pulmonary vein", "Superior vena cava"], correctAnswer: "Pulmonary artery" }
                      ]
                    },
                ]
            },
            'heart-failure-management': {
                title: 'Heart Failure: Diagnosis & Nonpharmacologic Measures',
                color: 'from-red-500 to-orange-400',
                description: 'Learn to diagnose heart failure and implement nonpharmacologic interventions.',
                steps: [
                    { id: 'hf-lab-tests', title: 'Lab Tests to Diagnose Heart Failure', type: 'text', content: `Laboratory tests help diagnose Heart Failure (HF):<br>
                        - <strong>Atrial Natriuretic Hormone (ANH) or Peptide (ANP):</strong> Reference 20-77 pg/mL. Elevated levels may confirm HF. ANH is secreted from the atria, acting as an antagonist to renin and aldosterone. It produces vasodilation and increases GFR, leading to increased urine volume, decreased blood volume, and decreased blood pressure.<br>
                        - <strong>Brain Natriuretic Peptide (BNP):</strong> Desired value <100 pg/mL; positive >100 pg/mL. Primarily secreted from atrial cardiac cells, elevated BNP aids in HF diagnosis, especially differentiating dyspnea due to HF from lung dysfunction. BNP is often higher in women ≥65 years, but markedly elevated in HF (e.g., 400 pg/mL). It's considered more sensitive than ANP for diagnosing HF.` },
                    { id: 'hf-nonpharm-measures', title: 'Nonpharmacologic Measures for Heart Failure', type: 'text', content: `Non-drug therapy is crucial for controlling HF. Recommendations should be tailored per patient, but general guidelines include:<br>
                        - Limit <strong>salt intake</strong> to 2 g/day (approx. 1 teaspoon).<br>
                        - Decrease or avoid <strong>alcohol intake</strong> (excessive use can lead to cardiomyopathy).<br>
                        - Fluid intake may be restricted.<br>
                        - Avoid <strong>smoking</strong> (deprives the heart of O2).<br>
                        - Modify behaviors for <strong>obesity</strong> if associated with unhealthy habits.<br>
                        - Decrease <strong>saturated fat intake</strong>.<br>
                        - Engage in <strong>mild exercise</strong> (e.g., walking, bicycling).` },
                    { id: 'hf-stages', title: 'Stages of Heart Failure', type: 'text', content: `The American College of Cardiology Foundation (ACCF) and the American Heart Association (AHA) classify HF into stages:<br>
                        - <strong>Stage A:</strong> High risk for HF but no structural heart disease or symptoms.<br>
                        - <strong>Stage B:</strong> Structural heart disease but no signs or symptoms of HF.<br>
                        - <strong>Stage C:</strong> Structural heart disease with prior or current symptoms of HF.<br>
                        - <strong>Stage D:</strong> Refractory HF requiring specialized interventions.` },
                    { id: 'hf-diagnosis-quiz', title: 'HF Diagnosis & Nonpharm Quiz', type: 'quiz',
                      questions: [
                          { question: "Which laboratory test is primarily used to differentiate dyspnea due to heart failure from dyspnea due to lung dysfunction?", options: ["Atrial Natriuretic Hormone (ANH)", "Brain Natriuretic Peptide (BNP)", "Creatinine", "Electrolyte panel"], correctAnswer: "Brain Natriuretic Peptide (BNP)" },
                          { question: "A nurse is teaching a patient with heart failure about nonpharmacologic measures. Which recommendation should the nurse include?", options: ["Increase salt intake to improve fluid balance.", "Engage in strenuous exercise daily.", "Limit fluid intake as advised by the healthcare provider.", "Smoke in moderation to reduce stress."], correctAnswer: "Limit fluid intake as advised by the healthcare provider." }
                      ]
                    },
                ]
            },
            'cardiac-glycosides': {
                title: 'Cardiac Glycosides: Digoxin',
                color: 'from-blue-400 to-indigo-600',
                description: 'Understand the mechanism, uses, and nursing considerations for cardiac glycosides, particularly digoxin.',
                steps: [
                    { id: 'cardiac-glycosides-intro', title: 'Introduction to Cardiac Glycosides', type: 'text', content: `<strong>Cardiac glycosides</strong>, such as <strong>digitalis</strong> (from the foxglove plant), have long been used to treat <strong>Heart Failure (HF)</strong>, also known as pump failure or chronic HF. When the myocardium weakens and enlarges, its ability to pump blood is impaired. Acute HF occurs when compensatory mechanisms fail, leading to congestion in peripheral and lung tissues. Causes of HF include chronic hypertension, MI, CAD, valvular heart disease, congenital heart disease, and arteriosclerosis.<br><br>HF can be left-sided (left ventricle fails, blood backs up into lungs, causing SOB, dyspnea) or right-sided (right ventricle fails, blood backs up into peripheral tissues, causing edema). Myocardial hypertrophy and cardiomegaly are common with chronic HF.<br><br>In HF, preload and afterload increase. Cardiac glycosides inhibit the <strong>sodium-potassium pump</strong>, increasing intracellular sodium, which leads to an influx of calcium. This causes cardiac muscle fibers to contract more efficiently. They have three effects on heart muscle:<br>1. <strong>Positive inotropic action:</strong> Increases myocardial contraction stroke volume.<br>2. <strong>Negative chronotropic action:</strong> Decreases heart rate.<br>3. <strong>Negative dromotropic action:</strong> Decreases conduction of heart cells.<br><br>These effects strengthen cardiac, peripheral, and kidney function, enhancing cardiac output, decreasing preload, improving blood flow, reducing edema, and promoting fluid excretion. Digoxin increases the force and velocity of myocardial systolic contraction.` },
                    { id: 'digoxin-details', title: 'Digoxin: Pharmacokinetics & Pharmacodynamics', type: 'text', content: `<strong>Digoxin</strong> is a secondary drug for HF; first-line drugs include IV inotropic agents (dopamine, dobutamine) and phosphodiesterase (PDE) inhibitors (milrinone). Other HF drugs include oral diuretics, beta blockers, ACE inhibitors, ARBs, CCBs, and vasodilators. Cardiac glycosides also correct <strong>atrial fibrillation</strong> and <strong>atrial flutter</strong> by their negative chronotropic and dromotropic effects.<br><br><strong>Pharmacokinetics:</strong>
                        - Oral absorption: 70-80% (tablet), 75-85% (liquid).
                        - Protein binding: 20-30%.
                        - Half-life: 30-40 hours (risk of accumulation).
                        - Metabolism: 30% by liver; excretion: 70% by kidneys (mostly unchanged).
                        - Kidney dysfunction affects excretion; thyroid dysfunction alters metabolism (decrease dose in hypothyroidism, increase in hyperthyroidism).<br>
                        <strong>Pharmacodynamics:</strong>
                        - Increases myocardial contraction, cardiac output, circulation, and tissue perfusion.
                        - Decreases conduction through AV node, reducing heart rate.
                        - Therapeutic serum level for dysrhythmias: 0.8-2.0 ng/mL.
                        - Target therapeutic serum level for HF: 0.5-1.0 ng/mL.` },
                    { id: 'digitalis-toxicity', title: 'Digitalis (Digoxin) Toxicity & Antidote', type: 'text', content: `<strong>Digitalis toxicity</strong> results from overdose or accumulation. Signs and symptoms include:
                        - Anorexia, diarrhea, nausea, vomiting.
                        - <strong>Bradycardia</strong> (pulse <60 bpm), premature ventricular contractions, cardiac dysrhythmias.
                        - Headaches, malaise, blurred vision, <strong>visual illusions (white, green, or yellow halos around objects)</strong>, confusion, delirium.
                        - Older adults are more prone to toxicity.<br><br>
                        <strong>Cardiotoxicity</strong> is a serious adverse reaction, leading to ventricular dysrhythmias due to suppressed AV conduction, increased automaticity, and decreased refractory period in ventricular muscle. Phenytoin and lidocaine can treat digoxin-induced ventricular dysrhythmias (lidocaine for short-term).<br><br>
                        <strong>Antidote: Digoxin-immune Fab</strong>. It binds with digoxin, forming complex molecules excreted in urine, preventing digoxin from binding to its cellular site of action. Monitor serum digoxin levels and report toxicity signs promptly. Digitalis toxicity can lead to first-, second-, or complete heart block.<br><br>
                        <strong>Drug Interactions:</strong>
                        - Potassium-wasting diuretics (furosemide, hydrochlorothiazide) cause hypokalemia, increasing digoxin effect and toxicity.
                        - Cortisone also promotes potassium loss, increasing toxicity risk.
                        - Patients on digoxin with potassium-wasting diuretics or cortisone should consume high-potassium foods or take supplements.
                        - Antacids decrease digoxin absorption; stagger doses.` },
                    { id: 'cardiac-glycosides-np', title: 'Digoxin: Nursing Process', type: 'text', content: `<strong>Concept: Perfusion</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        - Obtain drug and herbal history (e.g., ginseng, St. John's wort, hawthorn, licorice, aloe, ma-huang, goldenseal can interact).
                        - Report probable drug-drug or drug-herb interactions (e.g., hypokalemia from potassium-wasting diuretics/cortisone increases toxicity).
                        - Obtain baseline apical pulse rate (full minute, >60 bpm) and assess for digitalis toxicity signs (anorexia, nausea, vomiting, bradycardia, dysrhythmias, visual disturbances).<br>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Decreased gas exchange, decreased tissue perfusion, hypoxemia, ischemia.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient will check pulse, report rates <60 bpm, and list potassium-rich foods.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        - Ascertain apical pulse rate before administering digoxin; withhold if <60 bpm.
                        - Determine signs of peripheral and pulmonary edema.
                        - Monitor serum digoxin level (0.8-2 ng/mL; >2 ng/mL indicates toxicity).
                        - Monitor serum potassium level (3.5-5.0 mEq/L); report hypokalemia (<3.5 mEq/L).<br>
                        <strong>Patient Teaching:</strong>
                        - Adherence to therapy; avoid OTC drugs without provider consult.
                        - Keep drugs out of reach of children.
                        - Teach pulse check; report irregular pulse or <60 bpm.
                        - Report side effects: pulse <60 bpm, nausea, vomiting, headache, diarrhea, visual disturbances (diplopia).
                        - Advise high-potassium foods (fresh/dried fruits, juices, potatoes).<br>
                        <strong>Evaluate Outcomes:</strong> Assess effectiveness (decreased heart rate, decreased rales, absence of side effects) and continue monitoring pulse.` },
                    { id: 'cardiac-glycosides-quiz', title: 'Cardiac Glycosides Quiz', type: 'quiz',
                      questions: [
                          { question: "Which of the following is a primary effect of cardiac glycosides like digoxin on the heart muscle?", options: ["Negative inotropic action", "Positive chronotropic action", "Positive dromotropic action", "Increased myocardial contraction"], correctAnswer: "Increased myocardial contraction" },
                          { question: "A patient receiving digoxin reports seeing yellow halos around lights and has a pulse rate of 52 bpm. The nurse suspects digitalis toxicity. Which of the following is the antidote?", options: ["Naloxone", "Protamine sulfate", "Digoxin-immune Fab", "Vitamin K"], correctAnswer: "Digoxin-immune Fab" },
                          { question: "What is the desired therapeutic serum level of digoxin for a patient being treated for heart failure?", options: ["0.2-0.8 ng/mL", "0.5-1.0 ng/mL", "1.5-2.5 ng/mL", "2.0-3.0 ng/mL"], correctAnswer: "0.5-1.0 ng/mL" },
                          { question: "Which electrolyte imbalance significantly increases a patient's risk for digoxin toxicity?", options: ["Hyperkalemia", "Hypocalcemia", "Hypokalemia", "Hypernatremia"], correctAnswer: "Hypokalemia" }
                      ]
                    },
                ]
            },
            'other-hf-agents': {
                title: 'Other Agents for Heart Failure',
                color: 'from-purple-500 to-pink-500',
                description: 'Explore additional drug classes used in the management of heart failure.',
                steps: [
                    { id: 'pde-inhibitors', title: 'Phosphodiesterase Inhibitors', type: 'text', content: `<strong>Phosphodiesterase (PDE) inhibitors</strong> are positive inotropic drugs used for acute HF. They inhibit the enzyme PDE, promoting a positive inotropic response and vasodilation. <strong>Milrinone lactate</strong> is an example that increases stroke volume and cardiac output and promotes vasodilation. It's given IV for no longer than 48-72 hours due to the risk of severe cardiac dysrhythmias. ECG and cardiac status must be closely monitored. Milrinone is a <strong>high-alert medication</strong>.` },
                    { id: 'vasodilators-hf', title: 'Vasodilators, ACEIs, ARBs in HF', type: 'text', content: `Various drug groups treat HF, including <strong>vasodilators, ACE inhibitors, angiotensin II-receptor antagonists (ARBs), diuretics, spironolactone, nesiritide,</strong> and some <strong>beta blockers</strong>.<br><br>
                        - <strong>Vasodilators:</strong> Decrease venous blood return (preload), cardiac filling, ventricular stretching, and oxygen demand. Arteriolar dilators reduce afterload, increasing cardiac output, improving renal perfusion and fluid loss, and enhancing skeletal muscle circulation.<br>
                        - <strong>ACE inhibitors:</strong> (e.g., lisinopril) Dilate venules and arterioles, improving renal blood flow and decreasing fluid volume. They moderately reduce aldosterone release, reducing sodium and fluid retention. Monitor serum potassium due to potential increase, especially with potassium-sparing diuretics.<br>
                        - <strong>ARBs:</strong> (e.g., valsartan, candesartan) Approved for HF in patients intolerant to ACE inhibitors.` },
                    { id: 'diuretics-spironolactone', title: 'Diuretics & Spironolactone in HF', type: 'text', content: `<strong>Diuretics</strong> are first-line for reducing fluid volume in HF, often prescribed with digoxin or other agents.<br><br>
                        - <strong>Spironolactone:</strong> A potassium-sparing diuretic used for moderate to severe HF. It blocks aldosterone production, which is increased in HF and promotes potassium/magnesium loss while increasing sodium/water retention. Spironolactone improves heart rate variability and decreases myocardial fibrosis, promoting cardiac remodeling. Recommended dose is 12.5-25 mg/day. Hyperkalemia is rare unless ≥50 mg/day with renal insufficiency, but serum potassium should be closely monitored.` },
                    { id: 'beta-blockers-nesiritide', title: 'Beta Blockers & Nesiritide in HF', type: 'text', content: `- <strong>Beta blockers:</strong> (carvedilol, metoprolol, bisoprolol) Historically contraindicated in HF due to reduced contractility, but with careful, low, and gradually increasing dosages, they can improve cardiac performance. Beneficial effects may take 1-3 months to develop.<br><br>
                        - <strong>Nesiritide:</strong> An atrial natriuretic peptide hormone that inhibits antidiuretic hormone (ADH) by increasing urine sodium loss. It corrects HF by promoting vasodilation, natriuresis, and diuresis. Useful for acute decompensated HF with dyspnea at rest or with minimal exertion.` },
                    { id: 'new-hf-drugs', title: 'Newer HF Agents & Combinations', type: 'text', content: `- A combination of <strong>hydralazine</strong> (for blood pressure) and <strong>isosorbide dinitrate</strong> (a dilator for heart pain) is FDA-approved for HF, especially effective in African Americans.<br><br>
                        - <strong>Vericiguat:</strong> The newest HF drug, a guanylate cyclase stimulant. It regulates vascular tone, cardiac contractility, and cardiac remodeling. Used to reduce cardiovascular mortality and HF hospitalizations with ejection fraction <45%. It is contraindicated in pregnancy due to serious birth defects; females of childbearing age must have a negative pregnancy test and use effective contraception. Not recommended with PDE5 inhibitors due to potentiated hypotension. Side effects include hypotension, anemia, syncope, and birth defects.` },
                    { id: 'other-hf-agents-quiz', title: 'Other HF Agents Quiz', type: 'quiz',
                      questions: [
                          { question: "Which of the following adverse effects is a significant concern when administering phosphodiesterase inhibitors like milrinone lactate?", options: ["Bradycardia", "Severe cardiac dysrhythmias", "Hypertension", "Hyperglycemia"], correctAnswer: "Severe cardiac dysrhythmias" },
                          { question: "A patient with heart failure is prescribed spironolactone. The nurse understands that this medication helps by:", options: ["Increasing aldosterone production.", "Promoting potassium loss.", "Blocking aldosterone production.", "Increasing fluid retention."], correctAnswer: "Blocking aldosterone production." },
                          { question: "Which newer medication for heart failure is a guanylate cyclase stimulant and requires a negative pregnancy test for females of childbearing age?", options: ["Milrinone", "Nesiritide", "Hydralazine-isosorbide dinitrate combination", "Vericiguat"], correctAnswer: "Vericiguat" }
                      ]
                    },
                ]
            },
            'antianginal-drugs': {
                title: 'Antianginal Drugs',
                color: 'from-green-500 to-lime-400',
                description: 'Learn about medications used to treat angina pectoris, including nitrates, beta blockers, and calcium channel blockers.',
                steps: [
                    { id: 'angina-intro', title: 'Angina Pectoris: Introduction & Types', type: 'text', content: `<strong>Angina pectoris</strong> is acute cardiac pain due to inadequate blood flow to the myocardium, caused by plaque occlusions or coronary artery spasms. Decreased blood flow means decreased oxygen to the myocardium, resulting in pain. Pain is often described as tightness, chest pressure, and radiating down the left arm or to the neck. Angina usually lasts a few minutes and can lead to MI. Stress tests, echocardiograms, cardiac profiles, and cardiac catheterization diagnose blockages.<br><br>There are three types of angina:
                        - <strong>Classic (stable) angina:</strong> Occurs with predictable stress or exertion.
                        - <strong>Unstable (preinfarction) angina:</strong> Frequent, progressive, and unpredictable in severity, unrelated to activity. Indicates impending MI, requires immediate medical intervention.
                        - <strong>Variant (Prinzmetal, vasospastic) angina:</strong> Occurs at rest, caused by vessel spasm (vasospasm).<br>Classic and unstable angina are caused by narrowing/occlusion; variant by spasm. Patients can have both classic and variant.` },
                    { id: 'antianginal-nonpharm', title: 'Nonpharmacologic Measures for Angina', type: 'text', content: `Both pharmacologic and nonpharmacologic measures control angina. Nonpharmacologic methods include avoiding heavy meals, smoking, extreme weather changes, strenuous exercise, and emotional upset. Preventive measures include proper nutrition, moderate exercise (with provider approval), adequate rest, and relaxation techniques.` },
                    { id: 'types-antianginals', title: 'Types of Antianginal Drugs', type: 'text', content: `Antianginal drugs increase blood flow by increasing oxygen supply or decreasing oxygen demand. Three types are:
                        1. <strong>Nitrates:</strong> Reduce venous tone, decreasing heart workload, and promote vasodilation.
                        2. <strong>Beta blockers:</strong> Decrease heart workload and oxygen demand. Most useful for classic (stable) angina. *Not effective for variant (vasospastic) angina; may aggravate it.*
                        3. <strong>Calcium Channel Blockers (CCBs):</strong> Decrease heart workload and oxygen demand. Effective for both stable and variant angina.
                        <br><br>For unstable angina, immediate medical care is needed. Nitrates (sublingual/IV) are usually given first. If pain persists, an IV beta blocker may be given; if not tolerated, a CCB may be substituted.` },
                    { id: 'nitrates', title: 'Nitrates: Nitroglycerin', type: 'text', content: `<strong>Nitrates</strong> (e.g., <strong>nitroglycerin</strong>) were the first drugs for angina. They cause generalized vascular and coronary vasodilation, increasing blood flow to myocardial cells and reducing ischemia, but can cause hypotension.<br><br>
                        - <strong>Sublingual (SL) Nitroglycerin:</strong> Average 0.4 mg after cardiac pain. If pain not subsided, call 911. Effects last 30-60 minutes. Tablets decompose in heat/light; store in original, airtight, amber glass containers (often with non-childproof caps for emergency use). Patient may experience dizziness, faintness, or headache. Do not swallow SL tablets due to first-pass metabolism; absorbed rapidly via SL vessels.<br>
                        - Other forms: topical (ointment, transdermal patch), translingual, oral extended-release, aerosol spray, IV.<br>
                        - <strong>Nitroglycerin Ointment/Patch:</strong> Slow absorption through skin. Ointment effective for 4-8 hours; patch for 18-24 hours (applied once daily). Patch should be removed nightly for an 8-12 hour nitrate-free interval to avoid tolerance.<br>
                        - <strong>Side Effects:</strong> Headaches (common, may lessen with use, treat with acetaminophen), hypotension, dizziness, flushing, weakness, faintness. Taper dose over weeks when discontinuing ointment/patches to prevent rebound severe pain (myocardial ischemia). Reflex tachycardia can occur if given too rapidly.<br>
                        - <strong>Drug Interactions:</strong> Enhanced hypotensive effect with alcohol, beta blockers, CCBs, vasodilators. IV nitroglycerin may antagonize heparin.` },
                    { id: 'beta-blockers-antianginal', title: 'Beta Blockers as Antianginals', type: 'text', content: `<strong>Beta-adrenergic blockers</strong> block beta1- and beta2-receptor sites, decreasing sympathetic nervous system effects (epinephrine, norepinephrine). They reduce heart rate and blood pressure, acting as antianginals, antidysrhythmics, and antihypertensives. As antianginals, they decrease heart rate and myocardial contractility, reducing oxygen demand and anginal pain. Most useful for <strong>classic (stable) angina</strong>.<br><br>
                        - <strong>Important:</strong> Do not abruptly discontinue beta blockers; taper dose over days/weeks to avoid reflex tachycardia and anginal pain recurrence. Contraindicated in patients with decreased heart rate/BP or second-/third-degree AV block.<br>
                        - <strong>Types:</strong>
                            - <strong>Nonselective:</strong> (e.g., propranolol, nadolol) Block beta1 and beta2; decrease heart rate, can cause bronchoconstriction.
                            - <strong>Cardioselective:</strong> (e.g., atenolol, metoprolol) Primarily block beta1; decrease heart rate without bronchoconstriction. Group of choice for angina pectoris.<br>
                        - <strong>Pharmacokinetics:</strong> Well absorbed orally (sustained-release is slow). Liver metabolism for propranolol/metoprolol; atenolol excreted unchanged in feces.<br>
                        - <strong>Pharmacodynamics:</strong> Reduce myocardial contraction force, decreasing oxygen demand. Effective for classic angina.<br>
                        - <strong>Side Effects:</strong> Decrease heart rate and BP. Nonselective can cause bronchospasm, agitation, dizziness, confusion, cool extremities, erectile dysfunction. Monitor vital signs closely. Tapering discontinuance prevents rebound effects.` },
                    { id: 'calcium-channel-blockers', title: 'Calcium Channel Blockers (CCBs) as Antianginals', type: 'text', content: `<strong>Calcium Channel Blockers (CCBs)</strong>, introduced in 1982, treat stable and variant angina pectoris, certain dysrhythmias, and hypertension. Calcium activates myocardial contraction, increasing workload and oxygen need. CCBs relax coronary artery spasm (variant angina) and peripheral arterioles (stable angina), decreasing cardiac oxygen demand. They also decrease cardiac contractility (negative inotropic effect), afterload, and peripheral resistance, reducing heart workload and oxygen need.<br><br>
                        - <strong>Effective for:</strong> Variant (vasospastic) angina (by relaxing coronary arteries) and classic (stable) angina (by decreasing oxygen demand).<br>
                        - <strong>Pharmacokinetics:</strong> Verapamil, nifedipine, diltiazem are common. 80-90% GI absorbed, but significant first-pass metabolism (20-65% bioavailability). Highly protein bound (70-98%), half-lives 2-12 hours.<br>
                        - <strong>Pharmacodynamics:</strong> Bradycardia common with verapamil. Nifedipine is potent, causing vasodilation and potential hypotension. Onset 10 mins (verapamil), 30 mins (nifedipine/diltiazem). Duration 6-8 hours (oral).<br>
                        - <strong>Side Effects:</strong> Headache, hypotension (more with nifedipine), dizziness, flushing, reflex tachycardia (due to hypotension), peripheral edema. Monitor liver enzymes. Immediate-release nifedipine (10- and 20-mg capsules) linked to increased sudden cardiac death in high doses for outpatients; sustained-release forms are safer. Therefore, immediate-release nifedipine is usually for acute hospital BP increases.` },
                    { id: 'antianginal-np', title: 'Antianginals: Nursing Process', type: 'text', content: `<strong>Concept: Perfusion</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        - Obtain baseline vital signs and health/drug histories.
                        - Nitroglycerin is contraindicated for marked hypotension or AMI.<br>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Dyspnea, myocardial tissue injury, pain, decreased tissue perfusion, hypoxemia, anxiety, reduced functional ability.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient will report controlled angina pain.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        - Monitor vital signs (hypotension common).
                        - Position patient sitting/lying for first nitrate dose; monitor vitals lying, then sitting, then standing slowly.
                        - Offer sips of water before SL nitrates (dryness inhibits absorption).
                        - Monitor IV nitroglycerin effects; report persistent angina.
                        - Apply nitroglycerin ointment with tongue blade/gloves; do not touch medication.
                        - Do not apply nitroglycerin ointment/patch near defibrillator paddles (risk of explosion/burns).<br>
                        <strong>Patient Teaching:</strong>
                        - Administer SL nitroglycerin if chest pain occurs; if no relief/worsens in 5 mins, call 911.
                        - Avoid alcohol with nitroglycerin (hypotension risk).
                        - Report if chest pain not alleviated (tolerance can occur).
                        - Do not discontinue beta blockers/CCBs abruptly (withdrawal symptoms: reflex tachycardia, pain).
                        - Teach SL nitroglycerin use (under tongue, stinging indicates freshness, but newer tablets may not sting).
                        - Store SL nitrates away from light in original, amber glass, screw-cap bottle.
                        - Teach about nitroglycerin patches: apply once daily (morning), rotate sites (chest wall, thighs, arms), avoid hairy areas.
                        - Suggest acetaminophen for headache.
                        - If hypotension from SL nitroglycerin, supine position with legs elevated.
                        - Teach pulse rate check; report dizziness/faintness with beta blockers/CCBs.<br>
                        <strong>Evaluate Outcomes:</strong> Evaluate relief of anginal pain; note headache, dizziness, faintness.` },
                    { id: 'antianginal-quiz', title: 'Antianginal Drugs Quiz', type: 'quiz',
                      questions: [
                          { question: "Which type of angina is caused by vessel spasm and typically occurs at rest?", options: ["Classic angina", "Unstable angina", "Preinfarction angina", "Variant angina"], correctAnswer: "Variant angina" },
                          { question: "A nurse is teaching a patient about sublingual nitroglycerin. Which instruction is most important?", options: ["Swallow the tablet whole with a glass of water.", "Place the tablet under the tongue and allow it to dissolve.", "Chew the tablet for faster absorption.", "Store the tablets in a plastic bag in the refrigerator."], correctAnswer: "Place the tablet under the tongue and allow it to dissolve." },
                          { question: "Which antianginal drug class is generally NOT effective for variant (vasospastic) angina and may even aggravate it?", options: ["Nitrates", "Beta blockers", "Calcium channel blockers", "Alpha-adrenergic blockers"], correctAnswer: "Beta blockers" },
                          { question: "When applying a nitroglycerin transdermal patch, what is a crucial instruction the nurse should give the patient?", options: ["Apply the patch to a hairy area for better adhesion.", "Leave the patch on for 24 hours without removal.", "Remove the patch nightly to allow for a nitrate-free interval.", "Apply the patch only to the chest area."], correctAnswer: "Remove the patch nightly to allow for a nitrate-free interval." }
                      ]
                    },
                ]
            },
            'antidysrhythmic-drugs': {
                title: 'Antidysrhythmic Drugs',
                color: 'from-orange-400 to-red-500',
                description: 'Explore the classes, mechanisms, and nursing considerations for medications used to treat cardiac dysrhythmias.',
                steps: [
                    { id: 'dysrhythmias-intro', title: 'Cardiac Dysrhythmias & Action Potentials', type: 'text', content: `A <strong>cardiac dysrhythmia (arrhythmia)</strong> is any deviation from the normal heart rate or pattern (bradycardia, tachycardia, irregularity). The ECG identifies dysrhythmias: P wave (atrial activation), QRS complex (ventricular depolarization), T wave (ventricular repolarization). PR interval (AV conduction time), QT interval (ventricular action potential duration).<br><br>Atrial dysrhythmias decrease cardiac output by 33%. Ventricular dysrhythmias are life-threatening, causing decreased/absent cardiac output. Ventricular tachycardia can lead to ventricular fibrillation and death, requiring CPR.<br><br>Dysrhythmias often follow MI, or result from hypoxia, hypercapnia, thyroid disease, CAD, cardiac surgery, excess catecholamines, or electrolyte imbalance.<br><br><strong>Cardiac Action Potentials:</strong> Electrolyte transfer across cardiac muscle cell membranes. Sodium and calcium influx cause depolarization (contraction). Sodium enters rapidly, calcium later to maintain it, leading to intracellular calcium release and contraction. Myocardial ischemia can cause irregular contraction.<br><br>Action potential phases (ventricular myocyte):
                        - <strong>Phase 0:</strong> Rapid depolarization (sodium influx).
                        - <strong>Phase 1:</strong> Initial repolarization (sodium influx termination).
                        - <strong>Phase 2:</strong> Plateau (calcium influx, prolongs action potential, promotes contraction).
                        - <strong>Phase 3:</strong> Rapid repolarization (potassium influx).
                        - <strong>Phase 4:</strong> Resting membrane potential (flat in ventricular muscle, slowly depolarizes in SA node to initiate next beat).` },
                    { id: 'antidysrhythmic-types', title: 'Types & Classes of Antidysrhythmic Drugs', type: 'text', content: `The goal of <strong>antidysrhythmic (antiarrhythmic) drugs</strong> is to restore normal cardiac rhythm. They are <strong>high-alert drugs</strong>.<br><br>Mechanisms of action:
                        - Block adrenergic stimulation of the heart.
                        - Depress myocardial excitability and contractility.
                        - Decrease conduction velocity in cardiac tissue.
                        - Increase recovery time (repolarization) of the myocardium.
                        - Suppress automaticity (spontaneous depolarization).<br><br>Antidysrhythmics are grouped into four classes:
                        1.  <strong>Class I: Sodium (fast) channel blockers</strong> (IA, IB, IC)
                            - IA (e.g., quinidine, procainamide): Slow conduction, prolong repolarization.
                            - IB (e.g., lidocaine, mexiletine): Slow conduction, shorten repolarization. Lidocaine treats acute ventricular dysrhythmias.
                            - IC (e.g., flecainide): Prolong conduction, little effect on repolarization.
                        2.  <strong>Class II: Beta blockers</strong> (e.g., propranolol, acebutolol, esmolol, sotalol)
                            - Decrease conduction velocity, automaticity, and refractory period. More common for dysrhythmias than Class I. Gradual dose reduction on discontinuation.
                        3.  <strong>Class III: Drugs that prolong repolarization</strong> (e.g., amiodarone, adenosine, dofetilide, ibutilide, sotalol)
                            - Used in emergencies for ventricular dysrhythmias when others fail. Amiodarone increases refractory period and prolongs action potential.
                        4.  <strong>Class IV: Calcium (slow) channel blockers</strong> (e.g., verapamil, diltiazem)
                            - Block calcium influx, decreasing excitability and contractility. Increase refractory period of AV node, decreasing ventricular response. Verapamil contraindicated in AV block or HF.<br><br>
                        All antidysrhythmic drugs are potentially <strong>prodysrhythmic</strong>; they can cause life-threatening ventricular dysrhythmias due to drug activity on the heart and the unpredictability of a diseased heart. Therapy is often initiated with continuous cardiac monitoring in a hospital setting.` },
                    { id: 'antidysrhythmic-np', title: 'Antidysrhythmics: Nursing Process', type: 'text', content: `<strong>Concept: Perfusion</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        - Obtain health and drug histories (SOB, palpitations, chest pain, previous angina/dysrhythmias, current meds).
                        - Obtain baseline vital signs and ECG.
                        - Monitor early cardiac enzyme results (AST, LDH, CPK) and cardiac-specific troponins.<br>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Decreased gas exchange, dysrhythmia, decreased tissue perfusion, hypoxemia, anxiety.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient will be in normal sinus rhythm and comply with drug regimen.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        - Monitor vital signs (hypotension can occur).
                        - Administer IV push/bolus drugs over 2-3 minutes or as prescribed.
                        - Monitor ECG for abnormal patterns (PVCs, increased PR/QT intervals, widening QRS complex); increased QT interval is risk for torsades de pointes.<br>
                        <strong>Patient Teaching:</strong>
                        - Take prescribed drugs as ordered (compliance is essential).
                        - Provide specific instructions for each drug (e.g., photosensitivity for amiodarone).
                        - Report side effects/adverse reactions (dizziness, faintness, nausea, vomiting).
                        - Avoid alcohol (intensifies hypotension), caffeine (increases catecholamines), tobacco (promotes vasoconstriction).<br>
                        <strong>Evaluate Outcomes:</strong> Evaluate effectiveness by comparing heart rates to baseline and assessing patient response. Report side effects/adverse reactions; drug regimen may need adjustment, or drug-induced dysrhythmias may require discontinuation.` },
                    { id: 'critical-thinking-case-study', title: 'Critical Thinking Case Study', type: 'case_study', case: {
                        scenario: `A 64-year-old female patient with a diagnosis of heart failure has been admitted to the emergency department. Her medication profile includes furosemide 20 mg/d, digoxin 0.25 mg/d, and potassium chloride (KCl) 20 mEq/d. The patient has experienced three days of flulike symptoms, including anorexia, nausea, vomiting, and diarrhea. Her fluid and food intake are diminished, and she refused to take the KCl, stating, “This drug makes me sick.” The nurse’s assessment includes:
                            • Normal skin turgor
                            • Complaints of stress
                            • Muscle weakness
                            • Pulse rate 90 beats per minute (bpm), irregular
                            • Hypoactive bowel sounds
                            • Complaints of feeling lightheaded
                            • Pedal pulses strong and palpable
                            • Patient alert and oriented`,
                        question: `Which nursing actions are required related to the client’s condition and prescribed pain medication? Choose the most likely options for the information missing from the statements below by selecting from the lists of options provided.
                            The nurse will continue to monitor the patient’s ______(A)_______ and assess the depth and rate of the patient’s ______(A)______. Instruct the patient to report signs and symptoms of ________(A)________, _________(A)________, and ________(A)________. Monitor and observe for changes in the patient’s _______(B)________. The nurse will withhold pain medication for any difficulty in the patient’s _______(B)_______ and respirations below ______(B)_______. Instruct the patient to notify the nurse immediately upon return or increase of the patient’s _______(B)_______.`,
                        options: [
                            "Option A: tinnitus", "Option A: dizziness", "Option A: vital signs", "Option A: sore throat", "Option A: respirations", "Option A: constipation", "Option A: hypotension", "Option A: feeling of fullness",
                            "Option B: dry skin", "Option B: breathing", "Option B: pedal edema", "Option B: mental status", "Option B: abdominal pain", "Option B: episodes of sneezing", "Option B: 12 breaths per minute", "Option B: 20 breaths per minute"
                        ],
                        correctAnswer: [
                            "Option A: vital signs", "Option A: respirations", "Option A: dizziness", "Option A: constipation", "Option A: hypotension",
                            "Option B: mental status", "Option B: breathing", "Option B: 12 breaths per minute", "Option B: abdominal pain"
                        ],
                        explanation: `<strong>Rationale:</strong> This case study is adapted from a different chapter and some of the original answers related to pain medication are not directly relevant. However, applying the principles of Chapter 40 regarding cardiac glycosides and their side effects:
                            The nurse will continue to monitor the patient’s <strong>vital signs</strong> and assess the depth and rate of the patient’s <strong>respirations</strong>. Instruct the patient to report signs and symptoms of <strong>dizziness</strong>, <strong>constipation</strong>, and <strong>hypotension</strong>. Monitor and observe for changes in the patient’s <strong>mental status</strong>. The nurse will withhold pain medication (if it were an opioid, for instance) for any difficulty in the patient’s <strong>breathing</strong> and respirations below <strong>12 breaths per minute</strong>. Instruct the patient to notify the nurse immediately upon return or increase of the patient’s <strong>abdominal pain</strong>.
                            Specifically, for digoxin:
                            The patient has refused potassium, leading to likely hypokalemia. Digoxin toxicity can manifest with GI symptoms (anorexia, nausea, vomiting, diarrhea), neurological symptoms (lightheadedness, confusion - impacting mental status), and cardiac effects (bradycardia, irregular pulse, muscle weakness). Monitoring vital signs, particularly pulse rate and rhythm, and respirations, is crucial. Hypotension and dizziness are common side effects to monitor. Constipation is also a known side effect of digoxin. Abdominal pain is relevant due to the patient's history of flulike GI symptoms. Respirations below 12 breaths/min indicate respiratory depression, a critical finding, especially with medications affecting CNS or cardiac function.
                            `
                    }},
                    { id: 'antidysrhythmic-quiz', title: 'Antidysrhythmics Quiz', type: 'quiz',
                      questions: [
                          { question: "Which phase of the cardiac action potential is characterized by the rapid influx of sodium ions, causing depolarization?", options: ["Phase 0", "Phase 1", "Phase 2", "Phase 3"], correctAnswer: "Phase 0" },
                          { question: "A patient is prescribed a Class II antidysrhythmic drug. Which of the following is a key action of this class?", options: ["Prolonging repolarization", "Blocking calcium influx", "Slowing conduction and shortening repolarization", "Decreasing conduction velocity and automaticity"], correctAnswer: "Decreasing conduction velocity and automaticity" },
                          { question: "Why are all antidysrhythmic drugs considered potentially prodysrhythmic?", options: ["They always cause severe hypotension.", "They can cause life-threatening ventricular dysrhythmias.", "They only work for a short duration.", "They are difficult to metabolize."], correctAnswer: "They can cause life-threatening ventricular dysrhythmias." },
                          { question: "A nurse is teaching a patient taking amiodarone. Which instruction is important to include?", options: ["Increase caffeine intake.", "Avoid exposure to sunlight.", "Discontinue the medication if you experience dizziness.", "Take with antacids for better absorption."], correctAnswer: "Avoid exposure to sunlight." }
                      ]
                    },
                ]
            },
            'chapter-review': {
                title: 'Chapter Review & NCLEX Questions',
                color: 'from-blue-600 to-indigo-800',
                description: 'Integrate knowledge and practice NCLEX-style review questions for Chapter 40.',
                steps: [
                    { id: 'chapter-review-quiz', title: 'Review Questions', type: 'quiz',
                      questions: [
                          { question: "The patient is receiving digoxin for treatment of heart failure. Which finding would suggest to the nurse that the heart failure is improving?", options: ["Pale and cool extremities", "Absence of peripheral edema", "Urine output of 60 mL every 4 hours", "Complaints of increasing dyspnea"], correctAnswer: "Absence of peripheral edema" },
                          { question: "The patient’s serum digoxin level is 3.0 ng/mL. What does the nurse know about this serum digoxin level?", options: ["It is in the high (elevated) range.", "It is in the low (decreased) range.", "It is within the normal range.", "It is in the low-average range."], correctAnswer: "It is in the high (elevated) range." },
                          { question: "The nurse is assessing a patient for possible evidence of digitalis toxicity. Which of these is included in the signs and symptoms for digitalis toxicity?", options: ["Apical pulse rate of 100 beats/min", "Apical pulse of 72 beats/min with an irregular rate", "Apical pulse of 90 beats/min with an irregular rate", "Apical pulse of 48 beats/min with an irregular rate"], correctAnswer: "Apical pulse of 48 beats/min with an irregular rate" },
                          { question: "A patient is taking a potassium-depleting diuretic and digoxin. The nurse expects that a low potassium level (hypokalemia) could have what effect on digoxin?", options: ["Increases serum digoxin sensitivity level", "Decreases serum digoxin sensitivity level", "No effect on serum digoxin sensitivity level", "Causes a low-average serum digoxin sensitivity level"], correctAnswer: "Increases serum digoxin sensitivity level" },
                          { question: "A patient takes an initial dose of a nitrate. Which symptom(s) will the nurse expect to occur?", options: ["Nausea and vomiting", "Headaches", "Stomach cramps", "Irregular pulse rate"], correctAnswer: "Headaches" },
                          { question: "A patient is prescribed a beta blocker. Beta blockers are as effective as antianginals because they do what?", options: ["Increase oxygen to the systemic circulation", "Maintain heart rate and blood pressure", "Decrease heart rate and decrease myocardial contractility", "Decrease heart rate and increase myocardial contractility"], correctAnswer: "Decrease heart rate and decrease myocardial contractility" },
                          { question: "The health care provider is planning to discontinue a patient’s beta blocker. Which instruction will the nurse give the patient regarding the beta blocker?", options: ["The beta blocker should be abruptly stopped when another cardiac drug is prescribed.", "The beta blocker should not be abruptly stopped; the dose should be tapered down.", "The beta blocker dose should be maintained while taking another antianginal drug.", "Half the beta blocker dose should be taken for the next several weeks."], correctAnswer: "The beta blocker should not be abruptly stopped; the dose should be tapered down." },
                          { question: "The beta blocker acebutolol is prescribed for dysrhythmias. What is the primary purpose of the drug?", options: ["Increase beta1 and beta2 receptors in cardiac tissues", "Increase the flow of oxygen to cardiac tissues", "Block beta1-adrenergic receptors in cardiac tissues", "Block beta2-adrenergic receptors in cardiac tissues"], correctAnswer: "Block beta1-adrenergic receptors in cardiac tissues" },
                          { question: "A patient who has angina is prescribed nitroglycerin. Which are appropriate nursing interventions for nitroglycerin? (Select all that apply.)", options: ["Have the patient sit or lie down when taking a nitroglycerin sublingual tablet.", "Teach the patient who has taken nitroglycerin to call 911 if chest pain persists.", "Apply the nitroglycerin patch to a hairy area to protect skin from burning.", "Call the health care provider after taking five tablets if chest pain persists.", "Warn the patient against ingesting alcohol while taking nitroglycerin.", "Advise the patient not to drink water before taking nitroglycerin."], correctAnswer: ["Have the patient sit or lie down when taking a nitroglycerin sublingual tablet.", "Teach the patient who has taken nitroglycerin to call 911 if chest pain persists.", "Warn the patient against ingesting alcohol while taking nitroglycerin."] }
                      ]
                    },
                ]
            }
        };

        // The pre-assessment quiz data now includes questions for all new modules.
        const preAssessmentQuizData = [
            // Questions for Module 1: Introduction to Cardiovascular System
            { moduleId: 'introduction-cardio', question: "Which part of the heart is responsible for pumping oxygenated blood to the systemic circulation?", options: ["Right atrium", "Right ventricle", "Left atrium", "Left ventricle"], correctAnswer: "Left ventricle" },
            { moduleId: 'introduction-cardio', question: "What is the primary pacemaker of the heart?", options: ["Atrioventricular (AV) node", "Bundle of His", "Purkinje fibers", "Sinoatrial (SA) node"], correctAnswer: "Sinoatrial (SA) node" },
            { moduleId: 'introduction-cardio', question: "Which of the following factors is NOT one of the three determinants of stroke volume?", options: ["Preload", "Afterload", "Heart Rate", "Contractility"], correctAnswer: "Heart Rate" },
            { moduleId: 'introduction-cardio', question: "Deoxygenated blood is carried from the right ventricle to the lungs by which vessel?", options: ["Aorta", "Pulmonary artery", "Pulmonary vein", "Superior vena cava"], correctAnswer: "Pulmonary artery" },

            // Questions for Module 2: Heart Failure: Diagnosis & Nonpharmacologic Measures
            { moduleId: 'heart-failure-management', question: "Which laboratory test is primarily used to differentiate dyspnea due to heart failure from dyspnea due to lung dysfunction?", options: ["Atrial Natriuretic Hormone (ANH)", "Brain Natriuretic Peptide (BNP)", "Creatinine", "Electrolyte panel"], correctAnswer: "Brain Natriuretic Peptide (BNP)" },
            { moduleId: 'heart-failure-management', question: "A nurse is teaching a patient with heart failure about nonpharmacologic measures. Which recommendation should the nurse include?", options: ["Increase salt intake to improve fluid balance.", "Engage in strenuous exercise daily.", "Limit fluid intake as advised by the healthcare provider.", "Smoke in moderation to reduce stress."], correctAnswer: "Limit fluid intake as advised by the healthcare provider." },

            // Questions for Module 3: Cardiac Glycosides: Digoxin
            { moduleId: 'cardiac-glycosides', question: "Which of the following is a primary effect of cardiac glycosides like digoxin on the heart muscle?", options: ["Negative inotropic action", "Positive chronotropic action", "Positive dromotropic action", "Increased myocardial contraction"], correctAnswer: "Increased myocardial contraction" },
            { moduleId: 'cardiac-glycosides', question: "A patient receiving digoxin reports seeing yellow halos around lights and has a pulse rate of 52 bpm. The nurse suspects digitalis toxicity. Which of the following is the antidote?", options: ["Naloxone", "Protamine sulfate", "Digoxin-immune Fab", "Vitamin K"], correctAnswer: "Digoxin-immune Fab" },
            { moduleId: 'cardiac-glycosides', question: "What is the desired therapeutic serum level of digoxin for a patient being treated for heart failure?", options: ["0.2-0.8 ng/mL", "0.5-1.0 ng/mL", "1.5-2.5 ng/mL", "2.0-3.0 ng/mL"], correctAnswer: "0.5-1.0 ng/mL" },
            { moduleId: 'cardiac-glycosides', question: "Which electrolyte imbalance significantly increases a patient's risk for digoxin toxicity?", options: ["Hyperkalemia", "Hypocalcemia", "Hypokalemia", "Hypernatremia"], correctAnswer: "Hypokalemia" },

            // Questions for Module 4: Other Agents for Heart Failure
            { moduleId: 'other-hf-agents', question: "Which of the following adverse effects is a significant concern when administering phosphodiesterase inhibitors like milrinone lactate?", options: ["Bradycardia", "Severe cardiac dysrhythmias", "Hypertension", "Hyperglycemia"], correctAnswer: "Severe cardiac dysrhythmias" },
            { moduleId: 'other-hf-agents', question: "A patient with heart failure is prescribed spironolactone. The nurse understands that this medication helps by:", options: ["Increasing aldosterone production.", "Promoting potassium loss.", "Blocking aldosterone production.", "Increasing fluid retention."], correctAnswer: "Blocking aldosterone production." },
            { moduleId: 'other-hf-agents', question: "Which newer medication for heart failure is a guanylate cyclase stimulant and requires a negative pregnancy test for females of childbearing age?", options: ["Milrinone", "Nesiritide", "Hydralazine-isosorbide dinitrate combination", "Vericiguat"], correctAnswer: "Vericiguat" },

            // Questions for Module 5: Antianginal Drugs
            { moduleId: 'antianginal-drugs', question: "Which type of angina is caused by vessel spasm and typically occurs at rest?", options: ["Classic angina", "Unstable angina", "Preinfarction angina", "Variant angina"], correctAnswer: "Variant angina" },
            { moduleId: 'antianginal-drugs', question: "A nurse is teaching a patient about sublingual nitroglycerin. Which instruction is most important?", options: ["Swallow the tablet whole with a glass of water.", "Place the tablet under the tongue and allow it to dissolve.", "Chew the tablet for faster absorption.", "Store the tablets in a plastic bag in the refrigerator."], correctAnswer: "Place the tablet under the tongue and allow it to dissolve." },
            { moduleId: 'antianginal-drugs', question: "Which antianginal drug class is generally NOT effective for variant (vasospastic) angina and may even aggravate it?", options: ["Nitrates", "Beta blockers", "Calcium channel blockers", "Alpha-adrenergic blockers"], correctAnswer: "Beta blockers" },
            { moduleId: 'antianginal-drugs', question: "When applying a nitroglycerin transdermal patch, what is a crucial instruction the nurse should give the patient?", options: ["Apply the patch to a hairy area for better adhesion.", "Leave the patch on for 24 hours without removal.", "Remove the patch nightly to allow for a nitrate-free interval.", "Apply the patch only to the chest area."], correctAnswer: "Remove the patch nightly to allow for a nitrate-free interval." },

            // Questions for Module 6: Antidysrhythmic Drugs
            { moduleId: 'antidysrhythmic-drugs', question: "Which phase of the cardiac action potential is characterized by the rapid influx of sodium ions, causing depolarization?", options: ["Phase 0", "Phase 1", "Phase 2", "Phase 3"], correctAnswer: "Phase 0" },
            { moduleId: 'antidysrhythmic-drugs', question: "A patient is prescribed a Class II antidysrhythmic drug. Which of the following is a key action of this class?", options: ["Prolonging repolarization", "Blocking calcium influx", "Slowing conduction and shortening repolarization", "Decreasing conduction velocity and automaticity"], correctAnswer: "Decreasing conduction velocity and automaticity" },
            { moduleId: 'antidysrhythmic-drugs', question: "Why are all antidysrhythmic drugs considered potentially prodysrhythmic?", options: ["They always cause severe hypotension.", "They can cause life-threatening ventricular dysrhythmias.", "They only work for a short duration.", "They are difficult to metabolize."], correctAnswer: "They can cause life-threatening ventricular dysrhythmias." },
            { moduleId: 'antidysrhythmic-drugs', question: "A nurse is teaching a patient taking amiodarone. Which instruction is important to include?", options: ["Increase caffeine intake.", "Avoid exposure to sunlight.", "Discontinue the medication if you experience dizziness.", "Take with antacids for better absorption."], correctAnswer: "Avoid exposure to sunlight." },

            // Questions for Module 7: Chapter Review & NCLEX Questions (These are also in the post-module quiz, but included here for a comprehensive pre-assessment)
            { moduleId: 'chapter-review', question: "The patient is receiving digoxin for treatment of heart failure. Which finding would suggest to the nurse that the heart failure is improving?", options: ["Pale and cool extremities", "Absence of peripheral edema", "Urine output of 60 mL every 4 hours", "Complaints of increasing dyspnea"], correctAnswer: "Absence of peripheral edema" },
            { moduleId: 'chapter-review', question: "The patient’s serum digoxin level is 3.0 ng/mL. What does the nurse know about this serum digoxin level?", options: ["It is in the high (elevated) range.", "It is in the low (decreased) range.", "It is within the normal range.", "It is in the low-average range."], correctAnswer: "It is in the high (elevated) range." },
            { moduleId: 'chapter-review', question: "The nurse is assessing a patient for possible evidence of digitalis toxicity. Which of these is included in the signs and symptoms for digitalis toxicity?", options: ["Apical pulse rate of 100 beats/min", "Apical pulse of 72 beats/min with an irregular rate", "Apical pulse of 90 beats/min with an irregular rate", "Apical pulse of 48 beats/min with an irregular rate"], correctAnswer: "Apical pulse of 48 beats/min with an irregular rate" },
            { moduleId: 'chapter-review', question: "A patient is taking a potassium-depleting diuretic and digoxin. The nurse expects that a low potassium level (hypokalemia) could have what effect on digoxin?", options: ["Increases serum digoxin sensitivity level", "Decreases serum digoxin sensitivity level", "No effect on serum digoxin sensitivity level", "Causes a low-average serum digoxin sensitivity level"], correctAnswer: "Increases serum digoxin sensitivity level" },
            { moduleId: 'chapter-review', question: "A patient takes an initial dose of a nitrate. Which symptom(s) will the nurse expect to occur?", options: ["Nausea and vomiting", "Headaches", "Stomach cramps", "Irregular pulse rate"], correctAnswer: "Headaches" },
            { moduleId: 'chapter-review', question: "A patient is prescribed a beta blocker. Beta blockers are as effective as antianginals because they do what?", options: ["Increase oxygen to the systemic circulation", "Maintain heart rate and blood pressure", "Decrease heart rate and decrease myocardial contractility", "Decrease heart rate and increase myocardial contractility"], correctAnswer: "Decrease heart rate and decrease myocardial contractility" },
            { moduleId: 'chapter-review', question: "The health care provider is planning to discontinue a patient’s beta blocker. Which instruction will the nurse give the patient regarding the beta blocker?", options: ["The beta blocker should be abruptly stopped when another cardiac drug is prescribed.", "The beta blocker should not be abruptly stopped; the dose should be tapered down.", "The beta blocker dose should be maintained while taking another antianginal drug.", "Half the beta blocker dose should be taken for the next several weeks."], correctAnswer: "The beta blocker should not be abruptly stopped; the dose should be tapered down." },
            { moduleId: 'chapter-review', question: "The beta blocker acebutolol is prescribed for dysrhythmias. What is the primary purpose of the drug?", options: ["Increase beta1 and beta2 receptors in cardiac tissues", "Increase the flow of oxygen to cardiac tissues", "Block beta1-adrenergic receptors in cardiac tissues", "Block beta2-adrenergic receptors in cardiac tissues"], correctAnswer: "Block beta1-adrenergic receptors in cardiac tissues" },
            { moduleId: 'chapter-review', question: "A patient who has angina is prescribed nitroglycerin. Which are appropriate nursing interventions for nitroglycerin? (Select all that apply.)", options: ["Have the patient sit or lie down when taking a nitroglycerin sublingual tablet.", "Teach the patient who has taken nitroglycerin to call 911 if chest pain persists.", "Apply the nitroglycerin patch to a hairy area to protect skin from burning.", "Call the health care provider after taking five tablets if chest pain persists.", "Warn the patient against ingesting alcohol while taking nitroglycerin.", "Advise the patient not to drink water before taking nitroglycerin."], correctAnswer: ["Have the patient sit or lie down when taking a nitroglycerin sublingual tablet.", "Teach the patient who has taken nitroglycerin to call 911 if chest pain persists.", "Warn the patient against ingesting alcohol while taking nitroglycerin."] }
        ];

        // --- Helper Functions ---
        // Utility for conditionally joining Tailwind CSS classes.
        const cn = (...classes) => classes.filter(Boolean).join(' ');


        // --- Child Components ---

        /**
         * Quiz component for interactive multiple-choice questions.
         * Users answer questions and receive immediate feedback.
         */
        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState([]); // Changed to array for multi-select
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            // Handle option selection for both single and multiple choice
            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return; // Prevent changing answer after feedback in regular quiz

                if (Array.isArray(currentQuestion.correctAnswer)) {
                    // Multi-select (SATA)
                    setSelectedOption(prevSelected => {
                        if (prevSelected.includes(option)) {
                            return prevSelected.filter(item => item !== option);
                        } else {
                            return [...prevSelected, option];
                        }
                    });
                } else {
                    // Single select
                    setSelectedOption(option);
                }
            };

            const handlePreAssessmentNext = () => {
                if (selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)) return;
                
                // Logic for checking correctness for both single and multi-select
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                
                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption([]); // Reset for next question
                    setFeedback(null);
                } else {
                    onComplete(updatedAnswers);
                }
            };
            
            const handleRegularQuizSubmit = () => {
                if (selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)) return;
                
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                
                setFeedback(isCorrect ? 'correct' : 'incorrect');
            };

            const handleRegularQuizNext = () => {
                // Ensure the current answer is recorded before moving to the next question
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const finalAnswers = [...answers, { question: currentQuestion, isCorrect }];
                
                if (currentQuestionIndex < questions.length - 1) {
                    setAnswers(finalAnswers);
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption([]); // Reset for next question
                    setFeedback(null);
                } else {
                    const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-3">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = Array.isArray(selectedOption) ? selectedOption.includes(option) : selectedOption === option;
                            const isCorrectOption = Array.isArray(currentQuestion.correctAnswer)
                                ? currentQuestion.correctAnswer.includes(option)
                                : option.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';

                            if (feedback && !isPreAssessment) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : <span className="text-red-600 mr-2">✗</span>
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 text-center">
                        {isPreAssessment ? (
                             <button
                                 onClick={handlePreAssessmentNext}
                                 disabled={selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)}
                                 className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                            </button>
                        ) : (
                            <>
                            {!feedback ? (
                                <button
                                    onClick={handleRegularQuizSubmit}
                                    disabled={selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Submit Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleRegularQuizNext}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Next Question
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        /**
         * PreAssessmentQuiz component to handle the initial diagnostic quiz.
         * Displays quiz questions and then results, allowing users to "test out" of modules.
         */
        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    // For pre-assessment, a module is "completed" if all its questions in the pre-assessment quiz were answered correctly.
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-6">
                                You correctly answered {results.correct} out of {results.total} questions.
                            </p>
                            {results.completedModules.length > 0 ? (
                                <>
                                    <p className="text-green-600 font-semibold mb-4">You've tested out of the following modules:</p>
                                    <ul className="list-disc list-inside text-left mb-6 bg-green-50 p-4 rounded-lg">
                                        {results.completedModules.map(id => <li key={id}>{contentData[id].title}</li>)}
                                    </ul>
                                </>
                            ) : (
                                <p className="text-yellow-600 font-semibold mb-6">You haven't tested out of any modules. You can proceed to the main modules for learning.</p>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                            >
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Diagnostic Quiz</h2>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };


        /**
         * Dashboard component to display the available learning modules.
         * It allows users to select a module to start learning.
         * Shows progress for each module using a circular progress bar and status.
         */
        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            // Calculate overall progress and gather quiz scores
            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });


            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <div className="w-full">
                        <header className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                {/* Text placeholder for the main application identifier */}
                                <span className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">CVM</span>
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Cardiovascular Pharmacology Module</h1>
                                <span className="bg-gray-200 text-gray-600 text-xs font-mono px-2.5 py-1 rounded-full">V:1.0</span>
                            </div>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">Master the pharmacology of cardiac glycosides, antianginals, and antidysrhythmics through interactive modules and NCLEX-style assessments.</p>
                        </header>

                        {/* Skip Ahead Button */}
                        <div className="mb-8 text-center">
                            <button
                                onClick={onStartPreAssessment}
                                className="w-full max-w-md mx-auto px-6 py-4 bg-teal-500 text-white font-bold rounded-lg shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105"
                            >
                                <div className="text-xl">Skip Ahead: Take Diagnostic Quiz</div>
                                <div className="text-sm font-normal">Test your knowledge and potentially skip modules.</div>
                            </button>
                        </div>

                        {/* Overall Progress Bar & Reset Button */}
                        <div className="mb-8 bg-white rounded-2xl shadow-lg p-6 w-full">
                           <div className="flex justify-between items-center mb-3">
                             <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
                             <button 
                                 onClick={onResetProgress}
                                 className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2"
                             >
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                     <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" />
                                 </svg>
                                 Reset Progress
                             </button>
                           </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallPercentage}%` }}
                                ></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-left text-sm text-gray-600 mt-2">
                                    {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
                                </p>
                                <p className="text-right text-sm text-gray-600 mt-2">{Math.round(overallPercentage)}% Completed</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                            {/* Iterate over all modules defined in contentData */}
                            {Object.entries(contentData).map(([id, module]) => {
                                const moduleProgress = progress[id] || {};
                                // Calculate completion count for steps within the module.
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-green-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                // Get quiz score for this module if available
                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        // Styling for module cards, including hover effects.
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            {/* Placeholder for module icon: Displays the first letter of the module title. */}
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-10 h-10 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.title.split(' ').map(word => word.charAt(0)).join('')}
                                            </div>
                                            {/* Progress Circle */}
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    {/* Background circle for the progress bar. */}
                                                    <path
                                                        className="text-gray-200"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                    />
                                                    {/* Foreground arc representing the completion percentage. */}
                                                    <path
                                                        className="text-indigo-500"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                        strokeDasharray={`${percentage}, 100`}
                                                        strokeLinecap="round"
                                                        transform="rotate(-90 18 18)"
                                                    />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10">{module.description}</p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * CaseStudy component for a multiple-choice case study challenge.
         * Presents a scenario and a question with multiple options.
         */
        const CaseStudy = ({ caseData, onComplete }) => {
            // State to store the user's selected answer.
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            // Handles the selection of an answer option.
            const handleSelect = (option) => {
                if (selectedAnswer) return; // Prevents changing the answer once selected.
                setSelectedAnswer(option);
                // Case-insensitive comparison needs to check if the 'option' matches any of the correct answers.
                // For the case study, the correct answers are an array in the data.
                const isCorrect = Array.isArray(caseData.correctAnswer)
                    ? caseData.correctAnswer.includes(option)
                    : option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                
                if (isCorrect) {
                    onComplete(); // Marks the step as complete if the correct answer is chosen.
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Case Study Challenge</h4>
                    {/* Scenario description, using dangerouslySetInnerHTML to render HTML bold tags */}
                    <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-3">{caseData.question}</p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrectOption = Array.isArray(caseData.correctAnswer)
                                ? caseData.correctAnswer.includes(option)
                                : option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                            const showFeedback = selectedAnswer !== null; // Show feedback once any answer is selected 

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling for options.
                            if (showFeedback) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown 
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red 
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission 
                            } 

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {showFeedback && ( // Display a checkmark or cross icon if feedback is active 
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedAnswer && ( // Display the explanation after an answer has been selected.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * VitalsCheck component for an interactive question about vital signs.
         * This component is not used in the Analgesics module, but kept for completeness if needed in other modules.
         */
        const VitalsCheck = ({ onComplete }) => {
            // State to store the user's selected vital sign.
            const [selectedVital, setSelectedVital] = useState(null);
            const vitals = { "BP": "100/68 mmHg", "HR": "110 bpm", "RR": "24/min", "Temp": "99°F" };
            const mostConcerning = "HR"; // The correct answer.
            const explanation = "A heart rate of 110 bpm (tachycardia) is a significant sign of distress. It indicates the heart is working hard to compensate for poor perfusion, which is common during an acute myocardial infarction.";

            // Handles the selection of a vital sign option.
            const handleSelect = (vital) => {
                if(selectedVital) return; // Prevents changing the selection once made.
                setSelectedVital(vital);
                // Case-insensitive comparison (though keys are already consistent)
                if (vital.toLowerCase() === mostConcerning.toLowerCase()) {
                    onComplete(); // Mark step as complete if correct answer is chosen 
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Vitals Check</h4>
                    <p className="text-sm text-gray-600 mb-4">A patient presents with chest pain. Based on these vital signs, which one is the MOST concerning indicator of impaired central perfusion?</p>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {Object.entries(vitals).map(([key, value]) => {
                            const isSelected = selectedVital === key;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrect = key.toLowerCase() === mostConcerning.toLowerCase();
                            const showFeedback = selectedVital !== null; // Show feedback once any vital is selected 

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling.
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown 
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red 
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission 
                            } 
                            return (
                                <div key={key} onClick={() => handleSelect(key)} className={cn('p-4 rounded-lg border-2 cursor-pointer text-center', optionClass)}>
                                    <div className="text-sm font-bold text-gray-500">{key}</div>
                                    <div className="text-xl font-semibold text-gray-800">{value}</div>
                                </div>
                            );
                        })}
                    </div>
                   {selectedVital && ( // Display the rationale after a selection is made.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Rationale</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * StaticContentStep component for displaying basic text content.
         * Marks itself as complete immediately on render.
         */
        const StaticContentStep = ({ step, onComplete }) => {
            // For 'text' type steps, mark them as complete immediately upon rendering.
            // The effect should only run once when the component mounts to prevent an infinite loop.
            useEffect(() => {
                onComplete();
            }, []); // Empty dependency array ensures this runs only once.

            // Using dangerouslySetInnerHTML to render HTML content (e.g., <strong> tags).
            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg shadow-inner space-y-4" dangerouslySetInnerHTML={{ __html: step.content }}>
                </div>
            );
        };

        /**
         * CompletionModal component displayed when a module is completed.
         */
        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
                        <h3 className="text-2xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors shadow-sm"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * LearningModule component to manage steps within the selected module.
         * Provides navigation between steps and renders the appropriate content for each.
         */
        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0); // Manages the index of the currently active step.
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Controls the visibility of the sidebar on mobile.
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false); // State for completion modal 

            // Callback function to update the completion status of a specific step.
            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            
            // Check if all steps in the current module are completed
            const allStepsCompletedInModule = module.steps.every(step =>
                moduleProgress[step.id] && moduleProgress[step.id].completed
            );

            // Navigates to the next step, if available.
            const handleNextStep = () => {
                // If it's the last step and all steps in the module are completed, open the modal 
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            // Navigates to the previous step, if available.
            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };
            
            // Ensure module and its steps are defined before accessing properties 
            if (!module || !module.steps) {
                console.error("LearningModule received invalid module prop:", module);
                return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Loading module...</div>;
            }

            const currentStep = module.steps[activeStep];
            
            // Renders the appropriate content component based on the current step's type.
            // This function acts as a router for different interactive and static content types.
            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;

                const onCompleteForStep = (data) => handleStepComplete(step.id, data);

                switch (step.type) {
                    case 'text':
                        return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'interactive_vitals':
                        return <VitalsCheck key={step.id} onComplete={onCompleteForStep} />;
                    case 'case_study':
                        return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz':
                        return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default:
                        // Fallback for unrecognized step types, ensuring robust error handling.
                        return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack(); // Go back to dashboard when modal is closed 
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule(); // Proceed to next module 
            };


            return (
                <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
                    {/* Header for the learning module, including back button and module title. */}
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        </div>
                        {/* Mobile sidebar toggle button using text/emoji placeholders. */}
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar for navigation steps within the module. */}
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false); // Close sidebar on mobile after a step is selected.
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        {/* Step completion indicator */}
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        {/* Main content area for the current step. */}
                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                {/* Navigation buttons for moving between steps. */}
                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };
        
        // --- Main App Component ---
        /**
         * The root component of the Analgesics Learning Module application.
         * Manages overall application state, including module selection, user ID, and progress.
         */
        function App() {
            // State for the currently selected learning module's ID. Null means Dashboard is active.
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            // State for the authenticated user's ID, used for local storage progress tracking.
            const [userId, setUserId] = useState(null);
            // State for storing the user's progress across all modules and steps.
            const [progress, setProgress] = useState({});
            // State to indicate if authentication is complete and user ID is available.
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Effect hook for handling initial authentication and setting the user ID.
            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true); // Mark authentication as ready once user is determined.
                });
                return () => unsubscribe(); // Cleanup the auth state listener on component unmount.
            }, []); // Empty dependency array ensures this runs only once on mount.

            // Effect hook for loading user progress from localStorage after authentication is ready.
            useEffect(() => {
                if (!isAuthReady || !userId) return; // Only proceed if auth is ready and userId is available.
                const storedProgress = localStorage.getItem(`cardiac-module-progress-${userId}`);
                if (storedProgress) {
                    try {
                        setProgress(JSON.parse(storedProgress)); // Attempt to parse and set stored progress.
                    } catch (e) {
                        console.error("Failed to parse stored progress, resetting.", e);
                        setProgress({}); // Reset progress if parsing fails (e.g., corrupted data).
                    }
                }
            }, [isAuthReady, userId]); // Reruns when auth status or userId changes.

            // Callback function to update and persist the user's progress for a specific step.
            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;

                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };

                    // If the old and new step data are identical, do not update state.
                    // This prevents the infinite re-render loop.
                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
                        return currentProgress;
                    }

                    // Otherwise, proceed with the update.
                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: newStepProgress
                        }
                    };

                    localStorage.setItem(`cardiac-module-progress-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);

            const handlePreAssessmentComplete = (completedModuleIds) => {
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => {
                            newProgress[moduleId][step.id] = { completed: true };
                        });
                    }
                });
                setProgress(newProgress);
                localStorage.setItem(`cardiac-module-progress-${userId}`, JSON.stringify(newProgress));
                // The results screen is now part of the PreAssessmentQuiz component.
                // We just need to handle exiting it.
            };
            
            // Callback to reset all progress
            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                // Clear from state
                setProgress({});
                // Clear from localStorage
                localStorage.removeItem(`cardiac-module-progress-${userId}`);
            }, [isAuthReady, userId]);

            // Function to navigate to the next module in the sequence
            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    // If it's the last module, go back to the dashboard.
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            // Determine which module is currently selected based on `currentModuleId`.
            const selectedModule = currentModuleId && contentData[currentModuleId]
                                             ? { ...contentData[currentModuleId], id: currentModuleId }
                                             : null;

            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz 
                            onComplete={handlePreAssessmentComplete} 
                            onExit={() => setIsPreAssessmentActive(false)}
                        />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                        />
                    )}
                </div>
            );
        }

        // --- Render the App into the DOM ---
        // Get the DOM element where the React application will be mounted.
        const container = document.getElementById('root');
        // Create a React root, which is the entry point for React 18+ applications.
        const root = ReactDOM.createRoot(container);
        // Render the main App component into the root.
        root.render(<App />);
    </script>
</body>
</html>
