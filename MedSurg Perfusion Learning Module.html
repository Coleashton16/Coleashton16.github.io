<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfusion Learning Module</title>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS for styling: Provides utility classes for modern responsive design. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration to use the Inter font.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                },
            },
        };
    </script>

    <!-- React Libraries: Core React for building UI components. -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel to translate JSX: Required for in-browser JSX compilation. Must be loaded after React. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
    <!-- The root div where our React application will be mounted. -->
    <div id="root"></div>

    <script type="text/babel">
        // --- React and Library Setup ---
        // Destructure necessary hooks from the global React object.
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup for Standalone Demo ---
        // This mock object simulates basic user authentication to allow progress tracking via localStorage.
        // In a real application, this would be replaced with actual Firebase authentication.
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                // Simulate an asynchronous authentication check, providing a unique user ID.
                setTimeout(() => callback({ uid: 'standalone-perfusion-user' }), 100);
                return () => {}; // Returns an empty function as a cleanup/unsubscribe placeholder.
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-perfusion-user' } }), // Mock anonymous sign-in.
        };

        // --- Content & Data Structure for the Perfusion Learning Module ---
        // The main content is now broken down into smaller, focused modules.
        const contentData = {
            'perfusion-foundations': {
                title: 'Perfusion Foundations',
                color: 'from-sky-500 to-cyan-400',
                description: 'Basic definitions, normal physiological processes, and core concepts of perfusion.',
                steps: [
                    { id: 'definition-scope', title: 'Definition & Scope', type: 'text', content: `<strong>Definition:</strong> Perfusion is the consistent flow of blood through arteries and capillaries, delivering nutrients and oxygen to cells and removing waste products. It is a fundamental process for all body tissues.<br><br><strong>Scope:</strong> Perfusion exists on a continuum from optimal to no perfusion. Impaired perfusion leads to ischemia (reduced blood flow) and can progress to necrosis (tissue death) if uncorrected. The nurse's role is to promote healthy behaviors, identify individuals at risk, recognize signs of impairment, and respond with appropriate interventions.` },
                    { id: 'central-local-perfusion', title: 'Central vs. Local Perfusion', type: 'text', content: `Perfusion is categorized into two main types:<br><br>- <strong>Central Perfusion:</strong> This is the force of blood movement generated by the heart's pumping action (cardiac output). It's responsible for delivering blood to all organs and tissues. Adequate central perfusion requires a healthy heart, sufficient blood pressure, and adequate blood volume.<br><br>- <strong>Tissue or Local Perfusion:</strong> This refers to the volume of blood that flows through arteries and capillaries to a specific target tissue. It depends on central perfusion but also requires patent (open) vessels, adequate hydrostatic pressure, and appropriate capillary permeability to allow for the exchange of fluids, nutrients, and waste.` },
                    { id: 'cardiac-output-factors', title: 'Cardiac Output & Key Factors', type: 'text', content: `<strong>Cardiac Output (CO):</strong> The amount of blood pumped by the heart each minute, which is the primary driver of central perfusion. A sufficient CO is needed to transport blood to all tissues. The formula is:<br><br><div class="text-center font-semibold text-lg bg-indigo-50 p-3 rounded-md">Cardiac Output (CO) = Stroke Volume (SV) × Heart Rate (HR)</div><br><strong>Key terms influencing Cardiac Output:</strong><br>- <strong>Stroke Volume (SV):</strong> The amount of blood ejected from each ventricle during one contraction.<br>- <strong>Heart Rate (HR):</strong> The number of times the heart contracts per minute.<br>- <strong>Preload:</strong> The amount of blood in the ventricles at the end of diastole (the filling phase). This volume creates a stretch on the heart muscle just before it contracts.<br>- <strong>Afterload:</strong> The amount of resistance the heart must pump against to eject blood. This is also called <strong>Systemic Vascular Resistance (SVR)</strong>. High SVR (e.g., from constricted arteries) increases the heart's workload.` },
                    { id: 'bp-regulation', title: 'Mechanisms of BP Control', type: 'text', content: `The body has several complex systems to maintain blood pressure, which is crucial for perfusion. Four major control systems are:<br><br><strong>1. The Arterial Baroreceptor System:</strong> Located in the carotid sinus, aorta, and left ventricle, these receptors monitor the level of stretch in the arterial walls. When BP increases, they signal the brain to lower heart rate and cause vasodilation. When BP decreases, they trigger vasoconstriction and increase heart rate.<br><br><strong>2. Regulation of Body Fluid Volume:</strong> The kidneys play a key role. When BP is high, the kidneys excrete more fluid to reduce blood volume. When BP is low, they retain fluid.<br><br><strong>3. The Renin-Angiotensin-Aldosterone System (RAAS):</strong> When the kidneys sense low blood flow, they release renin. Renin triggers a cascade that produces angiotensin II, a potent vasoconstrictor, and aldosterone, which causes the kidneys to retain sodium and water. Both actions increase blood pressure.<br><br><strong>4. Vascular Autoregulation:</strong> This is the ability of individual tissues to regulate their own blood flow. For example, a tissue that is highly active will release local chemicals that cause its arterioles to dilate, increasing blood supply to meet metabolic demands.` },
                    { id: 'foundations-quiz', title: 'Foundations Quiz', type: 'quiz',
                      questions: [
                        { question: "What is the term for the amount of resistance the heart pumps against?", options: ["Preload", "Cardiac Output", "Stroke Volume", "Afterload (SVR)"], correctAnswer: "Afterload (SVR)" },
                        { question: "Which system is primarily responsible for long-term blood pressure control through fluid retention and vasoconstriction?", options: ["Arterial Baroreceptor System", "Vascular Autoregulation", "Renin-Angiotensin-Aldosterone System (RAAS)", "Central Nervous System"], correctAnswer: "Renin-Angiotensin-Aldosterone System (RAAS)" },
                      ]
                    },
                ]
            },
            'perfusion-hypertension': {
                title: 'Hypertension',
                color: 'from-red-500 to-orange-400',
                description: 'Explore the types, risk factors, and management of high blood pressure.',
                steps: [
                    { id: 'hypertension-types', title: 'Types of Hypertension', type: 'text', content: `Hypertension is a major risk factor for cardiovascular disease and impairs perfusion by increasing the workload of the heart and damaging the endothelium of arteries, leading to medial hyperplasia (thickening) and atherosclerosis.<br><br><strong>Essential (Primary) Hypertension:</strong> This is the most common type and is not caused by an existing health problem. It develops gradually over many years.<br><br><strong>Secondary Hypertension:</strong> This type is caused by a specific disease state or medication, such as kidney disease, diabetes, or certain drugs.<br><br><strong>Hypertensive Crisis (Malignant Hypertension):</strong> This is a medical emergency where blood pressure rises rapidly and severely. Symptoms can include morning headaches, blurred vision, and dyspnea.<br>- <strong>Urgency:</strong> BP > 180/120 mm Hg without signs of organ damage.<br>- <strong>Emergency:</strong> BP > 180/120 mm Hg WITH signs of organ damage (e.g., chest pain, shortness of breath, vision changes, difficulty speaking). This requires immediate medical attention (Call 911).` },
                    { id: 'hypertension-guidelines', title: 'Screening & Guidelines', type: 'text', content: `Secondary prevention for perfusion issues heavily relies on regular blood pressure screening.<br><br><strong>JNC 8 Guidelines for Treatment:</strong><br>- For people over 60: Goal is a BP below <strong>150/90</strong> mm Hg.<br>- For people younger than 60: Goal is a BP below <strong>140/90</strong> mm Hg.<br>Patients with BPs above these goals should be treated with lifestyle modifications and drug therapy.<br><br><strong>AHA General Guidelines:</strong><br>- <strong>Normal:</strong> < 120/80 mm Hg<br>- <strong>Elevated:</strong> 120-129 / <80 mm Hg<br>- <strong>Stage 1 HTN:</strong> 130-139 / 80-89 mm Hg<br>- <strong>Stage 2 HTN:</strong> ≥ 140/90 mm Hg` },
                    { id: 'hypertension-risks', title: 'Common Risk Factors', type: 'text', content: `Several factors increase the risk for developing essential hypertension:<br><br>- <strong>Age:</strong> Being older than 60 years.<br>- <strong>Family History:</strong> Genetic predisposition.<br>- <strong>Obesity:</strong> Increases workload on the heart.<br>- <strong>Smoking:</strong> Nicotine is a vasoconstrictor.<br>- <strong>Physical Inactivity:</strong> Contributes to obesity and poor cardiovascular health.<br>- <strong>Hyperlipidemia:</strong> High cholesterol contributes to atherosclerosis.<br>- <strong>Stress:</strong> Can chronically elevate BP.<br>- <strong>Ethnicity:</strong> African American individuals have a higher risk of developing hypertension, often at an earlier age and with more severity.` },
                    { id: 'hypertension-prevention', title: 'Health Promotion & Prevention', type: 'text', content: `Primary prevention focuses on lifestyle modifications:<br><br><strong>1. Weight Reduction:</strong> Maintaining a healthy body weight (BMI 18.5-24.9) is crucial.<br><br><strong>2. DASH Diet:</strong> The Dietary Approaches to Stop Hypertension (DASH) eating plan is highly recommended. It emphasizes:<br>- Low sodium, saturated fat, and trans fats.<br>- Plenty of fruits, vegetables, and fiber-rich whole grains.<br>- Fish, skinless poultry, legumes, and nuts.<br>- Low-fat or fat-free dairy products.<br>- Limiting red meat and sugar-sweetened beverages.<br><br><strong>3. Reduce Sodium Intake:</strong> Lowering salt consumption helps reduce fluid retention and blood pressure.<br><br><strong>4. Increase Physical Activity:</strong> Aim for at least 150 minutes of moderate-intensity activity or 75 minutes of vigorous-intensity activity per week.<br><br><strong>5. Smoking Cessation:</strong> Quitting smoking is one of the most effective prevention strategies.` },
                    { id: 'hypertension-quiz', title: 'Hypertension Quiz', type: 'quiz',
                      questions: [
                        { question: "A patient's blood pressure is 190/122 mm Hg and they complain of a severe headache and blurred vision. This is considered a:", options: ["Stage 1 Hypertension", "Stage 2 Hypertension", "Hypertensive Urgency", "Hypertensive Emergency"], correctAnswer: "Hypertensive Emergency" },
                        { question: "Which of these is a key feature of the DASH diet?", options: ["High protein from red meat", "Low intake of fruits and vegetables", "Low sodium and high fiber", "Full-fat dairy products"], correctAnswer: "Low sodium and high fiber" }
                      ]
                    }
                ]
            },
            'perfusion-assessment': {
                title: 'Perfusion Assessment',
                color: 'from-blue-400 to-indigo-600',
                description: 'Learn how to assess for impaired perfusion, from vitals to advanced tools.',
                steps: [
                    { id: 'assessment-cues', title: 'Recognizing Cues', type: 'text', content: `A thorough assessment is critical for identifying impaired perfusion. The process involves multiple steps:<br><br><strong>1. Measure Vital Signs:</strong> Look for hypotension/hypertension and tachycardia/bradycardia. An irregular pulse suggests dysrhythmias.<br><br><strong>2. General Inspection:</strong> Observe skin color (pallor, cyanosis), respiratory effort, and any signs of distress.<br><br><strong>3. Thorax Inspection & Palpation:</strong> Look for heaves or lifts and palpate for thrills (vibrations indicating turbulent flow).<br><br><strong>4. Auscultation:</strong> Listen to heart sounds (S1, S2, and abnormal S3/S4 or murmurs) and vascular sounds (e.g., carotid bruits).<br><br><strong>5. Extremity Assessment:</strong> Inspect for skin color, hair distribution, and signs of edema. Palpate for temperature, capillary refill (<2 sec is normal), and peripheral pulse strength (0 to 4+ scale).<br><br><strong>6. Advanced Assessments:</strong> When indicated, perform measurements like ankle-brachial index (ABI) for PAD, leg circumferences for DVT, and pulse deficit for dysrhythmias.` },
                    { id: 'assessment-history', title: 'Assessment: Patient History', type: 'text', content: `Gathering subjective data is key. Inquire about:<br><br><strong>Problem-Based History (Symptoms):</strong><br>- <strong>Pain:</strong> Ischemic pain is a hallmark of poor perfusion. Chest pain (angina) or leg pain (claudication) are common.<br>- <strong>Dyspnea:</strong> Shortness of breath, especially on exertion, can indicate heart failure.<br>- <strong>Edema:</strong> Swelling in the extremities can signal fluid overload from heart, renal, or liver failure.<br>- <strong>Dizziness/Syncope:</strong> Lightheadedness or fainting may result from orthostatic hypotension or inadequate blood flow to the brain.` },
                    { id: 'assessment-diagnostics', title: 'Assessment: Diagnostic Cues', type: 'text', content: `Lab and imaging results provide objective data for impaired perfusion.<br><br><strong>For Hypertension:</strong><br>- <strong>Urinalysis:</strong> May show protein or RBCs, indicating kidney damage.<br>- <strong>Chest X-ray:</strong> Can reveal cardiomegaly (enlarged heart).<br>- <strong>ECG:</strong> May show signs of left ventricular hypertrophy, a consequence of the heart working harder against high pressure.<br><br><strong>For Clotting Disorders:</strong><br>- <strong>CBC with Platelet Count:</strong> Assesses for anemia, polycythemia, and thrombocytopenia.<br>- <strong>Coagulation Studies:</strong> PT, INR, and aPTT are crucial for monitoring anticoagulant therapy.<br>- <strong>D-dimer:</strong> A level < 0.4 mcg/mL can help rule out a thrombus.` },
                    { id: 'assessment-quiz', title: 'Assessment Quiz', type: 'quiz',
                      questions: [
                        { question: "A capillary refill time of 4 seconds indicates:", options: ["Normal perfusion", "Impaired perfusion", "Fluid overload", "A normal finding in older adults"], correctAnswer: "Impaired perfusion" },
                        { question: "An enlarged heart on a chest x-ray, known as cardiomegaly, is a potential diagnostic cue for which condition?", options: ["Deep Vein Thrombosis", "Anemia", "Chronic Hypertension", "Acute Ischemia"], correctAnswer: "Chronic Hypertension" }
                      ]
                    }
                ]
            },
            'perfusion-clotting-vte': {
                title: 'Clotting & VTE',
                color: 'from-purple-500 to-pink-500',
                description: 'Understand the clotting process and the pathophysiology of Venous Thromboembolism (VTE).',
                steps: [
                    { id: 'clotting-cascade', title: 'The Clotting Process', type: 'text', content: `When a blood vessel is injured, a complex process called the coagulation cascade is initiated to stop bleeding.<br><br><strong>1. Vasoconstriction:</strong> The injured vessel constricts to reduce blood flow.<br><strong>2. Platelet Plug Formation:</strong> Platelets become activated and adhere to the injury site, forming a temporary plug.<br><strong>3. Coagulation Cascade:</strong> A series of clotting factors are activated, leading to a common final pathway where <strong>thrombin</strong> converts soluble <strong>fibrinogen</strong> into insoluble <strong>fibrin</strong>. This fibrin forms a mesh that stabilizes the platelet plug, creating a durable clot.` },
                    { id: 'virchows-triad', title: 'Virchow\'s Triad', type: 'text', content: `The formation of a thrombus (a blood clot within a vessel), such as in Deep Vein Thrombosis (DVT), is promoted by three factors known as Virchow's Triad:<br><br><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">1. Blood Flow Stasis</h4>
                            <p class="text-sm">Decreased blood flow, often due to immobility, obesity, or varicose veins.</p>
                        </div>
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">2. Endothelial Injury</h4>
                            <p class="text-sm">Damage to the inner lining of the blood vessel from surgery, trauma, or infection.</p>
                        </div>
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">3. Hypercoagulability</h4>
                            <p class="text-sm">An increased tendency for blood to clot, caused by cancer, sepsis, dehydration, or genetic disorders.</p>
                        </div>
                    </div>` },
                    { id: 'dvt-assessment', title: 'DVT Assessment', type: 'text', content: `Recognizing a DVT is crucial to prevent a life-threatening pulmonary embolism.<br><br><strong>Signs & Symptoms:</strong> Often may be asymptomatic. Classic signs include calf or groin pain and sudden onset of unilateral leg swelling, warmth, and redness.<br><br><strong>Diagnostic Assessment:</strong><br>- <strong>Venous Duplex Ultrasonography:</strong> The primary diagnostic tool to visualize the thrombus.<br>- <strong>D-dimer Test:</strong> Measures a product of fibrin degradation. A negative result helps rule out DVT, but a positive result is not definitive as it can be elevated in other conditions.<br>- <strong>Padua Prediction Score (PPS):</strong> A clinical tool used to assess a patient's risk for VTE.` },
                    { id: 'dvt-management', title: 'DVT Management & Anticoagulation', type: 'text', content: `The primary goals are to prevent the thrombus from growing and to prevent it from becoming a pulmonary embolism.<br><br><strong>Nonsurgical Management:</strong><br>- Early ambulation and leg exercises.<br>- Graduated compression stockings.<br>- Sequential Compression Devices (SCDs).<br>- Anticoagulant therapy is the cornerstone of treatment.<br><br><strong>Anticoagulant Therapy:</strong><br>- <strong>Heparin:</strong> Unfractionated Heparin (UFH) is given IV and requires monitoring of aPTT. Low-Molecular-Weight Heparin (LMWH, e.g., enoxaparin) is given subcutaneously and does not require regular lab monitoring.<br>- <strong>Warfarin (Coumadin):</strong> An oral anticoagulant that requires monitoring of PT/INR. It is often started while the patient is on heparin, and heparin is discontinued once the INR is therapeutic (usually >2.0).<br>- <strong>Direct Oral Anticoagulants (DOACs):</strong> Newer agents like rivaroxaban and apixaban that do not require frequent lab monitoring.<br><br><strong>Antidotes:</strong><br>- Heparin: <strong>Protamine Sulfate</strong><br>- Warfarin: <strong>Vitamin K</strong><br>- Dabigatran (DOAC): <strong>Idarucizumab (Praxbind)</strong><br>- Apixaban & Rivaroxaban (DOACs): <strong>Andexanet alfa (Andexxa)</strong>` },
                     { id: 'clotting-quiz', title: 'Clotting & VTE Quiz', type: 'quiz',
                      questions: [
                        { question: "A post-operative patient who is immobile is at risk for DVT primarily due to which part of Virchow's Triad?", options: ["Endothelial Injury & Blood Flow Stasis", "Hypercoagulability only", "Blood Flow Stasis only", "Endothelial Injury only"], correctAnswer: "Endothelial Injury & Blood Flow Stasis" },
                        { question: "A patient is receiving an IV infusion of Unfractionated Heparin. Which lab value must the nurse monitor closely?", options: ["INR", "Platelet Count", "aPTT", "D-dimer"], correctAnswer: "aPTT" }
                      ]
                    }
                ]
            },
            'perfusion-stroke': {
                title: 'Stroke (Brain Attack)',
                color: 'from-amber-500 to-lime-500',
                description: 'Learn the types, assessment, and emergency management of strokes.',
                steps: [
                    { id: 'stroke-overview', title: 'Stroke Overview & TIA', type: 'text', content: `A stroke is a medical emergency caused by an interruption of perfusion to a part of the brain.<br><br><strong>Transient Ischemic Attack (TIA):</strong> Often called a "warning sign," a TIA is a temporary neurologic dysfunction resulting from a brief interruption in cerebral blood flow. Symptoms resolve, but it indicates a high risk for a future stroke. The <strong>ABCD2 tool</strong> helps assess this risk.<br><br><strong>Types of Stroke:</strong><br>- <strong>Ischemic Stroke (87%):</strong> Caused by the occlusion of a cerebral artery by either a thrombus (clot forming in the artery) or an embolus (clot that travels from elsewhere in the body).<br>- <strong>Hemorrhagic Stroke (13%):</strong> Caused by bleeding in the brain tissue, often from a ruptured aneurysm (a weak, dilated vessel) or an arteriovenous malformation (AVM).` },
                    { id: 'stroke-assessment', title: 'Stroke Assessment', type: 'text', content: `Rapid assessment is critical. The first priority is ensuring the patient is transported to a stroke center.<br><br><strong>Key Assessments:</strong><br>- <strong>Neurologic Examination:</strong> The <strong>NIH Stroke Scale (NIHSS)</strong> is a standardized tool used to assess the severity of stroke-related neurologic deficits. A higher score indicates greater severity.<br>- <strong>Imaging:</strong> A non-contrast CT scan is the first step to differentiate between an ischemic and hemorrhagic stroke. This is crucial because the treatments are very different.<br>- <strong>Psychosocial:</strong> Assess for emotional lability (rapid, often exaggerated changes in mood), which is common after a stroke.` },
                    { id: 'ischemic-stroke-management', title: 'Ischemic Stroke Management', type: 'text', content: `The goal is to restore perfusion to the brain as quickly as possible.<br><br><strong>Thrombolytic Therapy:</strong><br>- Recombinant tissue plasminogen activator (rt-PA), such as <strong>alteplase</strong>, is used to dissolve the clot.<br>- It must be administered within a strict time window, typically <strong>3 to 4.5 hours</strong> from the onset of symptoms.<br>- The main complication is bleeding, especially intracranial hemorrhage. Patients require frequent neurologic monitoring.<br><br><strong>Endovascular Procedures:</strong><br>- <strong>Mechanical Thrombectomy:</strong> A catheter is used to physically remove the clot from the artery. This can be done up to 24 hours after symptom onset in certain patients.<br>- <strong>Carotid Endarterectomy:</strong> A surgical procedure to remove plaque from the carotid artery to prevent future strokes.` },
                    { id: 'hemorrhagic-stroke-management', title: 'Hemorrhagic Stroke Management', type: 'text', content: `The goal is to stop the bleeding and manage intracranial pressure (ICP).<br><br><strong>Blood Pressure Control:</strong> BP must be carefully managed to prevent rebleeding without compromising cerebral perfusion.<br><br><strong>Surgical Interventions:</strong><br>- <strong>Aneurysm Clipping:</strong> A surgeon places a small titanium clip across the neck of the aneurysm to stop blood from entering it.<br>- <strong>Aneurysm Coiling:</strong> An endovascular procedure where platinum coils are deployed into the aneurysm, causing a clot to form and sealing it off from the artery.` },
                    { id: 'stroke-nursing-care', title: 'General Stroke Nursing Care', type: 'text', content: `Nursing care is focused on preventing complications and promoting recovery.<br><br>- <strong>Monitor for Increased ICP:</strong> Keep the head of the bed elevated (≥30 degrees) and the neck in a midline position.<br>- <strong>Aspiration Precautions:</strong> Perform a bedside swallow screen before giving the patient anything to eat or drink. The diet may need to be modified (e.g., thickened liquids, pureed foods).<br>- <strong>Promote Mobility:</strong> Prevent pressure ulcers and contractures with frequent repositioning and range-of-motion exercises.<br>- <strong>Communication:</strong> For patients with aphasia (difficulty with language), develop strategies for effective communication.` },
                    { id: 'stroke-quiz', title: 'Stroke Quiz', type: 'quiz',
                      questions: [
                        { question: "A patient presents with symptoms of an ischemic stroke that started 2 hours ago. Which intervention is the highest priority?", options: ["Administering aspirin", "Preparing for aneurysm coiling", "Evaluating for thrombolytic (rt-PA) therapy", "Checking blood glucose"], correctAnswer: "Evaluating for thrombolytic (rt-PA) therapy" },
                        { question: "Which assessment tool is used to quantify the severity of neurologic deficits in a stroke patient?", options: ["ABCD2 Score", "Glasgow Coma Scale", "NIH Stroke Scale (NIHSS)", "Padua Prediction Score"], correctAnswer: "NIH Stroke Scale (NIHSS)" }
                      ]
                    }
                ]
            },
            'perfusion-case-studies': {
                title: 'Perfusion Case Studies',
                color: 'from-rose-400 to-red-500',
                description: 'Apply your knowledge with clinical case studies.',
                steps: [
                    { id: 'george-jones-case-study', title: 'Case Study: George Jones', type: 'case_study', case: {
                      scenario: `George Jones, a 59-year-old male, arrived at the emergency department with chest pain that he had experienced for 30 minutes, and it was not relieved after taking four nitroglycerin tablets 5 minutes apart. He reports the pain feels “like an elephant is sitting on my chest.” He is diaphoretic and appears anxious. His vital signs are as follows: temperature, 99°F; blood pressure, 100/68 mm Hg; heart rate, 110 beats/min; and respiratory rate, 24 breaths per minute. Mr. Jones is overweight and has type 2 diabetes, hyperlipidemia, and hypertension. He quit smoking last year after a 40-year history of smoking one pack of cigarettes a day. His troponin level is elevated, and his ECG shows ST segment elevation. The nurse administers oxygen and draws blood for arterial blood gas analysis. Mr. Jones is told he will undergo cardiac catheterization to locate the blockage, determine its severity, and evaluate left ventricular function.`,
                      question: "Based on Mr. Jones's presentation and history, what is the most likely primary diagnosis related to his impaired perfusion?",
                      options: ["Pulmonary Embolism", "Hypovolemic Shock", "Acute Myocardial Infarction", "Hypertensive Crisis"],
                      correctAnswer: "Acute Myocardial Infarction",
                      explanation: "Mr. Jones's symptoms (crushing chest pain not relieved by nitroglycerin, diaphoresis, anxiety), risk factors (age, overweight, type 2 diabetes, hyperlipidemia, hypertension, history of smoking), and vital signs, along with elevated troponin and ST segment elevation on ECG, are classic indicators of an acute myocardial infarction (heart attack). This represents severe impaired central and localized tissue perfusion to the heart muscle. Pulmonary embolism might cause chest pain but typically with pleurisy and different vitals. Hypovolemic shock would have signs of fluid loss. A hypertensive crisis would show significantly elevated blood pressure."
                    }},
                    { id: 'george-jones-questions', title: 'Case Study: Analysis Questions', type: 'text', content: `<strong>1. What risk factors does Mr. Jones have for impaired perfusion?</strong><br>Mr. Jones has several significant risk factors for impaired perfusion, both modifiable and unmodifiable:<br>- <strong>Age:</strong> 59 years old (risk increases with age).<br>- <strong>Gender:</strong> Male (men > women for heart disease risk).<br>- <strong>Overweight:</strong> Contributes to obesity, increasing risk for diabetes and atherosclerosis.<br>- <strong>Type 2 Diabetes:</strong> Increases risk of atherosclerosis.<br>- <strong>Hyperlipidemia:</strong> Contributes to atherosclerosis by plaque buildup.<br>- <strong>Hypertension:</strong> Increases workload of myocardium and damages endothelium.<br>- <strong>History of Smoking:</strong> Quit smoking last year after 40 years, indicating significant past exposure to a major vasoconstrictor and endothelial toxin, increasing atherosclerosis risk.<br><br><strong>2. Does this case exemplify an impairment of local perfusion, central perfusion, or both?</strong><br>This case exemplifies an impairment of <strong>both local and central perfusion</strong>.<br>- <strong>Local Perfusion Impairment:</strong> The blockage in a coronary artery directly impairs blood flow to a specific area of the myocardium, leading to myocardial ischemia and ultimately irreversible cell death (necrosis) in that localized tissue (Acute Myocardial Infarction).<br>- <strong>Central Perfusion Impairment:</strong> An acute myocardial infarction, especially one with significant damage, directly affects the heart's ability to pump efficiently. Mr. Jones's vital signs (BP 100/68 mm Hg, HR 110 beats/min) suggest that his heart is struggling to maintain adequate cardiac output, leading to impaired central perfusion. If severe, this can lead to large-scale, systemic impairment affecting multiple organs and potentially cardiovascular collapse.`},
                ]
            },
        };

        // --- Helper Functions ---
        // Utility for conditionally joining Tailwind CSS classes.
        const cn = (...classes) => classes.filter(Boolean).join(' ');


        // --- Child Components ---

        /**
         * Quiz component for interactive multiple-choice questions.
         * Users answer questions and receive immediate feedback.
         */
        const Quiz = ({ questions, onComplete }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [feedback, setFeedback] = useState(null); // 'correct', 'incorrect', or null
            const [quizScores, setQuizScores] = useState(Array(questions.length).fill(0)); // To store scores for each question

            const currentQuestion = questions[currentQuestionIndex];

            const handleOptionSelect = (option) => {
                if (feedback) return; // Prevent changing answer after feedback is shown
                setSelectedOption(option);
            };

            const handleSubmitAnswer = () => {
                if (selectedOption === null) return; // Don't submit if no option is selected

                // Case-insensitive comparison
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                setFeedback(isCorrect ? 'correct' : 'incorrect');

                // Update score for the current question
                setQuizScores(prevScores => {
                    const newScores = [...prevScores];
                    newScores[currentQuestionIndex] = isCorrect ? 1 : 0;
                    return newScores;
                });
            };

            const handleNextQuestion = () => {
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null);
                    setFeedback(null);
                } else {
                    // Quiz finished. Calculate final score and pass to onComplete.
                    const finalScore = quizScores.reduce((sum, score) => sum + score, 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-3">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = selectedOption === option;
                            const isCorrectOption = option.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';

                            if (feedback) { // If feedback is active
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && (isCorrectOption || (isSelected && feedback === 'incorrect')) && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : <span className="text-red-600 mr-2">✗</span>
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 text-center">
                        {!feedback ? (
                            <button
                                onClick={handleSubmitAnswer}
                                disabled={selectedOption === null}
                                className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Submit Answer
                            </button>
                        ) : (
                            <>
                                <div className={`p-3 rounded-lg text-white font-semibold mb-4 ${feedback === 'correct' ? 'bg-green-500' : 'bg-red-500'}`}>
                                    {feedback === 'correct' ? 'Correct! Well done.' : 'Incorrect. The correct answer is highlighted.'}
                                </div>
                                <button
                                    onClick={handleNextQuestion}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Quiz'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * Dashboard component to display the various learning modules.
         * It allows users to select a module to start learning.
         * Shows progress for each module using a circular progress bar and status.
         */
        const Dashboard = ({ onSelectModule, progress, onResetProgress }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            // Calculate overall progress and gather quiz scores
            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });


            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <div className="w-full">
                        <header className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                {/* Text placeholder for the main application identifier */}
                                <span className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">PLM</span>
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Perfusion Learning Module</h1>
                            </div>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">Explore key concepts of perfusion through interactive modules designed for comprehensive understanding.</p>
                        </header>

                        {/* Overall Progress Bar & Reset Button */}
                        <div className="mb-8 bg-white rounded-2xl shadow-lg p-6 w-full">
                           <div className="flex justify-between items-center mb-3">
                             <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
                             <button 
                                onClick={onResetProgress}
                                className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2"
                             >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" />
                                </svg>
                                Reset Progress
                             </button>
                           </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallPercentage}%` }}
                                ></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-left text-sm text-gray-600 mt-2">
                                    {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
                                </p>
                                <p className="text-right text-sm text-gray-600 mt-2">{Math.round(overallPercentage)}% Completed</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                            {/* Iterate over all modules defined in contentData */}
                            {Object.entries(contentData).map(([id, module]) => {
                                const moduleProgress = progress[id] || {};
                                // Calculate completion count for steps within the module.
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-green-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                // Get quiz score for this module if available
                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        // Styling for module cards, including hover effects.
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            {/* Placeholder for module icon: Displays the first letter of the module title. */}
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-10 h-10 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.title.split(' ').map(word => word.charAt(0)).join('')}
                                            </div>
                                            {/* Progress Circle */}
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    {/* Background circle for the progress bar. */}
                                                    <path
                                                        className="text-gray-200"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                    />
                                                    {/* Foreground arc representing the completion percentage. */}
                                                    <path
                                                        className="text-indigo-500"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                        strokeDasharray={`${percentage}, 100`}
                                                        strokeLinecap="round"
                                                        transform="rotate(-90 18 18)"
                                                    />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10">{module.description}</p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * CaseStudy component for a multiple-choice case study challenge.
         * Presents a scenario and a question with multiple options.
         */
        const CaseStudy = ({ caseData, onComplete }) => {
            // State to store the user's selected answer.
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            // Handles the selection of an answer option.
            const handleSelect = (option) => {
                if (selectedAnswer) return; // Prevents changing the answer once selected.
                setSelectedAnswer(option);
                // Case-insensitive comparison
                if (option.toLowerCase() === caseData.correctAnswer.toLowerCase()) {
                    onComplete(); // Marks the step as complete if the correct answer is chosen.
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Case Study Challenge</h4>
                    {/* Scenario description, using dangerouslySetInnerHTML to render HTML bold tags */}
                    <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-3">{caseData.question}</p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrect = option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                            const showFeedback = selectedAnswer !== null; // Show feedback once any answer is selected

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling for options.
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission
                            }

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {showFeedback && ( // Display a checkmark or cross icon if feedback is active
                                            isCorrect ? <span className="text-green-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedAnswer && ( // Display the explanation after an answer has been selected.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * VitalsCheck component for an interactive question about vital signs.
         * Users identify the most concerning vital sign from a given set.
         */
        const VitalsCheck = ({ onComplete }) => {
            // State to store the user's selected vital sign.
            const [selectedVital, setSelectedVital] = useState(null);
            const vitals = { "BP": "100/68 mmHg", "HR": "110 bpm", "RR": "24/min", "Temp": "99°F" };
            const mostConcerning = "HR"; // The correct answer.
            const explanation = "A heart rate of 110 bpm (tachycardia) is a significant sign of distress. It indicates the heart is working hard to compensate for poor perfusion, which is common during an acute myocardial infarction.";

            // Handles the selection of a vital sign option.
            const handleSelect = (vital) => {
                if(selectedVital) return; // Prevents changing the selection once made.
                setSelectedVital(vital);
                // Case-insensitive comparison (though keys are already consistent)
                if (vital.toLowerCase() === mostConcerning.toLowerCase()) {
                    onComplete(); // Mark step as complete if correct answer is chosen
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Vitals Check</h4>
                    <p className="text-sm text-gray-600 mb-4">A patient presents with chest pain. Based on these vital signs, which one is the MOST concerning indicator of impaired central perfusion?</p>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {Object.entries(vitals).map(([key, value]) => {
                            const isSelected = selectedVital === key;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrect = key.toLowerCase() === mostConcerning.toLowerCase();
                            const showFeedback = selectedVital !== null; // Show feedback once any vital is selected

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling.
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission
                            }
                            return (
                                <div key={key} onClick={() => handleSelect(key)} className={cn('p-4 rounded-lg border-2 cursor-pointer text-center', optionClass)}>
                                    <div className="text-sm font-bold text-gray-500">{key}</div>
                                    <div className="text-xl font-semibold text-gray-800">{value}</div>
                                </div>
                            );
                        })}
                    </div>
                   {selectedVital && ( // Display the rationale after a selection is made.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Rationale</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * StaticContentStep component for displaying basic text content.
         * Marks itself as complete immediately on render.
         */
        const StaticContentStep = ({ step, onComplete }) => {
            // For 'text' type steps, mark them as complete immediately upon rendering.
            // The effect should only run once when the component mounts to prevent an infinite loop.
            useEffect(() => {
                onComplete();
            }, []); // Empty dependency array ensures this runs only once.

            // Using dangerouslySetInnerHTML to render HTML content (e.g., <strong> tags).
            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg shadow-inner space-y-4" dangerouslySetInnerHTML={{ __html: step.content }}>
                </div>
            );
        };

        /**
         * CompletionModal component displayed when a module is completed.
         */
        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
                        <h3 className="text-2xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors shadow-sm"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * LearningModule component to manage steps within the selected module.
         * Provides navigation between steps and renders the appropriate content for each.
         */
        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0); // Manages the index of the currently active step.
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Controls the visibility of the sidebar on mobile.
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false); // State for completion modal

            // Callback function to update the completion status of a specific step.
            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            
            // Check if all steps in the current module are completed
            const allStepsCompletedInModule = module.steps.every(step =>
                moduleProgress[step.id] && moduleProgress[step.id].completed
            );

            // Navigates to the next step, if available.
            const handleNextStep = () => {
                // If it's the last step and all steps in the module are completed, open the modal
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            // Navigates to the previous step, if available.
            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };
            
            // Ensure module and its steps are defined before accessing properties
            if (!module || !module.steps) {
                console.error("LearningModule received invalid module prop:", module);
                return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Loading module...</div>;
            }

            const currentStep = module.steps[activeStep];
            
            // Renders the appropriate content component based on the current step's type.
            // This function acts as a router for different interactive and static content types.
            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;

                const onCompleteForStep = (data) => handleStepComplete(step.id, data);

                switch (step.type) {
                    case 'text':
                        return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'interactive_vitals':
                        return <VitalsCheck key={step.id} onComplete={onCompleteForStep} />;
                    case 'case_study':
                        return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz':
                        return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default:
                        // Fallback for unrecognized step types, ensuring robust error handling.
                        return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack(); // Go back to dashboard when modal is closed
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule(); // Proceed to next module
            };


            return (
                <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
                    {/* Header for the learning module, including back button and module title. */}
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        </div>
                        {/* Mobile sidebar toggle button using text/emoji placeholders. */}
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar for navigation steps within the module. */}
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false); // Close sidebar on mobile after a step is selected.
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        {/* Step completion indicator */}
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        {/* Main content area for the current step. */}
                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                {/* Navigation buttons for moving between steps. */}
                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };
        
        // --- Main App Component ---
        /**
         * The root component of the Perfusion Learning Module application.
         * Manages overall application state, including module selection, user ID, and progress.
         */
        function App() {
            // State for the currently selected learning module's ID. Null means Dashboard is active.
            const [currentModuleId, setCurrentModuleId] = useState(null);
            // State for the authenticated user's ID, used for local storage progress tracking.
            const [userId, setUserId] = useState(null);
            // State for storing the user's progress across all modules and steps.
            const [progress, setProgress] = useState({});
            // State to indicate if authentication is complete and user ID is available.
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Effect hook for handling initial authentication and setting the user ID.
            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true); // Mark authentication as ready once user is determined.
                });
                return () => unsubscribe(); // Cleanup the auth state listener on component unmount.
            }, []); // Empty dependency array ensures this runs only once on mount.

            // Effect hook for loading user progress from localStorage after authentication is ready.
            useEffect(() => {
                if (!isAuthReady || !userId) return; // Only proceed if auth is ready and userId is available.
                const storedProgress = localStorage.getItem(`perfusion-learning-module-progress-${userId}`);
                if (storedProgress) {
                    try {
                        setProgress(JSON.parse(storedProgress)); // Attempt to parse and set stored progress.
                    } catch (e) {
                        console.error("Failed to parse stored progress, resetting.", e);
                        setProgress({}); // Reset progress if parsing fails (e.g., corrupted data).
                    }
                }
            }, [isAuthReady, userId]); // Reruns when auth status or userId changes.

            // Callback function to update and persist the user's progress for a specific step.
            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;

                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };

                    // If the old and new step data are identical, do not update state.
                    // This prevents the infinite re-render loop.
                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
                        return currentProgress;
                    }

                    // Otherwise, proceed with the update.
                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: newStepProgress
                        }
                    };

                    localStorage.setItem(`perfusion-learning-module-progress-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);
            
            // Callback to reset all progress
            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                // Clear from state
                setProgress({});
                // Clear from localStorage
                localStorage.removeItem(`perfusion-learning-module-progress-${userId}`);
            }, [isAuthReady, userId]);

            // Function to navigate to the next module
            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    // If it's the last module, go back to the dashboard.
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            // Determine which module is currently selected based on `currentModuleId`.
            const selectedModule = currentModuleId && contentData[currentModuleId]
                                    ? { ...contentData[currentModuleId], id: currentModuleId }
                                    : null;

            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
                    {selectedModule ? (
                        // If a module is selected, render the LearningModule component.
                        // BUG FIX: Added a `key` prop. When the key (the module ID) changes,
                        // React will unmount the old component and mount a new one, resetting its internal state (like activeStep).
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)} // Callback to return to dashboard.
                            progress={progress} // Pass current progress to the module.
                            onProgressUpdate={handleProgressUpdate} // Pass callback for updating progress.
                            onNextModule={handleNextModule} // Pass callback for next module navigation.
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        // Otherwise, render the Dashboard component to display module choices.
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                        />
                    )}
                </div>
            );
        }

        // --- Render the App into the DOM ---
        // Get the DOM element where the React application will be mounted.
        const container = document.getElementById('root');
        // Create a React root, which is the entry point for React 18+ applications.
        const root = ReactDOM.createRoot(container);
        // Render the main App component into the root.
        root.render(<App />);
    </script>
</body>
</html>
