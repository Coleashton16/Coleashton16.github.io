<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfusion Learning Module</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration to use the Inter font.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- React and Library Setup ---
        // Destructure necessary hooks from the global React object.
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup for Standalone Demo ---
        // This mock object simulates basic user authentication to allow progress tracking via localStorage.
        // In a real application, this would be replaced with actual Firebase authentication.
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                // Simulate an asynchronous authentication check, providing a unique user ID.
                setTimeout(() => callback({ uid: 'standalone-perfusion-user' }), 100);
                return () => {}; // Returns an empty function as a cleanup/unsubscribe placeholder.
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-perfusion-user' } }), // Mock anonymous sign-in.
        };

        // --- Content & Data Structure for the Perfusion Learning Module ---
        // The main content is now broken down into smaller, focused modules.
        const contentData = {
            'perfusion-foundations': {
                title: 'Perfusion Foundations',
                color: 'from-sky-500 to-cyan-400',
                description: 'Basic definitions, normal physiological processes, and core concepts of perfusion.',
                steps: [
                    { id: 'definition-scope', title: 'Definition & Scope', type: 'text', content: `<strong>Definition:</strong> Perfusion is the flow of blood through arteries and capillaries, delivering oxygenated blood to tissues and returning deoxygenated blood to the heart. This process is essential for providing nutrients to cells, removing metabolic waste, and maintaining organ function. It requires a functioning cardiovascular system, adequate blood volume, and patent vessels.<br><br><strong>Scope and Nurse's Role:</strong> Perfusion exists on a continuum from optimal to no perfusion (anoxia). Any disruption is termed impaired perfusion, which leads to ischemia (reduced blood flow) and can progress to necrosis (tissue death). The nurse's role is multifaceted:<br>- <strong>Promote:</strong> Educate patients on healthy lifestyle choices (diet, exercise, smoking cessation) to optimize cardiovascular health.<br>- <strong>Identify:</strong> Recognize individuals at risk for impaired perfusion (e.g., those with hypertension, diabetes, immobility).<br>- <strong>Recognize:</strong> Conduct thorough assessments to detect early signs and symptoms of impaired perfusion.<br>- <strong>Respond:</strong> Implement nursing interventions and collaborate with the healthcare team to restore or maintain perfusion.` },
                    { id: 'central-local-perfusion', title: 'Central vs. Local Perfusion', type: 'text', content: `Perfusion is categorized into two interconnected types:<br><br>- <strong>Central Perfusion:</strong> This is the macro-level circulation generated by the heart. It is the mechanical and electrical function of the heart to pump blood throughout the body. Central perfusion is a systemic process that affects the entire body. It requires:<br>  - <strong>Adequate Cardiac Function:</strong> The heart must pump effectively.<br>  - <strong>Sufficient Blood Pressure:</strong> To propel blood to all tissues.<br>  - <strong>Adequate Blood Volume:</strong> To fill the vascular system.<br>  Impairment of central perfusion (e.g., from a myocardial infarction or shock) leads to systemic effects, affecting multiple organs.<br><br>- <strong>Tissue or Local Perfusion:</strong> This is the micro-level circulation—the volume of blood that flows to a specific target tissue. It is dependent on central perfusion but also has its own requirements:<br>  - <strong>Patent Vessels:</strong> Arteries and capillaries must be open and unobstructed.<br>  - <strong>Adequate Hydrostatic Pressure:</strong> The force from the pumping heart that pushes blood through the capillaries.<br>  - <strong>Capillary Permeability:</strong> The ability of the capillary walls to allow for the exchange of fluids, gases, nutrients, and waste. Impairment of local perfusion (e.g., a thrombus in a leg vein) causes localized effects, though it can have systemic consequences if untreated.` },
                    { id: 'cardiac-output-factors', title: 'Cardiac Output & Key Factors', type: 'text', content: `<strong>Cardiac Output (CO):</strong> This is the volume of blood the heart pumps per minute and is the most critical measure of central perfusion. The normal range for an adult is 4 to 6 L/min. The formula is:<br><br><div class="text-center font-semibold text-lg bg-indigo-50 p-3 rounded-md">Cardiac Output (CO) = Stroke Volume (SV) × Heart Rate (HR)</div><br><strong>Factors Influencing Stroke Volume:</strong><br>- <strong>Preload:</strong> The volume of blood in the ventricles at the end of diastole, which determines the stretch on the myocardial fibers. According to Frank-Starling's Law, the more the heart muscle is stretched (within limits), the stronger the contraction. It is influenced by the amount of venous return to the heart. Conditions like dehydration or hemorrhage decrease preload.<br>- <strong>Afterload:</strong> The resistance the ventricles must overcome to eject blood. It is primarily determined by the <strong>Systemic Vascular Resistance (SVR)</strong>. Vasoconstriction increases afterload, making the heart work harder, while vasodilation decreases it. Chronic hypertension significantly increases afterload.<br>- <strong>Contractility:</strong> The intrinsic ability of the heart muscle to contract, independent of preload and afterload. Positive inotropic drugs (like digoxin) increase contractility, while conditions like acidosis or hypoxia can decrease it.` },
                    { id: 'bp-regulation', title: 'Mechanisms of BP Control', type: 'text', content: `The body has several complex systems to maintain blood pressure (BP), which is crucial for perfusion. Four major control systems are:<br><br><strong>1. The Arterial Baroreceptor System:</strong> These are pressure-sensitive nerve endings in the walls of the atria, aortic arch, and carotid arteries. They respond to stretching of the vessel wall. When BP increases, they send signals to the medulla oblongata, which in turn inhibits the sympathetic nervous system and excites the parasympathetic system, causing vasodilation and a decreased heart rate. This is a rapid, short-term regulatory mechanism.<br><br><strong>2. Regulation of Body Fluid Volume:</strong> This is a long-term regulatory mechanism primarily managed by the kidneys. When blood volume is high, pressure on the renal arteries increases, leading to increased glomerular filtration and excretion of sodium and water, which reduces blood volume and pressure. The opposite occurs when blood volume is low.<br><br><strong>3. The Renin-Angiotensin-Aldosterone System (RAAS):</strong> This powerful hormonal system is activated when renal blood flow is decreased. The kidneys release renin, which converts angiotensinogen to angiotensin I. Angiotensin-converting enzyme (ACE) then converts angiotensin I to angiotensin II. Angiotensin II is a potent vasoconstrictor that directly increases SVR and BP. It also stimulates the release of aldosterone from the adrenal cortex, which causes the kidneys to retain sodium and water, further increasing blood volume and pressure.<br><br><strong>4. Vascular Autoregulation:</strong> This allows individual tissues to regulate their own blood flow based on their metabolic needs. For instance, exercising muscle releases local vasodilators like lactic acid and carbon dioxide, which increase local blood flow to supply more oxygen and remove waste, without affecting systemic blood pressure.` },
                    { id: 'foundations-quiz', title: 'Foundations Quiz', type: 'quiz',
                      questions: [
                        { question: "What is the term for the amount of resistance the heart pumps against?", options: ["Preload", "Cardiac Output", "Stroke Volume", "Afterload (SVR)"], correctAnswer: "Afterload (SVR)" },
                        { question: "Which system is primarily responsible for long-term blood pressure control through fluid retention and vasoconstriction?", options: ["Arterial Baroreceptor System", "Vascular Autoregulation", "Renin-Angiotensin-Aldosterone System (RAAS)", "Central Nervous System"], correctAnswer: "Renin-Angiotensin-Aldosterone System (RAAS)" },
                      ]
                    },
                ]
            },
            'perfusion-hypertension': {
                title: 'Hypertension',
                color: 'from-red-500 to-orange-400',
                description: 'Explore the types, risk factors, and management of high blood pressure.',
                steps: [
                    { id: 'hypertension-types', title: 'Types of Hypertension', type: 'text', content: `Hypertension is a major risk factor for cardiovascular disease and impairs perfusion by increasing the workload of the heart and damaging the endothelium of arteries, leading to medial hyperplasia (thickening) and atherosclerosis.<br><br><strong>Essential (Primary) Hypertension:</strong> This is the most common type, accounting for 90-95% of cases. Its exact cause is unknown but is linked to a combination of genetic and environmental factors. It develops gradually over many years.<br><br><strong>Secondary Hypertension:</strong> This type is caused by a specific, identifiable disease state or medication. Common causes include chronic kidney disease, obstructive sleep apnea, thyroid disorders, and certain drugs like corticosteroids and NSAIDs. Treating the underlying cause can often resolve the hypertension.<br><br><strong>Hypertensive Crisis (Malignant Hypertension):</strong> This is a medical emergency where blood pressure rises rapidly and severely, often above 180/120 mm Hg. It can cause acute organ damage (e.g., encephalopathy, myocardial infarction, renal failure).<br>- <strong>Urgency:</strong> BP > 180/120 mm Hg without signs of acute organ damage. Management involves oral medications to gradually lower BP over 24-48 hours.<br>- <strong>Emergency:</strong> BP > 180/120 mm Hg WITH signs of acute organ damage. This requires immediate hospitalization and IV antihypertensive drugs to lower BP in a controlled manner.` },
                    { id: 'hypertension-guidelines', title: 'Screening & Guidelines', type: 'text', content: `Secondary prevention for perfusion issues heavily relies on regular blood pressure screening.<br><br><strong>JNC 8 Guidelines for Treatment:</strong><br>- For people over 60: Goal is a BP below <strong>150/90</strong> mm Hg.<br>- For people younger than 60: Goal is a BP below <strong>140/90</strong> mm Hg.<br>Patients with BPs above these goals should be treated with lifestyle modifications and drug therapy.<br><br><strong>AHA General Guidelines:</strong><br>- <strong>Normal:</strong> < 120/80 mm Hg<br>- <strong>Elevated:</strong> 120-129 / <80 mm Hg<br>- <strong>Stage 1 HTN:</strong> 130-139 / 80-89 mm Hg<br>- <strong>Stage 2 HTN:</strong> ≥ 140/90 mm Hg` },
                    { id: 'hypertension-risks', title: 'Common Risk Factors', type: 'text', content: `Several factors increase the risk for developing essential hypertension:<br><br>- <strong>Age:</strong> Being older than 60 years.<br>- <strong>Family History:</strong> Genetic predisposition.<br>- <strong>Obesity:</strong> Increases workload on the heart.<br>- <strong>Smoking:</strong> Nicotine is a vasoconstrictor.<br>- <strong>Physical Inactivity:</strong> Contributes to obesity and poor cardiovascular health.<br>- <strong>Hyperlipidemia:</strong> High cholesterol contributes to atherosclerosis.<br>- <strong>Stress:</strong> Can chronically elevate BP.<br>- <strong>Ethnicity:</strong> African American individuals have a higher risk of developing hypertension, often at an earlier age and with more severity.` },
                    { id: 'hypertension-prevention', title: 'Health Promotion & Prevention', type: 'text', content: `Primary prevention focuses on lifestyle modifications:<br><br><strong>1. Weight Reduction:</strong> Maintaining a healthy body weight (BMI 18.5-24.9) is crucial.<br><br><strong>2. DASH Diet:</strong> The Dietary Approaches to Stop Hypertension (DASH) eating plan is highly recommended. It emphasizes:<br>- Low sodium, saturated fat, and trans fats.<br>- Plenty of fruits, vegetables, and fiber-rich whole grains.<br>- Fish, skinless poultry, legumes, and nuts.<br>- Low-fat or fat-free dairy products.<br>- Limiting red meat and sugar-sweetened beverages.<br><br><strong>3. Reduce Sodium Intake:</strong> Lowering salt consumption helps reduce fluid retention and blood pressure.<br><br><strong>4. Increase Physical Activity:</strong> Aim for at least 150 minutes of moderate-intensity activity or 75 minutes of vigorous-intensity activity per week.<br><br><strong>5. Smoking Cessation:</strong> Quitting smoking is one of the most effective prevention strategies.` },
                    { id: 'hypertension-evaluation', title: 'Hypertension: Evaluation Outcomes', type: 'text', content: `The goals of care for a patient with hypertension are evaluated by their ability to:<br><br>- <strong>Verbalize Understanding:</strong> The patient can explain their plan of care, including drug therapy and necessary lifestyle changes.<br><br>- <strong>Report Adverse Effects:</strong> The patient knows to report common side effects of their medications, such as a persistent cough from ACE inhibitors, or dizziness and sexual dysfunction from beta-blockers and certain diuretics.<br><br>- <strong>Adhere to the Plan:</strong> The patient consistently follows the treatment plan, including taking medications as prescribed and attending regular follow-up appointments with their provider.` },
                    { id: 'hypertension-quiz', title: 'Hypertension Quiz', type: 'quiz',
                      questions: [
                        { question: "A patient's blood pressure is 190/122 mm Hg and they complain of a severe headache and blurred vision. This is considered a:", options: ["Stage 1 Hypertension", "Stage 2 Hypertension", "Hypertensive Urgency", "Hypertensive Emergency"], correctAnswer: "Hypertensive Emergency" },
                        { question: "Which of these is a key feature of the DASH diet?", options: ["High protein from red meat", "Low intake of fruits and vegetables", "Low sodium and high fiber", "Full-fat dairy products"], correctAnswer: "Low sodium and high fiber" }
                      ]
                    }
                ]
            },
            'perfusion-assessment': {
                title: 'Perfusion Assessment',
                color: 'from-blue-400 to-indigo-600',
                description: 'Learn how to assess for impaired perfusion, from vitals to advanced tools.',
                steps: [
                    { id: 'assessment-cues', title: 'Recognizing Cues', type: 'text', content: `A thorough assessment is critical for identifying impaired perfusion. The process involves multiple steps:<br><br><strong>1. Measure Vital Signs:</strong> Look for hypotension/hypertension and tachycardia/bradycardia. An irregular pulse suggests dysrhythmias.<br><br><strong>2. General Inspection:</strong> Observe skin color (pallor, cyanosis), respiratory effort, and any signs of distress.<br><br><strong>3. Thorax Inspection & Palpation:</strong> Look for heaves or lifts and palpate for thrills (vibrations indicating turbulent flow).<br><br><strong>4. Auscultation:</strong> Listen to heart sounds (S1, S2, and abnormal S3/S4 or murmurs) and vascular sounds (e.g., carotid bruits).<br><br><strong>5. Extremity Assessment:</strong> Inspect for skin color, hair distribution, and signs of edema. Palpate for temperature, capillary refill (<2 sec is normal), and peripheral pulse strength (0 to 4+ scale).<br><br><strong>6. Advanced Assessments:</strong> When indicated, perform measurements like ankle-brachial index (ABI) for PAD, leg circumferences for DVT, and pulse deficit for dysrhythmias.` },
                    { id: 'assessment-history', title: 'Assessment: Patient History', type: 'text', content: `Gathering subjective data is key. Inquire about:<br><br><strong>Problem-Based History (Symptoms):</strong><br>- <strong>Pain:</strong> Ischemic pain is a hallmark of poor perfusion. Chest pain (angina) or leg pain (claudication) are common.<br>- <strong>Dyspnea:</strong> Shortness of breath, especially on exertion, can indicate heart failure.<br>- <strong>Edema:</strong> Swelling in the extremities can signal fluid overload from heart, renal, or liver failure.<br>- <strong>Dizziness/Syncope:</strong> Lightheadedness or fainting may result from orthostatic hypotension or inadequate blood flow to the brain.` },
                    { id: 'assessment-diagnostics', title: 'Assessment: Diagnostic Cues', type: 'text', content: `Lab and imaging results provide objective data for impaired perfusion.<br><br><strong>For Hypertension:</strong><br>- <strong>Urinalysis:</strong> May show protein or RBCs, indicating kidney damage.<br>- <strong>Chest X-ray:</strong> Can reveal cardiomegaly (enlarged heart).<br>- <strong>ECG:</strong> May show signs of left ventricular hypertrophy, a consequence of the heart working harder against high pressure.<br><br><strong>For Clotting Disorders:</strong><br>- <strong>CBC with Platelet Count:</strong> Assesses for anemia, polycythemia, and thrombocytopenia.<br>- <strong>Coagulation Studies:</strong> PT, INR, and aPTT are crucial for monitoring anticoagulant therapy.<br>- <strong>D-dimer:</strong> A level < 0.4 mcg/mL can help rule out a thrombus.` },
                    { id: 'assessment-quiz', title: 'Assessment Quiz', type: 'quiz',
                      questions: [
                        { question: "A capillary refill time of 4 seconds indicates:", options: ["Normal perfusion", "Impaired perfusion", "Fluid overload", "A normal finding in older adults"], correctAnswer: "Impaired perfusion" },
                        { question: "An enlarged heart on a chest x-ray, known as cardiomegaly, is a potential diagnostic cue for which condition?", options: ["Deep Vein Thrombosis", "Anemia", "Chronic Hypertension", "Acute Ischemia"], correctAnswer: "Chronic Hypertension" }
                      ]
                    }
                ]
            },
            'perfusion-clotting-vte': {
                title: 'Clotting & VTE',
                color: 'from-purple-500 to-pink-500',
                description: 'Understand the clotting process and the pathophysiology of Venous Thromboembolism (VTE).',
                steps: [
                    { id: 'clotting-cascade', title: 'The Clotting Process', type: 'text', content: `When a blood vessel is injured, a complex process called the coagulation cascade is initiated to stop bleeding.<br><br><strong>1. Vasoconstriction:</strong> The injured vessel constricts to reduce blood flow.<br><strong>2. Platelet Plug Formation:</strong> Platelets become activated and adhere to the injury site, forming a temporary plug.<br><strong>3. Coagulation Cascade:</strong> A series of clotting factors are activated, leading to a common final pathway where <strong>thrombin</strong> converts soluble <strong>fibrinogen</strong> into insoluble <strong>fibrin</strong>. This fibrin forms a mesh that stabilizes the platelet plug, creating a durable clot.` },
                    { id: 'virchows-triad', title: 'Virchow\'s Triad', type: 'text', content: `The formation of a thrombus (a blood clot within a vessel), such as in Deep Vein Thrombosis (DVT), is promoted by three factors known as Virchow's Triad:<br><br><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">1. Blood Flow Stasis</h4>
                            <p class="text-sm">Decreased blood flow, often due to immobility, obesity, or varicose veins.</p>
                        </div>
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">2. Endothelial Injury</h4>
                            <p class="text-sm">Damage to the inner lining of the blood vessel from surgery, trauma, or infection.</p>
                        </div>
                        <div class="p-4 bg-gray-200 rounded-lg">
                            <h4 class="font-bold">3. Hypercoagulability</h4>
                            <p class="text-sm">An increased tendency for blood to clot, caused by cancer, sepsis, dehydration, or genetic disorders.</p>
                        </div>
                    </div>` },
                    { id: 'dvt-assessment', title: 'DVT Assessment', type: 'text', content: `Recognizing a DVT is crucial to prevent a life-threatening pulmonary embolism.<br><br><strong>Signs & Symptoms:</strong> Often may be asymptomatic. Classic signs include calf or groin pain and sudden onset of unilateral leg swelling, warmth, and redness.<br><br><strong>Diagnostic Assessment:</strong><br>- <strong>Venous Duplex Ultrasonography:</strong> The primary diagnostic tool to visualize the thrombus.<br>- <strong>D-dimer Test:</strong> Measures a product of fibrin degradation. A negative result helps rule out DVT, but a positive result is not definitive as it can be elevated in other conditions.<br>- <strong>Padua Prediction Score (PPS):</strong> A clinical tool used to assess a patient's risk for VTE.` },
                    { id: 'dvt-management', title: 'DVT Management & Anticoagulation', type: 'text', content: `The primary goals are to prevent the thrombus from growing and to prevent it from becoming a pulmonary embolism.<br><br><strong>Nonsurgical Management:</strong><br>- Early ambulation and leg exercises.<br>- Graduated compression stockings.<br>- Sequential Compression Devices (SCDs).<br>- Anticoagulant therapy is the cornerstone of treatment.<br><br><strong>Anticoagulant Therapy:</strong><br>- <strong>Heparin:</strong> Unfractionated Heparin (UFH) is given IV and requires monitoring of aPTT. Low-Molecular-Weight Heparin (LMWH, e.g., enoxaparin) is given subcutaneously and does not require regular lab monitoring.<br>- <strong>Warfarin (Coumadin):</strong> An oral anticoagulant that requires monitoring of PT/INR. It is often started while the patient is on heparin, and heparin is discontinued once the INR is therapeutic (usually >2.0).<br>- <strong>Direct Oral Anticoagulants (DOACs):</strong> Newer agents like rivaroxaban and apixaban that do not require frequent lab monitoring.<br><br><strong>Antidotes:</strong><br>- Heparin: <strong>Protamine Sulfate</strong><br>- Warfarin: <strong>Vitamin K</strong><br>- Dabigatran (DOAC): <strong>Idarucizumab (Praxbind)</strong><br>- Apixaban & Rivaroxaban (DOACs): <strong>Andexanet alfa (Andexxa)</strong>` },
                    { id: 'aging-clotting-teaching', title: 'Aging & Patient Teaching', type: 'text', content: `<strong>Hematologic Changes with Aging:</strong><br>As people age, several changes occur in the hematologic system that can affect clotting and perfusion:<br>- <strong>Decreased Blood Volume:</strong> With lower levels of plasma proteins.<br>- <strong>Reduced Blood Cell Production:</strong> Bone marrow becomes less productive.<br>- <strong>Lower Blood Counts:</strong> Total RBC and WBC counts are often lower.<br>- <strong>Decreased Immune Function:</strong> Lymphocytes become less reactive to antigens.<br>- <strong>Lower Hemoglobin:</strong> Levels tend to fall after middle age.<br><br><strong>Patient Teaching & Bleeding Precautions:</strong><br>For patients on anticoagulants or with decreased clotting ability, education is vital:<br>- Use an electric razor instead of a blade.<br>- Use a soft-bristled toothbrush.<br>- Avoid rectal temperature measurements.<br>- Implement strict fall precautions.<br>- Report any unusual bleeding or bruising immediately.` },
                     { id: 'clotting-quiz', title: 'Clotting & VTE Quiz', type: 'quiz',
                      questions: [
                        { question: "A post-operative patient who is immobile is at risk for DVT primarily due to which part of Virchow's Triad?", options: ["Endothelial Injury & Blood Flow Stasis", "Hypercoagulability only", "Blood Flow Stasis only", "Endothelial Injury only"], correctAnswer: "Endothelial Injury & Blood Flow Stasis" },
                        { question: "A patient is receiving an IV infusion of Unfractionated Heparin. Which lab value must the nurse monitor closely?", options: ["INR", "Platelet Count", "aPTT", "D-dimer"], correctAnswer: "aPTT" }
                      ]
                    }
                ]
            },
            'perfusion-exemplars': {
                title: 'Major Perfusion Exemplars',
                color: 'from-emerald-500 to-green-500',
                description: 'In-depth review of critical conditions affecting perfusion, such as PE, MI, and Heart Failure.',
                steps: [
                    { id: 'pe-intro', title: 'Pulmonary Embolism: Patho', type: 'text', content: `<strong>What is a Pulmonary Embolism (PE)?</strong><br>A PE is a life-threatening condition that occurs when a blood clot (thrombus) or other particulate matter (e.g., air, fat) becomes lodged in a pulmonary artery, obstructing blood flow to a portion of the lungs. The most common cause is a thrombus that originates from a deep vein thrombosis (DVT) in the legs or pelvis.<br><br><strong>Pathophysiology:</strong> When the embolus obstructs the pulmonary artery, it impairs gas exchange and circulation. This leads to:<br>- <strong>Ventilation-Perfusion (V/Q) Mismatch:</strong> The affected lung area is ventilated (receives air) but not perfused (receives blood), leading to profound hypoxemia.<br>- <strong>Increased Pulmonary Vascular Resistance:</strong> The obstruction increases the pressure in the pulmonary arteries, forcing the right ventricle to work much harder. This can lead to right ventricular failure and obstructive shock.` },
                    { id: 'pe-assessment', title: 'PE: Assessment & Cues', type: 'text', content: `<strong>Risk Factors:</strong><br>- Prolonged immobility (e.g., post-surgery, long travel)<br>- History of DVT or PE<br>- Major surgery (especially orthopedic)<br>- Malignancy (cancer)<br>- Obesity<br>- Use of oral contraceptives<br>- Smoking<br><br><strong>Clinical Manifestations:</strong><br>- <strong>Sudden onset of dyspnea and pleuritic chest pain</strong> (sharp pain that worsens on inspiration).<br>- Tachycardia and tachypnea.<br>- Cough, sometimes with hemoptysis (coughing up blood).<br>- Feelings of anxiety or a sense of impending doom.<br>- In massive PE, hypotension, syncope, and signs of shock may be present.<br><br><strong>Diagnostic Cues:</strong><br>- <strong>CT Pulmonary Angiography (CTPA):</strong> The gold standard for diagnosing PE.<br>- <strong>V/Q Scan:</strong> Used if CTPA is contraindicated (e.g., renal failure, contrast allergy).<br>- <strong>D-dimer:</strong> High sensitivity but low specificity. Useful for ruling out PE in low-risk patients.<br>- <strong>ECG:</strong> May show signs of right heart strain (e.g., new RBBB, S1Q3T3 pattern).` },
                    { id: 'pe-management', title: 'PE: Management & Nursing Care', type: 'text', content: `Management of PE is a medical emergency focused on stabilizing the patient and restoring pulmonary perfusion.<br><br><strong>Immediate Interventions:</strong><br>- <strong>Oxygen Therapy:</strong> Administer high-flow oxygen to treat hypoxemia.<br>- <strong>Anticoagulation:</strong> Immediate initiation of heparin (usually UFH or LMWH) is critical to prevent new clots from forming and to stop the existing clot from growing.<br>- <strong>Thrombolytic Therapy:</strong> For massive PE causing hemodynamic instability (hypotension), thrombolytics like alteplase may be used to dissolve the clot.<br><br><strong>Surgical/Endovascular Management:</strong><br>- <strong>Embolectomy:</strong> Surgical removal of the clot.<br>- <strong>Catheter-Directed Thrombolysis:</strong> A catheter is threaded to the clot to deliver thrombolytic agents directly.<br>- <strong>Inferior Vena Cava (IVC) Filter:</strong> May be placed to "catch" clots from the lower extremities in patients who have recurrent PEs or a contraindication to anticoagulation.<br><br><strong>Nursing Priorities:</strong><br>- Monitor for signs of bleeding (a major complication of anticoagulants/thrombolytics).<br>- Monitor respiratory status, vital signs, and cardiac rhythm closely.<br>- Manage anxiety and provide patient education on long-term anticoagulation.` },
                    { id: 'mi-intro', title: 'Myocardial Infarction: Patho', type: 'text', content: `<strong>What is a Myocardial Infarction (MI)?</strong><br>An MI, or heart attack, is the irreversible death (necrosis) of heart muscle tissue caused by prolonged ischemia. It is a life-threatening condition resulting from an abrupt cessation of blood flow to a portion of the myocardium.<br><br><strong>Pathophysiology:</strong> The most common cause of an MI is the rupture of an atherosclerotic plaque in a coronary artery. This rupture triggers the clotting cascade, leading to the formation of a thrombus that occludes the artery. The lack of blood flow deprives the myocardial cells of oxygen, leading to injury and, if not restored quickly, necrosis. The location and size of the infarct depend on which coronary artery is occluded.` },
                    { id: 'mi-assessment', title: 'MI: Assessment & Cues', type: 'text', content: `<strong>Risk Factors:</strong><br>- Atherosclerosis, Coronary Artery Disease (CAD)<br>- Hypertension, Hyperlipidemia, Diabetes<br>- Smoking<br>- Family History<br>- Obesity and sedentary lifestyle<br><br><strong>Clinical Manifestations:</strong><br>- <strong>Chest Pain:</strong> Often described as crushing, squeezing, or "like an elephant on the chest." It may radiate to the left arm, jaw, or back and is not relieved by rest or nitroglycerin.<br>- Shortness of breath (dyspnea).<br>- Diaphoresis (sweating), nausea, vomiting.<br>- Anxiety, lightheadedness.<br>- <strong>Atypical Presentations:</strong> Women, older adults, and patients with diabetes may present with atypical symptoms like fatigue, indigestion, or shoulder pain instead of classic chest pain.<br><br><strong>Diagnostic Cues:</strong><br>- <strong>ECG:</strong> The hallmark sign of an acute MI is ST-segment elevation (STEMI). Other changes can include T-wave inversion or new left bundle branch block.<br>- <strong>Cardiac Troponins:</strong> These are proteins released from damaged heart muscle. They are highly specific to cardiac injury and are the most important lab marker for diagnosing MI. Levels begin to rise within a few hours and can remain elevated for days.` },
                    { id: 'mi-management', title: 'MI: Management & Nursing Care', type: 'text', content: `The goal of MI management is to restore perfusion to the heart muscle as quickly as possible ("time is muscle").<br><br><strong>Immediate Interventions (Mnemonic: MONA):</strong><br>- <strong>M</strong>orphine: For pain relief and vasodilation.<br>- <strong>O</strong>xygen: To improve oxygenation of ischemic tissue.<br>- <strong>N</strong>itroglycerin: A vasodilator to improve coronary blood flow and reduce preload/afterload.<br>- <strong>A</strong>spirin: An antiplatelet agent to prevent further clot formation.<br><br><strong>Reperfusion Therapy:</strong><br>- <strong>Percutaneous Coronary Intervention (PCI):</strong> The preferred method. A catheter is used to perform an angioplasty and place a stent to open the occluded artery. The goal is "door-to-balloon" time of less than 90 minutes.<br>- <strong>Fibrinolytic (Thrombolytic) Therapy:</strong> Drugs like alteplase are used to dissolve the clot if PCI is not available in a timely manner.<br><br><strong>Nursing Priorities:</strong><br>- Continuous cardiac monitoring for life-threatening dysrhythmias.<br>- Frequent vital sign assessment.<br>- Administering medications and monitoring for therapeutic and adverse effects.<br>- Providing emotional support and patient education.` },
                    { id: 'hf-intro', title: 'Heart Failure: Patho', type: 'text', content: `<strong>What is Heart Failure (HF)?</strong><br>Heart Failure is a chronic, progressive condition in which the heart muscle is unable to pump enough blood to meet the body's needs for blood and oxygen. It is not a single disease but a syndrome that develops as a result of other conditions that have damaged the heart, such as hypertension, CAD, and MI.<br><br><strong>Pathophysiology:</strong> HF can be classified in several ways:<br>- <strong>Left-Sided vs. Right-Sided:</strong><br>  - <strong>Left-Sided HF:</strong> The left ventricle cannot pump effectively, causing blood to back up into the pulmonary circulation. This leads to pulmonary congestion and edema.<br>  - <strong>Right-Sided HF:</strong> The right ventricle cannot pump effectively, causing blood to back up into the systemic venous circulation. This leads to peripheral edema, jugular venous distention, and hepatomegaly.<br>- <strong>Systolic vs. Diastolic:</strong><br>  - <strong>Systolic HF (HFrEF):</strong> The heart has a pumping problem (impaired contractility). The ejection fraction is reduced (<40%).<br>  - <strong>Diastolic HF (HFpEF):</strong> The heart has a filling problem (impaired relaxation and stiff ventricles). The ejection fraction is preserved.` },
                    { id: 'hf-assessment', title: 'HF: Assessment & Cues', type: 'text', content: `<strong>Clinical Manifestations:</strong><br>- <strong>Left-Sided HF:</strong><br>  - Dyspnea, orthopnea, paroxysmal nocturnal dyspnea (PND).<br>  - Crackles on lung auscultation.<br>  - Pink, frothy sputum (a sign of acute pulmonary edema).<br>  - S3 heart sound ("ventricular gallop").<br>- <strong>Right-Sided HF:</strong><br>  - Peripheral edema (pitting edema in the legs and feet).<br>  - Jugular Venous Distention (JVD).<br>  - Ascites (fluid in the abdomen).<br>  - Hepatomegaly (enlarged liver).<br>- <strong>General Symptoms:</strong> Fatigue, weakness, weight gain from fluid retention.<br><br><strong>Diagnostic Cues:</strong><br>- <strong>B-type Natriuretic Peptide (BNP):</strong> A hormone released by the ventricles in response to stretching. A high BNP level is a key indicator of HF.<br>- <strong>Echocardiogram:</strong> The most useful test to diagnose HF. It measures the ejection fraction and visualizes heart chamber size and valve function.<br>- <strong>Chest X-ray:</strong> Can show cardiomegaly and signs of pulmonary congestion.` },
                    { id: 'hf-management', title: 'HF: Management & Nursing Care', type: 'text', content: `Management of HF focuses on treating the underlying cause, reducing symptoms, and improving quality of life.<br><br><strong>Pharmacologic Management:</strong><br>- <strong>Diuretics:</strong> To reduce fluid volume (e.g., furosemide).<br>- <strong>ACE Inhibitors or ARBs:</strong> To reduce afterload and improve cardiac output.<br>- <strong>Beta-Blockers:</strong> To block the negative effects of the sympathetic nervous system on the heart.<br>- <strong>Digoxin:</strong> To increase contractility and decrease heart rate.<br><br><strong>Nursing Priorities:</strong><br>- <strong>Fluid Balance Management:</strong> Monitor daily weights, intake and output, and administer diuretics as ordered. A weight gain of >3 lbs in 2 days or >5 lbs in a week is a red flag.<br>- <strong>Patient Education:</strong> Teach patients about their medication regimen, low-sodium diet, daily weight monitoring, and when to call their provider.<br>- <strong>Promote Activity:</strong> Encourage a balance of rest and activity to improve functional status without overtaxing the heart.` },
                ]
            },
            'perfusion-case-studies': {
                title: 'Perfusion Case Studies',
                color: 'from-rose-400 to-red-500',
                description: 'Apply your knowledge with clinical case studies.',
                steps: [
                    { id: 'george-jones-case-study', title: 'Case Study: George Jones', type: 'case_study', case: {
                      scenario: `George Jones, a 59-year-old male, arrived at the emergency department with chest pain that he had experienced for 30 minutes, and it was not relieved after taking four nitroglycerin tablets 5 minutes apart. He reports the pain feels “like an elephant is sitting on my chest.” He is diaphoretic and appears anxious. His vital signs are as follows: temperature, 99°F; blood pressure, 100/68 mm Hg; heart rate, 110 beats/min; and respiratory rate, 24 breaths per minute. Mr. Jones is overweight and has type 2 diabetes, hyperlipidemia, and hypertension. He quit smoking last year after a 40-year history of smoking one pack of cigarettes a day. His troponin level is elevated, and his ECG shows ST segment elevation. The nurse administers oxygen and draws blood for arterial blood gas analysis. Mr. Jones is told he will undergo cardiac catheterization to locate the blockage, determine its severity, and evaluate left ventricular function.`,
                      question: "Based on Mr. Jones's presentation and history, what is the most likely primary diagnosis related to his impaired perfusion?",
                      options: ["Pulmonary Embolism", "Hypovolemic Shock", "Acute Myocardial Infarction", "Hypertensive Crisis"],
                      correctAnswer: "Acute Myocardial Infarction",
                      explanation: "Mr. Jones's symptoms (crushing chest pain not relieved by nitroglycerin, diaphoresis, anxiety), risk factors (age, overweight, type 2 diabetes, hyperlipidemia, hypertension, history of smoking), and vital signs, along with elevated troponin and ST segment elevation on ECG, are classic indicators of an acute myocardial infarction (heart attack). This represents severe impaired central and localized tissue perfusion to the heart muscle. Pulmonary embolism might cause chest pain but typically with pleurisy and different vitals. Hypovolemic shock would have signs of fluid loss. A hypertensive crisis would show significantly elevated blood pressure."
                    }},
                    { id: 'george-jones-questions', title: 'Case Study: Analysis Questions', type: 'text', content: `<strong>1. What risk factors does Mr. Jones have for impaired perfusion?</strong><br>Mr. Jones has several significant risk factors for impaired perfusion, both modifiable and unmodifiable:<br>- <strong>Age:</strong> 59 years old (risk increases with age).<br>- <strong>Gender:</strong> Male (men > women for heart disease risk).<br>- <strong>Overweight:</strong> Contributes to obesity, increasing risk for diabetes and atherosclerosis.<br>- <strong>Type 2 Diabetes:</strong> Increases risk of atherosclerosis.<br>- <strong>Hyperlipidemia:</strong> Contributes to atherosclerosis by plaque buildup.<br>- <strong>Hypertension:</strong> Increases workload of myocardium and damages endothelium.<br>- <strong>History of Smoking:</strong> Quit smoking last year after 40 years, indicating significant past exposure to a major vasoconstrictor and endothelial toxin, increasing atherosclerosis risk.<br><br><strong>2. Does this case exemplify an impairment of local perfusion, central perfusion, or both?</strong><br>This case exemplifies an impairment of <strong>both local and central perfusion</strong>.<br>- <strong>Local Perfusion Impairment:</strong> The blockage in a coronary artery directly impairs blood flow to a specific area of the myocardium, leading to myocardial ischemia and ultimately irreversible cell death (necrosis) in that localized tissue (Acute Myocardial Infarction).<br>- <strong>Central Perfusion Impairment:</strong> An acute myocardial infarction, especially one with significant damage, directly affects the heart's ability to pump efficiently. Mr. Jones's vital signs (BP 100/68 mm Hg, HR 110 beats/min) suggest that his heart is struggling to maintain adequate cardiac output, leading to impaired central perfusion. If severe, this can lead to large-scale, systemic impairment affecting multiple organs and potentially cardiovascular collapse.`},
                ]
            },
        };

        const preAssessmentQuizData = [
            { moduleId: 'perfusion-foundations', question: "A patient's stroke volume is 70 mL and their heart rate is 80 bpm. The nurse calculates the cardiac output to be 5.6 L/min. This value is primarily an indicator of:", options: ["Local tissue perfusion", "Vascular autoregulation", "Central perfusion", "Capillary permeability"], correctAnswer: "Central perfusion" },
            { moduleId: 'perfusion-foundations', question: "A patient is admitted with severe dehydration. The nurse anticipates that the resulting hypovolemia will most directly decrease which component of cardiac output?", options: ["Afterload", "Preload", "Contractility", "Systemic Vascular Resistance"], correctAnswer: "Preload" },
            { moduleId: 'perfusion-hypertension', question: "A 62-year-old male patient with a history of smoking and a BMI of 31 has a blood pressure of 154/92 mm Hg. According to JNC 8 guidelines, what is the priority action?", options: ["Recheck the BP in 6 months", "Advise a low-sodium diet only", "Initiate lifestyle modifications and drug therapy", "Tell the patient this is a normal finding for his age"], correctAnswer: "Initiate lifestyle modifications and drug therapy" },
            { moduleId: 'perfusion-hypertension', question: "A patient taking an ACE inhibitor for hypertension calls the clinic complaining of a persistent, dry cough. What is the nurse's best response?", options: ["'This is a normal side effect that will go away on its own.'", "'This is a common side effect, and you should discuss it with your provider as a different medication may be needed.'", "'You are likely developing a respiratory infection.'", "'Stop taking the medication immediately.'"], correctAnswer: "'This is a common side effect, and you should discuss it with your provider as a different medication may be needed.'" },
            { moduleId: 'perfusion-assessment', question: "The nurse is assessing a patient with suspected peripheral arterial disease (PAD). Which finding would be most consistent with this diagnosis?", options: ["Bounding pedal pulses", "Warm, pink extremities", "Unilateral leg swelling and redness", "Absent dorsalis pedis pulse and shiny, hairless skin on the leg"], correctAnswer: "Absent dorsalis pedis pulse and shiny, hairless skin on the leg" },
            { moduleId: 'perfusion-assessment', question: "When auscultating the heart of a patient with heart failure and fluid volume overload, the nurse hears an extra sound early in diastole. This sound is documented as:", options: ["S1", "S4 heart sound", "A friction rub", "S3 heart sound"], correctAnswer: "S3 heart sound" },
            { moduleId: 'perfusion-clotting-vte', question: "A patient who underwent a total knee replacement 3 days ago is at high risk for a DVT. This increased risk is best explained by which factors of Virchow's Triad?", options: ["Endothelial injury and blood stasis", "Hypercoagulability and blood stasis", "Endothelial injury only", "Hypercoagulability only"], correctAnswer: "Endothelial injury and blood stasis" },
            { moduleId: 'perfusion-clotting-vte', question: "A patient is being discharged on warfarin after a DVT. Which statement by the patient indicates a need for further teaching?", options: ["'I will use a soft toothbrush and an electric razor.'", "'I need to have my INR checked regularly.'", "'I should eat large salads with spinach every day to increase my Vitamin K.'", "'I will report any unusual bruising or bleeding to my doctor.'"], correctAnswer: "'I should eat large salads with spinach every day to increase my Vitamin K.'" },
            { moduleId: 'perfusion-stroke', question: "A patient is brought to the ED with slurred speech and right-sided weakness that began 1 hour ago. Which diagnostic test is the highest priority to determine treatment?", options: ["MRI of the brain", "Carotid duplex ultrasound", "Non-contrast head CT scan", "Lumbar puncture"], correctAnswer: "Non-contrast head CT scan" },
            { moduleId: 'perfusion-stroke', question: "During administration of alteplase (rt-PA) for an ischemic stroke, the patient becomes difficult to arouse. What is the nurse's priority action?", options: ["Continue the infusion as ordered.", "Stop the infusion immediately and notify the provider.", "Check the patient's blood glucose level.", "Administer an anti-anxiety medication."], correctAnswer: "Stop the infusion immediately and notify the provider." },
        ];

        // --- Helper Functions ---
        // Utility for conditionally joining Tailwind CSS classes.
        const cn = (...classes) => classes.filter(Boolean).join(' ');


        // --- Child Components ---

        /**
         * Quiz component for interactive multiple-choice questions.
         * Users answer questions and receive immediate feedback.
         */
        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return;
                setSelectedOption(option);
            };

            const handlePreAssessmentNext = () => {
                if (selectedOption === null) return;
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null);
                } else {
                    onComplete(updatedAnswers);
                }
            };
            
            const handleRegularQuizSubmit = () => {
                if (selectedOption === null) return;
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                setFeedback(isCorrect ? 'correct' : 'incorrect');
                // The onComplete for regular quizzes is handled by handleRegularQuizNext
            };

            const handleRegularQuizNext = () => {
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const finalAnswers = [...answers, { question: currentQuestion, isCorrect }];
                
                if (currentQuestionIndex < questions.length - 1) {
                    setAnswers(finalAnswers);
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null);
                    setFeedback(null);
                } else {
                    const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-3">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = selectedOption === option;
                            const isCorrectOption = option.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';

                            if (feedback && !isPreAssessment) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : <span className="text-red-600 mr-2">✗</span>
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 text-center">
                        {isPreAssessment ? (
                             <button
                                onClick={handlePreAssessmentNext}
                                disabled={selectedOption === null}
                                className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                            </button>
                        ) : (
                            <>
                            {!feedback ? (
                                <button
                                    onClick={handleRegularQuizSubmit}
                                    disabled={selectedOption === null}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Submit Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleRegularQuizNext}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Next Question
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-6">
                                You correctly answered {results.correct} out of {results.total} questions.
                            </p>
                            {results.completedModules.length > 0 ? (
                                <>
                                    <p className="text-green-600 font-semibold mb-4">You've tested out of the following modules:</p>
                                    <ul className="list-disc list-inside text-left mb-6 bg-green-50 p-4 rounded-lg">
                                        {results.completedModules.map(id => <li key={id}>{contentData[id].title}</li>)}
                                    </ul>
                                </>
                            ) : (
                                <p className="text-yellow-600 font-semibold mb-6">You haven't tested out of any modules. We recommend reviewing all of them.</p>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                            >
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Skip Ahead: Diagnostic Quiz</h2>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };


        /**
         * Dashboard component to display the various learning modules.
         * It allows users to select a module to start learning.
         * Shows progress for each module using a circular progress bar and status.
         */
        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            // Calculate overall progress and gather quiz scores
            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });


            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <div className="w-full">
                        <header className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                {/* Text placeholder for the main application identifier */}
                                <span className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">PLM</span>
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Perfusion Learning Module</h1>
                                <span className="bg-gray-200 text-gray-600 text-xs font-mono px-2.5 py-1 rounded-full">V:5</span>
                            </div>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">Explore key concepts of perfusion through interactive modules designed for comprehensive understanding.</p>
                        </header>

                        {/* Skip Ahead Button */}
                        <div className="mb-8 text-center">
                            <button
                                onClick={onStartPreAssessment}
                                className="w-full max-w-md mx-auto px-6 py-4 bg-teal-500 text-white font-bold rounded-lg shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105"
                            >
                                <div className="text-xl">Skip Ahead: Take Diagnostic Quiz</div>
                                <div className="text-sm font-normal">Test out of modules you already know.</div>
                            </button>
                        </div>

                        {/* Overall Progress Bar & Reset Button */}
                        <div className="mb-8 bg-white rounded-2xl shadow-lg p-6 w-full">
                           <div className="flex justify-between items-center mb-3">
                             <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
                             <button 
                                onClick={onResetProgress}
                                className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2"
                             >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" />
                                </svg>
                                Reset Progress
                             </button>
                           </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallPercentage}%` }}
                                ></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-left text-sm text-gray-600 mt-2">
                                    {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
                                </p>
                                <p className="text-right text-sm text-gray-600 mt-2">{Math.round(overallPercentage)}% Completed</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                            {/* Iterate over all modules defined in contentData */}
                            {Object.entries(contentData).map(([id, module]) => {
                                const moduleProgress = progress[id] || {};
                                // Calculate completion count for steps within the module.
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-green-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                // Get quiz score for this module if available
                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        // Styling for module cards, including hover effects.
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            {/* Placeholder for module icon: Displays the first letter of the module title. */}
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-10 h-10 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.title.split(' ').map(word => word.charAt(0)).join('')}
                                            </div>
                                            {/* Progress Circle */}
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    {/* Background circle for the progress bar. */}
                                                    <path
                                                        className="text-gray-200"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                    />
                                                    {/* Foreground arc representing the completion percentage. */}
                                                    <path
                                                        className="text-indigo-500"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                        strokeDasharray={`${percentage}, 100`}
                                                        strokeLinecap="round"
                                                        transform="rotate(-90 18 18)"
                                                    />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10">{module.description}</p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * CaseStudy component for a multiple-choice case study challenge.
         * Presents a scenario and a question with multiple options.
         */
        const CaseStudy = ({ caseData, onComplete }) => {
            // State to store the user's selected answer.
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            // Handles the selection of an answer option.
            const handleSelect = (option) => {
                if (selectedAnswer) return; // Prevents changing the answer once selected.
                setSelectedAnswer(option);
                // Case-insensitive comparison
                if (option.toLowerCase() === caseData.correctAnswer.toLowerCase()) {
                    onComplete(); // Marks the step as complete if the correct answer is chosen.
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Case Study Challenge</h4>
                    {/* Scenario description, using dangerouslySetInnerHTML to render HTML bold tags */}
                    <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-3">{caseData.question}</p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrect = option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                            const showFeedback = selectedAnswer !== null; // Show feedback once any answer is selected

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling for options.
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission
                            }

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {showFeedback && ( // Display a checkmark or cross icon if feedback is active
                                            isCorrect ? <span className="text-green-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedAnswer && ( // Display the explanation after an answer has been selected.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * VitalsCheck component for an interactive question about vital signs.
         * Users identify the most concerning vital sign from a given set.
         */
        const VitalsCheck = ({ onComplete }) => {
            // State to store the user's selected vital sign.
            const [selectedVital, setSelectedVital] = useState(null);
            const vitals = { "BP": "100/68 mmHg", "HR": "110 bpm", "RR": "24/min", "Temp": "99°F" };
            const mostConcerning = "HR"; // The correct answer.
            const explanation = "A heart rate of 110 bpm (tachycardia) is a significant sign of distress. It indicates the heart is working hard to compensate for poor perfusion, which is common during an acute myocardial infarction.";

            // Handles the selection of a vital sign option.
            const handleSelect = (vital) => {
                if(selectedVital) return; // Prevents changing the selection once made.
                setSelectedVital(vital);
                // Case-insensitive comparison (though keys are already consistent)
                if (vital.toLowerCase() === mostConcerning.toLowerCase()) {
                    onComplete(); // Mark step as complete if correct answer is chosen
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Vitals Check</h4>
                    <p className="text-sm text-gray-600 mb-4">A patient presents with chest pain. Based on these vital signs, which one is the MOST concerning indicator of impaired central perfusion?</p>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {Object.entries(vitals).map(([key, value]) => {
                            const isSelected = selectedVital === key;
                            // Case-insensitive comparison for correct answer highlight
                            const isCorrect = key.toLowerCase() === mostConcerning.toLowerCase();
                            const showFeedback = selectedVital !== null; // Show feedback once any vital is selected

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200'; // Default styling.
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800'; // Correct answer always green when feedback is shown
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800'; // Incorrect selected answer is red
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800'; // Highlight selected before submission
                            }
                            return (
                                <div key={key} onClick={() => handleSelect(key)} className={cn('p-4 rounded-lg border-2 cursor-pointer text-center', optionClass)}>
                                    <div className="text-sm font-bold text-gray-500">{key}</div>
                                    <div className="text-xl font-semibold text-gray-800">{value}</div>
                                </div>
                            );
                        })}
                    </div>
                   {selectedVital && ( // Display the rationale after a selection is made.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Rationale</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * StaticContentStep component for displaying basic text content.
         * Marks itself as complete immediately on render.
         */
        const StaticContentStep = ({ step, onComplete }) => {
            // For 'text' type steps, mark them as complete immediately upon rendering.
            // The effect should only run once when the component mounts to prevent an infinite loop.
            useEffect(() => {
                onComplete();
            }, []); // Empty dependency array ensures this runs only once.

            // Using dangerouslySetInnerHTML to render HTML content (e.g., <strong> tags).
            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg shadow-inner space-y-4" dangerouslySetInnerHTML={{ __html: step.content }}>
                </div>
            );
        };

        /**
         * CompletionModal component displayed when a module is completed.
         */
        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
                        <h3 className="text-2xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors shadow-sm"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * LearningModule component to manage steps within the selected module.
         * Provides navigation between steps and renders the appropriate content for each.
         */
        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0); // Manages the index of the currently active step.
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Controls the visibility of the sidebar on mobile.
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false); // State for completion modal

            // Callback function to update the completion status of a specific step.
            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            
            // Check if all steps in the current module are completed
            const allStepsCompletedInModule = module.steps.every(step =>
                moduleProgress[step.id] && moduleProgress[step.id].completed
            );

            // Navigates to the next step, if available.
            const handleNextStep = () => {
                // If it's the last step and all steps in the module are completed, open the modal
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            // Navigates to the previous step, if available.
            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };
            
            // Ensure module and its steps are defined before accessing properties
            if (!module || !module.steps) {
                console.error("LearningModule received invalid module prop:", module);
                return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Loading module...</div>;
            }

            const currentStep = module.steps[activeStep];
            
            // Renders the appropriate content component based on the current step's type.
            // This function acts as a router for different interactive and static content types.
            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;

                const onCompleteForStep = (data) => handleStepComplete(step.id, data);

                switch (step.type) {
                    case 'text':
                        return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'interactive_vitals':
                        return <VitalsCheck key={step.id} onComplete={onCompleteForStep} />;
                    case 'case_study':
                        return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz':
                        return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default:
                        // Fallback for unrecognized step types, ensuring robust error handling.
                        return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack(); // Go back to dashboard when modal is closed
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule(); // Proceed to next module
            };


            return (
                <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
                    {/* Header for the learning module, including back button and module title. */}
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        </div>
                        {/* Mobile sidebar toggle button using text/emoji placeholders. */}
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar for navigation steps within the module. */}
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false); // Close sidebar on mobile after a step is selected.
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        {/* Step completion indicator */}
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        {/* Main content area for the current step. */}
                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                {/* Navigation buttons for moving between steps. */}
                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };
        
        // --- Main App Component ---
        /**
         * The root component of the Perfusion Learning Module application.
         * Manages overall application state, including module selection, user ID, and progress.
         */
        function App() {
            // State for the currently selected learning module's ID. Null means Dashboard is active.
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            // State for the authenticated user's ID, used for local storage progress tracking.
            const [userId, setUserId] = useState(null);
            // State for storing the user's progress across all modules and steps.
            const [progress, setProgress] = useState({});
            // State to indicate if authentication is complete and user ID is available.
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Effect hook for handling initial authentication and setting the user ID.
            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true); // Mark authentication as ready once user is determined.
                });
                return () => unsubscribe(); // Cleanup the auth state listener on component unmount.
            }, []); // Empty dependency array ensures this runs only once on mount.

            // Effect hook for loading user progress from localStorage after authentication is ready.
            useEffect(() => {
                if (!isAuthReady || !userId) return; // Only proceed if auth is ready and userId is available.
                const storedProgress = localStorage.getItem(`perfusion-learning-module-progress-${userId}`);
                if (storedProgress) {
                    try {
                        setProgress(JSON.parse(storedProgress)); // Attempt to parse and set stored progress.
                    } catch (e) {
                        console.error("Failed to parse stored progress, resetting.", e);
                        setProgress({}); // Reset progress if parsing fails (e.g., corrupted data).
                    }
                }
            }, [isAuthReady, userId]); // Reruns when auth status or userId changes.

            // Callback function to update and persist the user's progress for a specific step.
            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;

                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };

                    // If the old and new step data are identical, do not update state.
                    // This prevents the infinite re-render loop.
                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
                        return currentProgress;
                    }

                    // Otherwise, proceed with the update.
                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: newStepProgress
                        }
                    };

                    localStorage.setItem(`perfusion-learning-module-progress-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);

            const handlePreAssessmentComplete = (completedModuleIds) => {
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => {
                            newProgress[moduleId][step.id] = { completed: true };
                        });
                    }
                });
                setProgress(newProgress);
                localStorage.setItem(`perfusion-learning-module-progress-${userId}`, JSON.stringify(newProgress));
                // The results screen is now part of the PreAssessmentQuiz component.
                // We just need to handle exiting it.
            };
            
            // Callback to reset all progress
            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                // Clear from state
                setProgress({});
                // Clear from localStorage
                localStorage.removeItem(`perfusion-learning-module-progress-${userId}`);
            }, [isAuthReady, userId]);

            // Function to navigate to the next module
            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    // If it's the last module, go back to the dashboard.
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            // Determine which module is currently selected based on `currentModuleId`.
            const selectedModule = currentModuleId && contentData[currentModuleId]
                                    ? { ...contentData[currentModuleId], id: currentModuleId }
                                    : null;

            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz 
                            onComplete={handlePreAssessmentComplete} 
                            onExit={() => setIsPreAssessmentActive(false)}
                        />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                        />
                    )}
                </div>
            );
        }

        // --- Render the App into the DOM ---
        // Get the DOM element where the React application will be mounted.
        const container = document.getElementById('root');
        // Create a React root, which is the entry point for React 18+ applications.
        const root = ReactDOM.createRoot(container);
        // Render the main App component into the root.
        root.render(<App />);
    </script>
</body>
</html>
