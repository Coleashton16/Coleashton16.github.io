<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Pharmacology Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .main-content { transition: opacity 0.3s ease-in-out; }
        .nav-item.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; border-radius: 0.75rem; background-color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .flashcard-back { transform: rotateY(180deg); }

        /* --- STATIC MOA Visualizer Styles --- */
        .synapse { position: relative; width: 150px; height: 100px; }
        .neuron-pre { fill: #93c5fd; stroke: #3b82f6; stroke-width: 1.5; }
        .neuron-post { fill: #a5b4fc; stroke: #4f46e5; stroke-width: 1.5; }
        .neurotransmitter { fill: #f87171; }
        .drug-molecule { fill: #fbbf24; }
        .receptor { fill: #c7d2fe; }
        .blocker { fill: #facc15; }
        .ion { fill: #67e8f9; }
        
        .reveal-section { transition: all 0.5s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; transform: translateY(-10px); }
        .reveal-section.revealed { max-height: 500px; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
        <div class="p-6 border-b border-slate-200">
            <h1 class="text-xl font-bold text-sky-800">Pharm Mastery <span class="text-xs align-top bg-green-100 text-green-700 p-1 rounded">v3</span></h1>
            <p class="text-sm text-slate-500">Mental Health</p>
        </div>
        <nav id="navigation" class="flex-1 p-4 space-y-2">
            <a href="#dashboard" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
            <a href="#drug-library" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="library" class="w-5 h-5 mr-3"></i> Drug Library</a>
            <a href="#drug-showdown" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="git-compare" class="w-5 h-5 mr-3"></i> Drug Showdown</a>
            <a href="#flashcards" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layers" class="w-5 h-5 mr-3"></i> Flashcards</a>
            <a href="#quiz-zone" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="swords" class="w-5 h-5 mr-3"></i> Quiz Zone</a>
            <a href="#scenarios" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="clipboard-check" class="w-5 h-5 mr-3"></i> Clinical Scenarios</a>
            <a href="#brain-dump" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="brain-circuit" class="w-5 h-5 mr-3"></i> Brain Dump</a>
        </nav>
        <div class="p-4 border-t border-slate-200">
            <button id="reset-progress-btn" class="w-full text-sm text-center text-slate-500 hover:text-red-600">Reset Progress</button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 bg-slate-50 overflow-y-auto p-8"></main>
    
    <!-- Modals -->
    <div id="braindump-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold">Comparison Results</h2><button id="close-modal-btn" class="text-slate-500 hover:text-slate-800"><i data-lucide="x"></i></button></div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const drugData = [
            { id: 'diazepam', category: 'Alcohol Withdrawal', name: 'Diazepam', brandNames: 'Valium', class: 'Benzodiazepine', moa: 'Enhances the effect of GABA by binding to a separate site on the GABA-A receptor, increasing the frequency of chloride channel opening.', effects: ['Drowsiness, ataxia', 'Hypotension', 'Tachycardia', 'Respiratory Depression'], nursingConsiderations: ['Monitor vital signs closely, especially RR.', 'Do not mix with other IV solutions.', 'High potential for dependence; use short-term.', 'Taper dose to prevent severe withdrawal.'], mnemonic: 'A "Dia"-sy feeling of calm, but don\'t get too relaxed and forget to breathe!', visualizerType: 'benzo' },
            { id: 'chlordiazepoxide', category: 'Alcohol Withdrawal', name: 'Chlordiazepoxide', brandNames: 'Librium', class: 'Benzodiazepine', moa: 'Potentiates GABA by binding to the benzodiazepine site on the GABA-A receptor, causing CNS depression.', effects: ['Lethargy, hangover feeling', 'Respiratory depression', 'Hypotension'], nursingConsiderations: ['A cornerstone of alcohol withdrawal protocols.', 'Highly habituating.', 'Monitor for over-sedation.'], mnemonic: 'Get "rid-o-the-pox" of withdrawal with Chlordiazepoxide.', visualizerType: 'benzo' },
            { id: 'lorazepam', category: 'Alcohol Withdrawal', name: 'Lorazepam', brandNames: 'Ativan', class: 'Benzodiazepine (Anxiolytic)', moa: 'Increases GABA\'s inhibitory effects by binding to the BZD site on GABA-A receptors.', effects: ['Lightheadedness', 'Hepatic dysfunction', 'Orthostatic hypotension'], nursingConsiderations: ['Avoid other CNS depressants.', 'Monitor liver function (safer choice in liver impairment).', 'Do not discontinue abruptly.'], mnemonic: '"Lora" the Explorer needs to "pam-per" her anxiety, and it\'s safer for her liver.', visualizerType: 'benzo' },
            { id: 'methadone', category: 'Opioid Addiction', name: 'Methadone', brandNames: 'Dolophine', class: 'Opioid Agonist', moa: 'A long-acting synthetic full agonist that binds to and activates mu-opioid receptors, preventing withdrawal and cravings.', effects: ['QT prolongation (cardiac risk)', 'Respiratory depression', 'Constipation'], nursingConsiderations: ['Obtain baseline EKG to monitor QT interval.', 'High risk for overdose.', 'Must be dispensed through licensed programs.'], mnemonic: '"Metha-DONE" with heroin, now on a safer, longer-acting path.', visualizerType: 'agonist' },
            { id: 'buprenorphine', category: 'Opioid Addiction', name: 'Buprenorphine', brandNames: 'Subutex', class: 'Partial Opioid Agonist', moa: 'A partial agonist at the mu-opioid receptor with a ceiling effect, reducing overdose risk.', effects: ['Headache', 'Nausea/Vomiting', 'Can precipitate withdrawal if taken too soon after full agonist.'], nursingConsiderations: ['Educate patient to wait for moderate withdrawal before first dose.', 'Suboxone (with naloxone) deters IV abuse.', 'Monitor liver function.'], mnemonic: '"Bu-PREVENTS" the high, while keeping withdrawal at bay.', visualizerType: 'agonist' },
            { id: 'naltrexone', category: 'Opioid Addiction', name: 'Naltrexone', brandNames: 'Vivitrol', class: 'Opioid Antagonist', moa: 'A competitive antagonist that blocks the effects of opioids by binding to mu-opioid receptors without activating them.', effects: ['Nausea', 'Headache', 'Anxiety', 'Risk of hepatotoxicity.'], nursingConsiderations: ['Patient must be opioid-free for 7-10 days.', 'Monitor LFTs.', 'Will block the effect of opioid pain medication.'], mnemonic: '"NAL-TREX-ONE" blocks the opioid fun, so there is NONE.', visualizerType: 'antagonist' },
            { id: 'methylphenidate', category: 'ADHD', name: 'Methylphenidate', brandNames: 'Ritalin', class: 'CNS Stimulant', moa: 'Blocks the reuptake of norepinephrine and dopamine, increasing their concentration and availability in the synapse.', effects: ['Nervousness, insomnia', 'Tachycardia', 'Weight loss/growth suppression'], nursingConsiderations: ['Has a paradoxical calming effect in ADHD.', 'Monitor height and weight in children.', 'Avoid caffeine. Give last dose >6h before bedtime.'], mnemonic: '"Methyl-PHEN-tastic" for focus, but give it in the AM!', visualizerType: 'stimulant' },
            { id: 'dextroamphetamine', category: 'ADHD', name: 'Dextroamphetamine', brandNames: 'Dexedrine', class: 'CNS Stimulant', moa: 'Promotes the release of dopamine and norepinephrine from presynaptic terminals and blocks their reuptake.', effects: ['Insomnia', 'Tachycardia, palpitations', 'Highly habituating.'], nursingConsiderations: ['Give in the morning.', 'Do not use with MAOIs (hypertensive crisis risk).', 'Monitor for abuse/dependence.'], mnemonic: '"DEX" helps you focus on your "TRO"phies, but it\'s a fast track.', visualizerType: 'stimulant' },
            { id: 'clonidine', category: 'ADHD', name: 'Clonidine', brandNames: 'Catapres', class: 'Alpha-2 Adrenergic Agonist', moa: 'Stimulates alpha-2 adrenergic receptors in the brain, reducing sympathetic outflow from the CNS.', effects: ['Hypotension, bradycardia', 'Sedation, dizziness', 'Dry mouth'], nursingConsiderations: ['Monitor pulse and BP.', 'Do not stop abruptly (rebound hypertension).', 'Often used as an adjunctive or for stimulant-intolerant patients.'], mnemonic: '"CLON-idine" helps "CLONE" a sense of calm and control.', visualizerType: 'agonist' },
            { id: 'atomoxetine', category: 'ADHD', name: 'Atomoxetine', brandNames: 'Strattera', class: 'SNRI', moa: 'Selectively inhibits the presynaptic reuptake of norepinephrine. NOT a stimulant.', effects: ['GI upset', 'Insomnia', 'Dizziness', 'Increased risk of suicidal ideation in children.'], nursingConsiderations: ['Non-stimulant option for ADHD.', 'Takes 1-4 weeks for full effect.', 'Monitor for suicidal thinking and liver injury.'], mnemonic: 'This "ATOM" is not a stimulant, but still helps "STRAT"egize.', visualizerType: 'ssri' },
            { id: 'haloperidol', category: 'Antipsychotics', name: 'Haloperidol', brandNames: 'Haldol', class: 'First-Gen Antipsychotic', moa: 'Strongly blocks D2 (dopamine) receptors without activating them, which is effective for positive symptoms.', effects: ['High risk of Extrapyramidal Side Effects (EPS)', 'Tardive Dyskinesia (TD)', 'Neuroleptic Malignant Syndrome (NMS)'], nursingConsiderations: ['Primarily targets POSITIVE symptoms.', 'Monitor for EPS, TD, and NMS.', 'Can be given as a long-acting injectable.'], mnemonic: '"HAL"loperidol can stop the "HAL"lucinations, but watch for the shakes.', visualizerType: 'antagonist' },
            { id: 'fluphenazine', category: 'Antipsychotics', name: 'Fluphenazine', brandNames: 'Prolixin', class: 'First-Gen Antipsychotic', moa: 'A potent D2 dopamine receptor antagonist that blocks the receptor site.', effects: ['High risk of EPS', 'Anticholinergic effects', 'Sedation', 'Photosensitivity'], nursingConsiderations: ['Treats POSITIVE symptoms.', 'Monitor and manage EPS.', 'Available as long-acting injectable.'], mnemonic: '"Flu-PHEN-azine" flies away psychosis but can make you stiff as a hen.', visualizerType: 'antagonist' },
            { id: 'clomipramine', category: 'Personality Disorders', name: 'Clomipramine', brandNames: 'Anafranil', class: 'Tricyclic Antidepressant (TCA)', moa: 'Potently inhibits the reuptake of serotonin from the synapse, increasing its availability.', effects: ['Strong Anticholinergic effects', 'Sedation', 'Orthostatic hypotension', 'High overdose fatality risk.'], nursingConsiderations: ['For Obsessive-Compulsive traits.', 'Monitor for suicide risk.', 'Advise patient to rise slowly.'], mnemonic: '"CLOM-ipramine" helps calm O-C-D, but it\'s an older, riskier key (TCA).', visualizerType: 'ssri' },
            { id: 'fluoxetine', category: 'Personality Disorders', name: 'Fluoxetine', brandNames: 'Prozac', class: 'SSRI', moa: 'Selectively inhibits serotonin reuptake, leaving more serotonin available in the synaptic cleft.', effects: ['Anxiety, insomnia (initially)', 'Sexual dysfunction', 'Headache', 'Serotonin Syndrome risk'], nursingConsiderations: ['First-line treatment for many mood/anxiety features.', 'Safer profile than TCAs.', 'Long half-life is forgiving for missed doses.'], mnemonic: '"FLU-oxetine" helps serotonin "FLU-sh" through, a modern solution.', visualizerType: 'ssri' }
        ];

        const scenarioData = [
            { id: 1, patient: '28-year-old patient', chiefComplaint: 'Admitted for severe alcohol withdrawal.', assessment: { vitals: 'HR: 120, BP: 150/95, RR: 22', findings: 'Agitated, diaphoretic, and tremulous. CIWA score is 18.' }, question: 'Which medication is the most appropriate first-line treatment?', options: [{ text: 'Haloperidol' }, { text: 'Lorazepam', correct: true }, { text: 'Naltrexone' }, { text: 'Methadone' }], rationale: { correct: 'Lorazepam (Ativan) is a benzodiazepine, the gold standard for safely managing alcohol withdrawal by preventing seizures and reducing symptoms.', incorrect: { Haloperidol: 'Can lower the seizure threshold, making it risky in withdrawal.', Naltrexone: 'Is for relapse prevention after detox is complete.', Methadone: 'Is for opioid use disorder, not alcohol withdrawal.' } } },
            { id: 2, patient: '10-year-old child', chiefComplaint: 'Follow-up for ADHD management.', assessment: { vitals: 'WNL', findings: 'Patient reports trouble sleeping and has lost 5 lbs in one month since starting a new medication.' }, question: 'Which medication is most likely causing these side effects?', options: [{ text: 'Atomoxetine' }, { text: 'Clonidine' }, { text: 'Methylphenidate', correct: true }, { text: 'Guanfacine' }], rationale: { correct: 'Methylphenidate (Ritalin) is a CNS stimulant, and its most common side effects are insomnia and appetite suppression leading to weight loss.', incorrect: { Atomoxetine: 'Is a non-stimulant; while it can cause insomnia, significant weight loss is less common.', Clonidine: 'Typically causes sedation, not insomnia.' } } },
            { id: 3, patient: '65-year-old patient with schizophrenia', chiefComplaint: 'Reports "new, weird mouth movements."', assessment: { vitals: 'WNL', findings: 'Patient displays uncontrollable lip-smacking, tongue protrusion, and grimacing. Has been taking Fluphenazine for two years.' }, question: 'These new symptoms are most indicative of what condition?', options: [{ text: 'Acute Dystonia' }, { text: 'Akathisia' }, { text: 'Tardive Dyskinesia', correct: true }, { text: 'Neuroleptic Malignant Syndrome' }], rationale: { correct: 'Tardive Dyskinesia (TD) is a serious side effect of long-term first-generation antipsychotic use, characterized by involuntary facial movements.', incorrect: { 'Acute Dystonia': 'Is a painful muscle spasm that occurs early in treatment.', Akathisia: 'Is a feeling of inner restlessness.', NMS: 'Is a medical emergency with fever and rigidity.' } } },
            { id: 4, patient: '34-year-old client', chiefComplaint: 'Wants help quitting heroin.', assessment: { vitals: 'WNL', findings: 'Client states they used heroin this morning and now wants "the shot that blocks it so I can\'t get high."' }, question: 'Which medication is strictly contraindicated at this time?', options: [{ text: 'Buprenorphine' }, { text: 'Methadone' }, { text: 'Naltrexone', correct: true }, { text: 'Clonidine' }], rationale: { correct: 'Naltrexone (Vivitrol) is an opioid antagonist. Giving it to a patient with active opioids in their system will trigger severe, precipitated withdrawal.', incorrect: { Buprenorphine: 'A partial agonist used to manage withdrawal, but must be started carefully.', Methadone: 'A full agonist used for detox and maintenance.' } } },
            { id: 5, patient: '42-year-old patient', chiefComplaint: 'Feeling "really sick and weird."', assessment: { vitals: 'HR: 130, BP: 160/100, Temp: 38.5Â°C', findings: 'Patient is agitated, confused, and has noticeable muscle twitching. They take Fluoxetine daily.' }, question: 'Which condition are these findings most consistent with?', options: [{ text: 'Agranulocytosis' }, { text: 'Serotonin Syndrome', correct: true }, { text: 'Hypertensive Crisis' }, { text: 'Anticholinergic Toxicity' }], rationale: { correct: 'The combination of autonomic instability (tachycardia, fever), altered mental status, and neuromuscular hyperactivity (twitching) are classic signs of Serotonin Syndrome.', incorrect: { Agranulocytosis: 'Is a drop in white blood cells and presents with signs of infection.', 'Hypertensive Crisis': 'Is severe high blood pressure, often linked to MAOIs, not SSRIs alone.', 'Anticholinergic Toxicity': 'Presents with "dry as a bone, blind as a bat, red as a beet, mad as a hatter."' } } }
        ];

        // --- APPLICATION STATE ---
        let state = { currentView: '#dashboard', flashcard: { deck: [], currentIndex: 0, mastered: [], review: [] }, quiz: { deck: [], currentQuestion: 0, score: 0, isComplete: false }, scenarios: { deck: [], currentIndex: 0, isComplete: false, stage: 'initial' }, brainDump: { selectedDrug: null } };

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const navigation = document.getElementById('navigation');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const modal = document.getElementById('braindump-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalContent = document.getElementById('modal-content');

        // --- TEMPLATES ---
        const Templates = {
            dashboard: () => {
                const categories = [...new Set(drugData.map(d => d.category))];
                const masteredCount = state.flashcard.mastered.length;
                const totalCount = drugData.length;
                const progress = totalCount > 0 ? Math.round((masteredCount / totalCount) * 100) : 0;
                
                return `
                    <div class="fade-in">
                        <h1 class="text-4xl font-bold mb-2">Welcome Back!</h1>
                        <p class="text-slate-500 mb-8">Ready to master mental health pharmacology? Let's dive in.</p>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                            <h2 class="text-xl font-bold mb-4">Overall Progress</h2>
                            <div class="flex items-center">
                                <div class="w-full bg-slate-200 rounded-full h-4">
                                    <div class="bg-sky-600 h-4 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <span class="ml-4 font-semibold text-sky-700">${progress}%</span>
                            </div>
                            <p class="text-sm text-slate-500 mt-2">${masteredCount} of ${totalCount} drugs mastered.</p>
                        </div>

                        <h2 class="text-2xl font-bold mb-4">Study Modules</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${categories.map(category => {
                                const categoryDrugs = drugData.filter(d => d.category === category);
                                const masteredInCategory = categoryDrugs.filter(d => state.flashcard.mastered.includes(d.id)).length;
                                const categoryProgress = Math.round((masteredInCategory / categoryDrugs.length) * 100);
                                return `
                                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                                    <h3 class="font-bold text-lg">${category}</h3>
                                    <p class="text-sm text-slate-500 mb-4">${categoryDrugs.length} medications</p>
                                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                                        <div class="bg-teal-500 h-2.5 rounded-full" style="width: ${categoryProgress}%"></div>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2">${masteredInCategory} / ${categoryDrugs.length} mastered</p>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </div>
                `;
            },
            drugLibrary: () => `
                <div>
                    <h1 class="text-4xl font-bold mb-8">Drug Library</h1>
                    <div class="space-y-4">
                        ${drugData.map(drug => `
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h2 class="text-2xl font-bold text-sky-800">${drug.name} <span class="text-lg font-normal text-slate-500">(${drug.brandNames})</span></h2>
                                        <p class="text-md font-semibold text-teal-600 mb-4">${drug.class} - <span class="italic text-slate-600">${drug.category}</span></p>
                                    </div>
                                    <button onclick="App.speak('${drug.name}')" class="text-slate-500 hover:text-sky-600 p-2"><i data-lucide="volume-2"></i></button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                                    <div class="md:col-span-2">
                                        <h4 class="font-semibold mb-2 border-b pb-1">Mechanism of Action</h4>
                                        <p class="text-slate-600 text-sm">${drug.moa}</p>
                                    </div>
                                    <div class="flex flex-col items-center justify-center bg-slate-50 rounded-lg p-2">
                                        ${Templates.moaVisualizer(drug.visualizerType)}
                                    </div>
                                    <div>
                                        <h4 class="font-semibold mb-2 border-b pb-1">Adverse Effects</h4>
                                        <ul class="list-disc list-inside text-slate-600 text-sm space-y-1">
                                            ${drug.effects.map(e => `<li>${e}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="md:col-span-2">
                                        <h4 class="font-semibold mb-2 border-b pb-1">Nursing Considerations</h4>
                                        <ul class="list-disc list-inside text-slate-600 text-sm space-y-1">
                                            ${drug.nursingConsiderations.map(nc => `<li>${nc}</li>`).join('')}
                                        </ul>
                                    </div>
                                     <div class="md:col-span-3 bg-sky-50 p-4 rounded-lg">
                                        <h4 class="font-semibold mb-1 text-sky-900">Memory Aid</h4>
                                        <p class="text-sky-800 text-sm italic">"${drug.mnemonic}"</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `,
            drugShowdown: () => `
                <div>
                    <h1 class="text-4xl font-bold mb-2">Drug Showdown</h1>
                    <p class="text-slate-500 mb-8">Select two or three drugs to compare their properties side-by-side.</p>
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                        <div id="showdown-selectors" class="flex flex-wrap gap-4">
                            ${[1, 2].map(i => `
                                <select id="showdown-select-${i}" class="showdown-select mt-1 block w-full md:w-auto flex-1 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                                    <option value="">-- Select Drug ${i} --</option>
                                    ${drugData.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                                </select>
                            `).join('')}
                        </div>
                    </div>
                    <div id="showdown-table-container" class="overflow-x-auto"></div>
                </div>
            `,
            flashcards: () => {
                const { deck, currentIndex } = state.flashcard;
                if (!deck || deck.length === 0) {
                    return `
                        <div class="text-center">
                            <h1 class="text-4xl font-bold mb-4">Flashcards</h1>
                            <p class="text-slate-500 mb-6">You've mastered all the drugs! Reset progress to study again.</p>
                            <button onclick="App.startFlashcards()" class="bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700">Start Over</button>
                        </div>
                    `;
                }
                const drug = deck[currentIndex];
                return `
                    <div class="max-w-2xl mx-auto">
                        <h1 class="text-4xl font-bold text-center mb-2">Flashcards</h1>
                        <p class="text-slate-500 text-center mb-6">Card ${currentIndex + 1} of ${deck.length}</p>
                        
                        <div class="flashcard h-96 perspective-1000">
                           <div class="flashcard-inner">
                                <div class="flashcard-front">
                                    <p class="text-slate-500 text-sm mb-2">${drug.category}</p>
                                    <h2 class="text-4xl font-bold">${drug.name}</h2>
                                    <button onclick="App.flipCard()" class="absolute bottom-6 text-sm text-sky-600 font-semibold">Click to Flip</button>
                                </div>
                                <div class="flashcard-back overflow-y-auto">
                                    <h3 class="font-bold text-xl mb-2">${drug.class}</h3>
                                    <p class="text-xs text-slate-500 mb-4">${drug.moa}</p>
                                    <div class="text-left w-full px-4">
                                        <h4 class="font-semibold mb-1">Key Considerations:</h4>
                                        <ul class="list-disc list-inside text-slate-600 text-sm space-y-1">
                                            ${drug.nursingConsiderations.map(nc => `<li>${nc}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <button onclick="App.flipCard()" class="absolute bottom-6 text-sm text-sky-600 font-semibold">Click to Flip Back</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center items-center mt-8 space-x-4">
                            <button onclick="App.handleFlashcardAnswer(false)" class="bg-red-100 text-red-700 font-semibold px-8 py-3 rounded-lg hover:bg-red-200 flex items-center"><i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>Review Again</button>
                            <button onclick="App.handleFlashcardAnswer(true)" class="bg-green-100 text-green-700 font-semibold px-8 py-3 rounded-lg hover:bg-green-200 flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Got It!</button>
                        </div>
                    </div>
                `
            },
            quizZone: () => {
                const { deck, currentQuestion, score, isComplete } = state.quiz;

                if (isComplete) {
                     return `
                        <div class="text-center bg-white p-8 rounded-xl shadow-lg">
                            <h1 class="text-4xl font-bold mb-2">Quiz Complete!</h1>
                            <p class="text-2xl text-slate-600 mb-6">Your Score:</p>
                            <p class="text-6xl font-bold text-sky-600 mb-8">${score} / ${deck.length}</p>
                            <button onclick="App.startQuiz()" class="bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 text-lg">Try Again</button>
                        </div>
                    `;
                }
                
                if (!deck || deck.length === 0) {
                     return `
                        <div class="text-center">
                            <h1 class="text-4xl font-bold mb-4">Quiz Zone</h1>
                            <p class="text-slate-500 mb-6">Ready to test your knowledge? Let's begin.</p>
                            <button onclick="App.startQuiz()" class="bg-sky-600 text-white px-8 py-4 rounded-lg hover:bg-sky-700 text-xl">Start Quiz</button>
                        </div>
                    `;
                }

                const question = deck[currentQuestion];
                return `
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Quiz Zone</h1>
                        <p class="text-slate-500 mb-6">Question ${currentQuestion + 1} of ${deck.length} | Score: ${score}</p>
                        
                        <div class="bg-white p-8 rounded-xl shadow-md">
                            <p class="text-xl font-semibold mb-6">${question.text}</p>
                            <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${question.options.map((option, index) => `
                                    <button data-answer="${option.correct}" class="quiz-option text-left p-4 border-2 border-slate-200 rounded-lg hover:border-sky-500 hover:bg-sky-50 transition-colors">
                                        ${option.text}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },
            brainDump: () => `
                <div>
                    <h1 class="text-4xl font-bold mb-2">Brain Dump</h1>
                    <p class="text-slate-500 mb-8">Select a drug, write down everything you remember, then compare your notes with the correct info. This is a powerful way to test your recall!</p>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <label for="drug-select" class="block text-sm font-medium text-slate-700">1. Select a Medication</label>
                        <select id="drug-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                            <option value="">-- Choose a drug --</option>
                            ${drugData.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                        </select>

                        <div id="braindump-fields" class="mt-6 space-y-4 hidden">
                             <h2 class="text-xl font-bold">2. Dump Your Brain!</h2>
                             <div>
                                <label for="dump-moa" class="block text-sm font-medium text-slate-700">Mechanism of Action</label>
                                <textarea id="dump-moa" rows="3" class="mt-1 shadow-sm focus:ring-sky-500 focus:border-sky-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2"></textarea>
                            </div>
                            <div>
                                <label for="dump-effects" class="block text-sm font-medium text-slate-700">Adverse Effects (one per line)</label>
                                <textarea id="dump-effects" rows="4" class="mt-1 shadow-sm focus:ring-sky-500 focus:border-sky-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2"></textarea>
                            </div>
                            <div>
                                <label for="dump-nursing" class="block text-sm font-medium text-slate-700">Nursing Considerations (one per line)</label>
                                <textarea id="dump-nursing" rows="4" class="mt-1 shadow-sm focus:ring-sky-500 focus:border-sky-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2"></textarea>
                            </div>
                            <button id="compare-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">Compare</button>
                        </div>
                    </div>
                </div>
            `,
            brainDumpModalContent: (userAnswers, correctAnswers) => `...`,
            moaVisualizer: (type) => {
                switch(type) {
                    case 'ssri': return `<div class="synapse viz-ssri" title="Reuptake inhibitor"><svg viewBox="0 0 50 50"><path class="neuron-pre" d="M5,5 Q25,-5 45,5 V25 H5 Z"></path><path d="M5 20 L2 20 L2 15 L5 15" class="neuron-pre reuptake-pump"></path><rect class="blocker" x="2" y="15" width="3" height="5"></rect><path class="neuron-post" d="M5,50 H45 V35 H5 Z"></path><rect x="23" y="35" width="4" height="2" class="receptor"></rect><g class="neurotransmitter" transform="translate(0, 5)"><circle cx="25" cy="10" r="2"></circle></g></svg><p class="text-xs text-center text-slate-500 mt-1">Reuptake Inhibitor</p></div>`;
                    case 'stimulant': return `<div class="synapse viz-stimulant" title="Release agent"><svg viewBox="0 0 50 50"><path class="neuron-pre" d="M5,5 Q25,-5 45,5 V25 H5 Z"></path><path class="neuron-post" d="M5,50 H45 V35 H5 Z"></path><rect x="15" y="35" width="4" height="2" class="receptor"></rect><rect x="30" y="35" width="4" height="2" class="receptor"></rect><g class="neurotransmitter" transform="translate(0, 20)"><circle cx="17" cy="0" r="2"></circle><circle cx="25" cy="0" r="2"></circle><circle cx="33" cy="0" r="2"></circle></g></svg><p class="text-xs text-center text-slate-500 mt-1">Release Agent</p></div>`;
                    case 'agonist': return `<div class="synapse viz-agonist" title="Agonist"><svg viewBox="0 0 50 50"><path class="neuron-pre" d="M5,5 Q25,-5 45,5 V25 H5 Z"></path><path class="neuron-post" d="M5,50 H45 V35 H5 Z"></path><rect x="23" y="35" width="4" height="2" class="receptor"></rect><g class="drug-molecule" transform="translate(25, 36)"><circle cx="0" cy="0" r="2.5"></circle></g></svg><p class="text-xs text-center text-slate-500 mt-1">Agonist</p></div>`;
                    case 'antagonist': return `<div class="synapse viz-antagonist" title="Antagonist"><svg viewBox="0 0 50 50"><path class="neuron-pre" d="M5,5 Q25,-5 45,5 V25 H5 Z"></path><path class="neuron-post" d="M5,50 H45 V35 H5 Z"></path><rect x="23" y="35" width="4" height="2" class="receptor"></rect><g class="neurotransmitter" transform="translate(25, 10)"><circle cx="0" cy="0" r="2"></circle></g><g transform="translate(23, 34)"><path class="drug-molecule" d="M -3 -1 L 3 -1 L 3 1 L -3 1 Z"></path></g></svg><p class="text-xs text-center text-slate-500 mt-1">Antagonist</p></div>`;
                    case 'benzo': return `<div class="synapse viz-benzo" title="GABA Potentiator (hover me)"><svg viewBox="0 0 50 60"><path d="M5,5 H45 V55 H5 Z" class="neuron-post"></path><rect class="gaba-channel-gate" x="15" y="25" width="20" height="5" fill="#818cf8"></rect><rect class="benzo-site" x="40" y="15" width="5" height="5" rx="1" fill="#a78bfa" stroke="#4f46e5" stroke-width="1"></rect><g class="ion"><circle cx="25" cy="10" r="2" ></circle></g><text x="25" y="15" font-size="6" text-anchor="middle">GABA</text><text x="30" y="24" font-size="6" text-anchor="middle" transform="rotate(-90 30 24)">BZD</text></svg><p class="text-xs text-center text-slate-500 mt-1">GABA Potentiator</p></div>`;
                    default: return `<div class="text-xs text-slate-400">No visual available</div>`;
                }
            },
            clinicalScenarios: () => {
                const { deck, currentIndex, isComplete, stage } = state.scenarios;
                if(isComplete || !deck || deck.length === 0) {
                     return `<div class="text-center bg-white p-8 rounded-xl shadow-lg"><h1 class="text-4xl font-bold mb-2">Scenarios Complete!</h1><p class="text-2xl text-slate-600 mb-8">You've completed all clinical scenarios. Great job!</p><button onclick="App.startScenarios()" class="bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 text-lg">Practice Again</button></div>`;
                }
                const scenario = deck[currentIndex];
                return `
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Clinical Scenario Simulator</h1>
                        <p class="text-slate-500 mb-6">Scenario ${currentIndex + 1} of ${deck.length}</p>
                        
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                            <!-- Patient Chart -->
                            <div class="border border-slate-300 rounded-lg">
                                <div class="bg-slate-700 text-white px-4 py-2 rounded-t-lg flex items-center"><i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>PATIENT CHART</div>
                                <div class="p-4 space-y-4">
                                    <div><span class="font-semibold w-32 inline-block">PATIENT:</span><span>${scenario.patient}</span></div>
                                    <div><span class="font-semibold w-32 inline-block">CHIEF COMPLAINT:</span><span>${scenario.chiefComplaint}</span></div>
                                    
                                    <!-- Unfolding Section -->
                                    <div id="assessment-section" class="reveal-section ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                                        <div class="border-t border-slate-200 pt-4 mt-4 space-y-4">
                                            <div><span class="font-semibold w-32 inline-block">VITALS:</span><span class="text-red-600">${scenario.assessment.vitals}</span></div>
                                            <div><span class="font-semibold w-32 inline-block">FINDINGS:</span><span>${scenario.assessment.findings}</span></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Button -->
                                    ${stage === 'initial' ? `<button id="assess-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center mx-auto mt-4"><i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i>Assess Patient</button>`: ''}
                                </div>
                            </div>
                            
                            <!-- Question and Options Section -->
                            <div id="decision-section" class="reveal-section mt-6 ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                                <p class="text-lg font-semibold mb-4 text-sky-800">${scenario.question}</p>
                                <div id="scenario-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${scenario.options.map(option => `
                                        <button data-text="${option.text}" data-correct="${!!option.correct}" class="scenario-option text-left p-4 border-2 border-slate-200 rounded-lg hover:border-sky-500 hover:bg-sky-50 transition-colors disabled:opacity-75 disabled:cursor-not-allowed">
                                            ${option.text}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Rationale Section -->
                            <div id="scenario-rationale" class="mt-6"></div>
                        </div>
                    </div>
                `;
            },
        };

        // --- APPLICATION LOGIC ---
        const App = {
            init() {
                this.loadState();
                this.router();
                window.addEventListener('hashchange', this.router.bind(this));
                navigation.addEventListener('click', e => {
                    const link = e.target.closest('a');
                    if (link) {
                        e.preventDefault();
                        window.location.hash = link.getAttribute('href');
                    }
                });
                resetProgressBtn.addEventListener('click', () => {
                   if (confirm('Are you sure you want to reset all your progress? This cannot be undone.')) {
                       this.resetState();
                   }
                });
                closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
            },
            router() {
                const path = window.location.hash || '#dashboard';
                state.currentView = path;
                
                mainContent.style.opacity = 0;
                
                setTimeout(() => {
                    switch(state.currentView) {
                        case '#dashboard': mainContent.innerHTML = Templates.dashboard(); break;
                        case '#drug-library': mainContent.innerHTML = Templates.drugLibrary(); break;
                        case '#drug-showdown': mainContent.innerHTML = Templates.drugShowdown(); this.attachShowdownListeners(); break;
                        case '#flashcards': 
                            if (!state.flashcard.deck || state.flashcard.deck.length === 0) this.startFlashcards();
                            mainContent.innerHTML = Templates.flashcards();
                            break;
                        case '#quiz-zone': 
                            if (!state.quiz.deck || state.quiz.deck.length === 0) this.startQuiz();
                            mainContent.innerHTML = Templates.quizZone();
                            if(state.quiz.deck && state.quiz.deck.length > 0 && !state.quiz.isComplete) this.attachQuizListeners();
                            break;
                        case '#scenarios': 
                            if(!state.scenarios.deck || state.scenarios.deck.length === 0) this.startScenarios();
                            mainContent.innerHTML = Templates.clinicalScenarios();
                            this.attachScenarioListeners();
                            break;
                        case '#brain-dump': 
                            mainContent.innerHTML = Templates.brainDump();
                            this.attachBrainDumpListeners();
                            break;
                        default:
                            window.location.hash = '#dashboard';
                            mainContent.innerHTML = Templates.dashboard();
                    }
                    this.updateNav();
                    lucide.createIcons();
                    mainContent.style.opacity = 1;
                }, 150);
            },
            updateNav() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('href') === state.currentView) item.classList.add('active');
                    else item.classList.remove('active');
                });
            },
            speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Sorry, your browser does not support text-to-speech.');
                }
            },
            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
            saveState() { localStorage.setItem('pharmaMasteryStateV3', JSON.stringify(state)); },
            loadState() {
                const savedState = localStorage.getItem('pharmaMasteryStateV3');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if(!state.scenarios || typeof state.scenarios.stage === 'undefined') {
                       this.resetState(false);
                    }
                } else { this.resetState(false); }
            },
            resetState(doRoute = true) {
                localStorage.removeItem('pharmaMasteryStateV3');
                state = { currentView: '#dashboard', flashcard: { deck: [], currentIndex: 0, mastered: [], review: [] }, quiz: { deck: [], currentQuestion: 0, score: 0, isComplete: false }, scenarios: { deck: [], currentIndex: 0, isComplete: false, stage: 'initial' }, brainDump: { selectedDrug: null } };
                if(doRoute) this.router();
            },
            
            // --- Scenario Logic ---
            startScenarios() {
                state.scenarios = { deck: this.shuffle([...scenarioData]), currentIndex: 0, isComplete: false, stage: 'initial' };
                if(state.currentView === "#scenarios") this.router();
            },

            attachScenarioListeners() {
                if (state.scenarios.isComplete) return;

                const assessBtn = document.getElementById('assess-btn');
                if (assessBtn) {
                    assessBtn.addEventListener('click', () => {
                        state.scenarios.stage = 'assessed';
                        this.saveState();
                        this.router(); 
                    });
                }
                
                if (state.scenarios.stage === 'assessed') {
                     const optionsContainer = document.getElementById('scenario-options');
                     optionsContainer.addEventListener('click', e => {
                        const button = e.target.closest('.scenario-option');
                        if (!button || state.scenarios.stage === 'answered') return;

                        state.scenarios.stage = 'answered';
                        const isCorrect = button.dataset.correct === 'true';
                        const currentScenario = state.scenarios.deck[state.scenarios.currentIndex];
                        
                        // Show feedback
                        const rationaleDiv = document.getElementById('scenario-rationale');
                        let rationaleHTML = '';
                        if(isCorrect) {
                            button.classList.add('bg-green-200', 'border-green-500');
                            rationaleHTML = `<div class="p-4 bg-green-50 border border-green-200 rounded-lg"><h4 class="font-bold text-green-800 flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Correct!</h4><p class="text-green-700 mt-2">${currentScenario.rationale.correct}</p></div>`;
                        } else {
                            button.classList.add('bg-red-200', 'border-red-500');
                            const correctButton = optionsContainer.querySelector('[data-correct="true"]');
                            correctButton.classList.add('bg-green-200', 'border-green-500');
                            const incorrectRationale = currentScenario.rationale.incorrect[button.dataset.text] || "This was not the best choice in this situation.";

                            rationaleHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg space-y-3">
                                <div><h4 class="font-bold text-red-800 flex items-center"><i data-lucide="x-circle" class="w-5 h-5 mr-2"></i>Incorrect.</h4><p class="text-red-700 mt-1">${incorrectRationale}</p></div>
                                <div class="border-t pt-2"><p class="font-semibold text-slate-700">The correct answer is ${correctButton.dataset.text} because: ${currentScenario.rationale.correct}</p></div>
                            </div>`;
                        }
                        rationaleDiv.innerHTML = rationaleHTML;
                        
                        // Disable all buttons
                        document.querySelectorAll('.scenario-option').forEach(b => b.disabled = true);
                        
                        const nextButton = document.createElement('button');
                        nextButton.innerHTML = `Next Scenario <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>`;
                        nextButton.className = 'bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700 mt-4 flex items-center';
                        rationaleDiv.appendChild(nextButton);
                        lucide.createIcons();
                        
                        nextButton.addEventListener('click', () => {
                            state.scenarios.currentIndex++;
                            if (state.scenarios.currentIndex >= state.scenarios.deck.length) {
                                state.scenarios.isComplete = true;
                            } else {
                                state.scenarios.stage = 'initial';
                            }
                            this.saveState();
                            this.router();
                        });
                     });
                }
            },
            
            // --- Other Feature Logic ---
            attachShowdownListeners() {
                document.querySelectorAll('.showdown-select').forEach(sel => {
                    sel.addEventListener('change', () => this.renderShowdownTable());
                });
            },
            renderShowdownTable() {
                const selectedIds = Array.from(document.querySelectorAll('.showdown-select')).map(sel => sel.value).filter(Boolean);
                if (selectedIds.length < 2) {
                    document.getElementById('showdown-table-container').innerHTML = '';
                    return;
                }
                const selectedDrugs = selectedIds.map(id => drugData.find(d => d.id === id));
                const properties = ['Class', 'Mechanism of Action', 'Common Effects', 'Key Nursing Considerations', 'Mnemonic'];
                const keys = ['class', 'moa', 'effects', 'nursingConsiderations', 'mnemonic'];
                
                let tableHTML = `<table class="w-full text-sm text-left text-slate-500">`;
                tableHTML += `<thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-6 py-3 rounded-l-lg">Property</th>`;
                selectedDrugs.forEach(drug => {
                    tableHTML += `<th scope="col" class="px-6 py-3">${drug.name}</th>`;
                });
                tableHTML += `<th class="rounded-r-lg"></th></tr></thead><tbody>`;

                properties.forEach((prop, index) => {
                    const key = keys[index];
                    tableHTML += `<tr class="bg-white border-b"><th scope="row" class="px-6 py-4 font-medium text-slate-900">${prop}</th>`;
                    selectedDrugs.forEach(drug => {
                        let value = drug[key];
                        if(Array.isArray(value)) value = `<ul>${value.map(v => `<li class="list-disc ml-4">${v}</li>`).join('')}</ul>`;
                        tableHTML += `<td class="px-6 py-4">${value}</td>`;
                    });
                    tableHTML += `</tr>`;
                });

                tableHTML += `</tbody></table>`;
                document.getElementById('showdown-table-container').innerHTML = tableHTML;
            },
            startFlashcards() {
                const unmasteredDrugs = drugData.filter(d => !state.flashcard.mastered.includes(d.id));
                const reviewDrugs = state.flashcard.review.map(id => drugData.find(d => d.id === id));
                state.flashcard.deck = this.shuffle([...new Set([...unmasteredDrugs, ...reviewDrugs])]);
                state.flashcard.review = [];
                state.flashcard.currentIndex = 0;
                if(state.currentView === "#flashcards") this.router();
            },
            flipCard() { document.querySelector('.flashcard').classList.toggle('flipped'); },
            handleFlashcardAnswer(isCorrect) {
                if(!state.flashcard.deck || state.flashcard.deck.length === 0) return;
                const currentDrugId = state.flashcard.deck[state.flashcard.currentIndex].id;
                
                if(isCorrect) {
                    state.flashcard.review = state.flashcard.review.filter(id => id !== currentDrugId);
                    if (!state.flashcard.mastered.includes(currentDrugId)) state.flashcard.mastered.push(currentDrugId);
                } else {
                    if (!state.flashcard.review.includes(currentDrugId)) state.flashcard.review.push(currentDrugId);
                    if(state.flashcard.mastered.includes(currentDrugId)) state.flashcard.mastered = state.flashcard.mastered.filter(id => id !== currentDrugId);
                }
                
                state.flashcard.currentIndex++;
                if (state.flashcard.currentIndex >= state.flashcard.deck.length) {
                    this.startFlashcards();
                } else {
                    this.saveState();
                    this.router();
                }
            },
            startQuiz() {
                state.quiz.deck = this.generateQuiz(10);
                state.quiz.currentQuestion = 0;
                state.quiz.score = 0;
                state.quiz.isComplete = false;
                this.router();
            },
            generateQuiz(numQuestions) {
                let questions = [];
                for(let i=0; i<numQuestions; i++) {
                    const questionType = Math.random() > 0.5 ? 'class' : 'effect';
                    let question;
                    if(questionType === 'class') {
                        const drug = drugData[Math.floor(Math.random() * drugData.length)];
                        question = { text: `Which class does ${drug.name} belong to?`, options: this.generateOptions(drug.class, drugData.map(d => d.class)) };
                    } else {
                        const drug = drugData[Math.floor(Math.random() * drugData.length)];
                        const correctEffect = drug.effects[Math.floor(Math.random() * drug.effects.length)];
                        question = { text: `Which of the following is a common adverse effect of ${drug.name}?`, options: this.generateOptions(correctEffect, drugData.flatMap(d => d.effects)) };
                    }
                    questions.push(question);
                }
                return questions;
            },
            generateOptions(correctAnswer, allAnswers) {
                let options = [{text: correctAnswer, correct: true}];
                let otherOptions = [...new Set(allAnswers)].filter(a => a !== correctAnswer);
                otherOptions = this.shuffle(otherOptions);
                for(let i=0; i < 3; i++) { if(otherOptions[i]) options.push({text: otherOptions[i], correct: false}); }
                return this.shuffle(options);
            },
            attachQuizListeners() {
                const optionsContainer = document.getElementById('quiz-options');
                if(!optionsContainer) return;
                optionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.quiz-option');
                    if(!button || button.disabled) return;
                    document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                    
                    const isCorrect = button.dataset.answer === 'true';
                    if(isCorrect) {
                        state.quiz.score++;
                        button.classList.add('bg-green-200', 'border-green-500');
                    } else {
                        button.classList.add('bg-red-200', 'border-red-500');
                        optionsContainer.querySelector('[data-answer="true"]').classList.add('bg-green-200', 'border-green-500');
                    }
                    
                    setTimeout(() => {
                        state.quiz.currentQuestion++;
                        if(state.quiz.currentQuestion >= state.quiz.deck.length) state.quiz.isComplete = true;
                        this.saveState();
                        this.router();
                    }, 1500);
                });
            },
            attachBrainDumpListeners() {
                const drugSelect = document.getElementById('drug-select');
                const fields = document.getElementById('braindump-fields');
                const compareBtn = document.getElementById('compare-btn');

                drugSelect.addEventListener('change', () => {
                    if(drugSelect.value) {
                        fields.classList.remove('hidden');
                        state.brainDump.selectedDrug = drugData.find(d => d.id === drugSelect.value);
                    } else {
                        fields.classList.add('hidden');
                        state.brainDump.selectedDrug = null;
                    }
                });

                compareBtn.addEventListener('click', () => {
                    const userAnswers = { moa: document.getElementById('dump-moa').value, effects: document.getElementById('dump-effects').value, nursing: document.getElementById('dump-nursing').value, };
                    modalContent.innerHTML = Templates.brainDumpModalContent(userAnswers, state.brainDump.selectedDrug);
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    lucide.createIcons();
                });
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
