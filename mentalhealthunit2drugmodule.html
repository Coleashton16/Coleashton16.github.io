<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Pharmacology Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .main-content { transition: opacity 0.3s ease-in-out; }

        .nav-item.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .nav-item.active i { color: #0369a1; }

        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; border-radius: 0.75rem; background-color: white; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .flashcard-back { transform: rotateY(180deg); }

        .quiz-option.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; transform: scale(1.02); }
        .quiz-option.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .reveal-section { transition: all 0.5s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; transform: translateY(-10px); }
        .reveal-section.revealed { max-height: 1000px; opacity: 1; transform: translateY(0); }

        /* Matchup Game Styles */
        .match-item { touch-action: none; cursor: grab; }
        .match-item:active { cursor: grabbing; }
        .drop-zone { border: 2px dashed #94a3b8; transition: background-color 0.2s, border-color 0.2s; }
        .drop-zone.over { background-color: #dbeafe; border-color: #3b82f6; }
        .drop-zone.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .drop-zone.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }

        /* MOA Visualizer Styles */
        .viz-container { min-height: 80px; }
        .neuron-pre { fill: #93c5fd; }
        .neuron-post { fill: #a5b4fc; }
        .neurotransmitter { fill: #f87171; animation: float 3s ease-in-out infinite; }
        .blocker { fill: #facc15; }
        .receptor { fill: #c7d2fe; }
        .pump { fill: #67e8f9; }
        .reuptake-block { animation: block-pump 2s ease-in-out forwards; }
        @keyframes block-pump { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        .custom-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .custom-modal-overlay.visible { opacity: 1; visibility: visible; }
        .custom-modal-content { background: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 500px; width: 100%; transform: scale(0.95); transition: transform 0.3s; }
        .custom-modal-overlay.visible .custom-modal-content { transform: scale(1); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
        <div class="p-6 border-b border-slate-200">
            <h1 class="text-xl font-bold text-sky-800">Pharm Mastery <span class="text-xs align-top bg-green-200 text-green-800 p-1 rounded-md">v7</span></h1>
            <p class="text-sm text-slate-500">Enhanced Edition</p>
        </div>
        <nav id="navigation" class="flex-1 p-4 space-y-2">
            <a href="#dashboard" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
            <a href="#drug-library" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="library" class="w-5 h-5 mr-3"></i> Drug Library</a>
            <a href="#flashcards" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layers" class="w-5 h-5 mr-3"></i> Flashcards</a>
            <a href="#rapid-fire" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="zap" class="w-5 h-5 mr-3"></i> Rapid Fire</a>
            <a href="#match-up" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="puzzle" class="w-5 h-5 mr-3"></i> Match-Up</a>
            <a href="#scenarios" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="clipboard-check" class="w-5 h-5 mr-3"></i> Scenarios</a>
        </nav>
        <div class="p-4 border-t border-slate-200">
            <button id="reset-progress-btn" class="w-full text-sm text-center text-slate-500 hover:text-red-600 transition-colors">Reset Progress</button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 bg-slate-50 overflow-y-auto p-6 md:p-8"></main>

    <!-- Custom Confirm Modal for Reset -->
    <div id="confirm-reset-modal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 class="text-lg font-bold text-slate-800">Are you sure?</h3>
            <p class="text-sm text-slate-600 mt-2 mb-6">Resetting will erase all your flashcard and game progress. This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-reset-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancel</button>
                <button id="confirm-reset-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yes, Reset</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA STORE ---
        const drugData = [
            { id: 'diazepam', category: 'Alcohol Withdrawal', name: 'Diazepam', brandNames: 'Valium', class: 'Benzodiazepine', moa: 'Enhances the effect of GABA by binding to a separate site on the GABA-A receptor, increasing the frequency of chloride channel opening.', effects: ['Drowsiness, ataxia', 'Hypotension', 'Tachycardia', 'Respiratory Depression'], nursingConsiderations: ['Monitor vital signs closely, especially RR.', 'Do not mix with other IV solutions.', 'High potential for dependence; use short-term.', 'Taper dose to prevent severe withdrawal.'], mnemonic: 'Driving a Mercedes-BENZ makes you feel calm, but go too fast (rapid IV push) and you\'ll stop breathing.' , highAlert: true},
            { id: 'chlordiazepoxide', category: 'Alcohol Withdrawal', name: 'Chlordiazepoxide', brandNames: 'Librium', class: 'Benzodiazepine', moa: 'Potentiates GABA by binding to the benzodiazepine site on the GABA-A receptor, causing CNS depression.', effects: ['Lethargy, hangover feeling', 'Respiratory depression', 'Hypotension'], nursingConsiderations: ['A cornerstone of alcohol withdrawal protocols.', 'Highly habituating.', 'Monitor for over-sedation.'], mnemonic: 'Becomes "Liberated" from alcohol with Librium.', highAlert: true },
            { id: 'lorazepam', category: 'Alcohol Withdrawal', name: 'Lorazepam', brandNames: 'Ativan', class: 'Benzodiazepine', moa: 'Increases GABA\'s inhibitory effects by binding to the BZD site on GABA-A receptors.', effects: ['Lightheadedness', 'Hepatic dysfunction', 'Orthostatic hypotension'], nursingConsiderations: ['Avoid other CNS depressants.', 'Monitor liver function (safer choice in liver impairment).', 'Do not discontinue abruptly.'], mnemonic: 'The ATIVAN VAN is coming to LURE your anxiety AWAY.', highAlert: true },
            { id: 'methadone', category: 'Opioid Addiction', name: 'Methadone', brandNames: 'Dolophine', class: 'Opioid Agonist', moa: 'A long-acting synthetic full agonist that binds to and activates mu-opioid receptors, preventing withdrawal and cravings.', effects: ['QT prolongation (cardiac risk)', 'Respiratory depression', 'Constipation'], nursingConsiderations: ['Obtain baseline EKG to monitor QT interval.', 'High risk for overdose.', 'Must be dispensed through licensed programs.'], mnemonic: 'You are "DONE" with heroin, now take METHADONE.', highAlert: true },
            { id: 'buprenorphine', category: 'Opioid Addiction', name: 'Buprenorphine', brandNames: 'Subutex', class: 'Partial Opioid Agonist', moa: 'A partial agonist at the mu-opioid receptor with a ceiling effect, reducing overdose risk.', effects: ['Headache', 'Nausea/Vomiting', 'Can precipitate withdrawal if taken too soon after full agonist.'], nursingConsiderations: ['Educate patient to wait for moderate withdrawal before first dose.', 'Suboxone (with naloxone) deters IV abuse.', 'Monitor liver function.'], mnemonic: 'BUP-renorphine has a BUMP-er on its ceiling, preventing overdose.', highAlert: false },
            { id: 'naltrexone', category: 'Opioid Addiction', name: 'Naltrexone', brandNames: 'Vivitrol', class: 'Opioid Antagonist', moa: 'A competitive antagonist that blocks the effects of opioids by binding to mu-opioid receptors without activating them.', effects: ['Nausea', 'Headache', 'Anxiety', 'Risk of hepatotoxicity.'], nursingConsiderations: ['Patient must be opioid-free for 7-10 days.', 'Monitor LFTs.', 'Will block the effect of opioid pain medication.'], mnemonic: 'NAL-TREX-ONE (like a T-Rex) BLOCKS the opioid path.', highAlert: false },
            { id: 'methylphenidate', category: 'ADHD', name: 'Methylphenidate', brandNames: 'Ritalin', class: 'CNS Stimulant', moa: 'Blocks the reuptake of norepinephrine and dopamine, increasing their concentration and availability in the synapse.', effects: ['Nervousness, insomnia', 'Tachycardia', 'Weight loss/growth suppression'], nursingConsiderations: ['Has a paradoxical calming effect in ADHD.', 'Monitor height and weight in children.', 'Avoid caffeine. Give last dose >6h before bedtime.'], mnemonic: 'With Ritalin, you can finally get it "WRITTEN" down and focus.', highAlert: true },
            { id: 'dextroamphetamine', category: 'ADHD', name: 'Dextroamphetamine', brandNames: 'Dexedrine', class: 'CNS Stimulant', moa: 'Promotes the release of dopamine and norepinephrine from presynaptic terminals and blocks their reuptake.', effects: ['Insomnia', 'Tachycardia, palpitations', 'Highly habituating.'], nursingConsiderations: ['Give in the morning.', 'Do not use with MAOIs (hypertensive crisis risk).', 'Monitor for abuse/dependence.'], mnemonic: 'DEX gives you the mental "DEX-terity" to ace your exams.', highAlert: true },
            { id: 'clonidine', category: 'ADHD', name: 'Clonidine', brandNames: 'Catapres', class: 'Alpha-2 Adrenergic Agonist', moa: 'Stimulates alpha-2 adrenergic receptors in the brain, reducing sympathetic outflow from the CNS.', effects: ['Hypotension, bradycardia', 'Sedation', 'dizziness', 'Dry mouth'], nursingConsiderations: ['Monitor pulse and BP.', 'Do not stop abruptly (rebound hypertension).', 'Often used as an adjunctive or for stimulant-intolerant patients.'], mnemonic: 'Clonidine CALMS and is an alpha-2 agonist (C-A-A).', highAlert: false },
            { id: 'atomoxetine', category: 'ADHD', name: 'Atomoxetine', brandNames: 'Strattera', class: 'SNRI', moa: 'Selectively inhibits the presynaptic reuptake of norepinephrine. NOT a stimulant.', effects: ['GI upset', 'Insomnia', 'Dizziness', 'Increased risk of suicidal ideation in children.'], nursingConsiderations: ['Non-stimulant option for ADHD.', 'Takes 1-4 weeks for full effect.', 'Monitor for suicidal thinking and liver injury.'], mnemonic: 'Use STRAT-tera for a "Straight" path to focus; not a stimulant, so no "Atom" of abuse potential.', highAlert: true },
            { id: 'haloperidol', category: 'Antipsychotics', name: 'Haloperidol', brandNames: 'Haldol', class: 'Typical Antipsychotic', moa: 'Strongly blocks D2 (dopamine) receptors without activating them, which is effective for positive symptoms.', effects: ['High risk of EPS', 'Tardive Dyskinesia (TD)', 'NMS'], nursingConsiderations: ['Primarily targets POSITIVE symptoms.', 'Monitor for EPS, TD, NMS.', 'Can be given as a long-acting injectable.'], mnemonic: 'HAL-operidol will HALT psychosis and make you drop to the floor (Haldol). Watch for EPS!', highAlert: true },
            { id: 'fluphenazine', category: 'Antipsychotics', name: 'Fluphenazine', brandNames: 'Prolixin', class: 'Typical Antipsychotic', moa: 'A potent D2 dopamine receptor antagonist that blocks the receptor site.', effects: ['High risk of EPS', 'Anticholinergic effects', 'Sedation', 'Photosensitivity'], nursingConsiderations: ['Treats POSITIVE symptoms.', 'Monitor and manage EPS.', 'Available as long-acting injectable.'], mnemonic: 'A "PROLIX" (long-acting) shot of Fluphenazine is for the patient who is NOT "pro-lying" about their psychosis.', highAlert: true },
            { id: 'clomipramine', category: 'OCD', name: 'Clomipramine', brandNames: 'Anafranil', class: 'Tricyclic Antidepressant (TCA)', moa: 'Potently inhibits the reuptake of serotonin from the synapse, increasing its availability.', effects: ['Strong Anticholinergic effects', 'Sedation', 'Orthostatic hypotension', 'High overdose fatality risk.'], nursingConsiderations: ['For Obsessive-Compulsive traits.', 'Monitor for suicide risk.', 'Advise patient to rise slowly.'], mnemonic: 'Clomipramine "Calms" the OCD "Train" of thought.', highAlert: true },
            { id: 'fluoxetine', category: 'Depression/Anxiety', name: 'Fluoxetine', brandNames: 'Prozac', class: 'SSRI', moa: 'Selectively inhibits serotonin reuptake, leaving more serotonin available in the synaptic cleft.', effects: ['Anxiety, insomnia (initially)', 'Sexual dysfunction', 'Headache', 'Serotonin Syndrome risk'], nursingConsiderations: ['First-line treatment for many mood/anxiety features.', 'Safer profile than TCAs.', 'Long half-life is forgiving for missed doses.'], mnemonic: 'Fluoxetine helps serotonin "FLOW OUT" of the neuron, making you feel like a "PRO".', highAlert: false }
        ];
        const scenarioData = [
             { id: 1, patient: '28-year-old', chiefComplaint: 'Severe alcohol withdrawal.', assessment: { vitals: 'HR: 120, BP: 150/95', findings: 'Agitated, tremulous.' }, question: 'Which medication is first-line?', options: [{ text: 'Haloperidol' }, { text: 'Lorazepam', correct: true }, { text: 'Naltrexone' }], rationale: { correct: 'Lorazepam (Benzodiazepine) is gold standard for alcohol withdrawal.', incorrect: { Haloperidol: 'Lowers seizure threshold.', Naltrexone: 'For relapse prevention.' } } },
             { id: 2, patient: '10-year-old', chiefComplaint: 'ADHD follow-up.', assessment: { vitals: 'WNL', findings: 'Trouble sleeping, lost 5 lbs in a month.' }, question: 'Which medication is likely causing this?', options: [{ text: 'Atomoxetine' }, { text: 'Methylphenidate', correct: true }, { text: 'Clonidine' }], rationale: { correct: 'Methylphenidate (stimulant) commonly causes insomnia and appetite suppression.', incorrect: { Atomoxetine: 'Non-stimulant, less likely for significant weight loss.', Clonidine: 'Causes sedation.' } } },
             { id: 3, patient: '65-year-old with schizophrenia', chiefComplaint: 'New mouth movements.', assessment: { vitals: 'WNL', findings: 'Lip-smacking, tongue protrusion. On Fluphenazine for 2 years.' }, question: 'This suggests what condition?', options: [{ text: 'Tardive Dyskinesia', correct: true }, { text: 'Akathisia' }, { text: 'Acute Dystonia' }], rationale: { correct: 'Tardive Dyskinesia (TD) is a long-term side effect of typical antipsychotics.', incorrect: { Akathisia: 'Inner restlessness.', 'Acute Dystonia': 'Early-onset muscle spasm.' } } },
             { id: 4, patient: '34-year-old', chiefComplaint: 'Wants to quit heroin.', assessment: { vitals: 'WNL', findings: 'Used heroin this morning, wants "the shot that blocks it."' }, question: 'Which medication is contraindicated?', options: [{ text: 'Buprenorphine' }, { text: 'Methadone' }, { text: 'Naltrexone', correct: true }], rationale: { correct: 'Naltrexone (antagonist) will cause severe precipitated withdrawal if given to a patient with active opioids.', incorrect: { Buprenorphine: 'Partial agonist, used to manage withdrawal.', Methadone: 'Full agonist for detox.' } } },
             { id: 5, patient: '42-year-old', chiefComplaint: 'Feeling sick and weird.', assessment: { vitals: 'HR: 130, T: 38.5°C', findings: 'Agitated, confused, muscle twitching. Takes Fluoxetine.' }, question: 'These findings suggest what condition?', options: [{ text: 'Serotonin Syndrome', correct: true }, { text: 'Agranulocytosis' }, { text: 'Hypertensive Crisis' }], rationale: { correct: 'Autonomic instability, altered mental status, and neuromuscular hyperactivity are classic for Serotonin Syndrome.', incorrect: { Agranulocytosis: 'Presents with infection signs.', 'Hypertensive Crisis': 'Linked to MAOIs + tyramine.' } } },
        ];
        const reverseQuizData = [
            { clue: "Class: SSRI. Key feature: Longest half-life.", answer: "Fluoxetine" },
            { clue: "Class: Typical Antipsychotic. Key feature: High risk of EPS.", answer: "Haloperidol" },
            { clue: "Class: Benzodiazepine. Key feature: Preferred in liver impairment.", answer: "Lorazepam" },
            { clue: "Class: Opioid Antagonist. Key feature: Blocks opioid effects.", answer: "Naltrexone" }
        ];
        let state = {};

        const mainContent = document.getElementById('main-content');
        const navigation = document.getElementById('navigation');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const confirmResetModal = document.getElementById('confirm-reset-modal');

        const Templates = {
            dashboard: () => {
                const masteredCount = Object.values(state.flashcard.cards).filter(s => s.stage === 'mastered').length;
                const progress = Math.round((masteredCount / drugData.length) * 100);
                const reverseQuiz = App.getReverseQuiz();

                return `
                    <div class="fade-in">
                        <h1 class="text-4xl font-bold mb-2">Dashboard</h1>
                        <p class="text-slate-500 mb-8">Let's warm up your brain with a quick challenge!</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-cyan-400">
                                <p class="text-sm font-bold text-cyan-600">WHAT'S THAT DRUG?</p>
                                <p class="text-slate-800 mt-2 text-lg">${reverseQuiz.clue}</p>
                                <div class="mt-4">
                                    <input id="reverse-quiz-input" type="text" placeholder="Enter drug name..." class="border-slate-300 rounded-md w-full md:w-auto">
                                    <button onclick="App.checkReverseQuiz('${reverseQuiz.answer}')" class="bg-cyan-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-cyan-600 ml-2">Guess</button>
                                </div>
                                <p id="reverse-quiz-feedback" class="mt-2 text-sm font-semibold"></p>
                            </div>

                            <!-- Right Column -->
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-bold mb-4">Overall Mastery</h2>
                                <div class="w-full bg-slate-200 rounded-full h-4 mb-4">
                                    <div class="bg-sky-600 h-4 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                                </div>
                                <p class="text-center font-semibold text-sky-700">${progress}% Complete</p>
                                <div class="mt-8 space-y-4">
                                     <a href="#flashcards" class="block w-full text-center bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600 transition-colors">Practice Flashcards</a>
                                     <a href="#rapid-fire" class="block w-full text-center bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">Play Rapid Fire</a>
                                     <a href="#match-up" class="block w-full text-center bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition-colors">Play Match-Up</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            drugLibrary: () => `
                <div>
                    <h1 class="text-4xl font-bold mb-2">Drug Library</h1>
                    <p class="text-slate-500 mb-6">A quick reference for all medications.</p>
                    <div id="drug-library-list" class="space-y-4">
                        ${drugData.map(drug => `
                            <div id="drug-${drug.id}" class="bg-white rounded-lg shadow-sm p-6 scroll-mt-8">
                                <div class="flex justify-between items-start">
                                    <h2 class="text-2xl font-bold text-sky-800">${drug.name}</h2>
                                    ${drug.highAlert ? '<span class="bg-red-100 text-red-800 text-xs font-bold px-2.5 py-0.5 rounded-full flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>HIGH-ALERT</span>' : ''}
                                </div>
                                <p class="text-md font-semibold text-teal-600 mb-4">${drug.class}</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-4">
                                    <div class="viz-container">${App.getMoaVisual(drug.class)}</div>
                                    <div>
                                        <h4 class="font-semibold mb-2 border-b pb-1 text-slate-800">Mechanism of Action</h4>
                                        <p class="text-slate-600 text-sm">${drug.moa}</p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <h4 class="font-semibold mb-2 border-b pb-1 text-slate-800">Adverse Effects</h4>
                                        <ul class="list-disc list-inside text-slate-600 text-sm space-y-1">${drug.effects.map(e => `<li>${e}</li>`).join('')}</ul>
                                    </div>
                                    <div class="md:col-span-2">
                                        <h4 class="font-semibold mb-2 border-b pb-1 text-slate-800">Nursing Considerations</h4>
                                        <ul class="list-disc list-inside text-slate-600 text-sm space-y-1">${drug.nursingConsiderations.map(nc => `<li>${nc}</li>`).join('')}</ul>
                                    </div>
                                    <div class="md:col-span-2 bg-amber-50 p-4 rounded-lg">
                                        <h4 class="font-semibold mb-1 text-amber-900"><i data-lucide="user-plus" class="inline w-4 h-4 mr-2"></i>My Mnemonic</h4>
                                        <div id="mnemonic-display-${drug.id}" class="${state.userMnemonics[drug.id] ? '' : 'hidden'} text-amber-800 text-sm italic">"${state.userMnemonics[drug.id] || ''}"</div>
                                        <button onclick="App.toggleMnemonicEditor('${drug.id}')" class="text-sm font-semibold text-amber-700 hover:text-amber-900">${state.userMnemonics[drug.id] ? 'Edit' : 'Add'}</button>
                                        <div id="mnemonic-editor-${drug.id}" class="hidden mt-2">
                                            <textarea id="mnemonic-input-${drug.id}" class="w-full p-2 border border-amber-300 rounded-md" rows="2">${state.userMnemonics[drug.id] || ''}</textarea>
                                            <button onclick="App.saveUserMnemonic('${drug.id}')" class="bg-amber-400 text-amber-900 px-3 py-1 mt-2 rounded-md font-semibold hover:bg-amber-500">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `,
            flashcards: () => {
                if (!state.flashcard.deck || state.flashcard.deck.length === 0) { return `<div class="text-center"><i data-lucide="party-popper" class="w-24 h-24 mx-auto text-green-500 mb-4"></i><h1 class="text-4xl font-bold">All Cards Reviewed!</h1><p class="text-slate-500 mt-4">Great work! Come back later for more.</p></div>`; }
                const { deck, currentIndex } = state.flashcard;
                const drug = deck[currentIndex];
                const userMnemonic = state.userMnemonics[drug.id];
                return `
                    <div class="max-w-2xl mx-auto">
                        <h1 class="text-4xl font-bold text-center mb-6">Flashcards</h1>
                        <div class="flashcard h-96" onclick="this.classList.toggle('flipped')">
                           <div class="flashcard-inner">
                                <div class="flashcard-front flex-col items-center justify-center">
                                    <p class="text-slate-500 text-sm mb-2">${drug.category}</p>
                                    <h2 class="text-4xl font-bold">${drug.name}</h2>
                                    <p class="absolute bottom-6 text-sm text-sky-600 font-semibold">Click to Flip</p>
                                </div>
                                <div class="flashcard-back flex-col items-center justify-center text-center">
                                    <h3 class="font-bold text-2xl">${drug.class}</h3>
                                    <p class="text-sm mt-4 italic text-sky-700 p-4">"${userMnemonic || drug.mnemonic}"</p>
                                    <p class="absolute bottom-6 text-sm text-sky-600 font-semibold">Click to Flip Back</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center mt-8 space-x-4">
                            <button onclick="App.handleFlashcardAnswer('again')" class="bg-red-100 text-red-700 font-semibold px-8 py-3 rounded-lg hover:bg-red-200 flex items-center"><i data-lucide="x" class="w-5 h-5 mr-2"></i>Again</button>
                            <button onclick="App.handleFlashcardAnswer('good')" class="bg-blue-100 text-blue-700 font-semibold px-8 py-3 rounded-lg hover:bg-blue-200 flex items-center"><i data-lucide="thumbs-up" class="w-5 h-5 mr-2"></i>Good</button>
                            <button onclick="App.handleFlashcardAnswer('easy')" class="bg-green-100 text-green-700 font-semibold px-8 py-3 rounded-lg hover:bg-green-200 flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Easy</button>
                        </div>
                    </div>
                `;
            },
            rapidFire: () => {
                const { deck, currentQuestion, score, isComplete, timer } = state.quiz;
                if (isComplete) {
                    const percentage = deck.length > 0 ? Math.round((score / deck.length) * 100) : 0;
                    return `
                        <div class="text-center bg-white p-8 rounded-xl shadow-lg">
                            <h1 class="text-4xl font-bold mb-2">Round Complete!</h1>
                            <p class="text-2xl text-slate-600 mb-6">Your Score:</p>
                            <p class="text-6xl font-bold text-sky-600 mb-4">${score} / ${deck.length}</p>
                            ${timer.enabled ? `<p class="text-lg text-slate-500">Time remaining: ${timer.remaining}s</p>`: ''}
                            <button onclick="App.startQuiz(false)" class="mt-8 bg-sky-600 text-white px-8 py-4 rounded-lg hover:bg-sky-700 text-xl">Play Again</button>
                        </div>
                    `;
                }
                if (!deck || deck.length === 0) {
                       return `
                        <div class="text-center">
                            <h1 class="text-4xl font-bold mb-4">Rapid Fire</h1>
                            <p class="text-slate-500 mb-6">Test your knowledge in a fast-paced quiz.</p>
                            <div class="flex flex-col items-center space-y-4">
                                <button onclick="App.startQuiz(false)" class="bg-sky-600 text-white px-8 py-4 rounded-lg hover:bg-sky-700 text-xl w-64">Start Round</button>
                                <button onclick="App.startQuiz(true)" class="bg-purple-600 text-white px-8 py-4 rounded-lg hover:bg-purple-700 text-xl w-64 flex items-center justify-center"><i data-lucide="timer" class="w-6 h-6 mr-2"></i>Beat the Clock</button>
                            </div>
                        </div>
                    `;
                }
                const question = deck[currentQuestion];
                return `
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-3xl font-bold">Rapid Fire</h1>
                            <p class="text-lg font-semibold">Score: <span id="quiz-score">${score}</span></p>
                            ${timer.enabled ? `<p id="timer-display" class="text-lg font-bold text-purple-600">Time: ${timer.remaining}</p>` : ''}
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-md">
                            <p class="text-2xl font-semibold mb-8 text-center">${question.text}</p>
                            <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${question.options.map(option => `<button data-answer="${option.correct}" class="quiz-option text-left p-4 border-2 rounded-lg transition-all text-lg">${option.text}</button>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },
            matchUp: () => `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-bold">Match-Up Game</h1>
                        <p class="text-lg font-semibold">Score: <span id="matchup-score">0</span></p>
                    </div>
                    <p class="text-slate-500 mb-6">Drag the drug name to its correct class. Complete all drugs to win!</p>
                    <div id="matchup-board" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div id="drug-pile" class="space-y-3"><h2 class="font-bold text-lg text-center">Drugs</h2></div>
                        <div id="class-bins" class="space-y-3"><h2 class="font-bold text-lg text-center">Classes</h2></div>
                    </div>
                    <div id="matchup-feedback" class="mt-6 text-center"></div>
                </div>
            `,
            scenarios: () => {
                if (!state.scenarios) return '';
                const { deck, currentIndex, isComplete, stage } = state.scenarios;
                if(isComplete || !deck || deck.length === 0) {
                     return `<div class="text-center bg-white p-8 rounded-xl shadow-lg"><h1 class="text-4xl font-bold mb-2">Scenarios Complete!</h1><p class="text-2xl text-slate-600 mb-8">You've completed all clinical scenarios. Great job!</p><button onclick="App.startScenarios()" class="bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 text-lg">Practice Again</button></div>`;
                }
                const scenario = deck[currentIndex];
                return `
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Clinical Scenarios</h1>
                        <p class="text-slate-500 mb-6">Apply your knowledge. Scenario ${currentIndex + 1} of ${deck.length}</p>
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                            <div class="border border-slate-300 rounded-lg">
                                <div class="bg-slate-700 text-white px-4 py-2 rounded-t-lg flex items-center"><i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>PATIENT CHART</div>
                                <div class="p-4 space-y-4">
                                    <div><span class="font-semibold w-32 inline-block">PATIENT:</span><span>${scenario.patient}</span></div>
                                    <div><span class="font-semibold w-32 inline-block">CHIEF COMPLAINT:</span><span>${scenario.chiefComplaint}</span></div>
                                    <div id="assessment-section" class="reveal-section ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                                        <div class="border-t border-slate-200 pt-4 mt-4 space-y-4">
                                            <div><span class="font-semibold w-32 inline-block">VITALS:</span><span class="text-red-600 font-medium">${scenario.assessment.vitals}</span></div>
                                            <div><span class="font-semibold w-32 inline-block">FINDINGS:</span><span>${scenario.assessment.findings}</span></div>
                                        </div>
                                    </div>
                                    ${stage === 'initial' ? `<button id="assess-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center mx-auto mt-4"><i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i>Assess Patient</button>`: ''}
                                </div>
                            </div>
                            <div id="decision-section" class="reveal-section mt-6 ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                                <p class="text-lg font-semibold mb-4 text-sky-800">${scenario.question}</p>
                                <div id="scenario-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${scenario.options.map(option => `<button data-text="${option.text}" data-correct="${!!option.correct}" class="scenario-option text-left p-4 border-2 border-slate-200 rounded-lg hover:border-sky-500 hover:bg-sky-50 transition-colors disabled:opacity-75 disabled:cursor-not-allowed">${option.text}</button>`).join('')}
                                </div>
                            </div>
                            <div id="scenario-rationale" class="mt-6"></div>
                        </div>
                    </div>
                `;
            },
        };

        const App = {
            quizInterval: null,
            init() {
                this.loadState();
                this.router();
                window.addEventListener('hashchange', this.router.bind(this));
                navigation.addEventListener('click', e => {
                    const link = e.target.closest('a');
                    if (link && !link.onclick) {
                        e.preventDefault();
                        window.location.hash = link.getAttribute('href');
                    }
                });
                resetProgressBtn.addEventListener('click', () => confirmResetModal.classList.add('visible'));
                document.getElementById('cancel-reset-btn').addEventListener('click', () => confirmResetModal.classList.remove('visible'));
                document.getElementById('confirm-reset-btn').addEventListener('click', () => {
                    confirmResetModal.classList.remove('visible');
                    this.resetState();
                });
            },
            router() {
                clearInterval(this.quizInterval);
                const path = window.location.hash || '#dashboard';
                state.currentView = path;
                mainContent.style.opacity = 0;
                setTimeout(() => {
                    switch(path) {
                        case '#dashboard': mainContent.innerHTML = Templates.dashboard(); break;
                        case '#drug-library': mainContent.innerHTML = Templates.drugLibrary(); break;
                        case '#flashcards': 
                            this.startFlashcards(); 
                            mainContent.innerHTML = Templates.flashcards(); 
                            break;
                        case '#rapid-fire': 
                            mainContent.innerHTML = Templates.rapidFire();
                            if(state.quiz.deck && state.quiz.deck.length > 0 && !state.quiz.isComplete) this.attachQuizListeners();
                            break;
                        case '#match-up':
                            mainContent.innerHTML = Templates.matchUp();
                            this.startMatchUpGame();
                            break;
                        case '#scenarios': 
                            if (!state.scenarios || state.scenarios.deck.length === 0) this.startScenarios();
                            mainContent.innerHTML = Templates.scenarios();
                            this.attachScenarioListeners();
                            break;
                        default:
                            window.location.hash = '#dashboard';
                            mainContent.innerHTML = Templates.dashboard();
                    }
                    this.updateNav();
                    lucide.createIcons();
                    mainContent.style.opacity = 1;
                }, 150);
            },
            updateNav() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('href') === state.currentView) item.classList.add('active');
                    else item.classList.remove('active');
                });
            },
            shuffle: (array) => array.sort(() => Math.random() - 0.5),
            saveState() { localStorage.setItem('pharmaMasteryStateV7', JSON.stringify(state)); },
            loadState() {
                const savedState = localStorage.getItem('pharmaMasteryStateV7');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (!state.flashcard || !state.userMnemonics || !state.matchUp) {
                        this.resetState(false);
                    }
                } else {
                    this.resetState(false);
                }
            },
            resetState(doRoute = true) {
                const initialCardsState = {};
                drugData.forEach(d => { initialCardsState[d.id] = { stage: 'new', lastReviewed: null, correctInARow: 0 }; });
                state = { 
                    currentView: '#dashboard', 
                    flashcard: { cards: initialCardsState, deck: [], currentIndex: 0 },
                    quiz: { deck: [], currentQuestion: 0, score: 0, isComplete: false, timer: { enabled: false, remaining: 120 } }, 
                    scenarios: { deck: [], currentIndex: 0, isComplete: false, stage: 'initial' }, 
                    userMnemonics: {},
                    matchUp: { score: 0, matchedDrugIds: [] },
                };
                if(doRoute) { window.location.hash = '#dashboard'; this.router(); }
                this.saveState();
            },
            getMoaVisual(drugClass) {
                let svgContent = '';
                if (drugClass.includes('SSRI') || drugClass.includes('SNRI') || drugClass.includes('TCA')) {
                    svgContent = `<svg viewBox="0 0 100 50"><path class="neuron-pre" d="M0,5 H60 V25 H0 Z" /><rect class="pump" x="20" y="25" width="10" height="15" /><g class="reuptake-block"><rect class="blocker" x="20" y="25" width="10" height="5" /></g><circle class="neurotransmitter" cx="45" cy="32" r="3" /><path class="neuron-post" d="M30,50 H90 V40 H30 Z" /><rect class="receptor" x="43" y="40" width="8" height="2" /></svg><p class="text-xs text-center text-slate-500 mt-1">Reuptake Inhibitor</p>`;
                } else if (drugClass.includes('Antagonist')) {
                     svgContent = `<svg viewBox="0 0 100 50"><path class="neuron-pre" d="M0,5 H60 V25 H0 Z" /><circle class="neurotransmitter" cx="45" cy="15" r="3" /><path class="neuron-post" d="M30,50 H90 V40 H30 Z" /><rect class="receptor" x="43" y="40" width="8" height="2" /><text class="blocker" x="47" y="48" font-size="24" text-anchor="middle">X</text></svg><p class="text-xs text-center text-slate-500 mt-1">Receptor Antagonist</p>`;
                } else {
                     svgContent = `<div class="flex items-center justify-center h-full text-slate-400">No Visual</div>`;
                }
                return svgContent;
            },
            getReverseQuiz() {
                const index = Math.floor(Math.random() * reverseQuizData.length);
                return reverseQuizData[index];
            },
            checkReverseQuiz(correctAnswer) {
                const input = document.getElementById('reverse-quiz-input');
                const feedback = document.getElementById('reverse-quiz-feedback');
                if (input.value.trim().toLowerCase() === correctAnswer.toLowerCase()) {
                    feedback.textContent = 'Correct! Nice job!';
                    feedback.className = 'mt-2 text-sm font-semibold text-green-600';
                } else {
                    feedback.textContent = `Not quite. The answer is ${correctAnswer}.`;
                    feedback.className = 'mt-2 text-sm font-semibold text-red-600';
                }
            },
            toggleMnemonicEditor(drugId) {
                document.getElementById(`mnemonic-editor-${drugId}`).classList.toggle('hidden');
            },
            saveUserMnemonic(drugId) {
                const input = document.getElementById(`mnemonic-input-${drugId}`);
                const display = document.getElementById(`mnemonic-display-${drugId}`);
                state.userMnemonics[drugId] = input.value;
                display.textContent = `"${input.value}"`;
                if(input.value) display.classList.remove('hidden'); else display.classList.add('hidden');
                this.toggleMnemonicEditor(drugId);
                this.saveState();
            },
            startFlashcards() {
                const now = new Date().getTime();
                const cardStates = state.flashcard.cards;
                let reviewPile = [];
                for (const id in cardStates) {
                    const card = cardStates[id];
                    let shouldReview = false;
                    switch (card.stage) {
                        case 'new': shouldReview = true; break;
                        case 'learning': shouldReview = !card.lastReviewed || (now - card.lastReviewed > 10 * 60 * 1000); break;
                        case 'mastered': shouldReview = !card.lastReviewed || (now - card.lastReviewed > card.correctInARow * 24 * 60 * 60 * 1000); break;
                    }
                    if (shouldReview) { reviewPile.push(drugData.find(d => d.id === id)); }
                }
                state.flashcard.deck = this.shuffle(reviewPile);
                state.flashcard.currentIndex = 0;
                this.saveState();
            },
            handleFlashcardAnswer(difficulty) {
                if(!state.flashcard.deck || state.flashcard.deck.length === 0) return this.router();
                const cardId = state.flashcard.deck[state.flashcard.currentIndex].id;
                const cardState = state.flashcard.cards[cardId];
                cardState.lastReviewed = new Date().getTime();
                switch(difficulty) {
                    case 'again': cardState.stage = 'learning'; cardState.correctInARow = 0; break;
                    case 'good':
                        if (cardState.stage !== 'mastered') { cardState.stage = 'mastered'; cardState.correctInARow = 1; } 
                        else { cardState.correctInARow++; }
                        break;
                    case 'easy': cardState.stage = 'mastered'; cardState.correctInARow = (cardState.correctInARow || 0) + 3; break;
                }
                state.flashcard.currentIndex++;
                if (state.flashcard.currentIndex >= state.flashcard.deck.length) { this.startFlashcards(); }
                this.router();
            },
            startQuiz(timed = false) {
                state.quiz = {
                    deck: this.generateQuiz(10),
                    currentQuestion: 0, score: 0, isComplete: false,
                    timer: { enabled: timed, remaining: 120 }
                };
                if (timed) {
                    this.quizInterval = setInterval(() => {
                        state.quiz.timer.remaining--;
                        const timerDisplay = document.getElementById('timer-display');
                        if (timerDisplay) timerDisplay.textContent = `Time: ${state.quiz.timer.remaining}`;
                        if (state.quiz.timer.remaining <= 0) {
                            clearInterval(this.quizInterval);
                            state.quiz.isComplete = true;
                            this.router();
                        }
                    }, 1000);
                }
                this.router();
            },
            generateQuiz(numQuestions) {
                let questions = [];
                const shuffledDrugs = this.shuffle([...drugData]);
                for(let i=0; i < Math.min(numQuestions, shuffledDrugs.length); i++) {
                    const drug = shuffledDrugs[i];
                    const questionType = Math.random() < 0.5 ? 'class' : 'effect';
                    let question;
                    if(questionType === 'class') {
                        question = { text: `Which class does ${drug.name} belong to?`, options: this.generateOptions(drug.class, drugData.map(d => d.class)) };
                    } else {
                        const correctEffect = drug.effects[Math.floor(Math.random() * drug.effects.length)];
                        question = { text: `Which is a common adverse effect of ${drug.name}?`, options: this.generateOptions(correctEffect, drugData.flatMap(d => d.effects)) };
                    }
                    questions.push(question);
                }
                return questions;
            },
            generateOptions(correctAnswer, allAnswers) {
                let options = [{text: correctAnswer, correct: true}];
                let otherOptions = [...new Set(allAnswers)].filter(a => a !== correctAnswer);
                otherOptions = this.shuffle(otherOptions);
                for(let i=0; i < 3; i++) { if(otherOptions[i]) options.push({text: otherOptions[i], correct: false}); }
                return this.shuffle(options);
            },
            attachQuizListeners() {
                const optionsContainer = document.getElementById('quiz-options');
                if(!optionsContainer) return;
                optionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.quiz-option');
                    if(!button || button.disabled) return;
                    document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                    const isCorrect = button.dataset.answer === 'true';
                    if(isCorrect) { state.quiz.score++; button.classList.add('correct'); } 
                    else { button.classList.add('incorrect'); optionsContainer.querySelector('[data-answer="true"]').classList.add('correct'); }
                    setTimeout(() => {
                        state.quiz.currentQuestion++;
                        if(state.quiz.currentQuestion >= state.quiz.deck.length) {
                            clearInterval(this.quizInterval);
                            state.quiz.isComplete = true;
                        }
                        this.saveState();
                        this.router();
                    }, 1200);
                });
            },
            startMatchUpGame() {
                if(state.matchUp.matchedDrugIds.length >= drugData.length) {
                    state.matchUp.matchedDrugIds = []; // Reset if all drugs are matched
                }
                this.generateMatchUpRound();
            },
            generateMatchUpRound() {
                const feedbackEl = document.getElementById('matchup-feedback');
                if(feedbackEl) feedbackEl.innerHTML = '';

                const drugPile = document.getElementById('drug-pile');
                const classBins = document.getElementById('class-bins');
                if (!drugPile || !classBins) return;
                drugPile.innerHTML = '<h2 class="font-bold text-lg text-center">Drugs</h2>';
                classBins.innerHTML = '<h2 class="font-bold text-lg text-center">Classes</h2>';
                
                let unmatchedDrugs = drugData.filter(d => !state.matchUp.matchedDrugIds.includes(d.id));
                if (unmatchedDrugs.length === 0) {
                    document.getElementById('matchup-board').innerHTML = `<div class="text-center col-span-2"><p class="text-green-600 font-bold text-2xl">You've matched all the drugs!</p><button onclick="App.startMatchUpGame()" class="mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">Play Again</button></div>`;
                    return;
                }

                let roundDrugs = this.shuffle(unmatchedDrugs).slice(0, 5);
                state.matchUp.currentRoundDrugs = roundDrugs.map(d => d.id);
                let roundClasses = [...new Set(roundDrugs.map(d => d.class))];

                this.shuffle(roundDrugs).forEach(drug => {
                    drugPile.innerHTML += `<div id="match-drug-${drug.id}" draggable="true" data-class="${drug.class}" class="match-item p-3 bg-white rounded-lg shadow cursor-grab text-center">${drug.name}</div>`;
                });

                this.shuffle(roundClasses).forEach(className => {
                    classBins.innerHTML += `<div data-class="${className}" class="drop-zone p-8 rounded-lg text-center font-semibold text-slate-600">${className}</div>`;
                });
                this.attachDragDropListeners();
            },
            attachDragDropListeners() {
                document.querySelectorAll('.match-item').forEach(item => {
                    item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.id));
                });
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('over'); });
                    zone.addEventListener('dragleave', () => zone.classList.remove('over'));
                    zone.addEventListener('drop', e => {
                        e.preventDefault();
                        zone.classList.remove('over');
                        const drugIdWithPrefix = e.dataTransfer.getData('text');
                        const drugId = drugIdWithPrefix.replace('match-drug-', '');
                        const drugEl = document.getElementById(drugIdWithPrefix);
                        if (!drugEl) return;
                        
                        const drugClass = drugEl.dataset.class;
                        const zoneClass = zone.dataset.class;

                        if (drugClass === zoneClass) {
                            zone.classList.add('correct');
                            drugEl.style.display = 'none';
                            state.matchUp.score += 10;
                            state.matchUp.matchedDrugIds.push(drugId);
                            document.getElementById('matchup-score').textContent = state.matchUp.score;

                            const allMatchedInRound = state.matchUp.currentRoundDrugs.every(id => state.matchUp.matchedDrugIds.includes(id));
                            if (allMatchedInRound) {
                                document.getElementById('matchup-feedback').innerHTML = `<p class="text-green-600 font-bold text-xl">Round Complete! Great job!</p><button onclick="App.generateMatchUpRound()" class="mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">Next Round</button>`;
                            }
                        } else {
                            zone.classList.add('incorrect');
                            setTimeout(() => zone.classList.remove('incorrect'), 500);
                            state.matchUp.score -= 5;
                            document.getElementById('matchup-score').textContent = state.matchUp.score;
                        }
                        this.saveState();
                    });
                });
            },
            startScenarios() {
                state.scenarios = { deck: this.shuffle([...scenarioData]), currentIndex: 0, isComplete: false, stage: 'initial' };
                this.saveState();
            },
            attachScenarioListeners() {
                 if (!state.scenarios || state.scenarios.isComplete) return;
                const assessBtn = document.getElementById('assess-btn');
                if (assessBtn) {
                    assessBtn.addEventListener('click', () => {
                        state.scenarios.stage = 'assessed';
                        this.router(); 
                    });
                }
                const optionsContainer = document.getElementById('scenario-options');
                if (optionsContainer && state.scenarios.stage === 'assessed') {
                     optionsContainer.addEventListener('click', e => {
                        const button = e.target.closest('.scenario-option');
                        if (!button || state.scenarios.stage === 'answered') return;
                        state.scenarios.stage = 'answered';
                        const isCorrect = button.dataset.correct === 'true';
                        const currentScenario = state.scenarios.deck[state.scenarios.currentIndex];
                        const rationaleDiv = document.getElementById('scenario-rationale');
                        let rationaleHTML = '';
                        if(isCorrect) {
                            button.classList.add('correct');
                            rationaleHTML = `<div class="p-4 bg-green-50 border border-green-200 rounded-lg"><h4 class="font-bold text-green-800 flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Correct!</h4><p class="text-green-700 mt-2">${currentScenario.rationale.correct}</p></div>`;
                        } else {
                            button.classList.add('incorrect');
                            const correctButton = optionsContainer.querySelector('[data-correct="true"]');
                            correctButton.classList.add('correct');
                            const incorrectRationale = currentScenario.rationale.incorrect[button.dataset.text] || "This was not the best choice in this situation.";
                            rationaleHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg space-y-3">
                                <div><h4 class="font-bold text-red-800 flex items-center"><i data-lucide="x-circle" class="w-5 h-5 mr-2"></i>Incorrect.</h4><p class="text-red-700 mt-1">${incorrectRationale}</p></div>
                                <div class="border-t pt-2"><p class="font-semibold text-slate-700">The correct answer is ${correctButton.innerText} because: ${currentScenario.rationale.correct}</p></div>
                            </div>`;
                        }
                        rationaleDiv.innerHTML = rationaleHTML;
                        document.querySelectorAll('.scenario-option').forEach(b => b.disabled = true);
                        const nextButton = document.createElement('button');
                        nextButton.innerHTML = `Next Scenario <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>`;
                        nextButton.className = 'bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700 mt-4 flex items-center ml-auto';
                        rationaleDiv.appendChild(nextButton);
                        lucide.createIcons();
                        nextButton.addEventListener('click', () => {
                            state.scenarios.currentIndex++;
                            if (state.scenarios.currentIndex >= state.scenarios.deck.length) {
                                state.scenarios.isComplete = true;
                            } else {
                                state.scenarios.stage = 'initial';
                            }
                            this.router();
                        });
                     });
                }
            },
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
