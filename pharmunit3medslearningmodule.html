<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacology Exam 3 Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Softer blue-gray background */
            color: #1e293b;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .main-content { transition: opacity 0.3s ease-in-out; }
        .nav-item.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .nav-item.active i { color: #0369a1; }
        .achievement-card { transition: transform 0.2s, box-shadow 0.2s; }
        .achievement-card.unlocked { border-color: #f59e0b; background-color: #fffbeb; }
        .achievement-card.unlocked .text-slate-400 { color: #f59e0b; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-input { animation: shake 0.5s; }
        
        .quiz-option.correct, .scenario-option.correct, .daily-dose-option.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .quiz-option.incorrect, .scenario-option.incorrect, .daily-dose-option.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; border-radius: 0.75rem; background-color: white; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .flashcard-back { transform: rotateY(180deg); text-align: left; align-items: flex-start; justify-content: space-around; }
        
        .drop-zone { border: 2px dashed #94a3b8; transition: background-color 0.2s, border-color 0.2s; }
        .drop-zone.over { background-color: #dbeafe; border-color: #3b82f6; }
        .drop-zone.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .drop-zone.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        
        .reveal-section { transition: all 0.5s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; transform: translateY(-10px); }
        .reveal-section.revealed { max-height: 1000px; opacity: 1; transform: translateY(0); }

        .custom-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .custom-modal-overlay.visible { opacity: 1; visibility: visible; }
        .custom-modal-content { background: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 500px; width: 100%; transform: scale(0.95); transition: transform 0.3s; }
        .custom-modal-overlay.visible .custom-modal-content { transform: scale(1); }

        /* Progress bar for drug library */
        .drug-progress-bar-container {
            width: 100px; /* Fixed width for consistency */
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        .drug-progress-bar {
            height: 100%;
            background-color: #22c55e; /* Green for mastery */
            border-radius: 3px;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
        <div class="p-6 border-b border-slate-200">
            <h1 class="text-xl font-bold text-sky-800">Exam 3 Mastery <span class="text-xs align-top bg-green-200 text-green-800 p-1 rounded-md">v1</span></h1>
            <p class="text-sm text-slate-500">Pharmacology Focused</p>
        </div>
        <nav id="navigation" class="flex-1 p-4 space-y-2">
            <a href="#dashboard" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
            <a href="#achievements" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="award" class="w-5 h-5 mr-3"></i> Achievements</a>
            <a href="#drug-library" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="library" class="w-5 h-5 mr-3"></i> Drug Library</a>
            <div class="pt-2">
                    <p class="px-4 text-xs font-semibold text-slate-400 uppercase">Study Modes</p>
                    <a href="#flashcards" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="layers" class="w-5 h-5 mr-3"></i> Flashcards</a>
                    <a href="#match-up" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="puzzle" class="w-5 h-5 mr-3"></i> Match-Up</a>
                    <a href="#pharmacy-fill" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="pill" class="w-5 h-5 mr-3"></i> Pharmacy Fill</a>
                    <a href="#rapid-fire" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="zap" class="w-5 h-5 mr-3"></i> Rapid Fire</a>
                    <a href="#scenarios" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="clipboard-check" class="w-5 h-5 mr-3"></i> Scenarios</a>
                    <a href="#explain-this" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="lightbulb" class="w-5 h-5 mr-3"></i> Explain This</a>
                    <a href="#pomodoro" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="timer" class="w-5 h-5 mr-3"></i> Pomodoro Timer</a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-200">
            <button id="reset-progress-btn" class="w-full text-sm text-center text-slate-500 hover:text-red-600 transition-colors">Reset Progress</button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 bg-slate-50 overflow-y-auto p-6 md:p-8"></main>

    <div id="confirm-reset-modal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 class="text-lg font-bold text-slate-800">Are you sure?</h3>
            <p class="text-sm text-slate-600 mt-2 mb-6">Resetting will erase all your progress. This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-reset-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancel</button>
                <button id="confirm-reset-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yes, Reset</button>
            </div>
        </div>
    </div>
    <div id="achievement-unlocked-modal" class="custom-modal-overlay">
        <div class="custom-modal-content text-center">
                <i data-lucide="award" class="w-16 h-16 mx-auto text-amber-500"></i>
            <h3 id="achievement-title" class="text-2xl font-bold text-slate-800 mt-4">Achievement Unlocked!</h3>
            <p id="achievement-desc" class="text-slate-600 mt-2 mb-6">You've unlocked a new badge!</p>
            <button id="close-achievement-btn" class="px-6 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600">Awesome!</button>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const drugData = [
            // Pain/Inflammation and Analgesics
            { id: 'allopurinol', name: 'Allopurinol', brandNames: ['Zyloprim', 'Aloprim'], class: 'Xanthine Oxidase Inhibitor (Anti-gout)', moa: 'Decreases the production of uric acid by inhibiting the enzyme xanthine oxidase.', effects: ['Rash (can be severe like SJS)', 'GI upset', 'Liver/kidney dysfunction', 'Drowsiness'], nursingConsiderations: ['Monitor uric acid levels, liver and kidney function.', 'Encourage increased fluid intake to prevent kidney stones.', 'Administer after meals to reduce GI upset.', 'Report rash immediately.'], highAlert: false},
            { id: 'celecoxib', name: 'Celecoxib', brandNames: ['Celebrex'], class: 'COX-2 Inhibitor (NSAID)', moa: 'Selectively inhibits cyclooxygenase-2 (COX-2) enzyme, reducing inflammation, pain, and fever.', effects: ['GI upset (less than non-selective NSAIDs)', 'Increased risk of cardiovascular events (MI, stroke)', 'Renal impairment', 'Edema'], nursingConsiderations: ['Monitor for signs of GI bleeding and cardiovascular events.', 'Assess renal function (BUN, creatinine).', 'Contraindicated in patients with sulfa allergy.', 'Use lowest effective dose for shortest duration.'], highAlert: false},
            { id: 'aspirin', name: 'Aspirin', brandNames: ['Bayer Aspirin', 'Ecotrin'], class: 'Salicylate (NSAID, Antiplatelet)', moa: 'Irreversibly inhibits cyclooxygenase-1 (COX-1) and COX-2 enzymes, leading to reduced prostaglandin synthesis and inhibition of platelet aggregation.', effects: ['GI bleeding/ulcers', 'Tinnitus (salicylism)', 'Reye\'s syndrome (in children with viral infections)', 'Hypersensitivity reactions'], nursingConsiderations: ['Administer with food or milk to reduce GI irritation.', 'Monitor for signs of bleeding (bruising, black stools).', 'Avoid in children/adolescents with viral infections (risk of Reye\'s syndrome).', 'Discontinue 5-7 days before surgery.'], highAlert: true},
            { id: 'ibuprofen', name: 'Ibuprofen', brandNames: ['Advil', 'Motrin'], class: 'NSAID', moa: 'Reversibly inhibits cyclooxygenase-1 (COX-1) and COX-2 enzymes, reducing inflammation, pain, and fever.', effects: ['GI upset/bleeding', 'Renal impairment', 'Increased risk of cardiovascular events', 'Edema'], nursingConsiderations: ['Administer with food or milk to reduce GI irritation.', 'Monitor renal function (BUN, creatinine).', 'Advise patient to report signs of bleeding.', 'Avoid in patients with severe heart failure.'], highAlert: false},
            { id: 'acetaminophen', name: 'Acetaminophen', brandNames: ['Tylenol'], class: 'Analgesic, Antipyretic', moa: 'Inhibits prostaglandin synthesis primarily in the central nervous system, reducing pain and fever.', effects: ['Hepatotoxicity (liver damage) with overdose', 'Rash'], nursingConsiderations: ['Assess for history of liver disease/alcoholism.', 'Maximum daily dose is typically 4g (or 3g for chronic use).', 'Educate patient about combination products containing acetaminophen.', 'Antidote for overdose is acetylcysteine.'], highAlert: false},
            { id: 'morphine_sulfate', name: 'Morphine Sulfate', brandNames: ['MS Contin', 'Roxanol'], class: 'Opioid Analgesic', moa: 'Binds to opioid receptors in the central nervous system, altering the perception and response to pain.', effects: ['Respiratory depression', 'Sedation', 'Constipation', 'Nausea/vomiting', 'Orthostatic hypotension', 'Pruritus'], nursingConsiderations: ['Assess pain level, respiratory rate, and sedation level frequently.', 'Monitor for constipation and implement bowel regimen.', 'Administer slowly IV.', 'High potential for abuse and dependence.', 'Antidote is naloxone.'], highAlert: true},
            { id: 'nalbuphine', name: 'Nalbuphine', brandNames: ['Nubain'], class: 'Opioid Agonist-Antagonist', moa: 'Agonist at kappa opioid receptors and a partial antagonist at mu opioid receptors, providing analgesia with a ceiling effect on respiratory depression.', effects: ['Sedation', 'Nausea/vomiting', 'Respiratory depression (less than pure agonists)', 'Dizziness'], nursingConsiderations: ['Assess pain and respiratory status.', 'Can precipitate withdrawal symptoms in patients physically dependent on pure opioid agonists.', 'Monitor for CNS depression.'], highAlert: false},
            
            // Antimicrobial Drugs
            { id: 'amoxicillin', name: 'Amoxicillin', brandNames: ['Amoxil', 'Moxatag'], class: 'Penicillin Antibiotic', moa: 'Inhibits bacterial cell wall synthesis by binding to penicillin-binding proteins, leading to cell lysis.', effects: ['Allergic reactions (rash, anaphylaxis)', 'GI upset (nausea, diarrhea)', 'C. difficile infection'], nursingConsiderations: ['Assess for penicillin allergy before administration.', 'Instruct patient to take full course of medication.', 'May be taken with food to decrease GI upset.', 'Monitor for signs of superinfection (e.g., oral thrush, vaginal yeast infection).'], highAlert: false},
            { id: 'ceftriaxone', name: 'Ceftriaxone', brandNames: ['Rocephin'], class: 'Cephalosporin Antibiotic', moa: 'Inhibits bacterial cell wall synthesis by binding to penicillin-binding proteins, leading to cell lysis.', effects: ['Allergic reactions (cross-sensitivity with penicillins)', 'GI upset', 'C. difficile infection', 'Injection site pain'], nursingConsiderations: ['Assess for penicillin or cephalosporin allergy.', 'Do not administer with calcium-containing IV solutions.', 'Monitor for signs of C. difficile-associated diarrhea.', 'Administer deep IM or slow IV.'], highAlert: false},
            { id: 'vancomycin', name: 'Vancomycin', brandNames: ['Vancocin'], class: 'Glycopeptide Antibiotic', moa: 'Inhibits bacterial cell wall synthesis by interfering with peptidoglycan polymerization.', effects: ['Ototoxicity (hearing loss, tinnitus)', 'Nephrotoxicity (kidney damage)', 'Red Man Syndrome (flushing, rash, pruritus, hypotension from rapid infusion)'], nursingConsiderations: ['Monitor vancomycin trough levels (before 4th dose).', 'Assess renal function (BUN, creatinine) regularly.', 'Infuse slowly over at least 60 minutes to prevent Red Man Syndrome.', 'Monitor hearing and balance.', 'High alert due to narrow therapeutic index and toxicity risk.'], highAlert: true},
            { id: 'gentamicin', name: 'Gentamicin', brandNames: ['Garamycin'], class: 'Aminoglycoside Antibiotic', moa: 'Inhibits bacterial protein synthesis by binding to the 30S ribosomal subunit.', effects: ['Ototoxicity (hearing loss, vertigo)', 'Nephrotoxicity (kidney damage)', 'Neuromuscular blockade'], nursingConsiderations: ['Monitor peak and trough levels to ensure therapeutic range and minimize toxicity.', 'Assess renal function (BUN, creatinine, urine output).', 'Monitor for signs of ototoxicity (tinnitus, hearing loss, dizziness).', 'Ensure adequate hydration.'], highAlert: true},
            { id: 'clindamycin', name: 'Clindamycin', brandNames: ['Cleocin'], class: 'Lincosamide Antibiotic', moa: 'Inhibits bacterial protein synthesis by binding to the 50S ribosomal subunit.', effects: ['Severe C. difficile-associated diarrhea (CDAD)', 'GI upset', 'Rash'], nursingConsiderations: ['Monitor for severe diarrhea or abdominal cramping; discontinue if CDAD occurs.', 'Educate patient to report persistent diarrhea.', 'Take with a full glass of water to prevent esophageal irritation.'], highAlert: false},
            { id: 'ciprofloxacin', name: 'Ciprofloxacin', brandNames: ['Cipro'], class: 'Fluoroquinolone Antibiotic', moa: 'Inhibits bacterial DNA gyrase and topoisomerase IV, essential for bacterial DNA replication and repair.', effects: ['Tendon rupture (Achilles tendon most common)', 'Photosensitivity', 'QT prolongation', 'GI upset', 'C. difficile infection'], nursingConsiderations: ['Educate patient to report any tendon pain, swelling, or inflammation and to discontinue medication immediately.', 'Advise patient to avoid sun exposure and use sunscreen.', 'Avoid concurrent administration with antacids, iron, or dairy products (decreases absorption).', 'Monitor EKG for QT prolongation.'], highAlert: false},

            // Cardiac Part 1
            { id: 'digoxin', name: 'Digoxin', brandNames: ['Lanoxin'], class: 'Cardiac Glycoside', moa: 'Increases myocardial contractility (positive inotropic effect) by inhibiting Na+/K+-ATPase pump, and decreases heart rate (negative chronotropic effect).', effects: ['Digoxin toxicity (anorexia, nausea, vomiting, bradycardia, visual disturbances like yellow-green halos)', 'Arrhythmias'], nursingConsiderations: ['Monitor apical pulse for 1 full minute before administration; hold if HR <60 bpm (adults) and notify provider.', 'Monitor digoxin serum levels (therapeutic range 0.5-2 ng/mL).', 'Monitor potassium levels; hypokalemia increases risk of toxicity.', 'Antidote is Digoxin Immune Fab (Digibind).', 'High alert due to narrow therapeutic index.'], highAlert: true},
            { id: 'nitroglycerin', name: 'Nitroglycerin', brandNames: ['Nitrostat', 'Nitro-Dur'], class: 'Nitrate (Antianginal)', moa: 'Relaxes vascular smooth muscle by stimulating guanylate cyclase, leading to vasodilation (primarily venous), which decreases preload and myocardial oxygen demand.', effects: ['Headache', 'Orthostatic hypotension', 'Reflex tachycardia', 'Flushing'], nursingConsiderations: ['For sublingual tablets, administer up to 3 doses, 5 minutes apart, if chest pain persists; call 911 if no relief after first dose.', 'Monitor blood pressure and heart rate closely.', 'Teach patient to sit or lie down when taking to prevent falls from hypotension.', 'Store tablets in original dark glass container, away from light and moisture.'], highAlert: true},
            { id: 'mannitol', name: 'Mannitol', brandNames: ['Osmitrol'], class: 'Osmotic Diuretic', moa: 'Increases osmotic pressure of the glomerular filtrate, inhibiting tubular reabsorption of water and electrolytes, leading to increased urine output.', effects: ['Fluid and electrolyte imbalances', 'Pulmonary edema', 'Heart failure exacerbation', 'Headache'], nursingConsiderations: ['Monitor fluid and electrolyte balance closely (Na, K, osmolality).', 'Assess for signs of dehydration or fluid overload (e.g., crackles in lungs).', 'Administer through an in-line filter due => potential for crystallization.', 'Monitor intracranial pressure (ICP) if used for cerebral edema.', 'High alert due to rapid fluid shifts.'], highAlert: true},
            { id: 'furosemide', name: 'Furosemide', brandNames: ['Lasix'], class: 'Loop Diuretic', moa: 'Inhibits sodium and chloride reabsorption in the ascending loop of Henle, leading to significant diuresis.', effects: ['Hypokalemia', 'Dehydration', 'Hypotension', 'Ototoxicity (especially with rapid IV push)', 'Hyperglycemia'], nursingConsiderations: ['Monitor fluid and electrolyte balance, especially potassium levels.', 'Assess blood pressure before administration; hold if hypotensive.', 'Administer IV push slowly over 1-2 minutes to prevent ototoxicity.', 'Encourage potassium-rich foods or provide potassium supplements as ordered.', 'Monitor I&O and daily weights.'], highAlert: false},
            { id: 'hydrochlorothiazide', name: 'Hydrochlorothiazide', brandNames: ['HCTZ', 'Microzide'], class: 'Thiazide Diuretic', moa: 'Inhibits sodium and chloride reabsorption in the distal convoluted tubule, leading to increased excretion of sodium, chloride, and water.', effects: ['Hypokalemia', 'Hyperglycemia', 'Hyperuricemia', 'Photosensitivity', 'Dizziness'], nursingConsiderations: ['Monitor fluid and electrolyte balance, especially potassium and glucose levels.', 'Advise patient to use sunscreen and protective clothing due to photosensitivity.', 'Administer in the morning to prevent nocturia.', 'May potentiate effects of other antihypertensives.'], highAlert: false},
            { id: 'spironolactone', name: 'Spironolactone', brandNames: ['Aldactone'], class: 'Potassium-Sparing Diuretic', moa: 'Acts as an aldosterone antagonist in the distal renal tubules, leading to increased sodium and water excretion while retaining potassium.', effects: ['Hyperkalemia', 'Gynecomastia (in males)', 'Irregular menses', 'Dizziness'], nursingConsiderations: ['Monitor potassium levels closely; avoid potassium supplements or salt substitutes.', 'Assess for signs of hyperkalemia (muscle weakness, fatigue, cardiac arrhythmias).', 'Administer with food to increase absorption and reduce GI upset.', 'Educate patient on symptoms of hyperkalemia.'], highAlert: false},
            { id: 'metoprolol', name: 'Metoprolol', brandNames: ['Lopressor', 'Toprol XL'], class: 'Beta-Blocker', moa: 'Selectively blocks beta-1 adrenergic receptors in the heart, decreasing heart rate, myocardial contractility, and blood pressure.', effects: ['Bradycardia', 'Hypotension', 'Fatigue', 'Dizziness', 'Bronchospasm (less common with selective beta-blockers)'], nursingConsiderations: ['Monitor heart rate and blood pressure before administration; hold if HR <60 bpm or SBP <90-100 mmHg and notify provider.', 'Do not discontinue abruptly due to risk of rebound hypertension or angina.', 'May mask signs of hypoglycemia in diabetic patients.', 'Assess for signs of heart failure exacerbation.'], highAlert: false},
            { id: 'lisinopril', name: 'Lisinopril', brandNames: ['Prinivil', 'Zestril'], class: 'ACE Inhibitor', moa: 'Inhibits angiotensin-converting enzyme (ACE), preventing the conversion of angiotensin I to angiotensin II, leading to vasodilation and reduced aldosterone secretion.', effects: ['Dry, persistent cough', 'Hyperkalemia', 'Angioedema (rare but serious swelling of face, lips, tongue, throat)', 'First-dose hypotension', 'Renal impairment'], nursingConsiderations: ['Monitor blood pressure, renal function (BUN, creatinine), and potassium levels.', 'Educate patient about the potential for a dry cough.', 'Advise patient to report any swelling of the face, lips, or tongue immediately.', 'High alert due to angioedema risk.'], highAlert: true},
            { id: 'amlodipine', name: 'Amlodipine', brandNames: ['Norvasc'], class: 'Calcium Channel Blocker (Dihydropyridine)', moa: 'Inhibits calcium ion influx across cardiac and vascular smooth muscle cell membranes, causing vasodilation and decreased peripheral vascular resistance.', effects: ['Peripheral edema', 'Headache', 'Flushing', 'Dizziness', 'Reflex tachycardia'], nursingConsiderations: ['Monitor blood pressure and heart rate.', 'Assess for peripheral edema, especially in ankles.', 'Administer without regard to food.', 'Educate patient about common side effects like headache and flushing.'], highAlert: false},

            // Cardiac Part 2
            { id: 'clopidogrel', name: 'Clopidogrel', brandNames: ['Plavix'], class: 'Antiplatelet', moa: 'Inhibits platelet aggregation by irreversibly blocking the P2Y12 ADP receptor on platelets, preventing platelet activation.', effects: ['Bleeding (GI, bruising)', 'GI upset (abdominal pain, diarrhea)', 'Thrombotic Thrombocytopenic Purpura (TTP - rare but serious)'], nursingConsiderations: ['Monitor for signs of bleeding (e.g., melena, hematuria, excessive bruising).', 'Advise patient to avoid concurrent use of NSAIDs or aspirin unless specifically prescribed by provider.', 'Discontinue 5-7 days before elective surgery to minimize bleeding risk.', 'High alert due to bleeding risk.'], highAlert: true},
            { id: 'heparin', name: 'Heparin', brandNames: ['Hep-Lock'], class: 'Anticoagulant', moa: 'Potentiates the action of antithrombin III, which inactivates thrombin and Factor Xa, preventing clot formation.', effects: ['Bleeding', 'Heparin-Induced Thrombocytopenia (HIT - severe drop in platelet count)', 'Osteoporosis (long-term use)'], nursingConsiderations: ['Monitor activated partial thromboplastin time (aPTT) and platelet count regularly.', 'Administer subcutaneously (do not aspirate or massage) or IV infusion.', 'Antidote is Protamine Sulfate.', 'High alert due to high risk of adverse events.'], highAlert: true},
            { id: 'warfarin', name: 'Warfarin', brandNames: ['Coumadin', 'Jantoven'], class: 'Anticoagulant (Vitamin K Antagonist)', moa: 'Interferes with hepatic synthesis of Vitamin K-dependent clotting factors (II, VII, IX, X), prolonging clotting time.', effects: ['Bleeding (hemorrhage)', 'Skin necrosis (rare)'], nursingConsiderations: ['Monitor Prothrombin Time (PT) and International Normalized Ratio (INR) regularly; therapeutic INR typically 2-3.', 'Educate patient on consistent intake of Vitamin K-rich foods (e.g., leafy green vegetables) to avoid fluctuations in INR.', 'Advise patient to avoid alcohol and large amounts of cranberry juice.', 'Antidote is Vitamin K.', 'High alert due to narrow therapeutic index and bleeding risk.', 'Many drug and herbal interactions (e.g., St. John\'s Wort, Ginkgo Biloba, Garlic, Ginseng, high doses of Vitamin E).'], highAlert: true},
            { id: 'enoxaparin', name: 'Enoxaparin', brandNames: ['Lovenox'], class: 'Low Molecular Weight Heparin (LMWH)', moa: 'Potentiates antithrombin III, primarily inhibiting Factor Xa, leading to a more predictable anticoagulant response than unfractionated heparin.', effects: ['Bleeding', 'Injection site hematoma', 'Thrombocytopenia (less common than with unfractionated heparin)'], nursingConsiderations: ['Administer subcutaneously into the anterolateral or posterolateral abdominal wall; do not expel air bubble from prefilled syringe.', 'Monitor for signs of bleeding.', 'No routine aPTT monitoring required for therapeutic effect.', 'High alert due to bleeding risk.'], highAlert: true},
            { id: 'atorvastatin', name: 'Atorvastatin', brandNames: ['Lipitor'], class: 'HMG-CoA Reductase Inhibitor (Statin)', moa: 'Inhibits HMG-CoA reductase, an enzyme critical for cholesterol synthesis in the liver, leading to decreased LDL cholesterol and triglycerides, and increased HDL cholesterol.', effects: ['Myopathy (muscle pain, tenderness, weakness)', 'Rhabdomyolysis (severe muscle breakdown, rare but serious)', 'Hepatotoxicity (liver enzyme elevation)', 'GI upset'], nursingConsiderations: ['Instruct patient to report any unexplained muscle pain, tenderness, or weakness immediately.', 'Monitor liver function tests (LFTs) before initiation and periodically during therapy.', 'Administer at any time of day, with or without food.', 'Educate on lifestyle modifications (diet, exercise) in conjunction with medication.'], highAlert: false}
        ];

        const scenarioData = [
            // Pain/Inflammation Scenarios
            { id: 1, drugId: 'morphine_sulfate', patient: 'A 45-year-old patient', chiefComplaint: 'post-abdominal surgery reports severe pain (9/10).', assessment: { vitals: 'Vitals: HR 105, BP 130/80, RR 10.', findings: 'Patient is grimacing, guarding abdomen, and drowsy.' }, question: 'Which opioid analgesic is indicated for severe pain, but requires careful monitoring of respiratory status?', options: [{ text: 'Acetaminophen' }, { text: 'Morphine Sulfate', correct: true }, { text: 'Ibuprofen' }], rationale: { correct: 'Morphine Sulfate is a potent opioid effective for severe pain, but its primary adverse effect is respiratory depression, requiring close monitoring.', incorrect: 'Acetaminophen and Ibuprofen are for mild-moderate pain and do not cause significant respiratory depression.' } },
            { id: 2, drugId: 'allopurinol', patient: 'A 68-year-old male', chiefComplaint: 'with a history of gout presents with recurrent painful joint flares.', assessment: { vitals: 'Stable.', findings: 'Labs show elevated uric acid levels.' }, question: 'Which medication is used for chronic gout management to reduce uric acid production?', options: [{ text: 'Celecoxib' }, { text: 'Allopurinol', correct: true }, { text: 'Nalbuphine' }], rationale: { correct: 'Allopurinol is a xanthine oxidase inhibitor used to prevent gout attacks by lowering uric acid levels.', incorrect: 'Celecoxib is an NSAID for acute pain/inflammation. Nalbuphine is an opioid for pain.' } },
            
            // Antimicrobial Scenarios
            { id: 3, drugId: 'vancomycin', patient: 'A 70-year-old patient', chiefComplaint: 'with a severe MRSA infection is receiving IV antibiotics.', assessment: { vitals: 'Stable.', findings: 'Patient reports ringing in ears and nurse notes slightly elevated creatinine.' }, question: 'Which antibiotic requires close monitoring of trough levels, renal function, and can cause ototoxicity and "Red Man Syndrome"?', options: [{ text: 'Ceftriaxone' }, { text: 'Vancomycin', correct: true }, { text: 'Ciprofloxacin' }], rationale: { correct: 'Vancomycin is a powerful antibiotic for serious infections like MRSA, but it is associated with ototoxicity, nephrotoxicity, and Red Man Syndrome if infused too quickly. Trough levels are crucial for safe dosing.', incorrect: 'Ceftriaxone is a cephalosporin. Ciprofloxacin is a fluoroquinolone; neither has the same toxicity profile or monitoring requirements as vancomycin.' } },
            { id: 4, drugId: 'amoxicillin', patient: 'A 25-year-old female', chiefComplaint: 'diagnosed with a bacterial ear infection.', assessment: { vitals: 'Stable.', findings: 'Reports pain and redness in the ear.' }, question: 'Before administering this penicillin antibiotic, what is the most critical assessment?', options: [{ text: 'Current diet' }, { text: 'Allergy history', correct: true }, { text: 'Last bowel movement' }], rationale: { correct: 'Assessing for a penicillin allergy is paramount before administering amoxicillin to prevent a severe hypersensitivity reaction like anaphylaxis.', incorrect: 'Diet and bowel movements are not critical pre-administration assessments for amoxicillin.' } },

            // Cardiac Part 1 Scenarios
            { id: 5, drugId: 'digoxin', patient: 'A 78-year-old patient', chiefComplaint: 'with heart failure presents with worsening edema and dyspnea.', assessment: { vitals: 'HR 52, BP 120/70.', findings: 'Patient reports nausea and seeing "yellow halos" around lights.' }, question: 'The nurse suspects toxicity from which cardiac medication, given the patient\'s symptoms and bradycardia?', options: [{ text: 'Furosemide' }, { text: 'Digoxin', correct: true }, { text: 'Metoprolol' }], rationale: { correct: 'The classic signs of digoxin toxicity include bradycardia, nausea, visual disturbances (yellow halos), and anorexia. The nurse should hold the dose and notify the provider.', incorrect: 'Furosemide is a diuretic and Metoprolol is a beta-blocker; neither typically causes these specific signs of toxicity.' } },
            { id: 6, drugId: 'nitroglycerin', patient: 'A 65-year-old male', chiefComplaint: 'experiences sudden chest pain at home.', assessment: { vitals: 'Stable.', findings: 'Patient describes pain as crushing, radiating to left arm.' }, question: 'What is the correct patient education for administering sublingual nitroglycerin for acute angina?', options: [{ text: 'Take 2 tablets every 10 minutes.' }, { text: 'Place under tongue and call 911 if pain not relieved after 1st dose.', correct: true }, { text: 'Swallow with a full glass of water.' }], rationale: { correct: 'For acute angina, sublingual nitroglycerin should be placed under the tongue, and the patient should call 911 if pain is not relieved after the first dose. Up to three doses can be taken 5 minutes apart.', incorrect: 'Incorrect dosing and administration routes are provided in other options.' } },
            { id: 7, drugId: 'lisinopril', patient: 'A 50-year-old patient', chiefComplaint: 'newly diagnosed with hypertension and diabetes.', assessment: { vitals: 'BP 150/90.', findings: 'No other significant findings.' }, question: 'Which antihypertensive medication is often preferred in patients with diabetes due to its renal protective effects, but can cause a persistent dry cough?', options: [{ text: 'Amlodipine' }, { text: 'Hydrochlorothiazothiazide' }, { text: 'Lisinopril', correct: true }], rationale: { correct: 'Lisinopril (an ACE inhibitor) is renally protective and commonly used in diabetic patients with hypertension, but a common side effect is a dry, persistent cough.', incorrect: 'Amlodipine is a calcium channel blocker. Hydrochlorothiazothiazide is a thiazide diuretic; neither is specifically noted for renal protection in diabetes or the characteristic cough.' } },

            // Cardiac Part 2 Scenarios
            { id: 8, drugId: 'warfarin', patient: 'A 72-year-old patient', chiefComplaint: 'on long-term anticoagulation for atrial fibrillation.', assessment: { vitals: 'Stable.', findings: 'INR is 1.2 (target 2-3).' }, question: 'What patient education is crucial for a patient taking Warfarin, given its interaction with Vitamin K?', options: [{ text: 'Increase intake of leafy green vegetables.' }, { text: 'Maintain consistent intake of Vitamin K-rich foods.', correct: true }, { text: 'Avoid all Vitamin K-rich foods.' }], rationale: { correct: 'Patients on Warfarin should maintain a consistent intake of Vitamin K-rich foods, not increase or avoid them. Fluctuations in Vitamin K intake can significantly alter INR levels, affecting drug efficacy or increasing bleeding risk.', incorrect: 'Increasing or avoiding Vitamin K can destabilize INR.' } },
            { id: 9, drugId: 'heparin', patient: 'A 60-year-old patient', chiefComplaint: 'admitted with a deep vein thrombosis (DVT) and started on IV Heparin.', assessment: { vitals: 'Stable.', findings: 'Patient has a large bruise at the IV site.' }, question: 'Which lab value is the primary indicator of therapeutic effect for IV unfractionated Heparin?', options: [{ text: 'INR' }, { text: 'aPTT', correct: true }, { text: 'Platelet count' }], rationale: { correct: 'The activated partial thromboplastin time (aPTT) is the primary lab test used to monitor the therapeutic effect of unfractionated heparin.', incorrect: 'INR monitors warfarin. Platelet count is monitored for HIT, not therapeutic effect.' } },
            { id: 10, drugId: 'atorvastatin', patient: 'A 58-year-old patient', chiefComplaint: 'started on a statin for hyperlipidemia.', assessment: { vitals: 'Stable.', findings: 'Cholesterol levels are elevated.' }, question: 'The nurse should instruct the patient to report which serious adverse effect of statin therapy immediately?', options: [{ text: 'Mild headache' }, { text: 'Muscle pain or weakness', correct: true }, { text: 'Temporary flushing' }], rationale: { correct: 'Muscle pain or weakness (myopathy) is a serious adverse effect of statins that can progress to rhabdomyolysis, requiring immediate medical attention.', incorrect: 'Headache and flushing are common but less serious side effects.' } }
        ];
        
        const achievements = {
            'first_step': { title: 'First Step', description: 'Completed your first activity.', unlocked: false },
            'streak_3': { title: 'On a Roll', description: 'Maintained a 3-day study streak.', unlocked: false },
            'master_pain_meds': { title: 'Pain Med Pro', description: 'Mastered all Pain/Inflammation & Analgesic drugs.', unlocked: false },
            'master_antimicrobials': { title: 'Germ Buster', description: 'Mastered all Antimicrobial drugs.', unlocked: false },
            'master_cardiac_part1': { title: 'Heart Smart Part 1', description: 'Mastered all Cardiac Part 1 drugs.', unlocked: false },
            'master_cardiac_part2': { title: 'Heart Smart Part 2', description: 'Mastered all Cardiac Part 2 drugs.', unlocked: false },
            'master_all': { title: 'Pharmacology Exam 3 Guru', description: 'Mastered all drugs in the library.', unlocked: false },
        };

        // --- GLOBAL STATE ---
        let state = {};
        let pharmacyFillTimerId = null;
        let rapidFireTimerId = null; 
        let pomodoroTimerId = null; 

        const mainContent = document.getElementById('main-content');
        const navigation = document.getElementById('navigation');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const confirmResetModal = document.getElementById('confirm-reset-modal');
        const achievementModal = document.getElementById('achievement-unlocked-modal');

        // --- TEMPLATE FUNCTIONS ---

        const dashboardTemplate = () => {
            const stats = App.calculateDashboardStats();
            const dueDrugs = App.getDueDrugs();

            const renderDrugList = (drugs, type = 'priority') => {
                if (!drugs || drugs.length === 0) {
                    return type === 'priority' ? '<p class="text-sm text-slate-400 italic">Nothing to review here. Amazing job!</p>' : '<p class="text-sm text-slate-400 italic">No drugs due for review.</p>';
                }
                return drugs.map(drug => `
                    <a href="#drug-library" onclick="App.scrollToDrug('${drug.id}')" class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm hover:shadow-md hover:bg-sky-50 transition-all">
                        <div>
                            <p class="font-semibold text-slate-800">${drug.name}</p>
                            <p class="text-xs text-slate-500">${drug.class}</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4 text-slate-400"></i>
                    </a>`).join('');
            };

            return `
                <div>
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h1 class="text-4xl font-bold">Your Command Center</h1>
                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow">
                            <i data-lucide="flame" class="text-orange-500"></i>
                            <span class="font-bold text-lg">${state.streak.count} Day Streak</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-sky-500 to-indigo-500 text-white p-6 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <h2 class="font-bold text-2xl">Ready for your Daily Dose?</h2>
                            <p class="text-sky-100">A quick, focused session on what you need to learn most.</p>
                        </div>
                        <button onclick="App.startDailyDose()" class="bg-white text-indigo-600 font-bold py-3 px-6 rounded-lg hover:bg-slate-100 transition-colors shrink-0">Start Session</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Mastery</p><p class="text-2xl font-bold">${stats.overallMastery}%</p></div>
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Accuracy</p><p class="text-2xl font-bold">${stats.accuracy}%</p></div>
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-green-600">Strongest Class</p><p class="font-bold truncate">${stats.strongestClass}</p></div>
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-red-600">Weakest Class</p><p class="font-bold truncate">${stats.weakestClass}</p></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h2 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i data-lucide="alert-circle" class="w-5 h-5 mr-2 text-red-500"></i>Priority Review Items</h2>
                                <div class="space-y-3">
                                    ${renderDrugList(stats.priorityDrugs, 'priority')}
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h2 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i data-lucide="calendar" class="w-5 h-5 mr-2 text-sky-500"></i>Drugs Due for Review</h2>
                                <div class="space-y-3">
                                    ${renderDrugList(dueDrugs, 'srs')}
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h2 class="font-bold text-lg text-slate-800 mb-4">Study Modes</h2>
                                <div class="space-y-3">
                                    <a href="#flashcards" class="flex items-center justify-between w-full bg-slate-100 hover:bg-sky-100 p-3 rounded-md font-semibold text-slate-700">Flashcards <i data-lucide="arrow-right" class="w-4 h-4"></i></a>
                                    <a href="#match-up" class="flex items-center justify-between w-full bg-slate-100 hover:bg-sky-100 p-3 rounded-md font-semibold text-slate-700">Match-Up <i data-lucide="arrow-right" class="w-4 h-4"></i></a>
                                    <a href="#pharmacy-fill" class="flex items-center justify-between w-full bg-slate-100 hover:bg-sky-100 p-3 rounded-md font-semibold text-slate-700">Pharmacy Fill <i data-lucide="arrow-right" class="w-4 h-4"></i></a>
                                    <a href="#rapid-fire" class="flex items-center justify-between w-full bg-slate-100 hover:bg-sky-100 p-3 rounded-md font-semibold text-slate-700">Rapid Fire <i data-lucide="arrow-right" class="w-4 h-4"></i></a>
                                    <a href="#scenarios" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="clipboard-check" class="w-5 h-5 mr-3"></i> Scenarios</a>
                                    <a href="#explain-this" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="lightbulb" class="w-5 h-5 mr-3"></i> Explain This</a>
                                    <a href="#pomodoro" class="nav-item flex items-center px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><i data-lucide="timer" class="w-5 h-5 mr-3"></i> Pomodoro Timer</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const achievementsTemplate = () => {
            return `
            <div>
                <h1 class="text-4xl font-bold mb-2">Your Achievements</h1>
                <p class="text-slate-500 mb-8">Track your progress and celebrate your milestones!</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                ${Object.entries(state.achievements).map(([key, ach]) => `
                    <div class="achievement-card border-2 ${ach.unlocked ? 'unlocked' : 'border-slate-200'} p-6 rounded-lg flex items-center space-x-4">
                        <i data-lucide="award" class="w-12 h-12 ${ach.unlocked ? 'text-amber-500' : 'text-slate-400'}"></i>
                        <div>
                            <h3 class="font-bold text-lg ${ach.unlocked ? 'text-amber-900' : 'text-slate-800'}">${ach.title}</h3>
                            <p class="text-sm ${ach.unlocked ? 'text-amber-700' : 'text-slate-500'}">${ach.description}</p>
                        </div>
                    </div>
                `).join('')}
                </div>
            </div>
            `;
        };

        const drugLibraryTemplate = () => {
            return `
            <div>
                <h1 class="text-4xl font-bold mb-2">Drug Library</h1>
                <p class="text-slate-500 mb-6">A quick reference for all medications.</p>
                <div class="space-y-4">
                    ${drugData.map(drug => `
                        <div id="drug-${drug.id}" class="bg-white rounded-lg shadow-sm p-6 scroll-mt-24 transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold text-sky-800">${drug.name} <span class="text-base font-normal text-slate-500">(${drug.brandNames.join(', ')})</span></h2>
                                    <p class="text-md font-semibold text-teal-600 mb-2">${drug.class}</p>
                                    <div class="drug-progress-bar-container">
                                        <div class="drug-progress-bar" style="width: ${(state.mastery[drug.id]?.score || 0) * 10}%"></div>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Mastery: ${(state.mastery[drug.id]?.score || 0)}/10</p>
                                </div>
                                ${drug.highAlert ? '<span class="flex items-center gap-1 text-xs bg-red-100 text-red-700 font-semibold px-2 py-1 rounded-full"><i data-lucide="alert-triangle" class="w-3 h-3"></i>High Alert</span>' : ''}
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <h3 class="font-semibold text-slate-700">Mechanism of Action</h3>
                                <p class="text-sm text-slate-600 mb-3">${drug.moa}</p>
                                <h3 class="font-semibold text-slate-700">Key Adverse Effects</h3>
                                <ul class="list-disc list-inside text-sm text-slate-600 mb-3">${drug.effects.map(e => `<li>${e}</li>`).join('')}</ul>
                                <h3 class="font-semibold text-slate-700">Nursing Considerations</h3>
                                <ul class="list-disc list-inside text-sm text-slate-600">${drug.nursingConsiderations.map(c => `<li>${c}</li>`).join('')}</ul>
                                <button onclick="App.startExplainThis('${drug.id}')" class="mt-4 bg-indigo-500 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-600 transition">Explain This</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            `;
        };

        const flashcardsTemplate = () => {
            const unmasteredDrugs = drugData.filter(d => (state.mastery[d.id]?.score || 0) < 10);
            const dueDrugs = App.getDueDrugs();
            const drugsToStudy = dueDrugs.length > 0 ? dueDrugs : unmasteredDrugs;

            if (drugsToStudy.length === 0) return `<div class="text-center p-8"><i data-lucide="party-popper" class="w-24 h-24 mx-auto text-green-500 mb-4"></i><h1 class="text-4xl font-bold">All Drugs Mastered!</h1><p class="text-slate-500 mt-2">You're a true Pharmacology Guru. Great job!</p></div>`;
            
            const drug = App.shuffle(drugsToStudy)[0];
            return `<div class="max-w-2xl mx-auto"><h1 class="text-4xl font-bold text-center mb-6">Flashcards</h1><div class="flashcard h-96 perspective-1000" onclick="this.classList.toggle('flipped')"><div class="flashcard-inner"><div class="flashcard-front"><p class="text-slate-500 text-sm mb-2">${drug.class}</p><h2 class="text-4xl font-bold">${drug.name}</h2><p class="absolute bottom-4 text-xs text-slate-400">(Click to flip)</p></div><div class="flashcard-back"><h3 class="font-bold text-xl text-sky-800">Mechanism of Action</h3><p class="mt-2 text-sm text-slate-700">${drug.moa}</p><h3 class="font-bold text-xl text-sky-800 mt-4">Key Nursing Consideration</h3><p class="mt-2 text-sm text-slate-700">${App.shuffle(drug.nursingConsiderations)[0]}</p></div></div></div><p class="text-center font-semibold mt-8 text-lg">How well did you know this?</p><div class="flex justify-center items-center mt-4 space-x-4"><button onclick="App.handleFlashcardAnswer('${drug.id}', 'again')" class="bg-red-100 text-red-700 font-semibold px-8 py-3 rounded-lg hover:bg-red-200 transition">Again</button><button onclick="App.handleFlashcardAnswer('${drug.id}', 'good')" class="bg-blue-100 text-blue-700 font-semibold px-8 py-3 rounded-lg hover:bg-blue-200 transition">Good</button><button onclick="App.handleFlashcardAnswer('${drug.id}', 'easy')" class="bg-green-100 text-green-700 font-semibold px-8 py-3 rounded-lg hover:bg-green-200 transition">Easy</button></div></div>`;
        };

        const matchUpTemplate = () => `
            <div>
                <h1 class="text-3xl font-bold text-center">Match-Up Game</h1>
                <p class="text-slate-500 text-center mb-6">Drag the drug to its correct property.</p>
                <div id="matchup-board" class="max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div id="drug-pile" class="flex flex-col items-center"></div>
                        <div id="answer-bins" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>
                    <div id="matchup-feedback" class="mt-6 text-center h-12"></div>
                </div>
            </div>`;

        const pharmacyFillTemplate = () => {
            const { score = 0, timer = 30, currentDrug } = state.pharmacyFill || {};
            const isComplete = state.pharmacyFill?.isComplete ?? true;

            if (isComplete) {
                const lastScore = state.pharmacyFill?.score ?? 0;
                return `<div class="text-center p-8">
                            <h1 class="text-4xl font-bold mb-2">Pharmacy Fill</h1>
                            ${lastScore > 0 ? `<p class="text-lg text-slate-600">Your last score: <span class="font-bold text-sky-700">${lastScore}</span></p>` : ''}
                            <p class="text-slate-500 mb-8 max-w-xl mx-auto">Quickly type the generic name for the given brand name. Press Enter to submit. You have 30 seconds!</p>
                            <button onclick="App.startPharmacyFill()" class="mt-4 bg-sky-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-sky-700 transition-transform hover:scale-105">Start Round</button>
                        </div>`;
            } else {
                return `<div class="max-w-xl mx-auto text-center">
                            <h1 class="text-3xl font-bold">Pharmacy Fill</h1>
                            <div class="flex justify-between font-bold text-lg my-4 bg-white p-3 rounded-lg shadow-sm">
                                <p>Score: <span id="pharmacy-fill-score" class="text-green-600">${score}</span></p>
                                <p>Time: <span id="pharmacy-fill-timer" class="text-red-600">${timer}s</span></p>
                            </div>
                            <div class="bg-white p-8 my-4 rounded-lg shadow-xl">
                                <p class="text-lg text-slate-500">Brand Name:</p>
                                <p id="pharmacy-fill-brand-name" class="text-5xl font-bold my-4 text-sky-700">${currentDrug?.brandNames[0] || 'N/A'}</p>
                                <label for="pharmacy-fill-input" class="text-lg text-slate-500">Generic Name:</label>
                                <input id="pharmacy-fill-input" type="text" autocomplete="off" class="text-center text-2xl p-2 mt-2 border-2 border-slate-300 focus:border-sky-500 focus:ring-sky-500 w-full rounded-md transition">
                            </div>
                        </div>`;
            }
        };

        const rapidFireTemplate = () => {
            const { deck = [], currentQuestion = 0, score = 0, timer = 60, isComplete = true, incorrectlyAnsweredDrugs = [] } = state.quiz || {};

            if (isComplete) {
                const lastScore = state.quiz?.score;
                const totalQuestions = state.quiz?.deck?.length;
                const missedDrugs = state.quiz?.incorrectlyAnsweredDrugs || [];
                return `<div class="text-center p-8">
                    <h1 class="text-4xl font-bold mb-2">Rapid Fire Quiz</h1>
                    ${(lastScore !== undefined) ? `
                        <p class="text-lg text-slate-600">Your last score: <span class="font-bold text-sky-700">${lastScore} / ${totalQuestions}</span></p>
                        ${missedDrugs.length > 0 ? `
                            <p class="text-md text-red-600 font-semibold mt-4">Review these drugs:</p>
                            <ul class="list-disc list-inside text-sm text-slate-700 mx-auto max-w-xs">
                                ${missedDrugs.map(drugName => `<li>${drugName}</li>`).join('')}
                            </ul>
                        ` : '<p class="text-md text-green-600 font-semibold mt-4">No drugs to review from last round. Excellent!</p>'}
                    ` : ''}
                    <p class="text-slate-500 mb-8 mt-4">Answer 10 questions as quickly as you can!</p>
                    <button onclick="App.startRapidFire()" class="mt-4 bg-sky-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-sky-700 transition-transform hover:scale-105">Start Round</button>
                </div>`;
            } else {
                const question = deck[currentQuestion];
                const progress = Math.round(((currentQuestion) / deck.length) * 100);

                let questionContent;
                if (question?.type === 'input') {
                    questionContent = `
                        <p class="text-lg text-slate-500">${question.text}</p>
                        <input id="rapid-fire-input" type="text" autocomplete="off" class="text-center text-2xl p-2 mt-2 border-2 border-slate-300 focus:border-sky-500 focus:ring-sky-500 w-full rounded-md transition">
                        <button onclick="App.handleRapidFireAnswer(document.getElementById('rapid-fire-input').value.trim().toLowerCase() === '${question.correctAnswer}', null, document.getElementById('rapid-fire-input'))" class="mt-6 bg-sky-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-sky-700 transition">Submit Answer</button>
                    `;
                } else { // multiple-choice
                    questionContent = `
                        <p class="text-xl font-semibold text-slate-800 mb-6 text-center">${question?.text || 'Loading question...'}</p>
                        <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${question?.options.map(o => `<button data-correct="${o.correct}" data-drug-id="${question.drugId}" class="quiz-option p-4 border-2 border-slate-200 rounded-lg text-slate-700 text-left hover:bg-slate-100 hover:border-sky-300 transition">${o.text}</button>`).join('') || ''}
                        </div>
                    `;
                }

                return `<div>
                    <div class="flex justify-between items-center mb-2">
                        <h1 class="text-3xl font-bold">Rapid Fire</h1>
                        <p class="font-semibold">Score: <span class="text-green-600">${score}</span></p>
                        <p class="font-semibold">Time: <span id="rapid-fire-timer" class="text-red-600">${timer}s</span></p>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                        <div class="bg-sky-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        ${questionContent}
                    </div>
                </div>`;
            }
        };

        const scenariosTemplate = () => {
            const scenarioState = state.scenarios || {};
            const { deck = [], currentIndex = 0, stage = 'initial' } = scenarioState;

            if (scenarioState.isComplete || currentIndex >= deck.length) {
                return `<div class="text-center p-8">
                    <h1 class="text-4xl font-bold mb-2">Clinical Scenarios</h1>
                    <p class="text-slate-500 mb-8">Apply your knowledge to real-world patient cases.</p>
                    <button onclick="App.startScenarios()" class="mt-4 bg-sky-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-sky-700 transition-transform hover:scale-105">Start Round</button>
                </div>`;
            }

            const scenario = deck[currentIndex];
            if (!scenario) { // Defensive check
                console.warn("Scenarios: No scenario found at current index. Resetting session.");
                App.setState({ scenarios: { isComplete: true } }); // Use setState to trigger re-render
                return scenariosTemplate(); // Recurse to render initial state
            }

            return `<div class="max-w-3xl mx-auto">
                <h1 class="text-3xl font-bold mb-4">Clinical Scenarios (${currentIndex + 1} / ${deck.length})</h1>
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <p class="text-lg text-slate-700">${scenario.patient} ${scenario.chiefComplaint}</p>
                    <div id="assessment-section" class="reveal-section ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                        <p class="mt-4 text-slate-600">${scenario.assessment.vitals} ${scenario.assessment.findings}</p>
                    </div>
                    <div id="question-section" class="reveal-section ${stage === 'assessed' || stage === 'answered' ? 'revealed' : ''}">
                        <p class="mt-6 font-semibold text-slate-800">${scenario.question}</p>
                        <div id="scenario-options" class="grid grid-cols-1 gap-3 mt-4">
                            ${scenario.options.map(o => `<button data-correct="${!!o.correct}" class="scenario-option p-3 border-2 border-slate-200 rounded-lg text-slate-700 text-left hover:bg-slate-100">${o.text}</button>`).join('')}
                        </div>
                    </div>
                    <div id="scenario-rationale" class="reveal-section ${stage === 'answered' ? 'revealed' : ''} border-t mt-6 pt-4"></div>
                    <div id="scenario-controls" class="text-center mt-6"></div>
                </div>
            </div>`;
        };

        const explainThisTemplate = () => {
            const explainThisState = state.explainThis || {};
            const { currentDrug, currentProperty, isAnswerRevealed, userAnswer } = explainThisState;

            if (!currentDrug || !currentProperty) {
                return `<div class="text-center p-8">
                            <h1 class="text-4xl font-bold mb-2">Explain This</h1>
                            <p class="text-slate-500 mb-8">Choose a drug from the library or start a new session to explain concepts in your own words.</p>
                            <button onclick="App.startExplainThis()" class="mt-4 bg-sky-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-sky-700 transition-transform hover:scale-105">Start Random Session</button>
                        </div>`;
            }

            let promptText;
            let actualAnswer;
            switch (currentProperty) {
                case 'moa':
                    promptText = `Explain the Mechanism of Action (MOA) for ${currentDrug.name}:`;
                    actualAnswer = currentDrug.moa;
                    break;
                case 'effects':
                    promptText = `List and explain key Adverse Effects for ${currentDrug.name}:`;
                    actualAnswer = currentDrug.effects.join('; ');
                    break;
                case 'nursingConsiderations':
                    promptText = `Describe key Nursing Considerations for ${currentDrug.name}:`;
                    actualAnswer = currentDrug.nursingConsiderations.join('; ');
                    break;
                case 'class':
                    promptText = `Describe the Drug Class for ${currentDrug.name}:`;
                    actualAnswer = currentDrug.class;
                    break;
            }

            return `
                <div class="max-w-3xl mx-auto">
                    <h1 class="text-4xl font-bold text-center mb-6">Explain This</h1>
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">${promptText}</h2>
                        <textarea id="explain-this-input" class="w-full h-48 p-3 border-2 border-slate-300 rounded-md focus:border-sky-500 focus:ring-sky-500 transition resize-y" placeholder="Type your explanation here..." ${isAnswerRevealed ? 'readonly' : ''}>${userAnswer || ''}</textarea>
                        <div class="mt-4 flex justify-between items-center">
                            ${!isAnswerRevealed ? `
                                <button onclick="App.checkExplainThisAnswer()" class="bg-sky-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-sky-700 transition">Reveal Answer</button>
                            ` : `
                                <button onclick="App.nextExplainThisQuestion()" class="bg-indigo-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-indigo-700 transition">Next Drug</button>
                            `}
                        </div>
                        <div id="explain-this-feedback" class="mt-4 reveal-section ${isAnswerRevealed ? 'revealed' : ''}">
                            <h3 class="font-bold text-lg text-slate-800">Official Answer:</h3>
                            <p class="text-sm text-slate-700">${actualAnswer}</p>
                            <p class="mt-4 font-semibold">How well did you explain it?</p>
                            <div class="flex justify-center items-center mt-2 space-x-4">
                                <button onclick="App.handleFlashcardAnswer('${currentDrug.id}', 'again'); App.nextExplainThisQuestion();" class="bg-red-100 text-red-700 font-semibold px-6 py-2 rounded-lg hover:bg-red-200 transition">Needs Work</button>
                                <button onclick="App.handleFlashcardAnswer('${currentDrug.id}', 'good'); App.nextExplainThisQuestion();" class="bg-blue-100 text-blue-700 font-semibold px-6 py-2 rounded-lg hover:bg-blue-200 transition">Good</button>
                                <button onclick="App.handleFlashcardAnswer('${currentDrug.id}', 'easy'); App.nextExplainThisQuestion();" class="bg-green-100 text-green-700 font-semibold px-6 py-2 rounded-lg hover:bg-green-200 transition">Mastered</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const pomodoroTemplate = () => {
            const { timeLeft, isRunning, isBreak } = state.pomodoro;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const displayTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            return `
                <div class="max-w-xl mx-auto text-center p-8">
                    <h1 class="text-4xl font-bold mb-6">Pomodoro Timer</h1>
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        <p class="text-lg text-slate-500 mb-4">${isBreak ? 'Break Time!' : 'Study Session'}</p>
                        <div class="text-7xl font-bold text-sky-700 mb-8">${displayTime}</div>
                        <div class="flex justify-center space-x-4">
                            ${isRunning ? `
                                <button onclick="App.pausePomodoro()" class="bg-orange-500 text-white font-bold px-8 py-4 rounded-lg hover:bg-orange-600 transition-transform hover:scale-105"><i data-lucide="pause" class="w-6 h-6 inline-block mr-2"></i>Pause</button>
                            ` : `
                                <button onclick="App.startPomodoro()" class="bg-green-500 text-white font-bold px-8 py-4 rounded-lg hover:bg-green-600 transition-transform hover:scale-105"><i data-lucide="play" class="w-6 h-6 inline-block mr-2"></i>Start</button>
                            `}
                            <button onclick="App.resetPomodoro()" class="bg-slate-300 text-slate-800 font-bold px-8 py-4 rounded-lg hover:bg-slate-400 transition-transform hover:scale-105"><i data-lucide="rotate-ccw" class="w-6 h-6 inline-block mr-2"></i>Reset</button>
                        </div>
                        <p class="text-sm text-slate-500 mt-6">25 minutes study, 5 minutes break.</p>
                    </div>
                </div>
            `;
        };

        const dailyDoseTemplate = () => {
            const dailyDoseState = state.dailyDose || {};
            const { deck = [], currentQuestionIndex = 0, score = 0, isComplete = true } = dailyDoseState;

            if (isComplete) {
                const totalQuestions = deck.length;
                return `<div class="text-center p-8">
                            <i data-lucide="check-circle" class="w-24 h-24 mx-auto text-green-500 mb-4"></i>
                            <h1 class="text-4xl font-bold mb-2">Daily Dose Complete!</h1>
                            <p class="text-lg text-slate-600">You answered ${score} out of ${totalQuestions} questions correctly.</p>
                            <p class="text-slate-500 mt-2">Keep up the great work!</p>
                            <button onclick="window.location.hash = '#dashboard'" class="mt-8 bg-indigo-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105">Back to Dashboard</button>
                        </div>`;
            }

            const question = deck[currentQuestionIndex];
            if (!question) {
                console.warn("Daily Dose: No question found at current index. Resetting session.");
                App.setState({ dailyDose: { isComplete: true, incorrectlyAnsweredDrugs: [] } });
                return dailyDoseTemplate();
            }

            const progress = Math.round(((currentQuestionIndex + 1) / deck.length) * 100);

            let questionContent;
            if (question.type === 'input') {
                questionContent = `
                    <p class="text-lg text-slate-500">${question.prompt}</p>
                    <p id="daily-dose-target" class="text-5xl font-bold my-4 text-sky-700">${question.targetDisplay}</p>
                    <label for="daily-dose-input" class="text-lg text-slate-500">Your Answer:</label>
                    <input id="daily-dose-input" type="text" autocomplete="off" class="text-center text-2xl p-2 mt-2 border-2 border-slate-300 focus:border-sky-500 focus:ring-sky-500 w-full rounded-md transition">
                    <button onclick="App.handleDailyDoseAnswer(document.getElementById('daily-dose-input').value.trim())" class="mt-6 bg-sky-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-sky-700 transition">Submit Answer</button>
                `;
            } else { // type === 'multiple-choice'
                questionContent = `
                    <p class="text-xl font-semibold text-slate-800 mb-6 text-center">${question.prompt}</p>
                    <div id="daily-dose-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${question.options.map(o => `<button data-correct="${o.correct}" class="daily-dose-option p-4 border-2 border-slate-200 rounded-lg text-slate-700 text-left hover:bg-slate-100 hover:border-sky-300 transition">${o.text}</button>`).join('')}
                    </div>
                `;
            }

            return `
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-2">
                        <h1 class="text-3xl font-bold">Daily Dose</h1>
                        <p class="font-semibold">Question: <span class="text-sky-600">${currentQuestionIndex + 1} / ${deck.length}</span></p>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                        <div class="bg-sky-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        ${questionContent}
                        <div id="daily-dose-feedback" class="mt-4 text-center font-bold text-lg"></div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="App.skipDailyDoseQuestion()" class="bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-lg hover:bg-slate-300 transition">Skip</button>
                        <!-- Next button will appear after answer -->
                    </div>
                </div>`;
        };


        // --- TEMPLATES OBJECT (now references the named functions) ---
        const Templates = {
            dashboard: dashboardTemplate,
            achievements: achievementsTemplate,
            drugLibrary: drugLibraryTemplate,
            flashcards: flashcardsTemplate,
            matchUp: matchUpTemplate,
            pharmacyFill: pharmacyFillTemplate,
            rapidFire: rapidFireTemplate,
            scenarios: scenariosTemplate,
            explainThis: explainThisTemplate,
            pomodoro: pomodoroTemplate,
            dailyDose: dailyDoseTemplate 
        };

        // --- CORE APP LOGIC ---
        const App = {
            // Centralized state update function
            // `updater` can be an object or a function that receives the current state and returns a new state object.
            // `shouldRender` (default: true) controls whether a router re-render is triggered after the state update.
            setState(updater, shouldRender = true) {
                if (typeof updater === 'function') {
                    state = { ...state, ...updater(state) };
                } else {
                    state = { ...state, ...updater };
                }
                this.saveState();
                if (shouldRender) {
                    this.router(); 
                }
            },

            // Initializes the application, loads state, sets up routing and global event listeners.
            init() {
                this.loadState();
                this.updateStreak();
                window.addEventListener('hashchange', () => this.router());
                this.router(); // Initial route load

                // Global event listeners for modals and reset button
                navigation.addEventListener('click', e => {
                    const link = e.target.closest('a');
                    if (link && !link.onclick) { // Prevent default for links that don't have inline onclick
                        e.preventDefault();
                        window.location.hash = link.getAttribute('href');
                    }
                });
                resetProgressBtn.addEventListener('click', () => confirmResetModal.classList.add('visible'));
                document.getElementById('cancel-reset-btn').addEventListener('click', () => confirmResetModal.classList.remove('visible'));
                document.getElementById('confirm-reset-btn').addEventListener('click', () => { this.resetState(true); confirmResetModal.classList.remove('visible'); });
                document.getElementById('close-achievement-btn').addEventListener('click', () => achievementModal.classList.remove('visible'));
            },

            // Handles routing based on URL hash. Clears timers and renders the appropriate view.
            router() {
                // Clear all active timers when navigating to a new route
                this.clearPharmacyFillTimer();
                this.clearRapidFireTimer();
                this.clearPomodoroTimer();

                const path = window.location.hash || '#dashboard';
                mainContent.style.opacity = 0; // Fade out current content

                // Define routes and their corresponding rendering functions
                const routes = {
                    "#dashboard": () => this.renderView(Templates.dashboard),
                    "#achievements": () => this.renderView(Templates.achievements),
                    "#drug-library": () => this.renderView(Templates.drugLibrary),
                    "#flashcards": () => this.renderView(Templates.flashcards),
                    "#match-up": () => { this.renderView(Templates.matchUp); this.startMatchUpGame(); },
                    "#pharmacy-fill": () => { this.renderView(Templates.pharmacyFill); this.renderPharmacyFill(); },
                    "#rapid-fire": () => { this.renderView(Templates.rapidFire); this.renderRapidFire(); },
                    "#scenarios": () => { this.renderView(Templates.scenarios); this.renderScenarios(); },
                    "#daily-dose": () => { this.renderView(Templates.dailyDose); this.renderDailyDose(); },
                    "#explain-this": () => { this.renderView(Templates.explainThis); this.renderExplainThis(); },
                    "#pomodoro": () => { this.renderView(Templates.pomodoro); this.renderPomodoro(); },
                };

                // Execute the rendering logic for the current route after a short delay for fade effect
                setTimeout(() => {
                    const routeAction = routes[path] || routes['#dashboard'];
                    routeAction();
                    this.updateNav(); // Update active navigation item
                    lucide.createIcons(); // Re-render Lucide icons
                    mainContent.style.opacity = 1; // Fade in new content
                }, 150);
            },

            // Renders a given template function into the main content area.
            renderView(templateFunction) {
                mainContent.innerHTML = ''; // Clear existing content
                mainContent.innerHTML = templateFunction(); // Insert new content
            },

            // Updates the active state of navigation items.
            updateNav() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    const href = item.getAttribute('href');
                    if (href && href === (window.location.hash || '#dashboard')) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            },

            // Shuffles an array randomly.
            shuffle: (array) => [...array].sort(() => Math.random() - 0.5),

            // Saves the current application state to localStorage.
            saveState() {
                localStorage.setItem('pharmaMasteryStateExam3', JSON.stringify(state));
            },

            // Loads the application state from localStorage or initializes it.
            loadState() { 
                const savedState = localStorage.getItem('pharmaMasteryStateExam3'); 
                state = savedState ? JSON.parse(savedState) : this.getInitialState(); 
                
                // Ensure all new state properties are initialized, especially for existing users
                if (!state.mastery || Object.keys(state.mastery).length !== drugData.length) this.initializeMasteryState(); 
                
                // Update mastery properties for SRS if they don't exist
                drugData.forEach(drug => {
                    if (!state.mastery[drug.id].lastReviewed) state.mastery[drug.id].lastReviewed = null;
                    if (!state.mastery[drug.id].interval) state.mastery[drug.id].interval = 0;
                    if (!state.mastery[drug.id].easeFactor) state.mastery[drug.id].easeFactor = 2.5;
                    if (!state.mastery[drug.id].dueDate) state.mastery[drug.id].dueDate = new Date().toDateString();
                });

                if (!state.achievements || Object.keys(state.achievements).length !== Object.keys(achievements).length) { 
                    const newAchievements = JSON.parse(JSON.stringify(achievements));
                    if (state.achievements) {
                        for (const key in state.achievements) {
                            if (newAchievements[key]) {
                                newAchievements[key].unlocked = state.achievements[key].unlocked;
                            }
                        }
                    }
                    state.achievements = newAchievements;
                }
                if (!state.streak) state.streak = { count: 1, lastLogin: new Date().toDateString() }; 
                if(!state.quiz) state.quiz = {isComplete: true, incorrectlyAnsweredDrugs: []}; 
                if(!state.scenarios) state.scenarios = {isComplete: true}; 
                if(!state.pharmacyFill) state.pharmacyFill = {isComplete: true}; 
                if(!state.dailyDose) state.dailyDose = {isComplete: true, incorrectlyAnsweredDrugs: []}; 
                if(!state.explainThis) state.explainThis = { isComplete: true }; 
                if(!state.pomodoro) state.pomodoro = { isRunning: false, timeLeft: 25 * 60, isBreak: false, studyDuration: 25 * 60, breakDuration: 5 * 60 }; 
            },

            // Returns the initial state object.
            getInitialState() { 
                const initialState = { 
                    mastery: {}, 
                    achievements: JSON.parse(JSON.stringify(achievements)), 
                    streak: { count: 1, lastLogin: new Date().toDateString() }, 
                    quiz: { isComplete: true, incorrectlyAnsweredDrugs: [] }, 
                    scenarios: { isComplete: true }, 
                    pharmacyFill: { isComplete: true }, 
                    dailyDose: { isComplete: true, incorrectlyAnsweredDrugs: [] },
                    explainThis: { isComplete: true },
                    pomodoro: { isRunning: false, timeLeft: 25 * 60, isBreak: false, studyDuration: 25 * 60, breakDuration: 5 * 60 }
                }; 
                drugData.forEach(drug => { 
                    initialState.mastery[drug.id] = { 
                        score: 0, 
                        correct: 0, 
                        incorrect: 0, 
                        lastReviewed: null, 
                        interval: 0, 
                        easeFactor: 2.5, 
                        dueDate: new Date().toDateString() 
                    }; 
                }); 
                return initialState; 
            },

            // Resets the application state to its initial values.
            resetState(doRoute = true) { 
                state = this.getInitialState(); 
                this.saveState(); 
                if (doRoute) { 
                    window.location.hash = '#dashboard'; 
                    this.router(); 
                } 
            },

            // Initializes the mastery state for all drugs.
            initializeMasteryState() { 
                state.mastery = {}; 
                drugData.forEach(drug => { 
                    state.mastery[drug.id] = { 
                        score: 0, 
                        correct: 0, 
                        incorrect: 0,
                        lastReviewed: null,
                        interval: 0,
                        easeFactor: 2.5,
                        dueDate: new Date().toDateString()
                    }; 
                }); 
                this.saveState(); 
            },

            // Updates the mastery score for a specific drug.
            updateMasteryScore(drugId, points, isCorrect) { 
                if(!drugId || !state.mastery[drugId]) return; 
                const stat = state.mastery[drugId]; 
                stat.score = Math.max(0, Math.min(10, stat.score + points)); 
                if (isCorrect) stat.correct++; 
                else stat.incorrect++; 
                this.unlockAchievement('first_step'); 
                this.checkClassMastery(); 
                this.saveState(); 
            },

            // Updates the Spaced Repetition System (SRS) properties for a drug.
            updateSRS(drugId, difficulty) {
                const stat = state.mastery[drugId];
                const today = new Date();
                stat.lastReviewed = today.toDateString();

                if (difficulty === 'again') {
                    stat.interval = 0; 
                    stat.easeFactor = Math.max(1.3, stat.easeFactor - 0.2); 
                } else { 
                    if (stat.interval === 0) { 
                        stat.interval = 1;
                    } else if (stat.interval === 1) { 
                        stat.interval = 6;
                    } else {
                        stat.interval = Math.round(stat.interval * stat.easeFactor);
                    }
                    stat.easeFactor = stat.easeFactor + (difficulty === 'easy' ? 0.1 : 0); 
                }
                
                const nextDueDate = new Date(today);
                nextDueDate.setDate(today.getDate() + stat.interval);
                stat.dueDate = nextDueDate.toDateString();
                this.saveState();
            },

            // Retrieves drugs that are due for review based on SRS.
            getDueDrugs() {
                const today = new Date().toDateString();
                return drugData.filter(d => {
                    const masteryStat = state.mastery[d.id];
                    return masteryStat && masteryStat.dueDate && new Date(masteryStat.dueDate) <= new Date(today);
                }).sort((a, b) => {
                    return (state.mastery[a.id]?.score || 0) - (state.mastery[b.id]?.score || 0);
                });
            },

            // Plays a sound based on correctness.
            playSound(isCorrect) { 
                try { 
                    const synth = new Tone.Synth().toDestination(); 
                    if(isCorrect) synth.triggerAttackRelease("C5", "8n", Tone.now()); 
                    else synth.triggerAttackRelease("G2", "8n", Tone.now()); 
                } catch (e) { 
                    console.error("Audio error:", e); 
                } 
            },

            // Updates the user's study streak.
            updateStreak() { 
                if(!state.streak) state.streak = { count: 0, lastLogin: null }; 
                const today = new Date().toDateString(); 
                if (state.streak.lastLogin !== today) { 
                    const yesterday = new Date(Date.now() - 86400000).toDateString(); 
                    state.streak.count = state.streak.lastLogin === yesterday ? state.streak.count + 1 : 1; 
                    state.streak.lastLogin = today; 
                    if(state.streak.count >= 3) this.unlockAchievement('streak_3'); 
                    this.saveState(); 
                } 
            },

            // Unlocks an achievement and displays a modal.
            unlockAchievement(key) { 
                if (state.achievements[key] && !state.achievements[key].unlocked) { 
                    state.achievements[key].unlocked = true; 
                    document.getElementById('achievement-title').textContent = achievements[key].title; 
                    document.getElementById('achievement-desc').textContent = achievements[key].description; 
                    achievementModal.classList.add('visible'); 
                    lucide.createIcons(); 
                    this.saveState(); 
                } 
            },

            // Checks and unlocks class-specific mastery achievements.
            checkClassMastery() { 
                const classGroups = drugData.reduce((acc, drug) => { 
                    let className = drug.class;
                    if (className.includes('Analgesic') || className.includes('NSAID') || className.includes('Anti-gout') || className.includes('Opioid')) {
                        className = 'Pain/Inflammation & Analgesics';
                    } else if (className.includes('Antibiotic')) {
                        className = 'Antimicrobial Drugs';
                    } else if (className.includes('Cardiac Glycoside') || className.includes('Nitrate') || className.includes('Diuretic') || className.includes('Beta-Blocker') || className.includes('ACE Inhibitor') || className.includes('Calcium Channel Blocker')) {
                        className = 'Cardiac Part 1';
                    } else if (className.includes('Antiplatelet') || className.includes('Anticoagulant') || className.includes('HMG-CoA Reductase Inhibitor')) {
                        className = 'Cardiac Part 2';
                    }

                    if(!acc[className]) acc[className] = []; 
                    acc[className].push(drug.id); 
                    return acc; 
                }, {}); 

                for(const className in classGroups) { 
                    const allDrugsInClassMastered = classGroups[className].every(id => (state.mastery[id]?.score || 0) >= 8);
                    if (allDrugsInClassMastered) {
                        if(className === 'Pain/Inflammation & Analgesics') this.unlockAchievement('master_pain_meds');
                        if(className === 'Antimicrobial Drugs') this.unlockAchievement('master_antimicrobials');
                        if(className === 'Cardiac Part 1') this.unlockAchievement('master_cardiac_part1');
                        if(className === 'Cardiac Part 2') this.unlockAchievement('master_cardiac_part2');
                    }
                } 
                if(drugData.every(d => (state.mastery[d.id]?.score || 0) >= 10)) this.unlockAchievement('master_all'); 
            },
            
            // Calculates and returns dashboard statistics.
            calculateDashboardStats() { 
                if (!state.mastery) return { overallMastery: 0, accuracy: 0, priorityDrugs: [], strongestClass: "N/A", weakestClass: "N/A" }; 
                
                const drugStats = Object.values(state.mastery); 
                const totalPossibleScore = drugStats.length * 10; 
                const currentTotalScore = drugStats.reduce((sum, stat) => sum + (stat.score || 0), 0); 
                const overallMastery = totalPossibleScore > 0 ? Math.round((currentTotalScore / totalPossibleScore) * 100) : 0; 
                
                const totalCorrect = drugStats.reduce((sum, stat) => sum + (stat.correct || 0), 0); 
                const totalIncorrect = drugStats.reduce((sum, stat) => sum + (stat.incorrect || 0), 0); 
                const totalAnswers = totalCorrect + totalIncorrect; 
                const accuracy = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0; 
                
                const sortedByScore = Object.entries(state.mastery)
                    .map(([id, stats]) => ({ id, ...stats, drug: drugData.find(d => d.id === id) }))
                    .sort((a, b) => a.score - b.score); 
                const priorityDrugs = sortedByScore.slice(0, 3).filter(d => d.score < 8).map(d => d.drug).filter(Boolean); 
                
                const classScores = drugData.reduce((acc, drug) => { 
                    let className = drug.class;
                    if (className.includes('Analgesic') || className.includes('NSAID') || className.includes('Anti-gout') || className.includes('Opioid')) {
                        className = 'Pain/Inflammation & Analgesics';
                    } else if (className.includes('Antibiotic')) {
                        className = 'Antimicrobial Drugs';
                    } else if (className.includes('Cardiac Glycoside') || className.includes('Nitrate') || className.includes('Diuretic') || className.includes('Beta-Blocker') || className.includes('ACE Inhibitor') || className.includes('Calcium Channel Blocker')) {
                        className = 'Cardiac Part 1';
                    } else if (className.includes('Antiplatelet') || className.includes('Anticoagulant') || className.includes('HMG-CoA Reductase Inhibitor')) {
                        className = 'Cardiac Part 2';
                    }

                    if (!acc[className]) acc[className] = { totalScore: 0, count: 0 }; 
                    acc[className].totalScore += state.mastery[drug.id]?.score || 0; 
                    acc[className].count++; 
                    return acc; 
                }, {}); 

                let strongestClass = "N/A", weakestClass = "N/A"; 
                if (Object.keys(classScores).length > 0) { 
                    const classAverages = Object.entries(classScores).map(([name, data]) => ({ name, avg: data.totalScore / data.count })); 
                    classAverages.sort((a,b) => b.avg - a.avg); 
                    if(classAverages.length > 0) { 
                        strongestClass = classAverages[0].name; 
                        weakestClass = classAverages[classAverages.length - 1].name; 
                    } 
                } 
                return { overallMastery, accuracy, priorityDrugs, strongestClass, weakestClass }; 
            },

            // Scrolls to a specific drug in the drug library and highlights it.
            scrollToDrug(drugId) { 
                if (window.location.hash !== '#drug-library') { 
                    window.location.hash = '#drug-library'; 
                    requestAnimationFrame(() => this.performScroll(drugId)); 
                } else { 
                    this.performScroll(drugId); 
                } 
            },
            performScroll(drugId) { 
                const element = document.getElementById(`drug-${drugId}`); 
                if (element) { 
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
                    element.style.backgroundColor = '#e0f2fe'; 
                    element.style.borderColor = '#38bdf8'; 
                    setTimeout(() => { 
                        element.style.backgroundColor = 'white'; 
                        element.style.borderColor = 'transparent'; 
                    }, 2000); 
                } 
            },

            // --- GAME LOGIC ---

            // Flashcards
            handleFlashcardAnswer(drugId, difficulty){ 
                let points = 0, isCorrect = false; 
                if (difficulty === 'easy') { points = 2; isCorrect = true; } 
                else if (difficulty === 'good') { points = 1; isCorrect = true; } 
                else if (difficulty === 'again') { points = -2; isCorrect = false;} 
                this.updateMasteryScore(drugId, points, isCorrect); 
                this.updateSRS(drugId, difficulty); 
                this.playSound(isCorrect); 
                this.router(); 
            },
            
            // Match-Up
            startMatchUpGame() { 
                this.generateMatchUpRound(); 
            },
            generateMatchUpRound() { 
                const drugPileEl = document.getElementById('drug-pile'); 
                const answerBinsEl = document.getElementById('answer-bins'); 
                const feedbackEl = document.getElementById('matchup-feedback'); 
                if(!drugPileEl || !answerBinsEl) return; 
                drugPileEl.innerHTML = ''; 
                answerBinsEl.innerHTML = ''; 
                if(feedbackEl) feedbackEl.innerHTML = ''; 
                
                const unmasteredDrugs = drugData.filter(d => (state.mastery[d.id]?.score || 0) < 10); 
                const targetPool = unmasteredDrugs.length > 3 ? unmasteredDrugs : drugData; 
                const targetDrug = this.shuffle(targetPool)[0]; 
                
                const roundTypes = [
                    { type: 'class', label: 'Drug Class', prop: 'class' }, 
                    { type: 'effect', label: 'Adverse Effect', prop: 'effects' }, 
                    { type: 'nursing', label: 'Nursing Implication', prop: 'nursingConsiderations' }
                ]; 
                
                const roundConfig = this.shuffle(roundTypes)[0]; 
                
                let correctAnswer;
                if (roundConfig.type === 'class') {
                    correctAnswer = targetDrug.class;
                } else {
                    correctAnswer = this.shuffle(targetDrug[roundConfig.prop])[0];
                }

                let optionsPool;
                if (roundConfig.type === 'class') {
                    optionsPool = [...new Set(drugData.map(d => d.class))];
                } else {
                    optionsPool = [...new Set(drugData.flatMap(d => d[roundConfig.prop]))];
                }

                let options = [correctAnswer, ...this.shuffle(optionsPool.filter(o => o !== correctAnswer)).slice(0, 3)]; 
                
                const drugEl = document.createElement('div'); 
                drugEl.id = `match-drug-${targetDrug.id}`; 
                drugEl.className = 'match-item p-6 bg-white rounded-lg shadow-lg cursor-grab text-center font-bold text-xl text-sky-800 w-48'; 
                drugEl.draggable = true; 
                drugEl.textContent = targetDrug.name; 
                drugEl.dataset.drugId = targetDrug.id; 
                drugPileEl.innerHTML = `<p class="font-semibold mb-2">${roundConfig.label}</p>`; 
                drugPileEl.appendChild(drugEl); 
                
                this.shuffle(options).forEach(optionText => { 
                    const binEl = document.createElement('div'); 
                    binEl.className = 'drop-zone p-4 rounded-lg text-center text-slate-700 h-24 flex items-center justify-center bg-slate-100'; 
                    binEl.textContent = optionText; 
                    binEl.dataset.isCorrect = (optionText === correctAnswer); 
                    answerBinsEl.appendChild(binEl); 
                }); 
                this.attachDragDropListeners(); 
            },
            attachDragDropListeners() { 
                const drugEl = document.querySelector('.match-item'); 
                if (drugEl) { 
                    drugEl.addEventListener('dragstart', (e) => { 
                        e.dataTransfer.setData('text/plain', e.target.id); 
                        setTimeout(() => e.target.classList.add('invisible'), 0); 
                    }); 
                    drugEl.addEventListener('dragend', (e) => e.target.classList.remove('invisible')); 
                } 
                document.querySelectorAll('.drop-zone').forEach(zone => { 
                    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('over'); }); 
                    zone.addEventListener('dragleave', (e) => zone.classList.remove('over')); 
                    zone.addEventListener('drop', (e) => this.handleDrop(e)); 
                }); 
            },
            handleDrop(e) { 
                e.preventDefault(); 
                const dropZone = e.target.closest('.drop-zone'); 
                if (!dropZone) return; 
                dropZone.classList.remove('over'); 
                const drugElId = e.dataTransfer.getData('text/plain'); 
                const drugEl = document.getElementById(drugElId); 
                const drugId = drugEl.dataset.drugId; 
                const isCorrect = dropZone.dataset.isCorrect === 'true'; 
                this.updateMasteryScore(drugId, isCorrect ? 1 : -2, isCorrect); 
                this.playSound(isCorrect); 
                const feedbackEl = document.getElementById('matchup-feedback'); 
                if (isCorrect) { 
                    dropZone.classList.add('correct'); 
                    feedbackEl.innerHTML = `<p class="text-green-600 font-bold text-xl">Correct!</p>`; 
                } else { 
                    dropZone.classList.add('incorrect'); 
                    const correctZone = document.querySelector('.drop-zone[data-is-correct="true"]'); 
                    if (correctZone) correctZone.classList.add('correct'); 
                    feedbackEl.innerHTML = `<p class="text-red-600 font-bold text-xl">Not quite!</p>`; 
                } 
                document.querySelectorAll('.drop-zone').forEach(z => z.style.pointerEvents = 'none'); 
                drugEl.draggable = false; 
                drugEl.classList.remove('cursor-grab'); 
                setTimeout(() => { this.generateMatchUpRound(); }, 1500); 
            },
            
            // Pharmacy Fill
            renderPharmacyFill() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = pharmacyFillTemplate(); // Render the initial template

                if (!state.pharmacyFill || state.pharmacyFill.isComplete) {
                    const startButton = container.querySelector('button[onclick="App.startPharmacyFill()"]');
                    if (startButton) {
                        startButton.onclick = () => this.startPharmacyFill();
                    }
                } else {
                    const inputEl = document.getElementById('pharmacy-fill-input');
                    if (inputEl) {
                        inputEl.focus();
                        // Re-attach event listener for keydown
                        inputEl.onkeydown = (e) => this.handlePharmacyFillKeyPress(e);
                    }
                }
                lucide.createIcons();
            },
            startPharmacyFill() {
                const drugsWithBrandNames = drugData.filter(d => d.brandNames && d.brandNames.length > 0);
                if (drugsWithBrandNames.length === 0) {
                    console.warn("No drugs with brand names available for Pharmacy Fill game.");
                    mainContent.innerHTML = `<div class="text-center p-8">
                        <h1 class="text-4xl font-bold mb-2">Pharmacy Fill</h1>
                        <p class="text-slate-500 mb-8 max-w-xl mx-auto">No drugs with brand names available to play this game.</p>
                    </div>`;
                    return;
                }

                App.setState({
                    pharmacyFill: { isComplete: false, score: 0, timer: 30, currentDrug: this.shuffle(drugsWithBrandNames)[0] }
                });
                this.renderPharmacyFill(); // Re-render to show game in progress

                pharmacyFillTimerId = setInterval(() => {
                    if (!state.pharmacyFill || state.pharmacyFill.isComplete) {
                        this.clearPharmacyFillTimer();
                        return;
                    }
                    // Directly update timer display without triggering full re-render via setState
                    const timerEl = document.getElementById('pharmacy-fill-timer');
                    if (timerEl) {
                        timerEl.textContent = state.pharmacyFill.timer - 1; // Update display immediately
                    }

                    App.setState(prevState => ({
                        pharmacyFill: { ...prevState.pharmacyFill, timer: prevState.pharmacyFill.timer - 1 }
                    }), false); // Update state, but don't re-render

                    if(state.pharmacyFill.timer <= 0) {
                        this.endPharmacyFill();
                    }
                }, 1000);
            },
            handlePharmacyFillKeyPress(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const inputEl = event.target;
                    const answer = inputEl.value.trim().toLowerCase();
                    const drug = state.pharmacyFill.currentDrug;

                    let isCorrect = (answer === drug.name.toLowerCase());
                    this.playSound(isCorrect);
                    this.updateMasteryScore(drug.id, isCorrect ? 1 : -2, isCorrect);

                    if (isCorrect) {
                        const remainingDrugs = drugData.filter(d => d.brandNames && d.brandNames.length > 0 && d.id !== drug.id);
                        App.setState(prevState => ({
                            pharmacyFill: {
                                ...prevState.pharmacyFill,
                                score: prevState.pharmacyFill.score + 10,
                                currentDrug: this.shuffle(remainingDrugs.length > 0 ? remainingDrugs : drugData.filter(d => d.brandNames && d.brandNames.length > 0))[0]
                            }
                        }));
                        // Directly update score and brand name display without full re-render
                        document.getElementById('pharmacy-fill-score').textContent = state.pharmacyFill.score;
                        document.getElementById('pharmacy-fill-brand-name').textContent = state.pharmacyFill.currentDrug.brandNames[0];
                        inputEl.value = '';
                    } else {
                        inputEl.classList.add('shake-input');
                        setTimeout(() => inputEl.classList.remove('shake-input'), 500);
                        inputEl.value = '';
                    }
                }
            },
            endPharmacyFill() {
                this.clearPharmacyFillTimer();
                App.setState(prevState => ({
                    pharmacyFill: { ...prevState.pharmacyFill, isComplete: true }
                }));
                this.renderPharmacyFill(); // Re-render to show completion screen
            },
            clearPharmacyFillTimer() {
                if (pharmacyFillTimerId) {
                    clearInterval(pharmacyFillTimerId);
                    pharmacyFillTimerId = null;
                }
            },

            // Rapid Fire
            renderRapidFire() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = rapidFireTemplate(); // Render the initial template

                if (!state.quiz || state.quiz.isComplete) {
                    const startButton = container.querySelector('button[onclick="App.startRapidFire()"]');
                    if (startButton) {
                        startButton.onclick = () => this.startRapidFire();
                    }
                } else {
                    const question = state.quiz.deck[state.quiz.currentQuestion];
                    if (question?.type === 'multiple-choice') {
                        const optionsContainer = document.getElementById('quiz-options');
                        if (optionsContainer) {
                            // Re-attach event listener for options
                            optionsContainer.onclick = (e) => {
                                const button = e.target.closest('.quiz-option');
                                if (!button || button.disabled) return;
                                this.handleRapidFireAnswer(button.dataset.correct === 'true', button);
                            };
                        }
                    } else if (question?.type === 'input') {
                        const inputEl = document.getElementById('rapid-fire-input');
                        if (inputEl) {
                            inputEl.focus();
                            // Re-attach event listener for keydown
                            inputEl.onkeydown = (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.handleRapidFireAnswer(inputEl.value.trim().toLowerCase() === question.correctAnswer, null, inputEl);
                                }
                            };
                        }
                    }
                }
                lucide.createIcons();
            },
            startRapidFire() {
                const questionPool = [];
                drugData.forEach(drug => {
                    questionPool.push({ drugId: drug.id, text: `Which class does ${drug.name} belong to?`, correctAnswer: drug.class, type: 'multiple-choice' });
                    if (drug.effects && drug.effects.length > 0) {
                        questionPool.push({ drugId: drug.id, text: `Which is a key adverse effect of ${drug.name}?`, correctAnswer: this.shuffle(drug.effects)[0], type: 'multiple-choice' });
                    }
                    if (drug.nursingConsiderations && drug.nursingConsiderations.length > 0) {
                        questionPool.push({ drugId: drug.id, text: `Which is a key nursing consideration for ${drug.name}?`, correctAnswer: this.shuffle(drug.nursingConsiderations)[0], type: 'multiple-choice' });
                    }
                    if (drug.brandNames && drug.brandNames.length > 0) {
                        questionPool.push({ drugId: drug.id, text: `What is the generic name for the brand name: ${this.shuffle(drug.brandNames)[0]}?`, correctAnswer: drug.name.toLowerCase(), type: 'input' });
                    }
                });

                const generateOptions = (correctAnswer, pool) => {
                    const otherOptions = this.shuffle(pool.filter(o => o !== correctAnswer)).slice(0, 3);
                    return this.shuffle([{text: correctAnswer, correct: true}, ...otherOptions.map(o => ({text: o, correct: false}))]);
                };

                const deck = this.shuffle(questionPool).slice(0, 10).map(q => {
                    let options;
                    if (q.type === 'multiple-choice') {
                        if (q.text.includes('class')) {
                            options = generateOptions(q.correctAnswer, [...new Set(drugData.map(d => d.class))]);
                        } else if (q.text.includes('adverse effect')) {
                            options = generateOptions(q.correctAnswer, [...new Set(drugData.flatMap(d => d.effects))]);
                        } else if (q.text.includes('nursing consideration')) {
                            options = generateOptions(q.correctAnswer, [...new Set(drugData.flatMap(d => d.nursingConsiderations))]);
                        }
                    }
                    return { ...q, options };
                });

                App.setState({ quiz: { deck, currentQuestion: 0, score: 0, isComplete: false, timer: 60, incorrectlyAnsweredDrugs: [] } });
                this.renderRapidFire(); // Render the first question

                rapidFireTimerId = setInterval(() => {
                    if (!state.quiz || state.quiz.isComplete) {
                        this.clearRapidFireTimer();
                        return;
                    }
                    // Directly update timer display
                    const timerEl = document.getElementById('rapid-fire-timer');
                    if (timerEl) {
                        timerEl.textContent = state.quiz.timer - 1; // Update display immediately
                    }

                    App.setState(prevState => ({
                        quiz: { ...prevState.quiz, timer: prevState.quiz.timer - 1 }
                    }), false); // Update state, but don't re-render

                    if(state.quiz.timer <= 0) {
                        this.endRapidFire();
                    }
                }, 1000);
            },
            handleRapidFireAnswer(isCorrect, buttonEl = null, inputEl = null) {
                // Disable all options/input after an answer
                document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                if (inputEl) inputEl.readOnly = true;

                const question = state.quiz.deck[state.quiz.currentQuestion];
                const drug = drugData.find(d => d.id === question.drugId);

                this.updateMasteryScore(question.drugId, isCorrect ? 1 : -2, isCorrect);
                this.playSound(isCorrect);

                if (isCorrect) {
                    App.setState(prevState => ({ quiz: { ...prevState.quiz, score: prevState.quiz.score + 1 } }), false);
                    if (buttonEl) buttonEl.classList.add('correct');
                    if (inputEl) inputEl.style.borderColor = '#22c55e';
                } else {
                    if (buttonEl) buttonEl.classList.add('incorrect');
                    if (inputEl) inputEl.style.borderColor = '#ef4444';

                    if (drug && !state.quiz.incorrectlyAnsweredDrugs.includes(drug.name)) {
                        App.setState(prevState => ({
                            quiz: { ...prevState.quiz, incorrectlyAnsweredDrugs: [...prevState.quiz.incorrectlyAnsweredDrugs, drug.name] }
                        }), false);
                    }
                    if (question.type === 'multiple-choice') {
                        const correctButton = document.querySelector('.quiz-option[data-correct="true"]');
                        if (correctButton) correctButton.classList.add('correct');
                    }
                }
                
                setTimeout(() => {
                    App.setState(prevState => ({
                        quiz: { ...prevState.quiz, currentQuestion: prevState.quiz.currentQuestion + 1 }
                    }));
                    if (state.quiz.currentQuestion >= state.quiz.deck.length) {
                        this.endRapidFire();
                    } else {
                        this.renderRapidFire(); // Re-render to next question
                    }
                }, 1200);
            },
            endRapidFire() {
                this.clearRapidFireTimer();
                App.setState(prevState => ({ quiz: { ...prevState.quiz, isComplete: true } }));
                this.renderRapidFire(); // Re-render to show completion screen
            },
            clearRapidFireTimer() {
                if (rapidFireTimerId) {
                    clearInterval(rapidFireTimerId);
                    rapidFireTimerId = null;
                }
            },
            
            // Scenarios
            renderScenarios() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = scenariosTemplate(); // Render the initial template

                if (!state.scenarios || state.scenarios.isComplete || state.scenarios.currentIndex >= state.scenarios.deck.length) {
                    const startButton = container.querySelector('button[onclick="App.startScenarios()"]');
                    if (startButton) {
                        startButton.onclick = () => this.startScenarios();
                    }
                } else {
                    this.manageScenarioControls();
                }
                lucide.createIcons();
            },
            startScenarios() {
                App.setState({ scenarios: { deck: this.shuffle(scenarioData), currentIndex: 0, isComplete: false, stage: 'initial' } });
                this.renderScenarios();
            },
            manageScenarioControls() {
                const controls = document.getElementById('scenario-controls');
                if (!controls) return;
                const stage = state.scenarios.stage;

                if (stage === 'initial') {
                    controls.innerHTML = `<button class="bg-sky-600 text-white font-semibold px-6 py-2 rounded-lg">Assess Patient</button>`;
                    controls.firstElementChild.onclick = () => {
                        App.setState(prevState => ({ scenarios: { ...prevState.scenarios, stage: 'assessed' } }));
                        this.renderScenarios(); // Re-render to show assessment and options
                    };
                } else if (stage === 'assessed') {
                    const optionsContainer = document.getElementById('scenario-options');
                    if (optionsContainer) {
                        optionsContainer.onclick = (e) => {
                            const button = e.target.closest('.scenario-option');
                            if (button) this.handleScenarioAnswer(button);
                        };
                    }
                } else if (stage === 'answered') {
                    const scenario = state.scenarios.deck[state.scenarios.currentIndex];
                    const rationaleSection = document.getElementById('scenario-rationale');
                    if(rationaleSection) {
                        if(scenario.userWasCorrect) {
                            rationaleSection.innerHTML = `<h4 class="font-bold text-green-700">Correct Rationale</h4><p class="text-sm mt-1">${scenario.rationale.correct}</p>`;
                        } else {
                            rationaleSection.innerHTML = `<h4 class="font-bold text-red-700">Incorrect. Here's Why:</h4><p class="text-sm mt-1">${scenario.rationale.incorrect}</p>`;
                        }
                    }

                    controls.innerHTML = `<button class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg">Next Scenario</button>`;
                    controls.firstElementChild.onclick = () => {
                        App.setState(prevState => ({ scenarios: { ...prevState.scenarios, currentIndex: prevState.scenarios.currentIndex + 1 } }));
                        if (state.scenarios.currentIndex >= state.scenarios.deck.length) {
                            App.setState(prevState => ({ scenarios: { ...prevState.scenarios, isComplete: true } }));
                        } else {
                            App.setState(prevState => ({ scenarios: { ...prevState.scenarios, stage: 'initial' } }));
                        }
                        this.renderScenarios(); // Re-render for next scenario or completion
                    };
                }
            },
            handleScenarioAnswer(buttonEl) {
                if (state.scenarios.stage === 'answered') return;

                const isCorrect = buttonEl.dataset.correct === 'true';
                const scenarioIndex = state.scenarios.currentIndex; // Get the index
                const currentScenario = state.scenarios.deck[scenarioIndex]; // Get the specific scenario object
                
                App.setState(prevState => {
                    const newDeck = [...prevState.scenarios.deck]; // Create a copy of the deck
                    newDeck[scenarioIndex] = { // Update the specific scenario object in the copy
                        ...currentScenario,
                        userWasCorrect: isCorrect
                    };
                    return {
                        scenarios: {
                            ...prevState.scenarios,
                            stage: 'answered',
                            deck: newDeck // Update the deck with the modified scenario
                        }
                    };
                });
                
                this.updateMasteryScore(currentScenario.drugId, isCorrect ? 2 : -1, isCorrect); // Use currentScenario for drugId
                this.playSound(isCorrect);
                
                document.querySelectorAll('.scenario-option').forEach(b => b.disabled = true);
                buttonEl.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    const correctButton = document.querySelector('.scenario-option[data-correct="true"]');
                    if (correctButton) correctButton.classList.add('correct');
                }
                this.renderScenarios(); // Re-render to show rationale and next button
            },

            // Daily Dose
            renderDailyDose() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = dailyDoseTemplate(); // Render the initial template

                if (!state.dailyDose || state.dailyDose.isComplete) {
                    const startButton = container.querySelector('button[onclick="App.startDailyDose()"]');
                    if (startButton) {
                        startButton.onclick = () => this.startDailyDose();
                    }
                } else {
                    const currentQuestion = state.dailyDose.deck[state.dailyDose.currentQuestionIndex];
                    if (currentQuestion?.type === 'input') {
                        const inputEl = document.getElementById('daily-dose-input');
                        if (inputEl) {
                            inputEl.focus();
                            inputEl.onkeydown = (e) => { // Use onkeydown to ensure single listener
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.handleDailyDoseAnswer(inputEl.value.trim());
                                }
                            };
                        }
                    } else if (currentQuestion?.type === 'multiple-choice') {
                        const optionsContainer = document.getElementById('daily-dose-options');
                        if (optionsContainer) {
                            optionsContainer.onclick = (e) => { // Use onclick to ensure single listener
                                const button = e.target.closest('.daily-dose-option');
                                if (button && !button.disabled) {
                                    this.handleDailyDoseAnswer(button.dataset.correct === 'true', button);
                                }
                            };
                        }
                    }
                    const skipButton = container.querySelector('button[onclick="App.skipDailyDoseQuestion()"]');
                    if(skipButton) skipButton.onclick = () => this.skipDailyDoseQuestion();
                }
                lucide.createIcons();
            },
            startDailyDose() {
                const unmasteredDrugs = drugData
                    .map(d => ({ drug: d, mastery: state.mastery[d.id]?.score || 0 }))
                    .filter(item => item.mastery < 10)
                    .sort((a, b) => a.mastery - b.mastery)
                    .map(item => item.drug);

                const drugsForSession = unmasteredDrugs.length > 0 
                    ? this.shuffle(unmasteredDrugs).slice(0, Math.min(unmasteredDrugs.length, 7)) 
                    : this.shuffle(drugData).slice(0, 5); 

                if (drugsForSession.length === 0) {
                    mainContent.innerHTML = `<div class="text-center p-8">
                        <i data-lucide="party-popper" class="w-24 h-24 mx-auto text-green-500 mb-4"></i>
                        <h1 class="text-4xl font-bold mb-2">All Drugs Mastered!</h1>
                        <p class="text-slate-500 mt-2">You're a true Pharmacology Guru. No daily dose needed!</p>
                        <button onclick="window.location.hash = '#dashboard'" class="mt-8 bg-indigo-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105">Back to Dashboard</button>
                    </div>`;
                    lucide.createIcons();
                    return;
                }

                const deck = [];
                const questionTypes = ['class', 'effect', 'nursing', 'brand']; 

                drugsForSession.forEach(drug => {
                    this.shuffle(questionTypes).forEach(type => {
                        let prompt, correctAnswer, optionsPool, targetDisplay;

                        switch (type) {
                            case 'class':
                                prompt = `Which class does ${drug.name} belong to?`;
                                correctAnswer = drug.class;
                                optionsPool = [...new Set(drugData.map(d => d.class))];
                                deck.push({ drugId: drug.id, type: 'multiple-choice', prompt, correctAnswer, options: this.generateDailyDoseOptions(correctAnswer, optionsPool) });
                                break;
                            case 'effect':
                                if (drug.effects && drug.effects.length > 0) {
                                    correctAnswer = this.shuffle(drug.effects)[0];
                                    prompt = `Which is a key adverse effect of ${drug.name}?`;
                                    optionsPool = [...new Set(drugData.flatMap(d => d.effects))];
                                    deck.push({ drugId: drug.id, type: 'multiple-choice', prompt, correctAnswer, options: this.generateDailyDoseOptions(correctAnswer, optionsPool) });
                                }
                                break;
                            case 'nursing':
                                if (drug.nursingConsiderations && drug.nursingConsiderations.length > 0) {
                                    correctAnswer = this.shuffle(drug.nursingConsiderations)[0];
                                    prompt = `Which is a key nursing consideration for ${drug.name}?`;
                                    optionsPool = [...new Set(drugData.flatMap(d => d.nursingConsiderations))];
                                    deck.push({ drugId: drug.id, type: 'multiple-choice', prompt, correctAnswer, options: this.generateDailyDoseOptions(correctAnswer, optionsPool) });
                                }
                                break;
                            case 'brand':
                                if (drug.brandNames && drug.brandNames.length > 0) {
                                    correctAnswer = this.shuffle(drug.brandNames)[0];
                                    prompt = `What is the generic name for the brand name:`;
                                    targetDisplay = correctAnswer; 
                                    correctAnswer = drug.name.toLowerCase(); 
                                    deck.push({ drugId: drug.id, type: 'input', prompt, correctAnswer, targetDisplay });
                                }
                                break;
                        }
                    });
                });

                App.setState({
                    dailyDose: {
                        isComplete: false,
                        currentQuestionIndex: 0,
                        score: 0,
                        deck: this.shuffle(deck).slice(0, 10), 
                        incorrectlyAnsweredDrugs: [] 
                    }
                });
                window.location.hash = '#daily-dose'; 
            },
            generateDailyDoseOptions: (correctAnswer, pool) => {
                const otherOptions = App.shuffle(pool.filter(o => o !== correctAnswer)).slice(0, 3);
                return App.shuffle([{text: correctAnswer, correct: true}, ...otherOptions.map(o => ({text: o, correct: false}))]);
            },
            attachDailyDoseListeners() {
                const currentQuestion = state.dailyDose.deck[state.dailyDose.currentQuestionIndex];
                if (!currentQuestion) return; 

                if (currentQuestion.type === 'input') {
                    const inputEl = document.getElementById('daily-dose-input');
                    if (inputEl) {
                        inputEl.focus();
                        inputEl.onkeydown = (e) => { // Use onkeydown to ensure single listener
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.handleDailyDoseAnswer(inputEl.value.trim());
                                }
                            };
                    }
                } else { 
                    const optionsContainer = document.getElementById('daily-dose-options');
                    if (optionsContainer) {
                        optionsContainer.onclick = (e) => { // Use onclick to ensure single listener
                            const button = e.target.closest('.daily-dose-option');
                            if (button && !button.disabled) {
                                this.handleDailyDoseAnswer(button.dataset.correct === 'true', button);
                            }
                        };
                    }
                }
            },
            handleDailyDoseAnswer(userAnswer, buttonEl = null) {
                const currentQuestion = state.dailyDose.deck[state.dailyDose.currentQuestionIndex];
                let isCorrect = false;
                let feedbackMessage = '';
                const feedbackEl = document.getElementById('daily-dose-feedback');
                const nextButtonContainer = document.querySelector('.flex.justify-between.mt-6');


                if (currentQuestion.type === 'input') {
                    isCorrect = (userAnswer.toLowerCase() === currentQuestion.correctAnswer.toLowerCase());
                    feedbackMessage = isCorrect ? 'Correct!' : `Incorrect. The answer was: ${currentQuestion.correctAnswer}`;
                    const inputEl = document.getElementById('daily-dose-input');
                    if (inputEl) {
                        inputEl.readOnly = true; 
                        inputEl.style.borderColor = isCorrect ? '#22c55e' : '#ef4444'; 
                    }
                } else { 
                    isCorrect = (userAnswer === true); 
                    feedbackMessage = isCorrect ? 'Correct!' : `Incorrect. The correct answer was: ${currentQuestion.correctAnswer}`;
                    
                    document.querySelectorAll('.daily-dose-option').forEach(b => b.disabled = true);
                    if (buttonEl) buttonEl.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) {
                        const correctButton = document.querySelector('.daily-dose-option[data-correct="true"]');
                        if (correctButton) correctButton.classList.add('correct');
                    }
                }

                if (isCorrect) {
                    App.setState(prevState => ({ dailyDose: { ...prevState.dailyDose, score: prevState.dailyDose.score + 1 } }), false);
                    feedbackEl.className = 'mt-4 text-center font-bold text-lg text-green-600';
                } else {
                    feedbackEl.className = 'mt-4 text-center font-bold text-lg text-red-600';
                    const drug = drugData.find(d => d.id === currentQuestion.drugId);
                    if (drug && !state.dailyDose.incorrectlyAnsweredDrugs.includes(drug.name)) {
                        App.setState(prevState => ({ dailyDose: { ...prevState.dailyDose, incorrectlyAnsweredDrugs: [...prevState.dailyDose.incorrectlyAnsweredDrugs, drug.name] } }), false);
                    }
                }
                feedbackEl.textContent = feedbackMessage;
                this.playSound(isCorrect);
                this.updateMasteryScore(currentQuestion.drugId, isCorrect ? 1 : -1, isCorrect); 

                if (nextButtonContainer) {
                    nextButtonContainer.innerHTML = `<button onclick="App.nextDailyDoseQuestion()" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition">Next Question</button>`;
                }
            },
            nextDailyDoseQuestion() {
                App.setState(prevState => ({ dailyDose: { ...prevState.dailyDose, currentQuestionIndex: prevState.dailyDose.currentQuestionIndex + 1 } }));
                if (state.dailyDose.currentQuestionIndex >= state.dailyDose.deck.length) {
                    App.setState(prevState => ({ dailyDose: { ...prevState.dailyDose, isComplete: true } }));
                }
                this.renderDailyDose();
            },
            skipDailyDoseQuestion() {
                const currentQuestion = state.dailyDose.deck[state.dailyDose.currentQuestionIndex];
                this.updateMasteryScore(currentQuestion.drugId, -0.5, false); 
                this.nextDailyDoseQuestion();
            },

            // Explain This
            renderExplainThis() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = explainThisTemplate(); // Render the initial template

                if (!state.explainThis || !state.explainThis.currentDrug) {
                    const startButton = container.querySelector('button[onclick="App.startExplainThis()"]');
                    if (startButton) {
                        startButton.onclick = () => this.startExplainThis();
                    }
                } else {
                    const revealButton = container.querySelector('button[onclick="App.checkExplainThisAnswer()"]');
                    if (revealButton) {
                        revealButton.onclick = () => this.checkExplainThisAnswer();
                    }
                    const nextDrugButton = container.querySelector('button[onclick="App.nextExplainThisQuestion()"]');
                    if (nextDrugButton) {
                        nextDrugButton.onclick = () => this.nextExplainThisQuestion();
                    }

                    const textarea = document.getElementById('explain-this-input');
                    if (textarea && !state.explainThis.isAnswerRevealed) {
                        textarea.focus();
                    }
                }
                lucide.createIcons();
            },
            startExplainThis(drugId = null) {
                let drug;
                if (drugId) {
                    drug = drugData.find(d => d.id === drugId);
                } else {
                    const unmasteredDrugs = drugData.filter(d => (state.mastery[d.id]?.score || 0) < 10);
                    drug = this.shuffle(unmasteredDrugs.length > 0 ? unmasteredDrugs : drugData)[0];
                }

                if (!drug) {
                    console.warn("No drugs available for Explain This session.");
                    return;
                }

                const properties = [];
                if (drug.moa) properties.push('moa');
                if (drug.effects && drug.effects.length > 0) properties.push('effects');
                if (drug.nursingConsiderations && drug.nursingConsiderations.length > 0) properties.push('nursingConsiderations');
                if (drug.class) properties.push('class');

                const randomProperty = this.shuffle(properties)[0];

                App.setState({
                    explainThis: {
                        isComplete: false,
                        currentDrug: drug,
                        currentProperty: randomProperty,
                        isAnswerRevealed: false,
                        userAnswer: ''
                    }
                });
                window.location.hash = '#explain-this';
            },
            checkExplainThisAnswer() {
                const inputEl = document.getElementById('explain-this-input');
                if (inputEl) {
                    App.setState(prevState => ({
                        explainThis: { ...prevState.explainThis, userAnswer: inputEl.value.trim(), isAnswerRevealed: true }
                    }));
                    this.renderExplainThis(); 
                }
            },
            nextExplainThisQuestion() {
                App.setState(prevState => ({ explainThis: { ...prevState.explainThis, isComplete: true } })); 
                this.startExplainThis(); 
            },

            // Pomodoro Timer
            renderPomodoro() {
                const container = document.getElementById('main-content');
                if (!container) return;
                container.innerHTML = pomodoroTemplate(); // Render the initial template

                const startButton = container.querySelector('button[onclick="App.startPomodoro()"]');
                if(startButton) startButton.onclick = () => this.startPomodoro();
                const pauseButton = container.querySelector('button[onclick="App.pausePomodoro()"]');
                if(pauseButton) pauseButton.onclick = () => this.pausePomodoro();
                const resetButton = container.querySelector('button[onclick="App.resetPomodoro()"]');
                if(resetButton) resetButton.onclick = () => this.resetPomodoro();

                lucide.createIcons();
            },
            startPomodoro() {
                if (state.pomodoro.isRunning) return;

                App.setState(prevState => ({ pomodoro: { ...prevState.pomodoro, isRunning: true } }));
                this.renderPomodoro(); 

                pomodoroTimerId = setInterval(() => {
                    if (state.pomodoro.timeLeft <= 0) {
                        this.playSound(true); 
                        App.setState(prevState => ({
                            pomodoro: {
                                ...prevState.pomodoro,
                                isBreak: !prevState.pomodoro.isBreak,
                                timeLeft: prevState.pomodoro.isBreak ? prevState.pomodoro.studyDuration : prevState.pomodoro.breakDuration
                            }
                        }));
                        this.renderPomodoro(); 
                    } else {
                        App.setState(prevState => ({ pomodoro: { ...prevState.pomodoro, timeLeft: prevState.pomodoro.timeLeft - 1 } }), false); 
                        this.renderPomodoro(); // Re-render to update time display
                    }
                }, 1000);
            },
            pausePomodoro() {
                if (!state.pomodoro.isRunning) return;
                App.setState(prevState => ({ pomodoro: { ...prevState.pomodoro, isRunning: false } }));
                this.clearPomodoroTimer();
                this.renderPomodoro(); 
            },
            resetPomodoro() {
                this.clearPomodoroTimer();
                App.setState({ pomodoro: { isRunning: false, timeLeft: 25 * 60, isBreak: false, studyDuration: 25 * 60, breakDuration: 5 * 60 } });
                this.renderPomodoro(); 
            },
            clearPomodoroTimer() {
                if (pomodoroTimerId) {
                    clearInterval(pomodoroTimerId);
                    pomodoroTimerId = null;
                }
            },
        };

        // Initialize the application when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
