import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from 'firebase/firestore';
import { ArrowLeft, BrainCircuit, Bot, User, CheckCircle, XCircle, ChevronRight, Menu, X, HelpCircle, BookOpen, ClipboardList, Lightbulb, Shield, Send, Users, Activity, Layers, GraduationCap } from 'lucide-react';

// --- Firebase Configuration ---
// These global variables are provided by the environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mindpath-app';
let firebaseConfig;
try {
    firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
} catch (e) {
    console.error("Failed to parse firebase config:", e);
    firebaseConfig = {};
}

// --- Firebase Initialization ---
let app;
let auth;
let db;

try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
} catch (e) {
    console.error("Firebase initialization error:", e);
}


// --- Content & Data Structure ---
const contentData = {
  'foundations': {
    title: 'Core Concepts',
    icon: GraduationCap,
    color: 'from-sky-500 to-cyan-400',
    description: 'Establish a strong base in mental health nursing terminology and principles.',
    steps: [
      { id: 'intro', title: 'Welcome to MindPath', type: 'intro' },
      { id: 'mse', title: 'The Mental Status Exam', type: 'text', content: `The Mental Status Exam (MSE) is the cornerstone of psychiatric assessment, like a physical exam for the mind. It's a structured way to observe and describe a patient's psychological functioning at a specific point in time. Key components include: \n\n- **Appearance:** Dress, grooming, hygiene. \n- **Behavior:** Posture, facial expressions, motor activity. \n- **Speech:** Rate, rhythm, volume, and content. \n- **Mood & Affect:** The patient's stated mood versus their observed emotional expression. \n- **Thought Process:** How thoughts are connected (e.g., logical, circumstantial, tangential). \n- **Thought Content:** What the patient is thinking about (e.g., delusions, obsessions, suicidal ideation). \n- **Perception:** Presence of hallucinations or illusions. \n- **Cognition:** Level of consciousness, orientation, memory, attention, and insight/judgment.` },
      { id: 'glossary', title: 'Interactive Glossary', type: 'glossary' },
    ],
  },
  'schizophrenia': {
    title: 'Schizophrenia Spectrum',
    icon: BrainCircuit,
    color: 'from-purple-500 to-indigo-500',
    description: 'Explore psychosis, symptoms, and interventions for schizophrenia.',
    steps: [
      { id: 'intro', title: 'Disorder Overview', type: 'text', content: `Schizophrenia is a brain disorder that affects how a person thinks, feels, and perceives reality. It is NOT split personality. It is characterized by periods of **psychosis**, where the individual has difficulty distinguishing what is real from what is not. Core symptoms are grouped into three categories: Positive (things that are added, like hallucinations), Negative (things that are taken away, like motivation), and Cognitive (deficits in thinking and memory).` },
      { id: 'symptom-sorter', title: 'Symptom Sorter', type: 'interactive_sorter' },
      { id: 'medications', title: 'Antipsychotics Deep Dive', type: 'text', content: `Antipsychotics are the primary medication for schizophrenia, mainly working on the **dopamine** neurotransmitter system. \n\n**First-Generation (Typicals) like Haloperidol:** These are strong dopamine blockers. While effective for positive symptoms, this strong blockade can cause motor side effects known as **Extrapyramidal Side Effects (EPS)**. This includes acute dystonia (sudden, painful muscle spasms), akathisia (severe inner restlessness), and symptoms resembling Parkinson's disease. \n\n**Second-Generation (Atypicals) like Risperidone & Olanzapine:** These block dopamine more selectively and also act on serotonin. This makes them effective for both positive and negative symptoms with a lower risk of EPS. However, they are known for causing **Metabolic Syndrome**: significant weight gain, high blood sugar, and high cholesterol. Nurses must monitor weight, waist circumference, blood pressure, and order labs (glucose, lipid panel) regularly. \n\n**Tardive Dyskinesia (TD):** A serious, potentially irreversible side effect from long-term antipsychotic use, causing involuntary movements (e.g., lip smacking, writhing). Nurses should perform regular AIMS (Abnormal Involuntary Movement Scale) assessments to screen for TD.`},
      { id: 'interventions', title: 'Interventions for Psychosis', type: 'text', content: `When a patient is experiencing psychosis, the nursing priority is safety and building trust. \n\n**For Hallucinations:** Ask directly what they are hearing/seeing. Do not argue with the perception, but state your own reality ("I know the voices are real to you, but I do not hear them."). This validates their experience without validating the hallucination. Reduce environmental stimuli and engage them in a reality-based activity. \n\n**For Delusions:** Do not challenge the false belief, as this can increase agitation. Instead, focus on the underlying feeling or theme ("It sounds like you feel frightened."). Gently redirect the conversation to reality-based topics.`},
      { id: 'case-study', title: 'Case Study Challenge', type: 'case_study', case: {
        scenario: "A 22-year-old male is admitted. He reports hearing voices telling him he's a prophet. His speech is disorganized, and he shows little emotional expression. He has been socially withdrawn for 6 months.",
        question: "Based on these signs, what is the most prominent category of symptoms he is displaying?",
        options: ["Negative Symptoms", "Positive Symptoms", "Cognitive Symptoms", "Affective Symptoms"],
        correctAnswer: "Positive Symptoms",
        explanation: "Hallucinations (hearing voices) and disorganized speech are hallmark positive symptoms of schizophrenia. While he also shows negative symptoms (flat affect, withdrawal), the primary reason for admission is the active psychosis."
      }},
    ],
  },
  'personality-disorders': {
    title: 'Personality Disorders',
    icon: Users,
    color: 'from-teal-500 to-emerald-500',
    description: 'Understand the clusters, traits, and therapeutic approaches for personality disorders.',
    steps: [
       { id: 'intro', title: 'Disorder Overview', type: 'text', content: `A personality disorder is not an illness in the typical sense; it's a deeply ingrained, inflexible, and unhealthy pattern of thinking, feeling, and behaving that deviates from cultural norms. These patterns are pervasive across many situations and lead to significant distress or impairment. They are grouped into three clusters:\n- **Cluster A (Odd/Eccentric):** Characterized by social awkwardness and withdrawal.\n- **Cluster B (Dramatic/Emotional):** Characterized by problems with impulse control and emotional regulation.\n- **Cluster C (Anxious/Fearful):** Characterized by high levels of anxiety.` },
       { id: 'cluster-b', title: 'Cluster B Deep Dive', type: 'text', content: `**Antisocial (ASPD):** Pervasive disregard for and violation of the rights of others. Deceitful, manipulative, and impulsive with a lack of remorse. Nursing requires firm, consistent limit-setting.\n\n**Borderline (BPD):** Pervasive instability in relationships, self-image, and emotions. Marked impulsivity, fear of abandonment, and chronic feelings of emptiness. Prone to using defense mechanisms like **splitting**. Nursing care requires a united team approach to manage boundaries.\n\n**Narcissistic (NPD):** Pervasive pattern of grandiosity, need for admiration, and lack of empathy. They may seem confident but have very fragile self-esteem.`},
       { id: 'dbt', title: 'Therapeutic Approaches: DBT', type: 'text', content: `**Dialectical Behavior Therapy (DBT)** is the most effective treatment for BPD. It combines cognitive-behavioral techniques with mindfulness. DBT focuses on teaching four key skill sets:\n\n1.  **Mindfulness:** Learning to be present in the moment without judgment.\n2.  **Distress Tolerance:** Learning to cope with and survive crises without making things worse.\n3.  **Emotion Regulation:** Learning to understand and reduce vulnerability to negative emotions.\n4.  **Interpersonal Effectiveness:** Learning to get needs met, maintain self-respect, and strengthen relationships.` },
       { id: 'case-study-bpd', title: 'Case Study: BPD', type: 'case_study', case: {
          scenario: "A client with Borderline Personality Disorder tells you, 'You're the only nurse who has ever understood me. The night nurse is completely useless.'",
          question: "This behavior is a classic example of which defense mechanism?",
          options: ["Projection", "Splitting", "Sublimation", "Reaction Formation"],
          correctAnswer: "Splitting",
          explanation: "Splitting is a common defense mechanism in BPD where individuals are unable to integrate the positive and negative qualities of self or others, viewing them as 'all good' or 'all bad'. This creates instability in relationships and requires a consistent, united approach from the care team."
       }},
    ],
  },
    'neurocognitive-disorders': {
    title: 'Neurocognitive Disorders',
    icon: Activity,
    color: 'from-amber-500 to-orange-500',
    description: 'Differentiate between delirium and dementia, and learn key nursing interventions.',
    steps: [
       { id: 'intro', title: 'Disorder Overview', type: 'text', content: `Neurocognitive disorders involve a clinically significant deficit in cognition (thinking skills) that represents a change from a previous level of functioning. A key nursing challenge is distinguishing among the "3 D's":\n- **Delirium:** Acute, fluctuating onset. A medical emergency.\n- **Dementia:** Gradual, progressive, and irreversible decline.\n- **Depression:** Can cause cognitive symptoms (pseudodementia) but is treatable.` },
       { id: 'care-strategies', title: 'Caring for Dementia', type: 'text', content: `Compassionate care for patients with dementia focuses on promoting safety and preserving dignity. \n\n**Communication:** Use simple, direct sentences. Approach from the front and make eye contact. Use non-verbal cues like smiling and gentle touch. If a patient is agitated, validate their feeling and gently redirect (e.g., "I see you're upset. Let's walk over here and look at this picture."). \n\n**Safety:** The environment should be safe and predictable. Remove clutter, ensure adequate lighting, and secure dangerous items. A consistent daily routine is calming. For wandering, ensure the patient has an ID bracelet and consider alarms on doors.` },
       { id: 'case-study-delirium', title: 'Case Study: Delirium', type: 'case_study', case: {
          scenario: "An 80-year-old patient, post-hip surgery, suddenly becomes disoriented, confused, and is seeing insects on the walls. These symptoms started acutely this evening.",
          question: "What is the most likely diagnosis and the priority nursing action?",
          options: ["Sundowning in dementia; offer reassurance.", "Acute delirium; look for an underlying cause (e.g., infection, hypoxia).", "Schizophrenia onset; administer antipsychotics.", "Medication side effect; stop all pain medication."],
          correctAnswer: "Acute delirium; look for an underlying cause (e.g., infection, hypoxia).",
          explanation: "Delirium is characterized by an acute onset and fluctuating course, often with visual hallucinations. It is a medical emergency. The priority is to identify and treat the underlying physiological cause."
       }},
       { id: 'alzheimers', title: `Alzheimer's Disease`, type: 'text', content: `Alzheimer's is the most common form of dementia. It's characterized by the "4 A's": Amnesia (memory loss, especially recent), Aphasia (language difficulty, from finding words to producing speech), Apraxia (loss of purposeful movement, like using a fork), and Agnosia (inability to recognize familiar objects or people).` },
    ],
  },
};

const glossaryTerms = {
  "Akathisia": "An intense subjective feeling of inner restlessness and a compelling need to move; inability to sit still.",
  "Anosognosia": "The inability to realize one's own illness or symptoms, caused by neurological deficits.",
  "Avolition": "Loss of motivation; difficulty beginning and sustaining goal-directed activities.",
  "Delirium": "An acute, fluctuating disturbance in attention, consciousness, and cognition. It's a medical emergency often caused by an underlying condition.",
  "Dementia": "A progressive decline in cognitive function that interferes with daily life. Alzheimer's is the most common type.",
  "EPS (Extrapyramidal Side Effects)": "A group of motor symptoms caused by antipsychotic medications, including acute dystonia, pseudoparkinsonism, and akathisia.",
  "NMS (Neuroleptic Malignant Syndrome)": "A rare but life-threatening reaction to antipsychotics, characterized by high fever, severe muscle rigidity, and altered mental status.",
  "Splitting": "A defense mechanism, common in BPD, of viewing people or situations as 'all good' or 'all bad'.",
  "Tardive Dyskinesia (TD)": "Involuntary, repetitive movements (e.g., facial grimacing, lip smacking) that can occur with long-term antipsychotic use."
};

const symptomSorterData = {
    "Positive": ["Hallucinations", "Delusions", "Disorganized Speech", "Bizarre Behavior"],
    "Negative": ["Alogia (Poverty of Speech)", "Avolition (Lack of Motivation)", "Anhedonia (Inability to feel pleasure)", "Flat Affect"],
    "Cognitive": ["Impaired Executive Function", "Memory Deficits", "Difficulty Focusing", "Anosognosia"]
};


// --- Helper Functions ---
const cn = (...classes) => classes.filter(Boolean).join(' ');


// --- Child Components ---

const Dashboard = ({ onSelectModule, progress }) => (
  <div className="p-4 sm:p-6 md:p-8">
    <header className="mb-8">
      <div className="flex items-center gap-3 mb-2">
        <Layers className="w-8 h-8 text-indigo-500" />
        <h1 className="text-3xl sm:text-4xl font-bold text-gray-800">MindPath Dashboard</h1>
      </div>
      <p className="text-lg text-gray-500">Your AI-powered mental health nursing companion.</p>
    </header>
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {Object.entries(contentData).map(([id, module]) => {
        const moduleProgress = progress[id] || {};
        const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
        const totalSteps = module.steps.length;
        const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

        return (
          <div
            key={id}
            onClick={() => onSelectModule(id)}
            className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group"
          >
            <div className="flex justify-between items-start mb-4">
              <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color)}>
                <module.icon className="w-6 h-6 text-white" />
              </div>
              <div className="relative w-12 h-12">
                  <svg className="w-full h-full" viewBox="0 0 36 36">
                      <path
                          className="text-gray-200"
                          d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none"
                          stroke="currentColor"
                          strokeWidth="3"
                      />
                      <path
                          className="text-indigo-500"
                          d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none"
                          stroke="currentColor"
                          strokeWidth="3"
                          strokeDasharray={`${percentage}, 100`}
                          strokeLinecap="round"
                          transform="rotate(-90 18 18)"
                      />
                  </svg>
                  <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
              </div>
            </div>
            <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
            <p className="text-gray-500 text-sm mb-4">{module.description}</p>
            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700">
              Start Learning <ChevronRight className="w-4 h-4 ml-1" />
            </div>
          </div>
        );
      })}
    </div>
  </div>
);

const SymptomSorter = ({ onComplete }) => {
    const [buckets, setBuckets] = useState({ Positive: [], Negative: [], Cognitive: [] });
    const [items, setItems] = useState([]);
    const [feedback, setFeedback] = useState(null);
    const [completed, setCompleted] = useState(false);

    useEffect(() => {
        const allItems = Object.values(symptomSorterData).flat();
        setItems(allItems.sort(() => Math.random() - 0.5));
    }, []);

    const handleDragStart = (e, item) => {
        e.dataTransfer.setData("text/plain", item);
    };

    const handleDrop = (e, bucketName) => {
        e.preventDefault();
        const item = e.dataTransfer.getData("text/plain");
        setItems(prev => prev.filter(i => i !== item));
        setBuckets(prev => ({ ...prev, [bucketName]: [...prev[bucketName], item] }));
    };

    const handleDragOver = (e) => {
        e.preventDefault();
    };
    
    const handleReturnItem = (item, fromBucket) => {
        setBuckets(prev => ({ ...prev, [fromBucket]: prev[fromBucket].filter(i => i !== item)}));
        setItems(prev => [...prev, item]);
    };

    const checkAnswers = () => {
        let allCorrect = true;
        Object.entries(buckets).forEach(([bucketName, items]) => {
            if (items.length !== symptomSorterData[bucketName].length) {
                allCorrect = false;
            }
            items.forEach(item => {
                if (!symptomSorterData[bucketName].includes(item)) {
                    allCorrect = false;
                }
            });
        });
        
        if (items.length > 0) allCorrect = false;
        
        setFeedback(allCorrect);
        if(allCorrect) {
            setCompleted(true);
            onComplete();
        }
    };

    return (
        <div className="p-4 bg-gray-50 rounded-lg">
            <h4 className="font-bold text-lg text-gray-800 mb-2">Symptom Sorter</h4>
            <p className="text-sm text-gray-600 mb-4">Drag and drop the symptoms into the correct categories.</p>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                {Object.keys(buckets).map(bucketName => (
                    <div
                        key={bucketName}
                        onDrop={(e) => handleDrop(e, bucketName)}
                        onDragOver={handleDragOver}
                        className="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300 min-h-[150px]"
                    >
                        <h5 className="font-semibold text-center text-gray-700 mb-2">{bucketName}</h5>
                        <div className="flex flex-col gap-2">
                            {buckets[bucketName].map(item => (
                                <div key={item} onClick={() => handleReturnItem(item, bucketName)} className="bg-indigo-100 text-indigo-800 text-sm p-2 rounded-md cursor-pointer">
                                    {item}
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>

            <div className="bg-gray-100 p-4 rounded-lg min-h-[100px] flex flex-wrap gap-2 items-center justify-center">
                {items.map(item => (
                    <div
                        key={item}
                        draggable
                        onDragStart={(e) => handleDragStart(e, item)}
                        className="bg-white shadow-sm p-2 rounded-md cursor-grab active:cursor-grabbing border border-gray-200 text-sm"
                    >
                        {item}
                    </div>
                ))}
            </div>
            
            <div className="mt-4 text-center">
                {feedback !== null && (
                    <div className={`p-3 rounded-lg text-white font-semibold mb-4 ${feedback ? 'bg-green-500' : 'bg-red-500'}`}>
                        {feedback ? 'All correct! Great job!' : 'Not quite right. Please try again.'}
                    </div>
                )}
                <button onClick={checkAnswers} disabled={completed} className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                    Check Answers
                </button>
            </div>
        </div>
    );
};

const CaseStudy = ({ caseData, onComplete }) => {
    const [selectedAnswer, setSelectedAnswer] = useState(null);
    const [isCorrect, setIsCorrect] = useState(null);

    const handleSelect = (option) => {
        if (selectedAnswer) return;
        setSelectedAnswer(option);
        const correct = option === caseData.correctAnswer;
        setIsCorrect(correct);
        if (correct) {
            onComplete();
        }
    };

    return (
        <div className="p-4 bg-gray-50 rounded-lg">
            <h4 className="font-bold text-lg text-gray-800 mb-2">Case Study Challenge</h4>
            <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm whitespace-pre-wrap">{caseData.scenario}</p>
            <p className="font-semibold text-gray-700 mb-3">{caseData.question}</p>
            <div className="space-y-2">
                {caseData.options.map(option => {
                    const isSelected = selectedAnswer === option;
                    let optionClass = 'bg-white hover:bg-gray-100';
                    if (isSelected) {
                        optionClass = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
                    } else if (selectedAnswer && option === caseData.correctAnswer) {
                        optionClass = 'bg-green-100 border-green-500';
                    }

                    return (
                        <div
                            key={option}
                            onClick={() => handleSelect(option)}
                            className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                        >
                            <div className="flex items-center">
                                {isSelected && (
                                    isCorrect ? <CheckCircle className="w-5 h-5 text-green-600 mr-2" /> : <XCircle className="w-5 h-5 text-red-600 mr-2" />
                                )}
                                <span className="flex-1">{option}</span>
                            </div>
                        </div>
                    );
                })}
            </div>
            {selectedAnswer && (
                <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                    <h5 className="font-bold text-indigo-800">Explanation</h5>
                    <p className="text-sm text-indigo-700">{caseData.explanation}</p>
                </div>
            )}
        </div>
    );
};

const Glossary = ({ onComplete, stepId }) => {
    const [searchTerm, setSearchTerm] = useState("");
    const filteredTerms = useMemo(() =>
        Object.entries(glossaryTerms).filter(([term, _]) =>
            term.toLowerCase().includes(searchTerm.toLowerCase())
        ), [searchTerm]
    );
    
    useEffect(() => {
        onComplete(stepId);
    }, [onComplete, stepId]);

    return (
        <div className="p-4 bg-gray-50 rounded-lg">
            <h4 className="font-bold text-lg text-gray-800 mb-4">Glossary of Terms</h4>
            <input
                type="text"
                placeholder="Search terms..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
            <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                {filteredTerms.map(([term, definition]) => (
                    <div key={term} className="bg-white p-3 rounded-md shadow-sm">
                        <h5 className="font-semibold text-indigo-700">{term}</h5>
                        <p className="text-sm text-gray-600">{definition}</p>
                    </div>
                ))}
            </div>
        </div>
    );
};

const TextStep = ({ step, onComplete }) => {
    useEffect(() => {
        if (step && step.id) {
            onComplete(step.id);
        }
    }, [step.id, onComplete]);

    return (
        <div className="text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg space-y-4 whitespace-pre-wrap">
            {step.content || "Welcome to this module. Select a step from the sidebar to begin."}
        </div>
    );
};

const LearningModule = ({ module, onBack, progress, onProgressUpdate }) => {
    const [activeStep, setActiveStep] = useState(0);
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);
    
    const handleStepComplete = useCallback((stepId) => {
        onProgressUpdate(module.id, stepId, true);
    }, [onProgressUpdate, module.id]);
    
    const handleNextStep = () => {
        if (activeStep < module.steps.length - 1) {
            setActiveStep(activeStep + 1);
        }
    };
    
    const handlePrevStep = () => {
        if (activeStep > 0) {
            setActiveStep(activeStep - 1);
        }
    };

    const currentStep = module.steps[activeStep];
    const moduleProgress = progress[module.id] || {};

    const renderStepContent = (step) => {
        if (!step) return <p>Please select a step.</p>;
        switch (step.type) {
            case 'intro':
                const introStepContent = "Welcome! This module provides a high-level overview. Navigate through the steps to learn more.";
                return <TextStep step={{...step, content: introStepContent }} onComplete={handleStepComplete} />;
            case 'text':
                return <TextStep step={step} onComplete={handleStepComplete} />;
            case 'interactive_sorter':
                return <SymptomSorter onComplete={() => handleStepComplete(step.id)} />;
            case 'case_study':
                return <CaseStudy caseData={step.case} onComplete={() => handleStepComplete(step.id)} />;
            case 'glossary':
                return <Glossary onComplete={handleStepComplete} stepId={step.id} />;
            default:
                return <p>Content not available.</p>;
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
            {/* Header */}
            <header className="bg-white shadow-md p-4 flex items-center justify-between z-10 flex-shrink-0">
                <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800">
                    <ArrowLeft className="w-5 h-5" />
                    Back to Dashboard
                </button>
                <div className="flex items-center gap-2">
                    <module.icon className="w-6 h-6 text-gray-600 hidden sm:block" />
                    <h2 className="text-xl font-bold text-gray-800">{module.title}</h2>
                </div>
                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2">
                    {isSidebarOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                </button>
            </header>

            <div className="flex flex-1 overflow-hidden">
                {/* Sidebar */}
                <aside className={cn(
                    "bg-white border-r border-gray-200 p-4 w-72 flex-shrink-0 flex flex-col transition-transform transform md:translate-x-0 absolute md:static h-full z-20",
                    isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                )}>
                    <h3 className="text-lg font-semibold mb-4 text-gray-700">Module Steps</h3>
                    <nav className="space-y-2">
                        {module.steps.map((step, index) => (
                            <button
                                key={step.id}
                                onClick={() => {
                                    setActiveStep(index);
                                    setIsSidebarOpen(false); // Close sidebar on selection for mobile
                                }}
                                className={cn(
                                    'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                    activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100'
                                )}
                            >
                                {moduleProgress[step.id]?.completed ? (
                                    <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0" />
                                ) : (
                                    <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                       <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500" : "border-gray-400")}></div>
                                    </div>
                                )}
                                <span className="flex-1">{step.title}</span>
                            </button>
                        ))}
                    </nav>
                </aside>

                {/* Main Content */}
                <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                        {renderStepContent(currentStep)}

                        <div className="flex justify-between mt-8">
                            <button
                                onClick={handlePrevStep}
                                disabled={activeStep === 0}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Previous
                            </button>
                            <button
                                onClick={handleNextStep}
                                disabled={activeStep === module.steps.length - 1}
                                className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    );
};

const ClinicalCoach = ({ userId }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState([
        { role: "assistant", text: "Hi! I'm your AI Clinical Coach. Ask me to explain a concept, or give you a clinical scenario. How can I help?" }
    ]);
    const [input, setInput] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    const chatHistoryRef = React.useRef(null);

    useEffect(() => {
        if (chatHistoryRef.current) {
            chatHistoryRef.current.scrollTop = chatHistoryRef.current.scrollHeight;
        }
    }, [messages]);

    const handleSend = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = { role: 'user', text: input };
        setMessages(prev => [...prev, userMessage]);
        setInput("");
        setIsLoading(true);

        const chatHistoryForAPI = messages.map(m => ({
            role: m.role === 'assistant' ? 'model' : 'user',
            parts: [{ text: m.text }]
        }));
        chatHistoryForAPI.push({ role: "user", parts: [{ text: input }] });
        
        const payload = { 
            contents: chatHistoryForAPI,
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
            ]
        };
        const apiKey = ""; // Canvas will provide the key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            
            let botResponse = "I'm having trouble responding right now. Please try again later.";
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                botResponse = result.candidates[0].content.parts[0].text;
            } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                botResponse = `My apologies, I cannot respond to that. Reason: ${result.promptFeedback.blockReason}. Let's focus on clinical nursing topics.`;
            }

            setMessages(prev => [...prev, { role: 'assistant', text: botResponse }]);
        } catch (error) {
            console.error("Gemini API error:", error);
            setMessages(prev => [...prev, { role: 'assistant', text: "There was an error connecting to the AI coach." }]);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <>
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="fixed bottom-6 right-6 bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform z-30"
                aria-label="Toggle Clinical Coach"
            >
                {isOpen ? <X className="w-8 h-8" /> : <Bot className="w-8 h-8" />}
            </button>
            {isOpen && (
                <div className="fixed bottom-24 right-6 w-full max-w-sm h-[60vh] bg-white rounded-2xl shadow-2xl flex flex-col border border-gray-200 z-30">
                    <header className="p-4 bg-gray-50 rounded-t-2xl border-b border-gray-200 flex items-center gap-3">
                       <div className="p-2 bg-indigo-100 rounded-full">
                         <Bot className="w-6 h-6 text-indigo-600" />
                       </div>
                       <div>
                         <h3 className="font-bold text-gray-800">AI Clinical Coach</h3>
                         <p className="text-xs text-gray-500">Powered by Gemini</p>
                       </div>
                    </header>
                    <div ref={chatHistoryRef} className="flex-1 p-4 overflow-y-auto space-y-4">
                        {messages.map((msg, index) => (
                            <div key={index} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                {msg.role === 'assistant' && <Bot className="w-6 h-6 text-indigo-500 flex-shrink-0" />}
                                <div className={`max-w-[80%] p-3 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`}>
                                    {msg.text}
                                </div>
                                {msg.role === 'user' && <User className="w-6 h-6 text-gray-400 flex-shrink-0" />}
                            </div>
                        ))}
                        {isLoading && (
                             <div className="flex gap-3 justify-start">
                                <Bot className="w-6 h-6 text-indigo-500 flex-shrink-0" />
                                <div className="max-w-[80%] p-3 rounded-2xl bg-gray-200 text-gray-800 rounded-bl-none">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.2s]"></div>
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.4s]"></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    <footer className="p-4 border-t border-gray-200">
                        <div className="flex items-center gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Ask a question..."
                                className="flex-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                            <button onClick={handleSend} disabled={isLoading} className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">
                                <Send className="w-5 h-5" />
                            </button>
                        </div>
                    </footer>
                </div>
            )}
        </>
    );
};


// --- Main App Component ---
export default function App() {
    const [currentModuleId, setCurrentModuleId] = useState(null);
    const [userId, setUserId] = useState(null);
    const [progress, setProgress] = useState({});
    const [isAuthReady, setIsAuthReady] = useState(false);

    // One-time Firebase initialization and Auth listening
    useEffect(() => {
        if (!db || !auth) {
            console.error("Firebase services not available.");
            return;
        }

        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                     } else {
                        await signInAnonymously(auth);
                     }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            }
            setIsAuthReady(true);
        });
        return () => unsubscribe();
    }, []);

    // Effect for fetching and listening to progress data from Firestore
    useEffect(() => {
        if (!isAuthReady || !userId) return;

        const docRef = doc(db, 'artifacts', appId, 'users', userId);
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                setProgress(docSnap.data().progress || {});
            } else {
                console.log("No progress document found for user. Creating one.");
                setDoc(docRef, { progress: {} });
            }
        }, (error) => {
            console.error("Error listening to progress updates:", error);
        });

        return () => unsubscribe();
    }, [isAuthReady, userId]);

    const handleProgressUpdate = useCallback(async (moduleId, stepId, completed) => {
        if (!isAuthReady || !userId) {
            console.log("Auth not ready or no user ID, cannot update progress.");
            return;
        }
        
        const docRef = doc(db, 'artifacts', appId, 'users', userId);
        
        try {
            const docSnap = await getDoc(docRef);
            const currentProgress = docSnap.exists() ? docSnap.data().progress : {};
            
            // Prevent unnecessary writes if already completed
            if(currentProgress[moduleId]?.[stepId]?.completed) return;

            const newProgress = {
                ...currentProgress,
                [moduleId]: {
                    ...(currentProgress[moduleId] || {}),
                    [stepId]: { completed: completed }
                }
            };
            
            await setDoc(docRef, { progress: newProgress }, { merge: true });
            
        } catch (error) {
            console.error("Error updating progress in Firestore:", error);
        }
    }, [isAuthReady, userId]);

    if (!isAuthReady) {
        return (
            <div className="w-full h-screen flex items-center justify-center bg-gray-100">
                <div className="flex flex-col items-center">
                    <Layers className="w-12 h-12 text-indigo-500 animate-pulse mb-4"/>
                    <p className="text-gray-600">Initializing MindPath...</p>
                </div>
            </div>
        );
    }
    
    const selectedModule = currentModuleId ? { ...contentData[currentModuleId], id: currentModuleId } : null;

    return (
        <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
            {selectedModule ? (
                <LearningModule
                    module={selectedModule}
                    onBack={() => setCurrentModuleId(null)}
                    progress={progress}
                    onProgressUpdate={handleProgressUpdate}
                />
            ) : (
                <Dashboard onSelectModule={setCurrentModuleId} progress={progress} />
            )}
            <ClinicalCoach userId={userId} />
        </div>
    );
}
