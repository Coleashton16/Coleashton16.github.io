<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diuretics Learning Module</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration to use the Inter font.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- React and Library Setup ---
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup for Standalone Demo ---
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                setTimeout(() => callback({ uid: 'standalone-diuretics-user' }), 100);
                return () => {};
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-diuretics-user' } }),
        };

        // --- Content & Data Structure for the Learning Modules ---
        const contentData = {
            'intro-diuretics': {
                title: 'Introduction to Diuretics',
                color: 'from-sky-500 to-cyan-400',
                description: 'Understand the purpose, mechanisms, and classifications of diuretics.',
                steps: [
                    { id: 'diuretics-purpose', title: 'Purpose of Diuretics', type: 'text', content: `<strong>Diuretics</strong> are primarily used to:
                        <ul>
                            <li>Decrease <strong>hypertension</strong> (lower blood pressure, >120/80 mm Hg).</li>
                            <li>Decrease <strong>edema</strong> (peripheral and pulmonary) in heart failure (HF) and renal or liver disorders.</li>
                        </ul>
                        They can be used alone or in combination.` },
                    { id: 'diuretics-mechanism', title: 'Mechanism of Action', type: 'text', content: `Diuretics increase <strong>urine flow (diuresis)</strong> by inhibiting <strong>sodium and water reabsorption</strong> from the kidney tubules.
                        <br><br>Most sodium and water reabsorption occurs throughout the renal tubular segments:
                        <ul>
                            <li>Proximal tubules</li>
                            <li>Loop of Henle (descending and ascending)</li>
                            <li>Collecting tubule</li>
                        </ul>
                        Diuretics can affect one or more segments. The total volume of the body’s extracellular fluid (ECF) is filtered through the kidneys (glomeruli) every 1.5 hours for cleansing. Small particles (electrolytes, drugs, glucose, waste products) are filtered. Larger products (protein, blood cells) are not normally filtered.<br><br>Normally, 99% of filtered sodium is reabsorbed. Diuretics acting on tubules closest to the glomeruli (e.g., osmotic diuretics like mannitol) have the greatest effect in causing <strong>natriuresis</strong> (sodium loss in urine). The diuretic effect depends on the drug reaching the kidneys and its concentration in the renal tubules.` },
                    { id: 'diuretics-effects', title: 'Antihypertensive & Electrolyte Effects', type: 'text', content: `Diuretics have an <strong>antihypertensive effect</strong> by promoting sodium and water loss (blocking reabsorption of sodium and chloride). This decreases fluid volume, lowering blood pressure. With fluid loss, <strong>edema</strong> (fluid retention) should decrease. If sodium is retained, water is also retained, increasing blood pressure.
                        <br><br>Many diuretics cause the loss of other electrolytes, including <strong>potassium, magnesium, chloride, and bicarbonate</strong>.
                        <ul>
                            <li><strong>Potassium-wasting diuretics:</strong> Promote potassium excretion.</li>
                            <li><strong>Potassium-sparing diuretics:</strong> Promote potassium retention.</li>
                        </ul>
                        The five categories of diuretics are:
                        <ul>
                            <li>Thiazide and thiazide-like diuretics</li>
                            <li>Loop diuretics</li>
                            <li>Osmotic diuretics</li>
                            <li>Carbonic anhydrase inhibitors</li>
                            <li>Potassium-sparing diuretics</li>
                        </ul>
                        Thiazide, loop, and potassium-sparing diuretics are most frequently prescribed for hypertension and edema associated with HF. Except for potassium-sparing diuretics, all are potassium wasting. Combination diuretics (potassium-wasting + potassium-sparing) are marketed for hypertension, providing an additive effect in reducing blood pressure and preventing potassium loss.` },
                    { id: 'intro-diuretics-quiz', title: 'Introduction Quiz', type: 'quiz',
                      questions: [
                          { question: "What are the two main purposes for which diuretics are used?", options: ["To increase blood sugar and decrease inflammation", "To decrease hypertension and decrease edema", "To increase heart rate and improve digestion", "To decrease pain and promote sleep"], correctAnswer: "To decrease hypertension and decrease edema" },
                          { question: "By what primary mechanism do diuretics produce increased urine flow?", options: ["Increasing glucose absorption from tubules", "Inhibiting sodium and water reabsorption from kidney tubules", "Promoting protein and blood cell filtration in glomeruli", "Decreasing blood flow to the kidneys"], correctAnswer: "Inhibiting sodium and water reabsorption from kidney tubules" },
                          { question: "Which type of diuretic is known for promoting potassium retention?", options: ["Thiazide diuretics", "Loop diuretics", "Osmotic diuretics", "Potassium-sparing diuretics"], correctAnswer: "Potassium-sparing diuretics" }
                      ]
                    }
                ]
            },
            'thiazide-diuretics': {
                title: 'Thiazide and Thiazide-Like Diuretics',
                color: 'from-green-500 to-lime-400',
                description: 'Explore the actions, uses, side effects, and nursing process for thiazide diuretics.',
                steps: [
                    { id: 'thiazides-actions-uses', title: 'Actions and Uses', type: 'text', content: `<strong>Thiazide and Thiazide-Like Diuretics</strong> (e.g., chlorothiazide, hydrochlorothiazide) act on the <strong>distal convoluted renal tubule</strong> to promote sodium, chloride, and water excretion.
                        <ul>
                            <li>Used for <strong>hypertension</strong> and <strong>peripheral edema</strong>.</li>
                            <li>Not effective for immediate diuresis.</li>
                            <li>Should not be used in patients with severe renal dysfunction (creatinine clearance less than 30 mL/min), as effectiveness is greatly decreased.</li>
                            <li>Primarily used for patients with normal renal function.</li>
                        </ul>` },
                    { id: 'thiazides-side-effects', title: 'Side Effects & Adverse Reactions', type: 'text', content: `Thiazides cause a loss of <strong>sodium, potassium, and magnesium</strong>, but they promote <strong>calcium reabsorption</strong>.
                        <ul>
                            <li><strong>Electrolyte imbalances:</strong> Hypokalemia, hypercalcemia, hypomagnesemia, hypochloremia.</li>
                            <li><strong>Hyperglycemia:</strong> Affects glucose tolerance, use cautiously in diabetic patients.</li>
                            <li><strong>Hyperuricemia:</strong> Elevated serum uric acid level (thiazides block uric acid excretion).</li>
                            <li><strong>Hyperlipidemia:</strong> Elevated blood lipid levels (cholesterol, LDL, triglycerides).</li>
                            <li>Other side effects: Dizziness, headache, nausea, vomiting, constipation, photosensitivity, blood dyscrasias (rare).</li>
                        </ul>
                        <br>
                        <strong>Contraindications:</strong> Renal failure (oliguria, elevated BUN, elevated serum creatinine).
                        <br><br>
                        <strong>Drug Interactions:</strong>
                        <ul>
                            <li><strong>Digoxin:</strong> Hypokalemia (and hypercalcemia) caused by thiazides enhances digoxin action, risking digitalis toxicity. Potassium supplements and monitoring are often needed.</li>
                            <li><strong>Lithium:</strong> Thiazides enhance lithium action, risking lithium toxicity.</li>
                            <li><strong>Other antihypertensives:</strong> Thiazides potentiate their action (can be beneficial in combination therapy).</li>
                            <li><strong>NSAIDs, cholestyramine, colestipol:</strong> Decrease thiazide absorption and effects.</li>
                        </ul>
                        <strong>Herbal Interactions:</strong> Aloe (decreases serum potassium), Ginkgo (increases BP), Licorice (increases potassium loss), Hawthorn (potentiates hypotension).` },
                    { id: 'thiazides-np', title: 'Thiazides: Nursing Process', type: 'text', content: `<strong>Concept: Elimination</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        <ul>
                            <li>Assess vital signs, weight, urine output, and serum chemistry (electrolytes, glucose, uric acid) for baseline.</li>
                            <li>Check peripheral extremities for edema (pitting edema).</li>
                            <li>Obtain drug and herbal history for interactions (digoxin, corticosteroids, antidiabetics, ginkgo, licorice).</li>
                        </ul>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Disrupted fluid and electrolyte imbalance, fluid overload, hypokalemia, hypernatremia.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient's BP will decrease, edema will decrease, serum chemistry will remain normal.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        <ul>
                            <li>Monitor vital signs and serum electrolytes (potassium, glucose, uric acid, cholesterol). Report changes.</li>
                            <li>Observe for signs of hypokalemia (muscle weakness, leg cramps, cardiac dysrhythmias).</li>
                            <li>Monitor weight daily (2.2 lb gain = 1 L fluid gain).</li>
                            <li>Note urine output.</li>
                            <li>Observe for hyperglycemia.</li>
                        </ul>
                        <strong>Patient Teaching:</strong>
                        <ul>
                            <li><strong>General:</strong> Adherence is key; take drug early morning to avoid nocturia; keep out of reach of children; inform about herbal interactions.</li>
                            <li><strong>Self-Administration:</strong> Teach how to take and record BP.</li>
                            <li><strong>Side Effects:</strong> Change positions slowly (orthostatic hypotension); have blood glucose checked periodically if prediabetic; use sunblock for photosensitivity.</li>
                            <li><strong>Diet:</strong> Eat potassium-rich foods (fruits, juices, vegetables); take drugs with food to avoid GI upset.</li>
                        </ul>
                        <strong>Evaluate Outcomes (Evaluation):</strong> Evaluate decreased BP and edema, normal blood chemistry, absence of side effects.` },
                    { id: 'thiazides-quiz', title: 'Thiazide Diuretics Quiz', type: 'quiz',
                      questions: [
                          { question: "On which part of the renal tubule do thiazide diuretics primarily act?", options: ["Proximal tubule", "Loop of Henle", "Distal convoluted tubule", "Collecting duct"], correctAnswer: "Distal convoluted tubule" },
                          { question: "Which electrolyte imbalance is a common side effect of thiazide diuretics due to their mechanism of action?", options: ["Hyperkalemia", "Hypocalcemia", "Hypomagnesemia", "Hypernatremia"], correctAnswer: "Hypomagnesemia" },
                          { question: "A patient taking hydrochlorothiazide is also on digoxin. What is the nurse's primary concern regarding this drug interaction?", options: ["Increased risk of hypertension", "Decreased effectiveness of digoxin", "Increased risk of digitalis toxicity due to hypokalemia", "Reduced absorption of hydrochlorothiazide"], correctAnswer: "Increased risk of digitalis toxicity due to hypokalemia" },
                          { question: "Which patient teaching point is crucial for a patient taking a thiazide diuretic?", options: ["Take the medication at bedtime for best results.", "Increase salt intake to prevent hypotension.", "Report any signs of photosensitivity to the healthcare provider.", "Consume a low-potassium diet to avoid hyperkalemia."], correctAnswer: "Report any signs of photosensitivity to the healthcare provider." }
                      ]
                    }
                ]
            },
            'loop-diuretics': {
                title: 'Loop Diuretics',
                color: 'from-purple-500 to-pink-500',
                description: 'Learn about the potent actions, uses, and nursing considerations for loop diuretics.',
                steps: [
                    { id: 'loop-actions-uses', title: 'Actions and Uses', type: 'text', content: `<strong>Loop Diuretics</strong> (e.g., furosemide, bumetanide, torsemide) act on the <strong>thick ascending loop of Henle</strong>. They inhibit chloride transport of sodium into the circulation and inhibit passive reabsorption of sodium.
                        <ul>
                            <li>Cause marked depletion of water and electrolytes (sodium, potassium, calcium, magnesium).</li>
                            <li>Extremely potent, with dose-related effects (increasing dose increases effect).</li>
                            <li>More potent than thiazides for promoting diuresis (inhibiting sodium reabsorption 2-3 times more effectively).</li>
                            <li>Less effective as antihypertensive agents compared to diuresis.</li>
                            <li>Can increase renal blood flow up to 40%.</li>
                            <li>Furosemide is often prescribed for patients with creatinine clearance less than 30 mL/min or end-stage renal disease.</li>
                            <li>Cause excretion of calcium (unlike thiazides, which inhibit calcium loss).</li>
                        </ul>
                        <br>
                        Furosemide is used when immediate diuresis is needed (e.g., acute HF, pulmonary edema) or when less potent diuretics fail. Oral dose is usually twice the IV dose. Ethacrynic acid is reserved for patients allergic to sulfa drugs.` },
                    { id: 'loop-pharmacokinetics-dynamics', title: 'Pharmacokinetics & Pharmacodynamics', type: 'text', content: `<strong>Pharmacokinetics:</strong>
                        <ul>
                            <li>Rapidly absorbed by GI tract (furosemide can be erratic).</li>
                            <li>Highly protein bound (approx. 95%), competing with other protein-bound drugs.</li>
                            <li>Half-lives vary from 0.5 to 5 hours (shorter than thiazides).</li>
                        </ul>
                        <strong>Pharmacodynamics:</strong>
                        <ul>
                            <li>Great <strong>saluretic (sodium chloride-losing) or natriuretic (sodium-losing) effect</strong>.</li>
                            <li>Cause rapid diuresis, decreasing vascular fluid volume, cardiac output, and blood pressure.</li>
                            <li>Furosemide has a vasodilatory effect, increasing renal blood flow before diuresis.</li>
                            <li>Onset of action: 30-60 minutes orally; 5 minutes IV.</li>
                            <li>Duration of action: Shorter than thiazides.</li>
                        </ul>`},
                    { id: 'loop-side-effects', title: 'Side Effects & Adverse Reactions', type: 'text', content: `Most common side effects are <strong>fluid and electrolyte imbalances</strong>:
                        <ul>
                            <li>Hypokalemia, hyponatremia, hypocalcemia, hypomagnesemia, hypochloremia.</li>
                            <li>Hypochloremic metabolic alkalosis may result, worsening hypokalemia.</li>
                            <li><strong>Orthostatic hypotension</strong> can occur.</li>
                            <li><strong>Ototoxicity:</strong> Hearing impairment (rare, more common with ethacrynic acid).</li>
                            <li><strong>Hyperglycemia</strong> (increased glycogenolysis).</li>
                            <li><strong>Hyperuricemia</strong> (elevated uric acid).</li>
                            <li>Elevated BUN and creatinine (from ECFV loss, reversible).</li>
                            <li>Elevated lipids (decreased HDL, increased LDL).</li>
                            <li>Rare: Thrombocytopenia, leukopenia, skin disturbances (pruritus, urticaria, exfoliative dermatitis, purpura), photosensitivity.</li>
                        </ul>
                        <br>
                        <strong>Drug Interactions:</strong>
                        <ul>
                            <li><strong>Digitalis preparations (digoxin):</strong> Major interaction. Hypokalemia from loop diuretics enhances digoxin action, risking digitalis toxicity. Potassium replacement is needed.</li>
                            <li><strong>Aminoglycosides:</strong> Increased ototoxicity.</li>
                            <li><strong>Anticoagulants:</strong> Increased bleeding.</li>
                            <li><strong>Corticosteroids, Amphotericin B, Amiodarone:</strong> Increased potassium loss.</li>
                            <li><strong>Lithium:</strong> Increased lithium toxicity.</li>
                        </ul>
                        <strong>Herbal Interactions:</strong> Hawthorn (potentiates hypotension), Ginseng (may decrease action of loop diuretics).` },
                    { id: 'loop-np', title: 'Loop Diuretics: Nursing Process', type: 'text', content: `<strong>Concept: Elimination</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        <ul>
                            <li>Obtain history of daily drugs (alcohol, aminoglycosides, anticoagulants, corticosteroids, lithium, amphotericin B, digitalis). Note if furosemide is highly protein bound and can displace other protein-bound drugs (e.g., warfarin).</li>
                            <li>Assess vital signs, serum electrolytes, weight, and urine output for baseline.</li>
                            <li>Compare drug dose with recommended dose.</li>
                            <li>Note hypersensitivity to sulfonamides.</li>
                        </ul>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Disrupted fluid and electrolyte imbalance, fluid overload, hypokalemia, hypernatremia.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient's edema/BP will reduce, serum chemistry will normalize.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        <ul>
                            <li>Monitor urinary output (at least 30 mL/h or 600 mL/24h). Notify provider if output doesn't increase.</li>
                            <li>Weigh patient daily (same time, same clothing; 2.2 lb loss = 1 L fluid loss).</li>
                            <li>Monitor vital signs for marked BP decreases.</li>
                            <li>Administer IV furosemide slowly (rapid injection can cause hearing loss).</li>
                            <li>Observe for signs of hypokalemia (<3.5 mEq/L): muscle weakness, abdominal distension, leg cramps, cardiac dysrhythmias.</li>
                            <li>Monitor serum potassium levels, especially with digoxin (hypokalemia enhances digitalis action, causing toxicity).</li>
                        </ul>
                        <strong>Patient Teaching:</strong>
                        <ul>
                            <li>Take furosemide in the morning to prevent nocturia.</li>
                            <li>Rise slowly from lying/sitting to standing (prevent dizziness/orthostatic hypotension).</li>
                            <li>Take with food to avoid nausea.</li>
                            <li>Request childproof bottle if children are around.</li>
                        </ul>
                        <strong>Evaluate Outcomes (Evaluation):</strong> Evaluate decreased fluid retention/overload, decreased respiratory distress, increased cardiac output, check for side effects and increased urine output.` },
                    { id: 'loop-diuretics-quiz', title: 'Loop Diuretics Quiz', type: 'quiz',
                      questions: [
                          { question: "A patient with acute heart failure needs rapid diuresis. Which type of diuretic would the nurse anticipate administering?", options: ["Thiazide diuretic", "Potassium-sparing diuretic", "Loop diuretic", "Carbonic anhydrase inhibitor"], correctAnswer: "Loop diuretic" },
                          { question: "Which of the following is a common adverse effect associated with rapid IV administration of furosemide?", options: ["Hyperkalemia", "Hyperglycemia", "Hearing loss", "Hypertension"], correctAnswer: "Hearing loss" },
                          { question: "A nurse is monitoring a patient on a loop diuretic. Which laboratory value is most critical to assess for potential drug toxicity, especially if the patient is also on digoxin?", options: ["Serum sodium", "Serum calcium", "Serum potassium", "Serum magnesium"], correctAnswer: "Serum potassium" },
                          { question: "Loop diuretics are effective in patients with renal dysfunction because they can increase renal blood flow up to what percentage?", options: ["10%", "20%", "40%", "60%"], correctAnswer: "40%" }
                      ]
                    }
                ]
            },
            'other-diuretics': {
                title: 'Other Diuretics: Osmotic, Carbonic Anhydrase, Potassium-Sparing',
                color: 'from-blue-400 to-indigo-600',
                description: 'Explore the mechanisms, uses, and nursing considerations for less common but important diuretic classes.',
                steps: [
                    { id: 'osmotic-diuretics', title: 'Osmotic Diuretics', type: 'text', content: `<strong>Osmotic Diuretics</strong> (e.g., mannitol, urea) increase osmolality (concentration) and sodium reabsorption in the proximal tubule and loop of Henle. This results in excretion of sodium, chloride, potassium (lesser degree), and water.
                        <ul>
                            <li>Used to decrease <strong>intracranial pressure (ICP)</strong> in cerebral edema.</li>
                            <li>Decrease <strong>intraocular pressure (IOP)</strong> in glaucoma.</li>
                            <li>Promote excretion of toxic substances.</li>
                            <li>Mannitol is potent, potassium-wasting, and used in emergencies for ICP/IOP.</li>
                            <li>Can be used with cisplatin/carboplatin in chemotherapy to induce diuresis and decrease side effects.</li>
                            <li>Given IV; diuresis occurs within 1-3 hours.</li>
                        </ul>
                        <br>
                        <strong>Side Effects:</strong> Fluid/electrolyte imbalance, pulmonary edema (from rapid fluid shift), nausea, vomiting, tachycardia (from rapid fluid loss), acidosis.
                        <br>
                        <strong>Caution:</strong> Mannitol crystals may form in vial at low temperatures; warm to dissolve. Do not use if crystals persist. Administer with extreme caution in heart disease/HF; discontinue immediately if HF or renal failure develops.` },
                    { id: 'carbonic-anhydrase-inhibitors', title: 'Carbonic Anhydrase Inhibitors', type: 'text', content: `<strong>Carbonic Anhydrase Inhibitors</strong> (e.g., acetazolamide) block the enzyme carbonic anhydrase, which is essential for acid-base balance (hydrogen and bicarbonate ion balance).
                        <ul>
                            <li>Inhibition causes increased sodium, potassium, and bicarbonate excretion.</li>
                            <li>Prolonged use can lead to <strong>metabolic acidosis</strong>.</li>
                            <li>Primarily used to decrease <strong>IOP in open-angle (chronic) glaucoma</strong>.</li>
                            <li>Other uses: diuresis, epilepsy management, high-altitude/acute mountain sickness.</li>
                            <li>Can be used for patients in metabolic alkalosis needing a diuretic, sometimes alternated with loop diuretics.</li>
                        </ul>
                        <br>
                        <strong>Side Effects:</strong> Fluid/electrolyte imbalance, metabolic acidosis, nausea, vomiting, anorexia, confusion, orthostatic hypotension, crystalluria.
                        <br>
                        <strong>Adverse Reactions:</strong> Hemolytic anemia, renal calculi.
                        <br>
                        <strong>Contraindicated:</strong> First trimester of pregnancy.` },
                    { id: 'potassium-sparing-diuretics', title: 'Potassium-Sparing Diuretics: Actions & Uses', type: 'text', content: `<strong>Potassium-Sparing Diuretics</strong> (e.g., spironolactone, amiloride, triamterene, eplerenone) are weaker than thiazides/loop diuretics. They are used as mild diuretics or in combination with other diuretics (e.g., hydrochlorothiazide) or antihypertensives.
                        <ul>
                            <li>Promote sodium and water excretion, and <strong>potassium retention</strong>.</li>
                            <li>Act primarily in the <strong>collecting duct renal tubules and late distal tubule</strong>.</li>
                            <li>Interfere with the sodium-potassium pump controlled by aldosterone.</li>
                            <li><strong>Spironolactone</strong> is an <strong>aldosterone antagonist</strong>; it blocks aldosterone's action, inhibiting the sodium-potassium pump (potassium retained, sodium excreted). Cardiologists prescribe it for cardiac disorders due to its potassium-retaining effect (regular heart rate, decreased myocardial fibrosis). Effects may take 48 hours.</li>
                            <li>Amiloride and eplerenone are effective antihypertensive agents. Triamterene treats edema from HF or liver cirrhosis.</li>
                            <li>Low doses of spironolactone and eplerenone are effective for chronic HF.</li>
                        </ul>
                        <br>
                        <strong>Combinations:</strong> Often combined with potassium-wasting diuretics (e.g., hydrochlorothiazide) to intensify diuretic effect and prevent potassium loss (e.g., spironolactone/HCTZ, amiloride/HCTZ, triamterene/HCTZ).` },
                    { id: 'potassium-sparing-side-effects', title: 'Potassium-Sparing Diuretics: Side Effects', type: 'text', content: `The main side effect is <strong>hyperkalemia</strong> (serum potassium >5.0 mEq/L).
                        <ul>
                            <li><strong>Caution:</strong> Use with poor renal function (kidneys excrete 80-90% of potassium); urine output should be at least 600 mL/day.</li>
                            <li><strong>Potassium supplements:</strong> NOT used with potassium-sparing diuretics, unless serum potassium is low.</li>
                            <li><strong>ACE inhibitors/ARBs:</strong> Co-administration can cause severe/life-threatening hyperkalemia, as both drug classes retain potassium. Monitoring serum potassium is essential.</li>
                            <li>Other side effects: Headache, dizziness, asthenia (weakness), GI disturbances (anorexia, nausea, vomiting, diarrhea), hyperuricemia, muscle cramps, paresthesia.</li>
                        </ul>` },
                    { id: 'potassium-sparing-np', title: 'Potassium-Sparing Diuretics: Nursing Process', type: 'text', content: `<strong>Concept: Elimination</strong><br>
                        <strong>Recognize Cues (Assessment):</strong>
                        <ul>
                            <li>Obtain history of drugs (potassium supplements, salt substitutes).</li>
                            <li>Assess vital signs, serum electrolytes, weight, and urinary output for baseline.</li>
                            <li>Compare drug dose with recommended dose.</li>
                        </ul>
                        <strong>Analyze Cues and Prioritize Hypothesis (Patient Problems):</strong> Fluid overload, hyperkalemia, diarrhea, nausea.<br>
                        <strong>Generate Solutions (Planning):</strong> Patient's BP will decrease, serum electrolytes will remain normal.<br>
                        <strong>Take Action (Nursing Interventions):</strong>
                        <ul>
                            <li>Monitor urinary output (should increase; report <30 mL/h or <600 mL/day).</li>
                            <li>Weigh patient daily (same time, same clothing; 2.2 lb loss = 1 L fluid loss).</li>
                            <li>Record vital signs; report abnormal changes.</li>
                            <li>Observe for signs of <strong>hyperkalemia</strong> (>5.0 mEq/L): nausea, diarrhea, abdominal cramps, numbness/tingling of hands/feet, leg cramps, tachycardia (later bradycardia), peaked narrow T waves on ECG, oliguria.</li>
                            <li>Administer in the morning to avoid nocturia.</li>
                        </ul>
                        <strong>Patient Teaching:</strong>
                        <ul>
                            <li>Take with or after meals to avoid nausea.</li>
                            <li>Do not discontinue without consulting provider.</li>
                            <li>Avoid direct sun exposure (photosensitivity).</li>
                            <li>Report side effects (rash, dizziness, weakness, GI upset).</li>
                            <li>Avoid potassium-rich foods if serum potassium is high.</li>
                        </ul>
                        <strong>Evaluate Outcomes (Evaluation):</strong> Evaluate decreased/absent edema, increased urine output, normal serum potassium level.` },
                    { id: 'other-diuretics-quiz', title: 'Other Diuretics Quiz', type: 'quiz',
                      questions: [
                          { question: "Which diuretic class is primarily used to decrease intracranial pressure (ICP) and intraocular pressure (IOP)?", options: ["Loop diuretics", "Thiazide diuretics", "Osmotic diuretics", "Potassium-sparing diuretics"], correctAnswer: "Osmotic diuretics" },
                          { question: "A patient taking acetazolamide for glaucoma should be monitored for which potential electrolyte imbalance due to its mechanism of action?", options: ["Hyperkalemia", "Hypocalcemia", "Hypermagnesemia", "Hypokalemia"], correctAnswer: "Hypokalemia" },
                          { question: "What is the primary concern when a patient taking a potassium-sparing diuretic also takes an ACE inhibitor?", options: ["Increased risk of hypokalemia", "Increased risk of digitalis toxicity", "Increased risk of severe hyperkalemia", "Decreased diuretic effectiveness"], correctAnswer: "Increased risk of severe hyperkalemia" },
                          { question: "Spironolactone is unique among diuretics as it is an antagonist to which hormone?", options: ["Antidiuretic hormone (ADH)", "Aldosterone", "Renin", "Angiotensin II"], correctAnswer: "Aldosterone" }
                      ]
                    }
                ]
            },
            'chapter-review': {
                title: 'Chapter Review & NCLEX Questions',
                color: 'from-blue-600 to-indigo-800',
                description: 'Integrate knowledge and practice NCLEX-style review questions for Chapter 41.',
                steps: [
                    { id: 'critical-thinking-case-study', title: 'Critical Thinking Case Study', type: 'case_study', case: {
                        scenario: `A 58-year-old patient has been recently diagnosed with hypertension. His resting blood pressure is 158/92. He is prescribed hydrochlorothiazide 50 mg/day and is told to eat foods rich in potassium.`,
                        question: `Which nursing actions are required related to the client’s condition and prescribed medication? Choose the most likely options for the information missing from the statements below by selecting from the lists of options provided.
                            After 1 month on hydrochlorothiazide therapy, the patient becomes weak and complains of nausea and vomiting. His muscles are “soft,” and his serum potassium level is 3.3 mEq/L. The patient’s diuretic is changed to triamterene and hydrochlorothiazide. Again, he is advised to eat foods rich in potassium.
                            <br><br>
                            1. How does hydrochlorothiazide differ from furosemide? What are their similarities and differences?
                            <br>
                            2. Why is it necessary for the patient to eat foods rich in potassium when taking hydrochlorothiazide? Explain your answer.
                            <br>
                            3. What nursing interventions should be considered while the patient takes hydrochlorothiazide?
                            <br>
                            4. Explain the rationale for changing the patient’s diuretic.
                            <br>
                            5. Should the patient receive a potassium supplement? Explain your answer.
                            <br>
                            6. What nursing interventions should the nurse follow for the patient?
                            <br>
                            7. What care plan should the nurse develop for the patient in relation to patient teaching?
                            <br>
                            8. What medical follow-up care is needed for the patient?
                        `,
                        options: [
                             // These options are placeholders. For a 'case_study' type, you'd typically have specific multiple choice options here.
                             // Given the format of the original case study questions, these are open-ended for discussion.
                             // The system will just render the questions.
                             "This is a discussion-based case study, not multiple choice."
                        ],
                        correctAnswer: ["This is a discussion-based case study, not multiple choice."], // Placeholder to satisfy structure
                        explanation: `This is a multi-part, open-ended case study designed for critical thinking and discussion. Here are the rationales for each question based on Chapter 41 content:
                        <br><br>
                        <strong>1. How does hydrochlorothiazide differ from furosemide? What are their similarities and differences?</strong>
                        <br>
                        <br><strong>Similarities:</strong> Both are diuretics used to treat hypertension and edema, and both are potassium-wasting.
                        <br><strong>Differences:</strong>
                        <ul>
                            <li><strong>Site of Action:</strong> Hydrochlorothiazide (thiazide) acts on the distal convoluted tubule; Furosemide (loop) acts on the thick ascending loop of Henle.</li>
                            <li><strong>Potency & Diuresis:</strong> Furosemide is much more potent, causing rapid and marked diuresis. Hydrochlorothiazide is less potent for diuresis.</li>
                            <li><strong>Renal Function:</strong> Furosemide is effective even with severe renal dysfunction (creatinine clearance <30 mL/min), whereas hydrochlorothiazide's effectiveness is greatly decreased or lost in such cases.</li>
                            <li><strong>Calcium Excretion:</strong> Furosemide causes calcium excretion, while hydrochlorothiazide promotes calcium reabsorption.</li>
                            <li><strong>Onset/Duration:</strong> Furosemide generally has a faster onset and shorter duration (especially IV) than hydrochlorothiazide.</li>
                        </ul>
                        <br>
                        <strong>2. Why is it necessary for the patient to eat foods rich in potassium when taking hydrochlorothiazide? Explain your answer.</strong>
                        <br>
                        Hydrochlorothiazide is a **potassium-wasting diuretic**. It increases the excretion of potassium from the body. If the patient does not consume enough potassium through diet or supplements, they risk developing **hypokalemia** (low serum potassium levels). Hypokalemia can lead to symptoms like muscle weakness, leg cramps, fatigue, and potentially life-threatening cardiac dysrhythmias.
                        <br><br>
                        <strong>3. What nursing interventions should be considered while the patient takes hydrochlorothiazide?</strong>
                        <br>
                        * **Monitor Vital Signs:** Especially blood pressure (for hypotension) and heart rate.
                        * **Monitor Electrolytes:** Closely monitor serum potassium, sodium, magnesium, calcium, and uric acid levels. Also, monitor blood glucose levels.
                        * **Assess for Edema:** Check peripheral extremities for presence or reduction of edema.
                        * **Monitor Weight & Urine Output:** Daily weights (same time, same clothing) and monitor urine output to track fluid balance.
                        * **Patient Teaching:** Instruct on slow position changes (orthostatic hypotension), importance of potassium-rich foods, taking medication in the morning, using sunblock, and reporting any side effects like dizziness, nausea, or muscle cramps.
                        * **Drug Interactions:** Be aware of potential interactions, especially with digoxin (increased toxicity risk with hypokalemia).
                        <br><br>
                        <strong>4. Explain the rationale for changing the patient’s diuretic.</strong>
                        <br>
                        The patient developed **symptoms of hypokalemia** (weakness, nausea, vomiting, soft muscles) and his serum potassium level dropped to 3.3 mEq/L, which is below the normal range (3.5-5.0 mEq/L). Hydrochlorothiazide, being a potassium-wasting diuretic, was contributing to this. The change to **triamterene and hydrochlorothiazide** (a combination diuretic) is rational because **triamterene is a potassium-sparing diuretic**. This combination helps to maintain serum potassium levels while still providing the diuretic and antihypertensive effects, thus mitigating the risk of hypokalemia caused by the hydrochlorothiazide component.
                        <br><br>
                        <strong>5. Should the patient receive a potassium supplement? Explain your answer.</strong>
                        <br>
                        **No, the patient should generally NOT receive a potassium supplement** when taking a combination of triamterene and hydrochlorothiazide. Triamterene's primary action is to retain potassium. Taking a potassium supplement concurrently with a potassium-sparing diuretic significantly increases the risk of **hyperkalemia** (elevated serum potassium), which can be dangerous and lead to cardiac dysrhythmias. The combination diuretic is designed to balance potassium levels without external supplementation.
                        <br><br>
                        <strong>6. What nursing interventions should the nurse follow for the patient?</strong>
                        <br>
                        * **Monitor for Hyperkalemia:** This is now the primary electrolyte concern. Watch for symptoms like nausea, diarrhea, abdominal cramps, numbness/tingling, leg cramps, tachycardia (then bradycardia), and peaked narrow T waves on ECG. Monitor serum potassium levels frequently.
                        * **Monitor Vital Signs:** Continue to assess BP for effectiveness and hypotension.
                        * **Fluid Balance:** Continue daily weights and monitoring of urine output.
                        * **Medication Administration:** Administer in the morning to prevent nocturia.
                        * **Patient Education:** Reinforce teaching about diet (avoiding high-potassium foods if levels are normal/high), avoiding salt substitutes (many contain potassium), and reporting any signs of hyperkalemia.
                        <br><br>
                        <strong>7. What care plan should the nurse develop for the patient in relation to patient teaching?</strong>
                        <br>
                        * **Medication Adherence:** Emphasize taking the combination diuretic exactly as prescribed, typically in the morning.
                        * **Dietary Management:** Educate on managing potassium intake. Initially, he was told to eat potassium-rich foods, but with the new medication, this advice needs to be *modified*. He should be advised to consume a *balanced* diet and avoid excessive intake of high-potassium foods unless specifically instructed due to low potassium. He should also avoid salt substitutes.
                        * **Signs/Symptoms to Report:** Teach both hypokalemia (less likely with new drug, but still possible with significant fluid loss) and, more importantly, **hyperkalemia** symptoms. Also, teach about orthostatic hypotension (dizziness with position changes) and general side effects like GI upset.
                        * **Self-Monitoring:** Continue teaching on home blood pressure monitoring and daily weights.
                        * **Sun Sensitivity:** Advise use of sunblock for photosensitivity (a general diuretic side effect).
                        <br><br>
                        <strong>8. What medical follow-up care is needed for the patient?</strong>
                        <br>
                        * **Regular Bloodwork:** Consistent monitoring of serum electrolytes (especially potassium), kidney function (BUN, creatinine), blood glucose, and lipid levels to ensure the new diuretic is effective and not causing imbalances.
                        * **Blood Pressure Monitoring:** Regular check-ups with the provider to assess the effectiveness of BP control and to adjust medication dosage as needed.
                        * **Symptom Assessment:** Ongoing assessment of the patient's symptoms (edema, energy levels, absence of muscle weakness/cramps, no new cardiac symptoms) to evaluate overall drug effectiveness and tolerability.
                        * **Lifestyle Management:** Reinforcement of non-pharmacological measures for hypertension (diet, exercise, stress management).`
                    }},
                    { id: 'review-quiz', title: 'Review Questions', type: 'quiz',
                      questions: [
                          { question: "A patient is taking hydrochlorothiazide 50 mg/day and digoxin 0.25 mg/day. The nurse plans to monitor the patient for which potential electrolyte imbalance?", options: ["Hypocalcemia", "Hypokalemia", "Hyperkalemia", "Hypermagnesemia"], correctAnswer: "Hypokalemia" },
                          { question: "The nurse knows that which statement is correct regarding nursing care of a patient receiving hydrochlorothiazide? (Select all that apply.)", options: ["Monitor patients for signs of hypoglycemia.", "Administer ordered potassium supplements.", "Monitor serum potassium and uric acid levels.", "Assess blood pressure before administration.", "Notify the health care provider if a patient has had oliguria for 24 hours.", "Assess for decreased cholesterol and triglyceride levels."], correctAnswer: ["Administer ordered potassium supplements.", "Monitor serum potassium and uric acid levels.", "Assess blood pressure before administration.", "Notify the health care provider if a patient has had oliguria for 24 hours."] },
                          { question: "A patient has heart failure, and a high dose of furosemide is ordered. What suggests a favorable response to furosemide?", options: ["A decrease in level of consciousness occurs, and the patient sleeps more.", "Respiratory rate decreases from 28/min to 20/min, and the depth increases.", "Breath sounds reveal increased congestion and the patient complains of shortness of breath.", "Urine output is 50 mL/4 hours, and intake is 200 milliliters."], correctAnswer: "Respiratory rate decreases from 28/min to 20/min, and the depth increases." },
                          { question: "What does the nurse know to be correct concerning the use of mannitol in patients?", options: ["It decreases intracranial pressure.", "It increases intraocular pressure.", "It causes sodium and potassium retention.", "It causes diuresis in several days."], correctAnswer: "It decreases intracranial pressure." },
                          { question: "What should the nurse do when a patient is taking furosemide?", options: ["Instruct the patient to change positions quickly when getting out of bed.", "Assess blood pressure before administration.", "Administer the drug at bedtime for maximum effectiveness.", "Teach the patient to avoid fruits to prevent hyperkalemia."], correctAnswer: "Assess blood pressure before administration." },
                          { question: "For the patient taking a diuretic, a combination such as triamterene and hydrochlorothiazide may be prescribed. The nurse realizes that this combination is ordered for which purpose?", options: ["To decrease serum potassium level", "To maintain serum potassium level", "To decrease glucose level", "To increase glucose level"], correctAnswer: "To maintain serum potassium level" },
                          { question: "The patient has been receiving spironolactone 50 mg/day for heart failure. The nurse should closely monitor the patient for which condition?", options: ["Hypokalemia", "Hyperkalemia", "Hypoglycemia", "Hypermagnesemia"], correctAnswer: "Hyperkalemia" }
                      ]
                    }
                ]
            }
        };

        // The pre-assessment quiz data now includes questions for all new modules.
        const preAssessmentQuizData = [
            // Questions for Module: Introduction to Diuretics
            { moduleId: 'intro-diuretics', question: "What are the two main purposes for which diuretics are used?", options: ["To increase blood sugar and decrease inflammation", "To decrease hypertension and decrease edema", "To increase heart rate and improve digestion", "To decrease pain and promote sleep"], correctAnswer: "To decrease hypertension and decrease edema" },
            { moduleId: 'intro-diuretics', question: "By what primary mechanism do diuretics produce increased urine flow?", options: ["Increasing glucose absorption from tubules", "Inhibiting sodium and water reabsorption from kidney tubules", "Promoting protein and blood cell filtration in glomeruli", "Decreasing blood flow to the kidneys"], correctAnswer: "Inhibiting sodium and water reabsorption from kidney tubules" },
            { moduleId: 'intro-diuretics', question: "Which type of diuretic is known for promoting potassium retention?", options: ["Thiazide diuretics", "Loop diuretics", "Osmotic diuretics", "Potassium-sparing diuretics"], correctAnswer: "Potassium-sparing diuretics" },

            // Questions for Module: Thiazide and Thiazide-Like Diuretics
            { moduleId: 'thiazide-diuretics', question: "On which part of the renal tubule do thiazide diuretics primarily act?", options: ["Proximal tubule", "Loop of Henle", "Distal convoluted tubule", "Collecting duct"], correctAnswer: "Distal convoluted tubule" },
            { moduleId: 'thiazide-diuretics', question: "Which electrolyte imbalance is a common side effect of thiazide diuretics due to their mechanism of action?", options: ["Hyperkalemia", "Hypocalcemia", "Hypomagnesemia", "Hypernatremia"], correctAnswer: "Hypomagnesemia" },
            { moduleId: 'thiazide-diuretics', question: "A patient taking hydrochlorothiazide is also on digoxin. What is the nurse's primary concern regarding this drug interaction?", options: ["Increased risk of hypertension", "Decreased effectiveness of digoxin", "Increased risk of digitalis toxicity due to hypokalemia", "Reduced absorption of hydrochlorothiazide"], correctAnswer: "Increased risk of digitalis toxicity due to hypokalemia" },
            { moduleId: 'thiazide-diuretics', question: "Which patient teaching point is crucial for a patient taking a thiazide diuretic?", options: ["Take the medication at bedtime for best results.", "Increase salt intake to prevent hypotension.", "Report any signs of photosensitivity to the healthcare provider.", "Consume a low-potassium diet to avoid hyperkalemia."], correctAnswer: "Report any signs of photosensitivity to the healthcare provider." },

            // Questions for Module: Loop Diuretics
            { moduleId: 'loop-diuretics', question: "A patient with acute heart failure needs rapid diuresis. Which type of diuretic would the nurse anticipate administering?", options: ["Thiazide diuretic", "Potassium-sparing diuretic", "Loop diuretic", "Carbonic anhydrase inhibitor"], correctAnswer: "Loop diuretic" },
            { moduleId: 'loop-diuretics', question: "Which of the following is a common adverse effect associated with rapid IV administration of furosemide?", options: ["Hyperkalemia", "Hyperglycemia", "Hearing loss", "Hypertension"], correctAnswer: "Hearing loss" },
            { moduleId: 'loop-diuretics', question: "A nurse is monitoring a patient on a loop diuretic. Which laboratory value is most critical to assess for potential drug toxicity, especially if the patient is also on digoxin?", options: ["Serum sodium", "Serum calcium", "Serum potassium", "Serum magnesium"], correctAnswer: "Serum potassium" },
            { moduleId: 'loop-diuretics', question: "Loop diuretics are effective in patients with renal dysfunction because they can increase renal blood flow up to what percentage?", options: ["10%", "20%", "40%", "60%"], correctAnswer: "40%" },

            // Questions for Module: Other Diuretics: Osmotic, Carbonic Anhydrase, Potassium-Sparing
            { moduleId: 'other-diuretics', question: "Which diuretic class is primarily used to decrease intracranial pressure (ICP) and intraocular pressure (IOP)?", options: ["Loop diuretics", "Thiazide diuretics", "Osmotic diuretics", "Potassium-sparing diuretics"], correctAnswer: "Osmotic diuretics" },
            { moduleId: 'other-diuretics', question: "A patient taking acetazolamide for glaucoma should be monitored for which potential electrolyte imbalance due to its mechanism of action?", options: ["Hyperkalemia", "Hypocalcemia", "Hypermagnesemia", "Hypokalemia"], correctAnswer: "Hypokalemia" },
            { moduleId: 'other-diuretics', question: "What is the primary concern when a patient taking a potassium-sparing diuretic also takes an ACE inhibitor?", options: ["Increased risk of hypokalemia", "Increased risk of digitalis toxicity", "Increased risk of severe hyperkalemia", "Decreased diuretic effectiveness"], correctAnswer: "Increased risk of severe hyperkalemia" },
            { moduleId: 'other-diuretics', question: "Spironolactone is unique among diuretics as it is an antagonist to which hormone?", options: ["Antidiuretic hormone (ADH)", "Aldosterone", "Renin", "Angiotensin II"], correctAnswer: "Aldosterone" },

            // Questions for Chapter Review & NCLEX Questions
            { moduleId: 'chapter-review', question: "A patient is taking hydrochlorothiazide 50 mg/day and digoxin 0.25 mg/day. The nurse plans to monitor the patient for which potential electrolyte imbalance?", options: ["Hypocalcemia", "Hypokalemia", "Hyperkalemia", "Hypermagnesemia"], correctAnswer: "Hypokalemia" },
            { moduleId: 'chapter-review', question: "The nurse knows that which statement is correct regarding nursing care of a patient receiving hydrochlorothiazide? (Select all that apply.)", options: ["Monitor patients for signs of hypoglycemia.", "Administer ordered potassium supplements.", "Monitor serum potassium and uric acid levels.", "Assess blood pressure before administration.", "Notify the health care provider if a patient has had oliguria for 24 hours.", "Assess for decreased cholesterol and triglyceride levels."], correctAnswer: ["Administer ordered potassium supplements.", "Monitor serum potassium and uric acid levels.", "Assess blood pressure before administration.", "Notify the health care provider if a patient has had oliguria for 24 hours."] },
            { moduleId: 'chapter-review', question: "A patient has heart failure, and a high dose of furosemide is ordered. What suggests a favorable response to furosemide?", options: ["A decrease in level of consciousness occurs, and the patient sleeps more.", "Respiratory rate decreases from 28/min to 20/min, and the depth increases.", "Breath sounds reveal increased congestion and the patient complains of shortness of breath.", "Urine output is 50 mL/4 hours, and intake is 200 milliliters."], correctAnswer: "Respiratory rate decreases from 28/min to 20/min, and the depth increases." },
            { moduleId: 'chapter-review', question: "What does the nurse know to be correct concerning the use of mannitol in patients?", options: ["It decreases intracranial pressure.", "It increases intraocular pressure.", "It causes sodium and potassium retention.", "It causes diuresis in several days."], correctAnswer: "It decreases intracranial pressure." },
            { moduleId: 'chapter-review', question: "What should the nurse do when a patient is taking furosemide?", options: ["Instruct the patient to change positions quickly when getting out of bed.", "Assess blood pressure before administration.", "Administer the drug at bedtime for maximum effectiveness.", "Teach the patient to avoid fruits to prevent hyperkalemia."], correctAnswer: "Assess blood pressure before administration." },
            { moduleId: 'chapter-review', question: "For the patient taking a diuretic, a combination such as triamterene and hydrochlorothiazide may be prescribed. The nurse realizes that this combination is ordered for which purpose?", options: ["To decrease serum potassium level", "To maintain serum potassium level", "To decrease glucose level", "To increase glucose level"], correctAnswer: "To maintain serum potassium level" },
            { moduleId: 'chapter-review', question: "The patient has been receiving spironolactone 50 mg/day for heart failure. The nurse should closely monitor the patient for which condition?", options: ["Hypokalemia", "Hyperkalemia", "Hypoglycemia", "Hypermagnesemia"], correctAnswer: "Hyperkalemia" }
        ];

        // --- Helper Functions ---
        const cn = (...classes) => classes.filter(Boolean).join(' ');


        // --- Child Components ---

        /**
         * Quiz component for interactive multiple-choice questions.
         * Users answer questions and receive immediate feedback.
         */
        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return;

                if (Array.isArray(currentQuestion.correctAnswer)) {
                    setSelectedOption(prevSelected => {
                        if (prevSelected.includes(option)) {
                            return prevSelected.filter(item => item !== option);
                        } else {
                            return [...prevSelected, option];
                        }
                    });
                } else {
                    setSelectedOption(option);
                }
            };

            const handlePreAssessmentNext = () => {
                if (selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)) return;
                
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                
                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption([]);
                    setFeedback(null);
                } else {
                    onComplete(updatedAnswers);
                }
            };
            
            const handleRegularQuizSubmit = () => {
                if (selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)) return;
                
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                
                setFeedback(isCorrect ? 'correct' : 'incorrect');
            };

            const handleRegularQuizNext = () => {
                const isCorrect = Array.isArray(currentQuestion.correctAnswer)
                    ? currentQuestion.correctAnswer.every(ans => selectedOption.includes(ans)) && selectedOption.length === currentQuestion.correctAnswer.length
                    : selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const finalAnswers = [...answers, { question: currentQuestion, isCorrect }];
                
                if (currentQuestionIndex < questions.length - 1) {
                    setAnswers(finalAnswers);
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption([]);
                    setFeedback(null);
                } else {
                    const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-3">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = Array.isArray(selectedOption) ? selectedOption.includes(option) : selectedOption === option;
                            const isCorrectOption = Array.isArray(currentQuestion.correctAnswer)
                                ? currentQuestion.correctAnswer.includes(option)
                                : option.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';

                            if (feedback && !isPreAssessment) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : <span className="text-red-600 mr-2">✗</span>
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 text-center">
                        {isPreAssessment ? (
                             <button
                                 onClick={handlePreAssessmentNext}
                                 disabled={selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)}
                                 className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                            </button>
                        ) : (
                            <>
                            {!feedback ? (
                                <button
                                    onClick={handleRegularQuizSubmit}
                                    disabled={selectedOption === null || (Array.isArray(selectedOption) && selectedOption.length === 0)}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Submit Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleRegularQuizNext}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Next Question
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        /**
         * PreAssessmentQuiz component to handle the initial diagnostic quiz.
         * Displays quiz questions and then results, allowing users to "test out" of modules.
         */
        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-6">
                                You correctly answered {results.correct} out of {results.total} questions.
                            </p>
                            {results.completedModules.length > 0 ? (
                                <>
                                    <p className="text-green-600 font-semibold mb-4">You've tested out of the following modules:</p>
                                    <ul className="list-disc list-inside text-left mb-6 bg-green-50 p-4 rounded-lg">
                                        {results.completedModules.map(id => <li key={id}>{contentData[id].title}</li>)}
                                    </ul>
                                </>
                            ) : (
                                <p className="text-yellow-600 font-semibold mb-6">You haven't tested out of any modules. You can proceed to the main modules for learning.</p>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                            >
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Diagnostic Quiz</h2>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };


        /**
         * Dashboard component to display the available learning modules.
         * It allows users to select a module to start learning.
         * Shows progress for each module using a circular progress bar and status.
         */
        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });


            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <div className="w-full">
                        <header className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                <span className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">DLM</span>
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Diuretics Learning Module</h1>
                                <span className="bg-gray-200 text-gray-600 text-xs font-mono px-2.5 py-1 rounded-full">V:1.0</span>
                            </div>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">Master the pharmacology of diuretics through interactive modules and NCLEX-style assessments.</p>
                        </header>

                        <div className="mb-8 text-center">
                            <button
                                onClick={onStartPreAssessment}
                                className="w-full max-w-md mx-auto px-6 py-4 bg-teal-500 text-white font-bold rounded-lg shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105"
                            >
                                <div className="text-xl">Skip Ahead: Take Diagnostic Quiz</div>
                                <div className="text-sm font-normal">Test your knowledge and potentially skip modules.</div>
                            </button>
                        </div>

                        <div className="mb-8 bg-white rounded-2xl shadow-lg p-6 w-full">
                           <div className="flex justify-between items-center mb-3">
                             <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
                             <button 
                                 onClick={onResetProgress}
                                 className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2"
                             >
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                     <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" />
                                 </svg>
                                 Reset Progress
                             </button>
                           </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallPercentage}%` }}
                                ></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-left text-sm text-gray-600 mt-2">
                                    {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
                                </p>
                                <p className="text-right text-sm text-gray-600 mt-2">{Math.round(overallPercentage)}% Completed</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                            {Object.entries(contentData).map(([id, module]) => {
                                const moduleProgress = progress[id] || {};
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-green-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-10 h-10 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.title.split(' ').map(word => word.charAt(0)).join('')}
                                            </div>
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    <path
                                                        className="text-gray-200"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                    />
                                                    <path
                                                        className="text-indigo-500"
                                                        d="M18 2.0845
                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                        strokeDasharray={`${percentage}, 100`}
                                                        strokeLinecap="round"
                                                        transform="rotate(-90 18 18)"
                                                    />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10">{module.description}</p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * CaseStudy component for a multiple-choice case study challenge.
         * Presents a scenario and a question with multiple options.
         */
        const CaseStudy = ({ caseData, onComplete }) => {
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            const handleSelect = (option) => {
                if (selectedAnswer) return;
                setSelectedAnswer(option);
                const isCorrect = Array.isArray(caseData.correctAnswer)
                    ? caseData.correctAnswer.includes(option)
                    : option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                
                if (isCorrect) {
                    onComplete();
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Critical Thinking Case Study</h4>
                    <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-3" dangerouslySetInnerHTML={{ __html: caseData.question }}></p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            const isCorrectOption = Array.isArray(caseData.correctAnswer)
                                ? caseData.correctAnswer.includes(option)
                                : option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                            const showFeedback = selectedAnswer !== null;

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';
                            if (showFeedback) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            } 

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {showFeedback && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedAnswer && (
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * VitalsCheck component for an interactive question about vital signs.
         */
        const VitalsCheck = ({ onComplete }) => {
            const [selectedVital, setSelectedVital] = useState(null);
            const vitals = { "BP": "100/68 mmHg", "HR": "110 bpm", "RR": "24/min", "Temp": "99°F" };
            const mostConcerning = "HR";
            const explanation = "A heart rate of 110 bpm (tachycardia) is a significant sign of distress. It indicates the heart is working hard to compensate for poor perfusion, which is common during an acute myocardial infarction.";

            const handleSelect = (vital) => {
                if(selectedVital) return;
                setSelectedVital(vital);
                if (vital.toLowerCase() === mostConcerning.toLowerCase()) {
                    onComplete();
                }
            };

            return (
                <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Vitals Check</h4>
                    <p className="text-sm text-gray-600 mb-4">A patient presents with chest pain. Based on these vital signs, which one is the MOST concerning indicator of impaired central perfusion?</p>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {Object.entries(vitals).map(([key, value]) => {
                            const isSelected = selectedVital === key;
                            const isCorrect = key.toLowerCase() === mostConcerning.toLowerCase();
                            const showFeedback = selectedVital !== null;

                            let optionClass = 'bg-white hover:bg-gray-100 border-gray-200';
                            if (showFeedback) {
                                if (isCorrect) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrect) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            } 
                            return (
                                <div key={key} onClick={() => handleSelect(key)} className={cn('p-4 rounded-lg border-2 cursor-pointer text-center', optionClass)}>
                                    <div className="text-sm font-bold text-gray-500">{key}</div>
                                    <div className="text-xl font-semibold text-gray-800">{value}</div>
                                </div>
                            );
                        })}
                    </div>
                   {selectedVital && (
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Rationale</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * StaticContentStep component for displaying basic text content.
         */
        const StaticContentStep = ({ step, onComplete }) => {
            useEffect(() => {
                onComplete();
            }, []);

            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg shadow-inner space-y-4" dangerouslySetInnerHTML={{ __html: step.content }}>
                </div>
            );
        };

        /**
         * CompletionModal component displayed when a module is completed.
         */
        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
                        <h3 className="text-2xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors shadow-sm"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * LearningModule component to manage steps within the selected module.
         */
        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false);

            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            
            const allStepsCompletedInModule = module.steps.every(step =>
                moduleProgress[step.id] && moduleProgress[step.id].completed
            );

            const handleNextStep = () => {
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };
            
            if (!module || !module.steps) {
                console.error("LearningModule received invalid module prop:", module);
                return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Loading module...</div>;
            }

            const currentStep = module.steps[activeStep];
            
            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;

                const onCompleteForStep = (data) => handleStepComplete(step.id, data);

                switch (step.type) {
                    case 'text':
                        return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'interactive_vitals':
                        return <VitalsCheck key={step.id} onComplete={onCompleteForStep} />;
                    case 'case_study':
                        return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz':
                        return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default:
                        return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack();
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule();
            };


            return (
                <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        </div>
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false);
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };
        
        /**
         * The root component of the Diuretics Learning Module application.
         */
        function App() {
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            const [userId, setUserId] = useState(null);
            const [progress, setProgress] = useState({});
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isAuthReady || !userId) return;
                const storedProgress = localStorage.getItem(`diuretics-module-progress-${userId}`);
                if (storedProgress) {
                    try {
                        setProgress(JSON.parse(storedProgress));
                    } catch (e) {
                        console.error("Failed to parse stored progress, resetting.", e);
                        setProgress({});
                    }
                }
            }, [isAuthReady, userId]);

            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;

                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };

                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
                        return currentProgress;
                    }

                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: newStepProgress
                        }
                    };

                    localStorage.setItem(`diuretics-module-progress-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);

            const handlePreAssessmentComplete = (completedModuleIds) => {
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => {
                            newProgress[moduleId][step.id] = { completed: true };
                        });
                    }
                });
                setProgress(newProgress);
                localStorage.setItem(`diuretics-module-progress-${userId}`, JSON.stringify(newProgress));
            };
            
            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                setProgress({});
                localStorage.removeItem(`diuretics-module-progress-${userId}`);
            }, [isAuthReady, userId]);

            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            const selectedModule = currentModuleId && contentData[currentModuleId]
                                             ? { ...contentData[currentModuleId], id: currentModuleId }
                                             : null;

            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz 
                            onComplete={handlePreAssessmentComplete} 
                            onExit={() => setIsPreAssessmentActive(false)}
                        />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                        />
                    )}
                </div>
            );
        }

        // --- Render the App into the DOM ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
